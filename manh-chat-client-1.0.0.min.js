this.Twilio=this.Twilio||{},this.Twilio.Conversations=function(e){"use strict";var B="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function O(e){return e&&e.Math==Math&&e}function t(e){try{return!!e()}catch(e){return!0}}var n=O("object"==typeof globalThis&&globalThis)||O("object"==typeof window&&window)||O("object"==typeof self&&self)||O("object"==typeof B&&B)||function(){return this}()||Function("return this")(),L={},N=!t(function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}),U={},r={}.propertyIsEnumerable,q=Object.getOwnPropertyDescriptor,z=q&&!r.call({1:2},1);U.f=z?function(e){e=q(this,e);return!!e&&e.enumerable}:r;function W(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}function G(e){return re.call(e).slice(8,-1)}function V(e){if(null==e)throw TypeError("Can't call method on "+e);return e}function H(e){return ae(se(e))}function J(e){return"object"==typeof e?null!==e:"function"==typeof e}function $(e,t){return arguments.length<2?"function"==typeof(n=ce[e])?n:void 0:ce[e]&&ce[e][t];var n}function K(t,n){try{Object.defineProperty(ve,t,{value:n,configurable:!0,writable:!0})}catch(e){ve[t]=n}return n}function Y(e){return Object(we(e))}function Q(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++Se+Ee).toString(36)}function X(e){return Te(Pe,e)&&(Re||"string"==typeof Pe[e])||(Re&&Te(Oe,e)?Pe[e]=Oe[e]:Pe[e]=Ae("Symbol."+e)),Pe[e]}function Z(e,t){if(!Me(e)||De(e))return e;var n=e[je];if(void 0===n){var r,i,o=e,a=t=void 0===t?"number":t;if("string"===a&&"function"==typeof(r=o.toString)&&!ye(i=r.call(o))||"function"==typeof(r=o.valueOf)&&!ye(i=r.call(o))||"string"!==a&&"function"==typeof(r=o.toString)&&!ye(i=r.call(o)))return i}else if(a=n.call(e,t=void 0===t?"default":t),!Me(a)||De(a))return a;throw TypeError("Can't convert object to primitive value")}function ee(e){return e=Le(e,"string"),Ne(e)?e:String(e)}function te(e){return Fe?Ue.createElement(e):{}}function ne(e){if($e(e))return e;throw TypeError(String(e)+" is not an object")}var re={}.toString,ie=G,oe="".split,z=t(function(){return!Object("z").propertyIsEnumerable(0)})?function(e){return"String"==ie(e)?oe.call(e,""):Object(e)}:Object,ae=z,se=V,ce=n,r=$("navigator","userAgent")||"",ue=r,le=n.process,de=n.Deno,le=le&&le.versions||de&&de.version,de=le&&le.v8,le=(de?me=(pe=de.split("."))[0]<4?1:pe[0]+pe[1]:ue&&(!(pe=ue.match(/Edge\/(\d+)/))||74<=pe[1])&&(pe=ue.match(/Chrome\/(\d+)/))&&(me=pe[1]),me&&+me),fe=le,de=t,ue=!!Object.getOwnPropertySymbols&&!de(function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&fe&&fe<41}),pe=ue&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,he=$,me=pe?function(e){return"symbol"==typeof e}:function(e){var t=he("Symbol");return"function"==typeof t&&Object(e)instanceof t},ye=J,de={exports:{}},ve=n,ge=K,be="__core-js_shared__",ge=n[be]||ge(be,{}),_e=ge,we=((de.exports=function(e,t){return _e[e]||(_e[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.17.3",mode:"global",copyright:"Â© 2021 Denis Pushkarev (zloirock.ru)"}),V),ke=Y,xe={}.hasOwnProperty,be=Object.hasOwn||function(e,t){return xe.call(ke(e),t)},Se=0,Ee=Math.random(),Ce=n,Te=be,Ie=Q,Re=ue,Pe=(0,de.exports)("wks"),Oe=Ce.Symbol,Ae=pe?Oe:Oe&&Oe.withoutSetter||Ie,Me=J,De=me,je=X("toPrimitive"),Le=Z,Ne=me,Ce=J,Ue=n.document,Fe=Ce(Ue)&&Ce(Ue.createElement),Be=te,pe=!N&&!t(function(){return 7!=Object.defineProperty(Be("div"),"a",{get:function(){return 7}}).a}),qe=U,ze=W,We=H,Ge=ee,Ve=be,He=pe,Je=Object.getOwnPropertyDescriptor,Ie=(L.f=N?Je:function(e,t){if(e=We(e),t=Ge(t),He)try{return Je(e,t)}catch(e){}if(Ve(e,t))return ze(!qe.f.call(e,t),e[t])},{}),$e=J,Ke=pe,Ye=ne,Qe=ee,Xe=Object.defineProperty,Ze=(Ie.f=N?Xe:function(e,t,n){if(Ye(e),t=Qe(t),Ye(n),Ke)try{return Xe(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(e[t]=n.value),e},Ie),et=W,Ce=N?function(e,t,n){return Ze.f(e,t,et(1,n))}:function(e,t,n){return e[t]=n,e},pe={exports:{}},tt=ge,nt=Function.toString;"function"!=typeof tt.inspectSource&&(tt.inspectSource=function(e){return nt.call(e)});function rt(e){return kt[e]||(kt[e]=wt(e))}function it(e){return isNaN(e=+e)?0:(0<e?Ft:Ut)(e)}function ot(e){return 0<e?qt(Bt(e),9007199254740991):0}function at(e,t){return(e=zt(e))<0?Wt(e+t,0):Gt(e,t)}function st(s){return function(e,t,n){var r,i=Vt(e),o=Ht(i.length),a=Jt(n,o);if(s&&t!=t){for(;a<o;)if((r=i[a++])!=r)return!0}else for(;a<o;a++)if((s||a in i)&&i[a]===t)return s||a||0;return!s&&-1}}function ct(e,t){var n,r=Kt(e),i=0,o=[];for(n in r)!$t(Qt,n)&&$t(r,n)&&o.push(n);for(;t.length>i;)!$t(r,n=t[i++])||~Yt(o,n)||o.push(n);return o}function ut(e,t){for(var n=on(t),r=sn.f,i=an.f,o=0;o<n.length;o++){var a=n[o];rn(e,a)||r(e,a,i(t,a))}}function lt(e,t){return(e=dn[ln(e)])==pn||e!=fn&&("function"==typeof t?cn(t):!!t)}function i(e,t){var n,r,i,o,a=e.target,s=e.global,c=e.stat;if(n=s?mn:c?mn[a]||bn(a,{}):(mn[a]||{}).prototype)for(r in t){if(i=t[r],o=e.noTargetGet?(o=yn(n,r))&&o.value:n[r],!wn(s?r:a+(c?".":"#")+r,e.forced)&&void 0!==o){if(typeof i==typeof o)continue;_n(i,o)}(e.sham||o&&o.sham)&&vn(i,"sham",!0),gn(n,r,i,e)}}function dt(e,t,n){e&&!xn(e=n?e:e.prototype,Sn)&&kn(e,Sn,{configurable:!0,value:t})}var ft,pt,ht,mt,yt,vt,gt,bt,tt=tt.inspectSource,_t=tt,o=n.WeakMap,_t="function"==typeof o&&/native code/.test(_t(o)),wt=Q,kt=(0,de.exports)("keys"),o={},xt=J,St=Ce,Et=be,Ct=rt,Tt=o,It="Object already initialized",Rt=n.WeakMap,_t=(gt=_t||ge.state?(ft=ge.state||(ge.state=new Rt),pt=ft.get,ht=ft.has,mt=ft.set,yt=function(e,t){if(ht.call(ft,e))throw new TypeError(It);return t.facade=e,mt.call(ft,e,t),t},vt=function(e){return pt.call(ft,e)||{}},function(e){return ht.call(ft,e)}):(Tt[bt=Ct("state")]=!0,yt=function(e,t){if(Et(e,bt))throw new TypeError(It);return t.facade=e,St(e,bt,t),t},vt=function(e){return Et(e,bt)?e[bt]:{}},function(e){return Et(e,bt)}),{set:yt,get:vt,has:gt,enforce:function(e){return gt(e)?vt(e):yt(e,{})},getterFor:function(t){return function(e){if(xt(e)&&(e=vt(e)).type===t)return e;throw TypeError("Incompatible receiver, "+t+" required")}}}),Pt=n,Ot=Ce,At=be,Mt=K,Dt=tt,jt=_t.get,Lt=_t.enforce,Nt=String(String).split("String"),ge=((pe.exports=function(e,t,n,r){var i,o=!!r&&!!r.unsafe,a=!!r&&!!r.enumerable,r=!!r&&!!r.noTargetGet;"function"==typeof n&&("string"!=typeof t||At(n,"name")||Ot(n,"name",t),(i=Lt(n)).source||(i.source=Nt.join("string"==typeof t?t:""))),e!==Pt?(o?!r&&e[t]&&(a=!0):delete e[t],a?e[t]=n:Ot(e,t,n)):a?e[t]=n:Mt(t,n)})(Function.prototype,"toString",function(){return"function"==typeof this&&jt(this).source||Dt(this)}),{}),Ut=Math.ceil,Ft=Math.floor,Bt=it,qt=Math.min,zt=it,Wt=Math.max,Gt=Math.min,Vt=H,Ht=ot,Jt=at,Rt={includes:st(!0),indexOf:st(!1)},$t=be,Kt=H,Yt=Rt.indexOf,Qt=o,Tt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Xt=ct,Zt=Tt.concat("length","prototype"),Ct=(ge.f=Object.getOwnPropertyNames||function(e){return Xt(e,Zt)},{}),en=(Ct.f=Object.getOwnPropertySymbols,ge),tn=Ct,nn=ne,a=$("Reflect","ownKeys")||function(e){var t=en.f(nn(e)),n=tn.f;return n?t.concat(n(e)):t},rn=be,on=a,an=L,sn=Ie,cn=t,un=/#|\.prototype\./,ln=lt.normalize=function(e){return String(e).replace(un,".").toLowerCase()},dn=lt.data={},fn=lt.NATIVE="N",pn=lt.POLYFILL="P",hn=lt,mn=n,yn=L.f,vn=Ce,gn=pe.exports,bn=K,_n=ut,wn=hn,kn=Ie.f,xn=be,Sn=X("toStringTag"),En=n,Cn=dt;i({global:!0},{Reflect:{}}),Cn(En.Reflect,"Reflect",!0);function Tn(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e}function In(){}function Rn(e){e.write(rr("")),e.close();var t=e.parentWindow.Object;return e=null,t}function Pn(e){if(kr(e))throw TypeError("Cannot convert a Symbol value to a string");return String(e)}function On(e){var t=Ir.Symbol||(Ir.Symbol={});Rr(t,e)||Or(t,e,{value:Pr.f(e)})}function An(r,i,e){if(Ar(r),void 0===i)return r;switch(e){case 0:return function(){return r.call(i)};case 1:return function(e){return r.call(i,e)};case 2:return function(e,t){return r.call(i,e,t)};case 3:return function(e,t,n){return r.call(i,e,t,n)}}return function(){return r.apply(i,arguments)}}function Mn(e,t){return new(void 0===(n=Dr(e=e)&&("function"==typeof(n=e.constructor)&&(n===Array||Dr(n.prototype))||Mr(n)&&null===(n=n[jr]))?void 0:n)?Array:n)(0===t?0:t);var n}function Dn(f){var p=1==f,h=2==f,m=3==f,y=4==f,v=6==f,g=7==f,b=5==f||v;return function(e,t,n,r){for(var i,o,a=Ur(e),s=Nr(a),c=Lr(t,n,3),u=Fr(s.length),l=0,t=r||Br,d=p?t(e,u):h||g?t(e,0):void 0;l<u;l++)if((b||l in s)&&(o=c(i=s[l],l,a),f))if(p)d[l]=o;else if(o)switch(f){case 3:return!0;case 5:return i;case 6:return l;case 2:qr.call(d,i)}else switch(f){case 4:return!1;case 7:qr.call(d,i)}return v?-1:m||y?y:d}}function jn(e,t){var n=Ei[e]=ei(bi.prototype);return yi(n,{type:hi,tag:e,description:t}),Wr||(n.description=t),n}function Ln(e,t,n){return e===gi&&Ln(Ci,t,n),$r(e),t=Qr(t),$r(n),(Gr(Ei,t)?(n.enumerable?(Gr(e,pi)&&e[pi][t]&&(e[pi][t]=!1),n=ei(n,{enumerable:Zr(0,!1)})):(Gr(e,pi)||ki(e,pi,Zr(1,{})),e[pi][t]=!0),Pi):ki)(e,t,n)}function Nn(t,e){$r(t);var n=Yr(e),e=ti(n).concat(qn(n));return fi(e,function(e){Wr&&!Un.call(n,e)||Ln(t,e,n[e])}),t}function Un(e){var e=Qr(e),t=Si.call(this,e);return!(this===gi&&Gr(Ei,e)&&!Gr(Ci,e))&&(!(t||!Gr(this,e)||!Gr(Ei,e)||Gr(this,pi)&&this[pi][e])||t)}function Fn(e,t){var n,e=Yr(e),t=Qr(t);if(e!==gi||!Gr(Ei,t)||Gr(Ci,t))return!(n=wi(e,t))||!Gr(Ei,t)||Gr(e,pi)&&e[pi][t]||(n.enumerable=!0),n}function Bn(e){var e=xi(Yr(e)),t=[];return fi(e,function(e){Gr(Ei,e)||Gr(si,e)||t.push(e)}),t}function qn(e){var t=e===gi,e=xi(t?Ci:Yr(e)),n=[];return fi(e,function(e){!Gr(Ei,e)||t&&!Gr(gi,e)||n.push(Ei[e])}),n}function zn(t){return 51<=Ai||!Oi(function(){var e=[];return(e.constructor={})[Mi]=function(){return{foo:1}},1!==e[t](Boolean).foo})}function Wn(e,t,n){(t=Ni(t))in e?Ui.f(e,t,Fi(0,n)):e[t]=n}var Gn,Vn=ct,Hn=Tt,Cn=Object.keys||function(e){return Vn(e,Hn)},Jn=Ie,$n=ne,Kn=Cn,En=N?Object.defineProperties:function(e,t){$n(e);for(var n,r=Kn(t),i=r.length,o=0;o<i;)Jn.f(e,n=r[o++],t[n]);return e},Yn=$("document","documentElement"),Qn=ne,Xn=En,Zn=Tt,Tt=o,er=Yn,tr=te,nr=rt("IE_PROTO"),rr=function(e){return"<script>"+e+"<\/script>"},ir=function(){try{Gn=new ActiveXObject("htmlfile")}catch(e){}var e,t;ir="undefined"==typeof document||document.domain&&Gn?Rn(Gn):((t=tr("iframe")).style.display="none",er.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(rr("document.F=Object")),e.close(),e.F);for(var n=Zn.length;n--;)delete ir.prototype[Zn[n]];return ir()},Tt=(Tt[nr]=!0,Object.create||function(e,t){var n;return null!==e?(In.prototype=Qn(e),n=new In,In.prototype=null,n[nr]=e):n=ir(),void 0===t?n:Xn(n,t)}),or=Tn,ar=J,sr=[].slice,cr={},ur=Function.bind||function(a){var s=or(this),c=sr.call(arguments,1),u=function(){var e=c.concat(sr.call(arguments));if(this instanceof u){var t=s,n=e.length,r=e;if(!(n in cr)){for(var i=[],o=0;o<n;o++)i[o]="a["+o+"]";cr[n]=Function("C,a","return new C("+i.join(",")+")")}return cr[n](t,r)}return s.apply(a,e)};return ar(s.prototype)&&(u.prototype=s.prototype),u},lr=i,dr=Tn,fr=ne,pr=J,hr=Tt,mr=ur,ur=t,yr=$("Reflect","construct"),vr=ur(function(){function e(){}return!(yr(function(){},[],e)instanceof e)}),gr=!ur(function(){yr(function(){})}),ur=vr||gr,br=(lr({target:"Reflect",stat:!0,forced:ur,sham:ur},{construct:function(e,t){dr(e),fr(t);var n=arguments.length<3?e:dr(arguments[2]);if(gr&&!vr)return yr(e,t,n);if(e==n){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var r=[null];return r.push.apply(r,t),new(mr.apply(e,r))}r=n.prototype,n=hr(pr(r)?r:Object.prototype),r=Function.apply.call(e,n,t);return pr(r)?r:n}}),Y),_r=Cn,wr=(i({target:"Object",stat:!0,forced:t(function(){_r(1)})},{keys:function(e){return _r(br(e))}}),G),lr=Array.isArray||function(e){return"Array"==wr(e)},kr=me,ur={},xr=H,Sr=ge.f,Er={}.toString,Cr="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],Tr=(ur.f=function(e){if(!Cr||"[object Window]"!=Er.call(e))return Sr(xr(e));var t=e;try{return Sr(t)}catch(t){return Cr.slice()}},{}),Ir=(Tr.f=X,n),Rr=be,Pr=Tr,Or=Ie.f,Ar=Tn,Mr=J,Dr=lr,jr=X("species"),Lr=An,Nr=z,Ur=Y,Fr=ot,Br=Mn,qr=[].push,zr={forEach:Dn(0),map:Dn(1),filter:Dn(2),some:Dn(3),every:Dn(4),find:Dn(5),findIndex:Dn(6),filterReject:Dn(7)},s=i,c=n,u=$,Wr=N,l=t,Gr=be,Vr=lr,Hr=J,Jr=me,$r=ne,Kr=Y,Yr=H,Qr=ee,Xr=Pn,Zr=W,ei=Tt,ti=Cn,d=ge,ni=ur,ri=Ct,ii=L,f=Ie,oi=U,p=Ce,ai=pe.exports,h=de.exports,si=o,ci=Q,ui=X,li=On,di=dt,m=_t,fi=zr.forEach,pi=rt("hidden"),hi="Symbol",mi=ui("toPrimitive"),yi=m.set,vi=m.getterFor(hi),gi=Object.prototype,bi=c.Symbol,_i=u("JSON","stringify"),wi=ii.f,ki=f.f,xi=ni.f,Si=oi.f,Ei=h("symbols"),Ci=h("op-symbols"),Ti=h("string-to-symbol-registry"),Ii=h("symbol-to-string-registry"),m=h("wks"),u=c.QObject,Ri=!u||!u.prototype||!u.prototype.findChild,Pi=Wr&&l(function(){return 7!=ei(ki({},"a",{get:function(){return ki(this,"a",{value:7}).a}})).a})?function(e,t,n){var r=wi(gi,t);r&&delete gi[t],ki(e,t,n),r&&e!==gi&&ki(gi,t,r)}:ki,Oi=(ue||(ai((bi=function(){if(this instanceof bi)throw TypeError("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?Xr(arguments[0]):void 0,t=ci(e),n=function(e){this===gi&&n.call(Ci,e),Gr(this,pi)&&Gr(this[pi],t)&&(this[pi][t]=!1),Pi(this,t,Zr(1,e))};return Wr&&Ri&&Pi(gi,t,{configurable:!0,set:n}),jn(t,e)}).prototype,"toString",function(){return vi(this).tag}),ai(bi,"withoutSetter",function(e){return jn(ci(e),e)}),oi.f=Un,f.f=Ln,ii.f=Fn,d.f=ni.f=Bn,ri.f=qn,Tr.f=function(e){return jn(ui(e),e)},Wr&&(ki(bi.prototype,"description",{configurable:!0,get:function(){return vi(this).description}}),ai(gi,"propertyIsEnumerable",Un,{unsafe:!0}))),s({global:!0,wrap:!0,forced:!ue,sham:!ue},{Symbol:bi}),fi(ti(m),function(e){li(e)}),s({target:hi,stat:!0,forced:!ue},{for:function(e){var t,e=Xr(e);return Gr(Ti,e)?Ti[e]:(t=bi(e),Ti[e]=t,Ii[t]=e,t)},keyFor:function(e){if(!Jr(e))throw TypeError(e+" is not a symbol");if(Gr(Ii,e))return Ii[e]},useSetter:function(){Ri=!0},useSimple:function(){Ri=!1}}),s({target:"Object",stat:!0,forced:!ue,sham:!Wr},{create:function(e,t){return void 0===t?ei(e):Nn(ei(e),t)},defineProperty:Ln,defineProperties:Nn,getOwnPropertyDescriptor:Fn}),s({target:"Object",stat:!0,forced:!ue},{getOwnPropertyNames:Bn,getOwnPropertySymbols:qn}),s({target:"Object",stat:!0,forced:l(function(){ri.f(1)})},{getOwnPropertySymbols:function(e){return ri.f(Kr(e))}}),_i&&s({target:"JSON",stat:!0,forced:!ue||l(function(){var e=bi();return"[null]"!=_i([e])||"{}"!=_i({a:e})||"{}"!=_i(Object(e))})},{stringify:function(e,t,n){for(var r,i=[e],o=1;o<arguments.length;)i.push(arguments[o++]);if((Hr(r=t)||void 0!==e)&&!Jr(e))return Vr(t)||(t=function(e,t){if("function"==typeof r&&(t=r.call(this,e,t)),!Jr(t))return t}),i[1]=t,_i.apply(null,i)}}),bi.prototype[mi]||p(bi.prototype,mi,bi.prototype.valueOf),di(bi,hi),si[pi]=!0,t),Ai=le,Mi=X("species"),Di=zr.filter,h=(i({target:"Array",proto:!0,forced:!zn("filter")},{filter:function(e){return Di(this,e,1<arguments.length?arguments[1]:void 0)}}),i),c=t,ji=H,Li=L.f,u=N,oi=c(function(){Li(1)}),Ni=(h({target:"Object",stat:!0,forced:!u||oi,sham:!u},{getOwnPropertyDescriptor:function(e,t){return Li(ji(e),t)}}),ee),Ui=Ie,Fi=W,Bi=a,qi=H,zi=L,Wi=Wn;function Gi(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}function A(s){return function(){var e=this,a=arguments;return new Promise(function(t,n){var r=s.apply(e,a);function i(e){Gi(r,t,n,i,o,"next",e)}function o(e){Gi(r,t,n,i,o,"throw",e)}i(void 0)})}}function Vi(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Hi(e,t){return(Hi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ji(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Hi(e,t)}function F(e){return(F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function $i(e,t){if(t&&("object"===F(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Vi(e)}function Ki(e){return(Ki=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}function Yi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function M(e,t,n){return t&&Yi(e.prototype,t),n&&Yi(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}i({target:"Object",stat:!0,sham:!N},{getOwnPropertyDescriptors:function(e){for(var t,n,r=qi(e),i=zi.f,o=Bi(r),a={},s=0;o.length>s;)void 0!==(n=i(r,t=o[s++]))&&Wi(a,t,n);return a}});function Qi(e,t,n){for(var r in t)lo(e,r,t[r],n);return e}function Xi(e){var e=ho(e),t=mo.f;yo&&e&&!e[vo]&&t(e,vo,{configurable:!0,get:function(){return this}})}function Zi(e,t,n){if(e instanceof t)return e;throw TypeError("Incorrect "+(n?n+" ":"")+"invocation")}function eo(e){return void 0!==e&&(go.Array===e||_o[bo]===e)}function to(e){if(null!=e)return e[xo]||e["@@iterator"]||ko[wo(e)]}function no(e,t){if("function"!=typeof(t=arguments.length<2?Eo(e):t))throw TypeError(String(e)+" is not iterable");return So(t.call(e))}function ro(e,t,n){var r,i;Co(e);try{if(void 0===(r=e.return)){if("throw"===t)throw n;return n}r=r.call(e)}catch(e){i=!0,r=e}if("throw"===t)throw n;if(i)throw r;return Co(r),n}function io(e,t){this.stopped=e,this.result=t}function oo(e,t,n){function r(e){return o&&Mo(o,"normal",e),new io(!0,e)}function i(e){return f?(To(e),h?m(e[0],e[1],r):m(e[0],e[1])):h?m(e,r):m(e)}var o,a,s,c,u,l,d=n&&n.that,f=!(!n||!n.AS_ENTRIES),p=!(!n||!n.IS_ITERATOR),h=!(!n||!n.INTERRUPTED),m=Po(t,d,1+f+h);if(p)o=e;else{if("function"!=typeof(n=Ao(e)))throw TypeError("Target is not iterable");if(Io(n)){for(a=0,s=Ro(e.length);a<s;a++)if((c=i(e[a]))&&c instanceof io)return c;return new io(!1)}o=Oo(e,n)}for(u=o.next;!(l=u.call(o)).done;){try{c=i(l.value)}catch(e){Mo(o,"throw",e)}if("object"==typeof c&&c&&c instanceof io)return c}return new io(!1)}var f={},ii=(f[X("toStringTag")]="z","[object z]"===String(f)),d=ii,ao=G,so=X("toStringTag"),co="Arguments"==ao(function(){return arguments}()),ni=d?ao:function(e){var t;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(t=function(e,t){try{return e[t]}catch(e){}}(e=Object(e),so))?t:co?ao(e):"Object"==(t=ao(e))&&"function"==typeof e.callee?"Arguments":t},uo=ni,Tr=(ii||(0,pe.exports)(Object.prototype,"toString",ii?{}.toString:function(){return"[object "+uo(this)+"]"},{unsafe:!0}),n.Promise),lo=pe.exports,fo=J,po=ne,ai=Object.setPrototypeOf||("__proto__"in{}?function(){var n,r=!1,e={};try{(n=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(e,[]),r=e instanceof Array}catch(n){}return function(e,t){return po(e),function(e){if(fo(e)||null===e)return;throw TypeError("Can't set "+String(e)+" as a prototype")}(t),r?n.call(e,t):e.__proto__=t,e}}():void 0),ho=$,mo=Ie,yo=N,vo=X("species"),m={},go=m,bo=X("iterator"),_o=Array.prototype,wo=ni,ko=m,xo=X("iterator"),So=ne,Eo=to,Co=ne,To=ne,Io=eo,Ro=ot,Po=An,Oo=no,Ao=to,Mo=ro,Do=X("iterator"),jo=!1;try{var Lo=0,No={next:function(){return{done:!!Lo++}},return:function(){jo=!0}};No[Do]=function(){return this},Array.from(No,function(){throw 2})}catch(e){}function Uo(e,t){if(!t&&!jo)return!1;var n=!1;try{var r={};r[Do]=function(){return{next:function(){return{done:n=!0}}}},e(r)}catch(e){}return n}function Fo(e,t){return void 0===(e=zo(e).constructor)||null==(e=zo(e)[Go])?t:Wo(e)}var Bo,qo,zo=ne,Wo=Tn,Go=X("species"),s=/(?:ipad|iphone|ipod).*applewebkit/i.test(r),ue="process"==G(n.process),Vo=n,l=t,p=An,Ho=Yn,Jo=te,mi=s,di=ue,c=Vo.setImmediate,h=Vo.clearImmediate,$o=Vo.process,oi=Vo.MessageChannel,Ko=Vo.Dispatch,Yo=0,Qo={};try{Bo=Vo.location}catch(e){}function Xo(e){return function(){ta(e)}}function Zo(e){ta(e.data)}function ea(e){Vo.postMessage(String(e),Bo.protocol+"//"+Bo.host)}var ta=function(e){var t;Qo.hasOwnProperty(e)&&(t=Qo[e],delete Qo[e],t())};c&&h||(c=function(e){for(var t=[],n=arguments.length,r=1;r<n;)t.push(arguments[r++]);return Qo[++Yo]=function(){("function"==typeof e?e:Function(e)).apply(void 0,t)},qo(Yo),Yo},h=function(e){delete Qo[e]},di?qo=function(e){$o.nextTick(Xo(e))}:Ko&&Ko.now?qo=function(e){Ko.now(Xo(e))}:oi&&!mi?(a=(u=new oi).port2,u.port1.onmessage=Zo,qo=p(a.postMessage,a,1)):Vo.addEventListener&&"function"==typeof postMessage&&!Vo.importScripts&&Bo&&"file:"!==Bo.protocol&&!l(ea)?(qo=ea,Vo.addEventListener("message",Zo,!1)):qo="onreadystatechange"in Jo("script")?function(e){Ho.appendChild(Jo("script")).onreadystatechange=function(){Ho.removeChild(this),ta(e)}}:function(e){setTimeout(Xo(e),0)});function na(e){var n,r;this.promise=new e(function(e,t){if(void 0!==n||void 0!==r)throw TypeError("Bad Promise constructor");n=e,r=t}),this.resolve=ma(n),this.reject=ma(r)}var ra,ia,oa,aa,sa,ca,ua,la,f={set:c,clear:h},d=n,ii=/ipad|iphone|ipod/i.test(r)&&void 0!==d.Pebble,No=/web0s(?!.*chrome)/i.test(r),da=n,Yn=L.f,fa=f.set,di=s,mi=ii,oi=No,pa=ue,u=da.MutationObserver||da.WebKitMutationObserver,p=da.document,ha=da.process,a=da.Promise,l=Yn(da,"queueMicrotask"),c=l&&l.value,h=(c||(ra=function(){var e,t;for(pa&&(e=ha.domain)&&e.exit();ia;){t=ia.fn,ia=ia.next;try{t()}catch(e){throw ia?aa():oa=void 0,e}}oa=void 0,e&&e.enter()},aa=di||pa||oi||!u||!p?!mi&&a&&a.resolve?((ua=a.resolve(void 0)).constructor=a,la=ua.then,function(){la.call(ua,ra)}):pa?function(){ha.nextTick(ra)}:function(){fa.call(da,ra)}:(sa=!0,ca=p.createTextNode(""),new u(ra).observe(ca,{characterData:!0}),function(){ca.data=sa=!sa})),c||function(e){e={fn:e,next:void 0};oa&&(oa.next=e),ia||(ia=e,aa()),oa=e}),d={},ma=Tn;d.f=function(e){return new na(e)};var ya,va,ga,ba,_a=ne,wa=J,ka=d,xa=n,s="object"==typeof window,ii=i,Sa=n,No=$,Yn=Tr,l=pe.exports,di=Qi,oi=ai,mi=dt,a=Xi,Ea=J,Ca=Tn,Ta=Zi,Ia=tt,Ra=oo,p=Uo,Pa=Fo,Oa=f.set,Aa=h,u=d,Ma=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},c=_t,Tr=hn,Da=s,ja=ue,La=le,Na=X("species"),Ua="Promise",Fa=c.get,Ba=c.set,qa=c.getterFor(Ua),tt=Yn&&Yn.prototype,za=Yn,f=tt,Wa=Sa.TypeError,Ga=Sa.document,Va=Sa.process,Ha=u.f,Ja=Ha,$a=!!(Ga&&Ga.createEvent&&Sa.dispatchEvent),Ka="function"==typeof PromiseRejectionEvent,Ya="unhandledrejection",Qa=!1,h=Tr(Ua,function(){var e,t=Ia(za),n=t!==String(za);return!n&&66===La||!(51<=La&&/native code/.test(t))&&(t=function(e){e(function(){},function(){})},((e=new za(function(e){e(1)})).constructor={})[Na]=t,!(Qa=e.then(function(){})instanceof t)||!n&&Da&&!Ka)}),d=h||!p(function(e){za.all(e).catch(function(){})}),Xa=function(e){var t;return!(!Ea(e)||"function"!=typeof(t=e.then))&&t},Za=function(f,p){var h;f.notified||(f.notified=!0,h=f.reactions,Aa(function(){for(var r,e=f.value,t=1==f.state,n=0;h.length>n;){var i,o,a,s=h[n++],c=t?s.ok:s.fail,u=s.resolve,l=s.reject,d=s.domain;try{c?(t||(2===f.rejection&&function(t){Oa.call(Sa,function(){var e=t.facade;ja?Va.emit("rejectionHandled",e):es("rejectionhandled",e,t.value)})}(f),f.rejection=1),!0===c?i=e:(d&&d.enter(),i=c(e),d&&(d.exit(),a=!0)),i===s.promise?l(Wa("Promise-chain cycle")):(o=Xa(i))?o.call(i,u,l):u(i)):l(e)}catch(e){d&&!a&&d.exit(),l(e)}}f.reactions=[],f.notified=!1,p&&!f.rejection&&(r=f,Oa.call(Sa,function(){var e,t=r.facade,n=r.value;if(ts(r)&&(e=Ma(function(){ja?Va.emit("unhandledRejection",n,t):es(Ya,t,n)}),r.rejection=ja||ts(r)?2:1,e.error))throw e.value}))}))},es=function(e,t,n){var r;$a?((r=Ga.createEvent("Event")).promise=t,r.reason=n,r.initEvent(e,!1,!0),Sa.dispatchEvent(r)):r={promise:t,reason:n},!Ka&&(t=Sa["on"+e])?t(r):e===Ya&&function(e,t){var n=xa.console;n&&n.error&&(1===arguments.length?n.error(e):n.error(e,t))}("Unhandled promise rejection",n)},ts=function(e){return 1!==e.rejection&&!e.parent},ns=function(t,n,r){return function(e){t(n,e,r)}},rs=function(e,t,n){e.done||(e.done=!0,(e=n?n:e).value=t,e.state=2,Za(e,!0))},is=function(n,e,t){if(!n.done){n.done=!0,t&&(n=t);try{if(n.facade===e)throw Wa("Promise can't be resolved itself");var r=Xa(e);r?Aa(function(){var t={done:!1};try{r.call(e,ns(is,t,n),ns(rs,t,n))}catch(e){rs(t,e,n)}}):(n.value=e,n.state=1,Za(n,!1))}catch(e){rs({done:!1},e,n)}}};if(h&&(f=(za=function(e){Ta(this,za,Ua),Ca(e),ya.call(this);var t=Fa(this);try{e(ns(is,t),ns(rs,t))}catch(e){rs(t,e)}}).prototype,(ya=function(e){Ba(this,{type:Ua,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:0,value:void 0})}).prototype=di(f,{then:function(e,t){var n=qa(this),r=Ha(Pa(this,za));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=ja?Va.domain:void 0,n.parent=!0,n.reactions.push(r),0!=n.state&&Za(n,!1),r.promise},catch:function(e){return this.then(void 0,e)}}),va=function(){var e=new ya,t=Fa(e);this.promise=e,this.resolve=ns(is,t),this.reject=ns(rs,t)},u.f=Ha=function(e){return e===za||e===ga?new va:Ja(e)},"function"==typeof Yn)&&tt!==Object.prototype){ba=tt.then,Qa||(l(tt,"then",function(e,t){var n=this;return new za(function(e,t){ba.call(n,e,t)}).then(e,t)},{unsafe:!0}),l(tt,"catch",f.catch,{unsafe:!0}));try{delete tt.constructor}catch(e){}oi&&oi(tt,f)}ii({global:!0,wrap:!0,forced:h},{Promise:za}),mi(za,Ua,!1),a(Ua),ga=No(Ua),ii({target:Ua,stat:!0,forced:h},{reject:function(e){var t=Ha(this);return t.reject.call(void 0,e),t.promise}}),ii({target:Ua,stat:!0,forced:h},{resolve:function(e){return e=e,_a(t=this),wa(e)&&e.constructor===t?e:((0,(t=ka.f(t)).resolve)(e),t.promise);var t}}),ii({target:Ua,stat:!0,forced:d},{all:function(e){var s=this,t=Ha(s),c=t.resolve,u=t.reject,n=Ma(function(){var r=Ca(s.resolve),i=[],o=0,a=1;Ra(e,function(e){var t=o++,n=!1;i.push(void 0),a++,r.call(s,e).then(function(e){n||(n=!0,i[t]=e,--a)||c(i)},u)}),--a||c(i)});return n.error&&u(n.value),t.promise},race:function(e){var n=this,r=Ha(n),i=r.reject,t=Ma(function(){var t=Ca(n.resolve);Ra(e,function(e){t.call(n,e).then(r.resolve,i)})});return t.error&&i(t.value),r.promise}});function os(e,t){var n=[][e];return!!n&&us(function(){n.call(null,t||function(){throw 1},1)})}function as(t){if(t&&t.forEach!==fs)try{ps(t,"forEach",fs)}catch(e){t.forEach=fs}}var ss,cs=zr.map,s=(i({target:"Array",proto:!0,forced:!zn("map")},{map:function(e){return cs(this,e,1<arguments.length?arguments[1]:void 0)}}),{CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}),c=te("span").classList,Tr=c&&c.constructor&&c.constructor.prototype,p=Tr===Object.prototype?void 0:Tr,us=t,ls=zr.forEach,ds=n,di=p,fs=os("forEach")?[].forEach:function(e){return ls(this,e,1<arguments.length?arguments[1]:void 0)},ps=Ce;for(ss in s)as(ds[ss]&&ds[ss].prototype);as(di);var hs,u=Object.prototype,ms=u.hasOwnProperty,Yn="function"==typeof Symbol?Symbol:{},ys=Yn.iterator||"@@iterator",l=Yn.asyncIterator||"@@asyncIterator",vs=Yn.toStringTag||"@@toStringTag";function gs(e,t,n,r){var i,o,a,s,t=t&&t.prototype instanceof Ss?t:Ss,t=Object.create(t.prototype),r=new Ms(r||[]);return t._invoke=(i=e,o=n,a=r,s=_s,function(e,t){if(s===ws)throw new Error("Generator is already running");if(s===ks){if("throw"===e)throw t;return js()}for(a.method=e,a.arg=t;;){var n=a.delegate;if(n){n=function e(t,n){var r=t.iterator[n.method];if(r===hs){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=hs,e(t,n),"throw"===n.method))return xs;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return xs}r=bs(r,t.iterator,n.arg);if("throw"===r.type)return n.method="throw",n.arg=r.arg,n.delegate=null,xs;r=r.arg;return r?r.done?(n[t.resultName]=r.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=hs),n.delegate=null,xs):r:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,xs)}(n,a);if(n){if(n===xs)continue;return n}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if(s===_s)throw s=ks,a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);s=ws;n=bs(i,o,a);if("normal"===n.type){if(s=a.done?ks:"suspendedYield",n.arg===xs)continue;return{value:n.arg,done:a.done}}"throw"===n.type&&(s=ks,a.method="throw",a.arg=n.arg)}}),t}function bs(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}var _s="suspendedStart",ws="executing",ks="completed",xs={};function Ss(){}function Es(){}function Cs(){}var oi={},tt=(oi[ys]=function(){return this},Object.getPrototypeOf),f=tt&&tt(tt(Ds([]))),Ts=(f&&f!==u&&ms.call(f,ys)&&(oi=f),Cs.prototype=Ss.prototype=Object.create(oi));function Is(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function Rs(e){e="function"==typeof e&&e.constructor;return!!e&&(e===Es||"GeneratorFunction"===(e.displayName||e.name))}function Ps(a,s){var t;this._invoke=function(n,r){function e(){return new s(function(e,t){!function t(e,n,r,i){var o,e=bs(a[e],a,n);if("throw"!==e.type)return(n=(o=e.arg).value)&&"object"===F(n)&&ms.call(n,"__await")?s.resolve(n.__await).then(function(e){t("next",e,r,i)},function(e){t("throw",e,r,i)}):s.resolve(n).then(function(e){o.value=e,r(o)},function(e){return t("throw",e,r,i)});i(e.arg)}(n,r,e,t)})}return t=t?t.then(e,e):e()}}function Os(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function As(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Ms(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(Os,this),this.reset(!0)}function Ds(t){if(t){var n,e=t[ys];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return n=-1,(e=function e(){for(;++n<t.length;)if(ms.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=hs,e.done=!0,e}).next=e}return{next:js}}function js(){return{value:hs,done:!0}}(Es.prototype=Ts.constructor=Cs).constructor=Es,Cs[vs]=Es.displayName="GeneratorFunction",Is(Ps.prototype),Ps.prototype[l]=function(){return this},Is(Ts),Ts[vs]="Generator",Ts[ys]=function(){return this},Ts.toString=function(){return"[object Generator]"},Ms.prototype={constructor:Ms,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=hs,this.done=!1,this.delegate=null,this.method="next",this.arg=hs,this.tryEntries.forEach(As),!e)for(var t in this)"t"===t.charAt(0)&&ms.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=hs)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var r=this;function e(e,t){return o.type="throw",o.arg=n,r.next=e,t&&(r.method="next",r.arg=hs),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t],o=i.completion;if("root"===i.tryLoc)return e("end");if(i.tryLoc<=this.prev){var a=ms.call(i,"catchLoc"),s=ms.call(i,"finallyLoc");if(a&&s){if(this.prev<i.catchLoc)return e(i.catchLoc,!0);if(this.prev<i.finallyLoc)return e(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return e(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return e(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&ms.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}var o=(i=i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc?null:i)?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,xs):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),xs},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),As(n),xs}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n,r,i=this.tryEntries[t];if(i.tryLoc===e)return"throw"===(n=i.completion).type&&(r=n.arg,As(i)),r}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:Ds(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=hs),xs}};var j={wrap:gs,isGeneratorFunction:Rs,AsyncIterator:Ps,mark:function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,Cs):(e.__proto__=Cs,vs in e||(e[vs]="GeneratorFunction")),e.prototype=Object.create(Ts),e},awrap:function(e){return{__await:e}},async:function(e,t,n,r,i){void 0===i&&(i=Promise);var o=new Ps(gs(e,t,n,r),i);return Rs(t)?o:o.next().then(function(e){return e.done?e.value:o.next()})},keys:function(n){var e,r=[];for(e in n)r.push(e);return r.reverse(),function e(){for(;r.length;){var t=r.pop();if(t in n)return e.value=t,e.done=!1,e}return e.done=!0,e}},values:Ds},mi=Object.freeze({__proto__:null,default:j});function y(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":F(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(a=(o<3?i(a):3<o?i(t,n,a):i(t,n))||a);return 3<o&&a&&Object.defineProperty(t,n,a),a}function v(e,t){if("object"===("undefined"==typeof Reflect?"undefined":F(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function Ls(e){var t,n,r,i,o,a,s=Ks(e),e="function"==typeof this?this:Array,c=arguments.length,u=1<c?arguments[1]:void 0,l=void 0!==u,d=ec(s),f=0;if(l&&(u=$s(u,2<c?arguments[2]:void 0,2)),null==d||e==Array&&Ys(d))for(n=new e(t=Qs(s.length));f<t;f++)a=l?u(s[f],f):s[f],Xs(n,f,a);else for(o=(i=Zs(s,d)).next,n=new e;!(r=o.call(i)).done;f++)a=l?function(e,t,n,r){try{return r?t(Hs(n)[0],n[1]):t(n)}catch(t){Js(e,"throw",t)}}(i,u,[r.value,f],!0):r.value,Xs(n,f,a);return n.length=f,n}var a=i,No=t,Ns=lr,Us=J,Fs=Y,Bs=ot,qs=Wn,zs=Mn,h=zn,ii=le,Ws=X("isConcatSpreadable"),Gs=9007199254740991,Vs="Maximum allowed index exceeded",d=51<=ii||!No(function(){var e=[];return e[Ws]=!1,e.concat()[0]!==e}),c=h("concat"),Hs=(a({target:"Array",proto:!0,forced:!d||!c},{concat:function(e){for(var t,n,r,i,o,a=Fs(this),s=zs(a,0),c=0,u=-1,l=arguments.length;u<l;u++)if(i=r=-1===u?a:arguments[u],o=void 0,!Us(i)||(void 0!==(o=i[Ws])?!o:!Ns(i))){if(Gs<=c)throw TypeError(Vs);qs(s,c++,r)}else{if(c+(n=Bs(r.length))>Gs)throw TypeError(Vs);for(t=0;t<n;t++,c++)t in r&&qs(s,c,r[t])}return s.length=c,s}}),ne),Js=ro,$s=An,Ks=Y,Ys=eo,Qs=ot,Xs=Wn,Zs=no,ec=to,Tr=Ls;i({target:"Array",stat:!0,forced:!Uo(function(e){Array.from(e)})},{from:Tr});function tc(i){return function(e,t){var n,e=ic(oc(e)),t=rc(t),r=e.length;return t<0||r<=t?i?"":void 0:(n=e.charCodeAt(t))<55296||56319<n||t+1===r||(r=e.charCodeAt(t+1))<56320||57343<r?i?e.charAt(t):n:i?e.slice(t,t+2):r-56320+(n-55296<<10)+65536}}var nc,rc=it,ic=Pn,oc=V,di={codeAt:tc(!1),charAt:tc(!0)},Yn=!t(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}),ac=be,sc=Y,tt=Yn,cc=rt("IE_PROTO"),uc=Object.prototype,u=tt?Object.getPrototypeOf:function(e){return e=sc(e),ac(e,cc)?e[cc]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?uc:null},f=t,oi=u,l=Ce,lc=X("iterator"),ii=!1;[].keys&&("next"in(No=[].keys())?(h=oi(oi(No)))!==Object.prototype&&(nc=h):ii=!0);function dc(){return this}function fc(e,t,n){return t+=" Iterator",e.prototype=yc(mc,{next:vc(1,n)}),gc(e,t,!1),bc[t]=dc,e}function pc(){return this}function hc(e,t,n,r,i,o,a){function s(e){if(e===i&&p)return p;if(!Rc&&e in d)return d[e];switch(e){case"keys":case Oc:case Ac:return function(){return new n(this,e)}}return function(){return new n(this)}}wc(n,t,r);var c,u,r=t+" Iterator",l=!1,d=e.prototype,f=d[Pc]||d["@@iterator"]||i&&d[i],p=!Rc&&f||s(i),h="Array"==t&&d.entries||f;if(h&&(h=kc(h.call(new e)))!==Object.prototype&&h.next&&(kc(h)!==Ic&&(xc?xc(h,Ic):"function"!=typeof h[Pc]&&Ec(h,Pc,pc)),Sc(h,r,!0)),i==Oc&&f&&f.name!==Oc&&(l=!0,p=function(){return f.call(this)}),d[Pc]!==p&&Ec(d,Pc,p),Tc[t]=p,i)if(c={values:s(Oc),keys:o?p:s("keys"),entries:s(Ac)},a)for(u in c)!Rc&&!l&&u in d||Cc(d,u,c[u]);else _c({target:t,proto:!0,forced:Rc||l},c);return c}"function"!=typeof(nc=null==nc||f(function(){var e={};return nc[lc].call(e)!==e})?{}:nc)[lc]&&l(nc,lc,function(){return this});var a={IteratorPrototype:nc,BUGGY_SAFARI_ITERATORS:ii},mc=a.IteratorPrototype,yc=Tt,vc=W,gc=dt,bc=m,_c=i,wc=fc,kc=u,xc=ai,Sc=dt,Ec=Ce,Cc=pe.exports,Tc=m,Ic=a.IteratorPrototype,Rc=a.BUGGY_SAFARI_ITERATORS,Pc=X("iterator"),Oc="values",Ac="entries",Mc=di.charAt,Dc=Pn,d=_t,c=hc,jc="String Iterator",Lc=d.set,Nc=d.getterFor(jc);c(String,"String",function(e){Lc(this,{type:jc,string:Dc(e),index:0})},function(){var e=Nc(this),t=e.string,n=e.index;return n>=t.length?{value:void 0,done:!0}:(t=Mc(t,n),e.index+=t.length,{value:t,done:!1})});Tr={exports:{}};function Uc(e,t){return["".concat((new Date).toISOString()," Conversations ").concat(e,":")].concat(Array.from(t))}Yn=B,tt=function(){var i=function(){},s="undefined",r=("undefined"==typeof window?"undefined":F(window))!==s&&F(window.navigator)!==s&&/Trident\/|MSIE /.test(window.navigator.userAgent),c=["trace","debug","info","warn","error"];function o(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function u(e,t){for(var n=0;n<c.length;n++){var r=c[n];this[r]=n<e?i:this.methodFactory(r,e,t)}this.log=this.debug}function l(e,t,n){return"debug"===(e=e)&&(e="log"),("undefined"==typeof console?"undefined":F(console))!==s&&("trace"===e&&r?a:void 0!==console[e]?o(console,e):void 0!==console.log?o(console,"log"):i)||function(e,t,n){return function(){("undefined"==typeof console?"undefined":F(console))!==s&&(u.call(this,t,n),this[e].apply(this,arguments))}}.apply(this,arguments)}function t(n,t,e){var r,i=this,o=(t=null==t?"WARN":t,"loglevel");function a(){var e;if(("undefined"==typeof window?"undefined":F(window))!==s&&o){try{e=window.localStorage[o]}catch(e){}if(F(e)===s)try{var t=window.document.cookie,n=t.indexOf(encodeURIComponent(o)+"=");-1!==n&&(e=/^([^;]+)/.exec(t.slice(n))[1])}catch(e){}return e=void 0===i.levels[e]?void 0:e}}"string"==typeof n?o+=":"+n:"symbol"===F(n)&&(o=void 0),i.name=n,i.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},i.methodFactory=e||l,i.getLevel=function(){return r},i.setLevel=function(t,e){if(!("number"==typeof(t="string"==typeof t&&void 0!==i.levels[t.toUpperCase()]?i.levels[t.toUpperCase()]:t)&&0<=t&&t<=i.levels.SILENT))throw"log.setLevel() called with invalid level: "+t;if(r=t,!1!==e&&function(){var e=(c[t]||"silent").toUpperCase();if(("undefined"==typeof window?"undefined":F(window))!==s&&o){try{return window.localStorage[o]=e}catch(e){}try{window.document.cookie=encodeURIComponent(o)+"="+e+";"}catch(e){}}}(),u.call(i,t,n),("undefined"==typeof console?"undefined":F(console))===s&&t<i.levels.SILENT)return"No console available for logging"},i.setDefaultLevel=function(e){t=e,a()||i.setLevel(e,!1)},i.resetLevel=function(){if(i.setLevel(t,!1),("undefined"==typeof window?"undefined":F(window))!==s&&o){try{return void window.localStorage.removeItem(o)}catch(e){}try{window.document.cookie=encodeURIComponent(o)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}},i.enableAll=function(e){i.setLevel(i.levels.TRACE,e)},i.disableAll=function(e){i.setLevel(i.levels.SILENT,e)};e=a();null==e&&(e=t),i.setLevel(e,!1)}var n=new t,d={},e=(n.getLogger=function(e){if("symbol"!==F(e)&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");return d[e]||(d[e]=new t(e,n.getLevel(),n.methodFactory))},("undefined"==typeof window?"undefined":F(window))!==s?window.log:void 0);return n.noConflict=function(){return("undefined"==typeof window?"undefined":F(window))!==s&&window.log===n&&(window.log=e),n},n.getLoggers=function(){return d},n.default=n},Tr.exports?Tr.exports=tt():Yn.log=tt();var Fc,Bc,qc=Tr.exports.getLogger("twilio-conversations"),oi=(M(zc,[{key:"setLevel",value:function(e){qc.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.trace.apply(null,Uc(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.debug.apply(null,Uc(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.info.apply(null,Uc(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.warn.apply(null,Uc(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.error.apply(null,Uc(this.prefix+"E",t))}}],[{key:"scope",value:function(e){return new zc(e)}},{key:"setLevel",value:function(e){qc.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.trace.apply(null,Uc("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.debug.apply(null,Uc("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.info.apply(null,Uc("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.warn.apply(null,Uc("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qc.error.apply(null,Uc("E",t))}}]),zc),No={};function zc(e){D(this,zc),b(this,"prefix",""),this.prefix=null!=e&&0<e.length?e+" ":""}Object.defineProperty(No,"__esModule",{value:!0});var Wc=["weeks","years","months","days","hours","minutes","seconds"],Gc=No.pattern=new RegExp("P(?:(\\d+(?:[\\.,]\\d+)?W)|(\\d+(?:[\\.,]\\d+)?Y)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?D)?(?:T(\\d+(?:[\\.,]\\d+)?H)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?S)?)?)"),h=Bc=No.parse=function(e){return e.match(Gc).slice(1).reduce(function(e,t,n){return e[Wc[n]]=parseFloat(t)||0,e},{})},Vc=No.end=function(e,t){t=t?t.getTime():Date.now(),t=new Date(t);return t.setFullYear(t.getFullYear()+e.years),t.setMonth(t.getMonth()+e.months),t.setDate(t.getDate()+e.days),t.setHours(t.getHours()+e.hours),t.setMinutes(t.getMinutes()+e.minutes),t.setMilliseconds(t.getMilliseconds()+1e3*e.seconds),t.setDate(t.getDate()+7*e.weeks),t},f=Fc=No.toSeconds=function(e,t){t=t?t.getTime():Date.now(),t=new Date(t);return(Vc(e,t).getTime()-t.getTime())/1e3};function Hc(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}No.default={end:Vc,toSeconds:f,pattern:Gc,parse:h};function Jc(e){eu[Zc][e]=!0}function $c(e,t){if(e){if(e[uu]!==du)try{cu(e,uu,du)}catch(t){e[uu]=du}if(e[lu]||cu(e,lu,t),au[t])for(var n in su)if(e[n]!==su[n])try{cu(e,n,su[n])}catch(t){e[n]=su[n]}}}var Kc,Yc="PT5S",Qc="PT5S",Xc=M(function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length?arguments[1]:void 0,r=2<arguments.length?arguments[2]:void 0,t=(D(this,e),b(this,"typingIndicatorTimeoutDefault",5e3),t.Chat||t.IPMessaging||t||{}),i=(this.productId=t.productId,this.links={myConversations:n.links.my_conversations,conversations:n.links.conversations,users:n.links.users,currentUser:n.links.current_user,typing:n.links.typing,mediaService:n.links.media_service,mediaSetService:n.links.media_set_service,messagesReceipts:n.links.messages_receipts},this.limits={mediaAttachmentsCountLimit:n.options.media_attachments_count_limit,mediaAttachmentSizeLimitInMb:n.options.media_attachment_size_limit_in_mb,mediaAttachmentsTotalSizeLimitInMb:n.options.media_attachments_total_size_limit_in_mb,emailHistoriesAllowedContentTypes:n.options.email_histories_allowed_mime_types,emailBodiesAllowedContentTypes:n.options.email_bodies_allowed_mime_types},this.typingIndicatorTimeoutOverride=t.typingIndicatorTimeoutOverride,this.backoffConfiguration=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Hc(Object(n),!0).forEach(function(e){b(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Hc(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}({min:1e3,max:4e3,maxAttemptsCount:3},t.backoffConfigOverride),this.retryWhenThrottled=void 0===t.retryWhenThrottledOverride||t.retryWhenThrottledOverride,this.userInfosToSubscribe=null!=(i=null!=(i=t.userInfosToSubscribeOverride)?i:n.options.user_infos_to_subscribe)?i:100,this.reachabilityEnabled=n.options.reachability_enabled,this.userIdentity=n.identity,this.userInfo=n.sync_objects.my_user_info,this.myConversations=n.sync_objects.my_conversations,null!=(i=null!=(i=t.httpCacheIntervalOverride)?i:n.options.http_cache_interval)?i:Yc);try{this.httpCacheInterval=Fc(Bc(i))}catch(e){r.error("Failed to parse http cache interval ".concat(i,", using default value ").concat(Yc)),this.httpCacheInterval=Fc(Bc(Yc))}i=null!=(t=null!=(i=t.consumptionReportIntervalOverride)?i:n.options.consumption_report_interval)?t:Qc;try{this.consumptionReportInterval=Fc(Bc(i))}catch(e){r.error("Failed to parse consumption report interval ".concat(i,", using default value ").concat(Qc)),this.consumptionReportInterval=Fc(Bc(Qc))}}),l=Tt,ii=Ie,Zc=X("unscopables"),eu=Array.prototype,tu=(null==eu[Zc]&&ii.f(eu,Zc,{configurable:!0,value:l(null)}),H),a=Jc,d=m,c=_t,Yn=hc,nu="Array Iterator",ru=c.set,iu=c.getterFor(nu),tt=Yn(Array,"Array",function(e,t){ru(this,{type:nu,target:tu(e),index:0,kind:t})},function(){var e=iu(this),t=e.target,n=e.kind,r=e.index++;return!t||r>=t.length?{value:e.target=void 0,done:!0}:"keys"==n?{value:r,done:!1}:"values"==n?{value:t[r],done:!1}:{value:[r,t[r]],done:!1}},"values"),ou=(d.Arguments=d.Array,a("keys"),a("values"),a("entries"),n),au=s,No=p,su=tt,cu=Ce,f=X,uu=f("iterator"),lu=f("toStringTag"),du=su.values;for(Kc in au)$c(ou[Kc]&&ou[Kc].prototype,Kc);$c(No,"DOMTokenList");function fu(e,t,n){var r=n.charAt(t-1),n=n.charAt(t+1);return gu.test(e)&&!bu.test(n)||bu.test(e)&&!gu.test(r)?"\\u"+e.charCodeAt(0).toString(16):e}function pu(e,t,n){return wu&&"function"==typeof(t=t.constructor)&&t!==n&&_u(t=t.prototype)&&t!==n.prototype&&wu(e,t),e}function hu(t){return function(e){e=xu(ku(e));return 1&t&&(e=e.replace(Su,"")),e=2&t?e.replace(Eu,""):e}}function mu(e){if(Ru(e))throw TypeError("Cannot convert a Symbol value to a number");var t,n,r,i,o,a,s,c=Pu(e,"number");if("string"==typeof c&&2<c.length)if(43===(e=(c=Du(c)).charCodeAt(0))||45===e){if(88===(t=c.charCodeAt(2))||120===t)return NaN}else if(48===e){switch(c.charCodeAt(1)){case 66:case 98:n=2,r=49;break;case 79:case 111:n=8,r=55;break;default:return+c}for(o=(i=c.slice(2)).length,a=0;a<o;a++)if((s=i.charCodeAt(a))<48||r<s)return NaN;return parseInt(i,n)}return+c}var h=i,ii=t,yu=$("JSON","stringify"),vu=/[\uD800-\uDFFF]/g,gu=/^[\uD800-\uDBFF]$/,bu=/^[\uDC00-\uDFFF]$/,l=ii(function(){return'"\\udf06\\ud834"'!==yu("\udf06\ud834")||'"\\udead"'!==yu("\udead")}),_u=(yu&&h({target:"JSON",stat:!0,forced:l},{stringify:function(e,t,n){var r=yu.apply(null,arguments);return"string"==typeof r?r.replace(vu,fu):r}}),J),wu=ai,ku=V,xu=Pn,m="[\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff]",Su=RegExp("^"+m+m+"*"),Eu=RegExp(m+m+"*$"),c={start:hu(1),end:hu(2),trim:hu(3)},Yn=N,d=n,a=hn,s=pe.exports,Cu=be,Tu=G,Iu=pu,Ru=me,Pu=Z,Ou=t,p=Tt,f=ge.f,Au=L.f,Mu=Ie.f,Du=c.trim,ju="Number",Lu=d.Number,Nu=Lu.prototype,Uu=Tu(p(Nu))==ju;if(a(ju,!Lu(" 0o1")||!Lu("0b1")||Lu("+0x1"))){for(var Fu,Bu=function(e){var e=arguments.length<1?0:e,t=this;return t instanceof Bu&&(Uu?Ou(function(){Nu.valueOf.call(t)}):Tu(t)!=ju)?Iu(new Lu(mu(e)),t,Bu):mu(e)},qu=Yn?f(Lu):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger,fromString,range".split(","),zu=0;qu.length>zu;zu++)Cu(Lu,Fu=qu[zu])&&!Cu(Bu,Fu)&&Mu(Bu,Fu,Au(Lu,Fu));(Bu.prototype=Nu).constructor=Bu,s(d,ju,Bu)}function Wu(){var e=Gu(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}var Gu=ne,No={},ii=t,Vu=n.RegExp;No.UNSUPPORTED_Y=ii(function(){var e=Vu("a","y");return e.lastIndex=2,null!=e.exec("abcd")}),No.BROKEN_CARET=ii(function(){var e=Vu("^r","gy");return e.lastIndex=2,null!=e.exec("str")});function Hu(n,e,t,r){var a,i=ll(n),s=!ul(function(){var e={};return e[i]=function(){return 7},7!=""[n](e)}),o=s&&!ul(function(){var e=!1,t=/a/;return"split"===n&&((t={}).constructor={},t.constructor[fl]=function(){return t},t.flags="",t[i]=/./[i]),t.exec=function(){return e=!0,null},t[i](""),!e});s&&o&&!t||(a=/./[i],o=e(i,""[n],function(e,t,n,r,i){var o=t.exec;return o===cl||o===pl.exec?s&&!i?{done:!0,value:a.call(t,n,r)}:{done:!0,value:e.call(n,t,r)}:{done:!1}}),sl(String.prototype,n,o[0]),sl(pl,i,o[1])),r&&dl(pl[i],"sham",!0)}function Ju(e,t,n){return t+(n?hl(e,t).length:1)}function $u(e,t){var n=e.exec;if("function"==typeof n){n=n.call(e,t);if("object"!=typeof n)throw TypeError("RegExp exec method returned something other than an Object or null");return n}if("RegExp"!==_l(e))throw TypeError("RegExp#exec called on incompatible receiver");return wl.call(e,t)}var h=t,Ku=n.RegExp,l=h(function(){var e=Ku(".","s");return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)}),m=t,Yu=n.RegExp,c=m(function(){var e=Yu("(?<a>b)","g");return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")}),Qu=Pn,Xu=Wu,p=No,a=de.exports,Zu=Tt,el=_t.get,Yn=l,f=c,tl=RegExp.prototype.exec,nl=a("native-string-replace",String.prototype.replace),rl=tl,il=(s=/b*/g,tl.call(d=/a/,"a"),tl.call(s,"a"),0!==d.lastIndex||0!==s.lastIndex),ol=p.UNSUPPORTED_Y||p.BROKEN_CARET,al=void 0!==/()??/.exec("")[1],ii=rl=il||al||ol||Yn||f?function(e){var t,n,r,i,o,a,s=this,c=el(s),e=Qu(e),u=c.raw;if(u)return u.lastIndex=s.lastIndex,d=rl.call(u,e),s.lastIndex=u.lastIndex,d;var l=c.groups,u=ol&&s.sticky,d=Xu.call(s),c=s.source,f=0,p=e;if(u&&(-1===(d=d.replace("y","")).indexOf("g")&&(d+="g"),p=e.slice(s.lastIndex),0<s.lastIndex&&(!s.multiline||s.multiline&&"\n"!==e.charAt(s.lastIndex-1))&&(c="(?: "+c+")",p=" "+p,f++),t=new RegExp("^(?:"+c+")",d)),al&&(t=new RegExp("^"+c+"$(?!\\s)",d)),il&&(n=s.lastIndex),r=tl.call(u?t:s,p),u?r?(r.input=r.input.slice(f),r[0]=r[0].slice(f),r.index=s.lastIndex,s.lastIndex+=r[0].length):s.lastIndex=0:il&&r&&(s.lastIndex=s.global?r.index+r[0].length:n),al&&r&&1<r.length&&nl.call(r[0],t,function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(r[i]=void 0)}),r&&l)for(r.groups=o=Zu(null),i=0;i<l.length;i++)o[(a=l[i])[0]]=r[a[1]];return r}:rl,sl=(i({target:"RegExp",proto:!0,forced:/./.exec!==ii},{exec:ii}),pe.exports),cl=ii,ul=t,ll=X,dl=Ce,fl=ll("species"),pl=RegExp.prototype,hl=di.charAt,ml=Y,yl=Math.floor,vl="".replace,gl=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,bl=/\$([$&'`]|\d{1,2})/g,_l=G,wl=ii,h=Hu,m=t,kl=ne,xl=it,Sl=ot,El=Pn,Cl=V,Tl=Ju,Il=$u,Rl=X("replace"),Pl=Math.max,Ol=Math.min,de="$0"==="a".replace(/./,"$0"),Al=!!/./[Rl]&&""===/./[Rl]("a","$0"),l=(h("replace",function(e,b,_){var w=Al?"$":"$0";return[function(e,t){var n=Cl(this),r=null==e?void 0:e[Rl];return void 0!==r?r.call(e,n,t):b.call(El(n),e,t)},function(e,t){var n=kl(this),r=El(e);if("string"==typeof t&&-1===t.indexOf(w)&&-1===t.indexOf("$<")){e=_(b,n,r,t);if(e.done)return e.value}var i,o="function"==typeof t,a=(o||(t=El(t)),n.global);a&&(i=n.unicode,n.lastIndex=0);for(var s=[];;){var c=Il(n,r);if(null===c)break;if(s.push(c),!a)break;""===El(c[0])&&(n.lastIndex=Tl(r,Sl(n.lastIndex),i))}for(var u,l="",d=0,f=0;f<s.length;f++){for(var p=El((c=s[f])[0]),h=Pl(Ol(xl(c.index),r.length),0),m=[],y=1;y<c.length;y++)m.push(void 0===(u=c[y])?u:String(u));var v=c.groups,g=o?(g=[p].concat(m,h,r),void 0!==v&&g.push(v),El(t.apply(void 0,g))):function(o,a,s,c,u,e){var l=s+o.length,d=c.length,t=bl;return void 0!==u&&(u=ml(u),t=gl),vl.call(e,t,function(e,t){var n;switch(t.charAt(0)){case"$":return"$";case"&":return o;case"`":return a.slice(0,s);case"'":return a.slice(l);case"<":n=u[t.slice(1,-1)];break;default:var r,i=+t;if(0==i)return e;if(d<i)return 0!==(r=yl(i/10))&&r<=d?void 0===c[r-1]?t.charAt(1):c[r-1]+t.charAt(1):e;n=c[i-1]}return void 0===n?"":n})}(p,r,h,m,v,t);d<=h&&(l+=r.slice(d,h)+g,d=h+p.length)}return l+r.slice(d)}]},!!m(function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")})||!de||Al),i),Ml=H,Dl=[].join,c=z!=Object,a=os("join",",");function jl(e){return void 0===e||isNaN(Number(e))?null:Number(e)}function Ll(e){try{return new Date(e)}catch(e){return null}}function Nl(e,t,n){var r={};if(e)try{r=JSON.parse(e)}catch(e){n.warn(t,e)}return r}l({target:"Array",proto:!0,forced:c||!a},{join:function(e){return Dl.call(Ml(this),void 0===e?",":e)}});M($l,[{key:"arg",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"path",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]);var Ul=$l,d={},s=i,Fl=J,Bl=lr,ql=at,zl=ot,Wl=H,Gl=Wn,p=X,Yn=zn("slice"),Vl=p("species"),Hl=[].slice,Jl=Math.max;function $l(e){D(this,$l),this.base=e.replace(/\/$/,""),this.args=[],this.paths=[]}s({target:"Array",proto:!0,forced:!Yn},{slice:function(e,t){var n,r,i,o=Wl(this),a=zl(o.length),s=ql(e,a),c=ql(void 0===t?a:t,a);if(Bl(o)&&((n="function"==typeof(n=o.constructor)&&(n===Array||Bl(n.prototype))||Fl(n)&&null===(n=n[Vl])?void 0:n)===Array||void 0===n))return Hl.call(o,s,c);for(r=new(void 0===n?Array:n)(Jl(c-s,0)),i=0;s<c;s++,i++)s in o&&Gl(r,i,o[s]);return r.length=i,r}});var Kl,Yl,Ql,Xl,Zl,ed,td,f=i,nd=J,m=(Kl=!1,(h=/[ac]/).exec=function(){return Kl=!0,/./.exec.apply(this,arguments)},!0===h.test("abc")&&Kl),rd=/./.test,de=(f({target:"RegExp",proto:!0,forced:!m},{test:function(e){if("function"!=typeof this.exec)return rd.call(this,e);e=this.exec(e);if(null===e||nd(e))return!!e;throw new Error("RegExp exec method returned something other than an Object or null")}}),i),id=be,od=J,l=Ie.f,c=ut,ad=n.Symbol,lr=(!N||"function"!=typeof ad||"description"in ad.prototype&&void 0===ad().description||(Yl={},c(Ql=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),t=this instanceof Ql?new ad(e):void 0===e?ad():ad(e);return""===e&&(Yl[t]=!0),t},ad),(a=Ql.prototype=ad.prototype).constructor=Ql,Xl=a.toString,Zl="Symbol(test)"==String(ad("test")),ed=/^Symbol\((.*)\)[^)]+$/,l(a,"description",{configurable:!0,get:function(){var e=od(this)?this.valueOf():this,t=Xl.call(e);return id(Yl,e)?"":""===(e=Zl?t.slice(7,-1):t.replace(ed,"$1"))?void 0:e}}),de({global:!0,forced:!0},{Symbol:Ql})),On("iterator"),{exports:{}});function sd(e){return td.exports=sd="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},td.exports.__esModule=!0,td.exports.default=td.exports,sd(e)}(td=lr).exports=sd,td.exports.__esModule=!0,td.exports.default=td.exports;var cd,ud,ld,dd,fd,pd,hd,md,yd,vd,p=Ie.f,s=Function.prototype,gd=s.toString,bd=/^\s*function ([^ (]*)/,Yn=(!N||"name"in s||p(s,"name",{configurable:!0,get:function(){try{return gd.call(this).match(bd)[1]}catch(e){return""}}}),{exports:{}}),h={exports:{}},m=((f=h).exports=function(e){if(Array.isArray(e))return e},f.exports.__esModule=!0,f.exports.default=f.exports,{exports:{}}),l=((c=m).exports=function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o=[],a=!0,s=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){s=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(s)throw i}}return o}},c.exports.__esModule=!0,c.exports.default=c.exports,{exports:{}}),a={exports:{}},s=((de=a).exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r},de.exports.__esModule=!0,de.exports.default=de.exports,cd=a.exports,(p=l).exports=function(e,t){var n;if(e)return"string"==typeof e?cd(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?cd(e,t):void 0},p.exports.__esModule=!0,p.exports.default=p.exports,{exports:{}}),de=((f=s).exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},f.exports.__esModule=!0,f.exports.default=f.exports,ud=h.exports,ld=m.exports,dd=l.exports,fd=s.exports,(c=Yn).exports=function(e,t){return ud(e)||ld(e,t)||dd(e,t)||fd()},c.exports.__esModule=!0,c.exports.default=c.exports,{exports:{}}),p={exports:{}},h=(pd=a.exports,(f=p).exports=function(e){if(Array.isArray(e))return pd(e)},f.exports.__esModule=!0,f.exports.default=f.exports,{exports:{}}),s=((m=h).exports=function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},m.exports.__esModule=!0,m.exports.default=m.exports,{exports:{}}),f=((c=s).exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},c.exports.__esModule=!0,c.exports.default=c.exports,hd=p.exports,md=h.exports,yd=l.exports,vd=s.exports,(a=de).exports=function(e){return hd(e)||md(e)||yd(e)||vd()},a.exports.__esModule=!0,a.exports.default=a.exports,{exports:{}});function _d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(m=f).exports=function(e,t,n){return t&&_d(e.prototype,t),n&&_d(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e},m.exports.__esModule=!0,m.exports.default=m.exports;var wd,kd,c={exports:{}},h=((p=c).exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},p.exports.__esModule=!0,p.exports.default=p.exports,{exports:{}}),l={exports:{}};function xd(e,t){return kd.exports=xd=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},kd.exports.__esModule=!0,kd.exports.default=kd.exports,xd(e,t)}(kd=l).exports=xd,kd.exports.__esModule=!0,kd.exports.default=kd.exports,wd=l.exports,(s=h).exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&wd(e,t)},s.exports.__esModule=!0,s.exports.default=s.exports;var Sd,Ed,Cd,a={exports:{}},m={exports:{}},p=((p=m).exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},p.exports.__esModule=!0,p.exports.default=p.exports,s=a,Sd=lr.exports.default,Ed=m.exports,s.exports=function(e,t){if(t&&("object"===Sd(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Ed(e)},s.exports.__esModule=!0,s.exports.default=s.exports,{exports:{}});function Td(e){return Cd.exports=Td=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Cd.exports.__esModule=!0,Cd.exports.default=Cd.exports,Td(e)}(Cd=p).exports=Td,Cd.exports.__esModule=!0,Cd.exports.default=Cd.exports;function Id(e){return!Od(e)&&isFinite(e)&&Ad(e)===e}function Rd(s){return function(e){for(var t,n=jd(e),r=Dd(n),i=r.length,o=0,a=[];o<i;)t=r[o++],Md&&!Ld.call(n,t)||a.push(s?[t,n[t]]:n[t]);return a}}var Pd=Rt.includes,s=Jc,Od=(i({target:"Array",proto:!0},{includes:function(e){return Pd(this,e,1<arguments.length?arguments[1]:void 0)}}),s("includes"),J),Ad=Math.floor,Md=(i({target:"Number",stat:!0},{isInteger:Id}),N),Dd=Cn,jd=H,Ld=U.f,Nd=[Rd(!0),Rd(!1)][0],s=(i({target:"Object",stat:!0},{entries:function(e){return Nd(e)}}),Object.defineProperty(d,"__esModule",{value:!0}),Yn.exports),Ud=de.exports,Fd=f.exports,Bd=c.exports,qd=h.exports,zd=a.exports,Wd=p.exports;function Gd(e){return e&&"object"===F(e)&&"default"in e?e:{default:e}}var Vd=Gd(lr.exports),Hd=Gd(s),Jd=Gd(Ud),$d=Gd(Fd),Kd=Gd(Bd),Yd=Gd(qd),Qd=Gd(zd),Xd=Gd(Wd),Zd=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{checks:t}};function ef(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function tf(){for(var e=arguments.length,a=new Array(e),t=0;t<e;t++)a[t]=arguments[t];return Zd(function(e){var t,n=!1,r=[],i=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?ef(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?ef(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(a);try{for(i.s();!(t=i.n()).done;){var o=t.value;"string"!=typeof o?(n=n||e instanceof o,r.push("an instance of ".concat(o.name))):(n=n||Vd.default(e)===o,r.push("of type ".concat(o)))}}catch(e){i.e(e)}finally{i.f()}return[n,r]})}function nf(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function rf(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?of(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?of(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function of(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function af(e,t){if(t.length>e.length)throw new Error("Expected at most ".concat(e.length," argument(s), but got ").concat(t.length));for(;t.length<e.length;)t.push(void 0);var n,r=rf(t.entries());try{for(r.s();!(n=r.n()).done;){var i=Hd.default(n.value,2),o=i[0],a=i[1],s=lf(e[o],a),c=Hd.default(s,4),u=c[0],l=c[1],d=c[2],f=c[3];if(!u)throw new Error("Argument ".concat(o+1," is expected to be ").concat(d).concat(f," but got ").concat(l))}}catch(e){r.e(e)}finally{r.f()}}function sf(e){var t,n;return["undefined","boolean","number","bigint","string"].includes(Vd.default(e))&&(t="string"==typeof e?'"'.concat(e,'"'):"".concat(e)),t=(t="object"===Vd.default(e)&&"Object"!==(null==e||null==(n=e.constructor)?void 0:n.name)?null===e?"null":"instance of ".concat(null==e||null==(n=e.constructor)?void 0:n.name):t)||Vd.default(e)}function cf(e){var t,n=[],r=rf(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;n.push(uf(i))}}catch(e){r.e(e)}finally{r.f()}return n}function uf(e){var t,n=[],r=rf(Array.isArray(e)?e:[e]);try{for(r.s();!(t=r.n()).done;){var i=t.value;n.push("string"!=typeof i&&"function"!=typeof i?i:tf(i))}}catch(e){r.e(e)}finally{r.f()}return n}function lf(e,t){var n,r,i,o=[],a=!1,s=rf(e);try{for(s.s();!(r=s.n()).done;){var c,u=rf(r.value.checks);try{for(u.s();!(c=u.n()).done;){var l=(0,c.value)(t),d=Hd.default(l,3),f=d[0],p=d[1],h=d[2],a=a||f;!n&&h&&(n=h),p&&(o=[].concat(Jd.default(o),"string"==typeof p?[p]:Jd.default(p)))}}catch(e){u.e(e)}finally{u.f()}}}catch(e){s.e(e)}finally{s.f()}return a?[!0]:[!1,n||sf(t),0<(i=o.length-1)?"".concat(o.slice(0,i).join(", ")," or ").concat(o[i]):o.join(", "),1<i?";":","]}function df(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}s=Zd(function(e){return["string"==typeof e&&0<e.length,"a non-empty string"]}),Ud=Zd(function(e){return["number"==typeof e&&Number.isInteger(e)&&0<=e,"a non-negative integer"]}),Fd=Zd(function(e){return["object"===Vd.default(e)&&null!==e&&!Array.isArray(e),"a pure object (non-null and non-array)"]});function ff(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}d.array=function(d,f){return Zd(function(e){if(!Array.isArray(e))return[!1,"an array of ".concat(d)];var t,n=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?ff(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?ff(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(e.entries());try{for(n.s();!(t=n.n()).done;){var r=Hd.default(t.value,2),i=r[0],o=r[1],a=lf(uf(f),o),s=Hd.default(a,3),c=s[0],u=s[1],l=s[2];if(!c)return[!1,"a valid array of ".concat(d," (index ").concat(i," should be ").concat(l,")"),"malformed array of ".concat(d," (index ").concat(i," is ").concat(u,")")]}}catch(e){n.e(e)}finally{n.f()}return[!0]})};var pf,hf,mf,Bd=d.custom=Zd,qd=d.literal=function(){for(var e=arguments.length,a=new Array(e),t=0;t<e;t++)a[t]=arguments[t];return Zd(function(e){var t,n=!1,r=[],i=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?nf(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?nf(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(a);try{for(i.s();!(t=i.n()).done;){var o=t.value,n=n||e===o;r.push("string"==typeof o?'"'.concat(o,'"'):"".concat(o))}}catch(e){i.e(e)}finally{i.f()}return[n,r]})},zd=d.nonEmptyArray=function(d,f){return Zd(function(e){if(!Array.isArray(e)||e.length<1)return[!1,"a non-empty array of ".concat(d)];var t,n=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?df(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?df(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(e.entries());try{for(n.s();!(t=n.n()).done;){var r=Hd.default(t.value,2),i=r[0],o=r[1],a=lf(uf(f),o),s=Hd.default(a,3),c=s[0],u=s[1],l=s[2];if(!c)return[!1,"a valid non-empty array of ".concat(d," (index ").concat(i," should be ").concat(l,")"),"malformed array of ".concat(d," (index ").concat(i," is ").concat(u,")")]}}catch(e){n.e(e)}finally{n.f()}return[!0]})},Wd=d.nonEmptyString=s,s=d.nonNegativeInteger=Ud,Ud=d.objectSchema=function(s,c){return Zd(function(e){if("object"!==Vd.default(e)||null===e||Array.isArray(e))return[!1,"valid ".concat(s," (should be a pure object)")];for(var t=0,n=Object.entries(c);t<n.length;t++){var r=Hd.default(n[t],2),i=r[0],r=r[1],r=lf(uf(r),e[i]),r=Hd.default(r,3),o=r[0],a=r[1],r=r[2];if(!o)return[!1,"valid ".concat(s,' (key "').concat(i,'" should be ').concat(r,")"),"malformed ".concat(s,' (key "').concat(i,'" is ').concat(a,")")]}return[!0]})},Fd=d.pureObject=Fd,yf=(d.runtimeTypeValidation=af,d.stringifyReceivedType=sf,d.type=tf,d.validateConstructorTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var a=cf(t);return function(e){Yd.default(o,e),n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=Xd.default(n);return e=r?(e=Xd.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),Qd.default(this,e)};function o(){Kd.default(this,o);for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return af(a,t),i.call.apply(i,[this].concat(t))}return $d.default(o)}}),vf=d.validateTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=cf(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypes decorator can only be applied to methods");var r=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return af(i,t),r.apply(this,t)}}},g=d.validateTypesAsync=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=cf(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypesAsync decorator can only be applied to methods");var r=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];try{af(i,t)}catch(e){return Promise.reject(e)}return r.apply(this,t)}}},gf=Bd(function(e){return[["string","number","boolean","object"].includes(F(e)),"a JSON type"]}),bf=Bd(function(e){return[["undefined","string","number","boolean","object"].includes(F(e)),"an optional JSON type"]}),_={},_f={exports:{}},wf={exports:{}};function kf(){return"undefined"!=typeof Reflect&&Reflect.get?pf.exports=kf=Reflect.get:pf.exports=kf=function(e,t,n){var r=hf(e,t);if(r)return(r=Object.getOwnPropertyDescriptor(r,t)).get?r.get.call(arguments.length<3?e:n):r.value},pf.exports.__esModule=!0,pf.exports.default=pf.exports,kf.apply(this,arguments)}mf=p.exports,(xf=wf).exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=mf(e)););return e},xf.exports.__esModule=!0,xf.exports.default=xf.exports,pf=_f,hf=wf.exports,pf.exports=kf,pf.exports.__esModule=!0,pf.exports.default=pf.exports;var xf={exports:{}},wf=((wf=xf).exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},wf.exports.__esModule=!0,wf.exports.default=wf.exports,Object.defineProperty(_,"__esModule",{value:!0}),c.exports),Sf=f.exports,Ef=m.exports,Cf=_f.exports,Tf=h.exports,If=a.exports,Rf=p.exports,w=xf.exports;function Pf(e){return e&&"object"===F(e)&&"default"in e?e:{default:e}}var Of=Pf(de.exports),Af=Pf(wf),Mf=Pf(Sf),Df=Pf(Ef),jf=Pf(Cf),Lf=Pf(Tf),Nf=Pf(If),Uf=Pf(Rf),Ff=Pf(w);function Bf(){}function qf(){qf.init.call(this)}function zf(e){return void 0===e._maxListeners?qf.defaultMaxListeners:e._maxListeners}function Wf(e,t,n,r){var i,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return(i=e._events)?(i.newListener&&(e.emit("newListener",t,n.listener||n),i=e._events),o=i[t]):(i=e._events=new Bf,e._eventsCount=0),o?("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(r=zf(e))&&0<r&&o.length>r&&(o.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",r.emitter=e,r.type=t,r.count=o.length,r=r,"function"==typeof console.warn?console.warn(r):console.log(r))):(o=i[t]=n,++e._eventsCount),e}function Gf(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function Vf(e){var t=this._events;if(t){t=t[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function Hf(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}Bf.prototype=Object.create(null),(qf.EventEmitter=qf).usingDomains=!1,qf.prototype.domain=void 0,qf.prototype._events=void 0,qf.prototype._maxListeners=void 0,qf.defaultMaxListeners=10,qf.init=function(){this.domain=null,qf.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new Bf,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},qf.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},qf.prototype.getMaxListeners=function(){return zf(this)},qf.prototype.emit=function(e){var t,n,r,i,o,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(s=this.domain,a){if(a=arguments[1],s)return(a=a||new Error('Uncaught, unspecified "error" event')).domainEmitter=this,a.domain=s,a.domainThrown=!1,s.emit("error",a),!1;if(a instanceof Error)throw a;var s=new Error('Uncaught, unspecified "error" event. ('+a+")");throw s.context=a,s}if(!(t=o[e]))return!1;var c="function"==typeof t;switch(n=arguments.length){case 1:var u=t,l=c,d=this;if(l)u.call(d);else for(var f=u.length,j=Hf(u,f),p=0;p<f;++p)j[p].call(d);break;case 2:var l=t,u=c,h=this,m=arguments[1];if(u)l.call(h,m);else for(var y=l.length,L=Hf(l,y),v=0;v<y;++v)L[v].call(h,m);break;case 3:var g=t,b=c,_=this,w=arguments[1],k=arguments[2];if(b)g.call(_,w,k);else for(var x=g.length,N=Hf(g,x),S=0;S<x;++S)N[S].call(_,w,k);break;case 4:var b=t,g=c,E=this,C=arguments[1],T=arguments[2],I=arguments[3];if(g)b.call(E,C,T,I);else for(var R=b.length,U=Hf(b,R),P=0;P<R;++P)U[P].call(E,C,T,I);break;default:for(r=new Array(n-1),i=1;i<n;i++)r[i-1]=arguments[i];var O=t,F=c,A=this,M=r;if(F)O.apply(A,M);else for(var B=O.length,q=Hf(O,B),D=0;D<B;++D)q[D].apply(A,M)}return!0},qf.prototype.on=qf.prototype.addListener=function(e,t){return Wf(this,e,t,!1)},qf.prototype.prependListener=function(e,t){return Wf(this,e,t,!0)},qf.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,Gf(this,e,t)),this},qf.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,Gf(this,e,t)),this},qf.prototype.removeListener=function(e,t){var n,r,i,o,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if((r=this._events)&&(n=r[e]))if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new Bf:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length;0<o--;)if(n[o]===t||n[o].listener&&n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new Bf,this;delete r[e]}else{var s=n;for(var c=i,u=c+1,l=s.length;u<l;c+=1,u+=1)s[c]=s[u];s.pop()}r.removeListener&&this.emit("removeListener",e,a||t)}return this},qf.prototype.off=function(e,t){return this.removeListener(e,t)},qf.prototype.removeAllListeners=function(e){var t,n;if(n=this._events)if(n.removeListener){if(0===arguments.length){for(var r,i=Object.keys(n),o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);this.removeAllListeners("removeListener"),this._events=new Bf,this._eventsCount=0}else if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(;this.removeListener(e,t[t.length-1]),t[0];);}else 0===arguments.length?(this._events=new Bf,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new Bf:delete n[e]);return this},qf.prototype.listeners=function(e){var t=this._events;{if(t&&(t=t[e])){if("function"==typeof t)return[t.listener||t];for(var n=t,r=new Array(n.length),i=0;i<r.length;++i)r[i]=n[i].listener||n[i];return r}return[]}},qf.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):Vf.call(e,t)},qf.prototype.listenerCount=Vf,qf.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};var Jf,$f,Kf,Yf,Qf,Xf,Zf,ep,tp,np,rp,ip,op,ap,sp,cp,up,lp,dp,fp,pp,hp,mp,yp,vp,gp,bp,_p,wp,kp,xp,Sp,Ep,Cp,Tp,Ip,Rp,Pp,Op,Ap,Mp,Dp,jp,Lp,Np,Up,Fp,Bp,qp,zp,wf=function(){Lf.default(o,qf);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,t=function(){var e,t=Uf.default(n);return e=r?(e=Uf.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),Nf.default(this,e)};function o(){var e;return Af.default(this,o),e=t.call(this),Ff.default(Df.default(e),"eventHistory",new Map),e}return Mf.default(o,[{key:"on",value:function(e,t){return jf.default(Uf.default(o.prototype),"on",this).call(this,e,t)}},{key:"once",value:function(e,t){return jf.default(Uf.default(o.prototype),"once",this).call(this,e,t)}},{key:"off",value:function(e,t){return jf.default(Uf.default(o.prototype),"off",this).call(this,e,t)}},{key:"emit",value:function(e){for(var t,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return this.eventHistory.set(e,r),(t=jf.default(Uf.default(o.prototype),"emit",this)).call.apply(t,[this,e].concat(r))}},{key:"addListener",value:function(e,t){return jf.default(Uf.default(o.prototype),"addListener",this).call(this,e,t)}},{key:"removeListener",value:function(e,t){return jf.default(Uf.default(o.prototype),"removeListener",this).call(this,e,t)}},{key:"addListenerWithReplay",value:function(e,t){var n=this.eventHistory.get(e);return void 0!==n&&t.apply(void 0,Of.default(n)),this.addListener(e,t)}},{key:"onWithReplay",value:function(e,t){return this.addListenerWithReplay(e,t)}},{key:"onceWithReplay",value:function(e,t){var n=this.eventHistory.get(e);return void 0!==n?(t.apply(void 0,Of.default(n)),this):jf.default(Uf.default(o.prototype),"once",this).call(this,e,t)}}]),o}(),Wp=_.ReplayEventEmitter=wf,Sf={exports:{}};function Gp(e){var n=-1,r=Array(e.size);return e.forEach(function(e,t){r[++n]=[t,e]}),r}function Vp(e){var t=-1,n=Array(e.size);return e.forEach(function(e){n[++t]=e}),n}function Hp(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Jp(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function $p(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Kp(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new $p;++t<n;)this.add(e[t])}function Yp(e){e=this.__data__=new Jp(e);this.size=e.size}function Qp(e,t){var n,r,i,o=Fp(e),a=!o&&Up(e),s=!o&&!a&&Bp(e),c=!o&&!a&&!s&&zp(e),u=o||a||s||c,l=u?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],d=l.length;for(n in e)!t&&!bp.call(e,n)||u&&("length"==n||s&&("offset"==n||"parent"==n)||c&&("buffer"==n||"byteLength"==n||"byteOffset"==n)||(r=n,i=d,(i=null==i?$f:i)&&("number"==typeof r||fp.test(r))&&-1<r&&r%1==0&&r<i))||l.push(n);return l}function Xp(e,t){for(var n=e.length;n--;)if(ch(e[n][0],t))return n;return-1}function Zp(e){{if(null==e)return void 0===e?"[object Undefined]":"[object Null]";if(Cp&&Cp in Object(e)){var t=e,n=bp.call(t,Cp),r=t[Cp];try{var i=!(t[Cp]=void 0)}catch(t){}var o=wp.call(t);return i&&(n?t[Cp]=r:delete t[Cp]),o}return wp.call(e)}}function eh(e){return fh(e)&&Zp(e)==Kf}function th(e,t,n,r,i){return e===t||(null==e||null==t||!fh(e)&&!fh(t)?e!=e&&t!=t:function(e,t,n,r,i,o){var a=Fp(e),s=Fp(t),c=a?Yf:Np(e),s=s?Yf:Np(t),u=(c=c==Kf?rp:c)==rp,l=(s=s==Kf?rp:s)==rp,s=c==s;if(s&&Bp(e)){if(!Bp(t))return!1;u=!(a=!0)}if(s&&!u)return o=o||new Yp,(a||zp(e)?rh:function(e,t,n,r,i,o){switch(c){case lp:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case up:return!(e.byteLength!=t.byteLength||!i(new xp(e),new xp(t)));case Qf:case Xf:case np:return ch(+e,+t);case Zf:return e.name==t.name&&e.message==t.message;case op:case sp:return e==t+"";case tp:var a=Gp;case ap:a=a||Vp;if(e.size!=t.size&&!(1&n))return!1;var s=o.get(e);if(s)return s==t;n|=2,o.set(e,t);s=rh(a(e),a(t),n,r,i,o);return o.delete(e),s;case"[object Symbol]":if(jp)return jp.call(e)==jp.call(t)}return!1})(e,t,n,r,i,o);if(!(1&n)){a=u&&bp.call(e,"__wrapped__"),u=l&&bp.call(t,"__wrapped__");if(a||u)return i(a?e.value():e,u?t.value():t,n,r,o=o||new Yp)}if(s){o=o||new Yp;var d=e,f=t,p=n,h=r,m=i,y=o,v=1&p,g=ih(d),b=g.length;if(b!=ih(f).length&&!v)return!1;for(var _=b;_--;){var w=g[_];if(!(v?w in f:bp.call(f,w)))return!1}l=y.get(d);if(l&&y.get(f))return l==f;for(var k=!0,x=(y.set(d,f),y.set(f,d),v);++_<b;){var S,E=d[w=g[_]],C=f[w];if(!(void 0===(S=h?v?h(C,E,w,f,d,y):h(E,C,w,d,f,y):S)?E===C||m(E,C,p,h,y):S)){k=!1;break}x=x||"constructor"==w}return k&&!x&&(l=d.constructor)!=(a=f.constructor)&&"constructor"in d&&"constructor"in f&&!("function"==typeof l&&l instanceof l&&"function"==typeof a&&a instanceof a)&&(k=!1),y.delete(d),y.delete(f),k}return!1}(e,t,n,r,th,i))}function nh(e){if(t=e&&e.constructor,e!==("function"==typeof t&&t.prototype||vp))return mp(yp(e));var t,n,r=[];for(n in Object(e))bp.call(e,n)&&"constructor"!=n&&r.push(n);return r}function rh(e,t,n,r,i,o){var a=1&n,s=e.length,c=t.length;if(s!=c&&!(a&&s<c))return!1;c=o.get(e);if(c&&o.get(t))return c==t;var u=-1,l=!0,d=2&n?new Kp:void 0;for(o.set(e,t),o.set(t,e);++u<s;){var f,p=e[u],h=t[u];if(void 0!==(f=r?a?r(h,p,u,t,e,o):r(p,h,u,e,t,o):f)){if(f)continue;l=!1;break}if(d){if(!function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return 1}(t,function(e,t){return!d.has(t)&&(p===e||i(p,e,n,r,o))&&d.push(t)})){l=!1;break}}else if(p!==h&&!i(p,h,n,r,o)){l=!1;break}}return o.delete(e),o.delete(t),l}function ih(e){var t=Lp,n=ph(e);if(Fp(e))return n;for(var r=n,i=t(e),o=-1,a=i.length,s=r.length;++o<a;)r[s+o]=i[o];return r}function oh(e,t){var n,r,e=e.__data__;return("string"==(r=F(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?e["string"==typeof t?"string":"hash"]:e.map}function ah(e,t){e=null==e?void 0:e[t];return!dh(t=e)||_p&&_p in t||!(uh(t)?kp:dp).test(sh(t))?void 0:e}function sh(e){if(null!=e){try{return gp.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function ch(e,t){return e===t||e!=e&&t!=t}function uh(e){if(dh(e))return(e=Zp(e))==ep||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e}function lh(e){return"number"==typeof e&&-1<e&&e%1==0&&e<=$f}function dh(e){var t=F(e);return null!=e&&("object"==t||"function"==t)}function fh(e){return null!=e&&"object"==F(e)}function ph(e){return(null!=e&&lh(e.length)&&!uh(e)?Qp:nh)(e)}Cf=(Ef=Sf).exports,Jf="__lodash_hash_undefined__",$f=9007199254740991,Kf="[object Arguments]",Yf="[object Array]",Qf="[object Boolean]",Xf="[object Date]",Zf="[object Error]",ep="[object Function]",tp="[object Map]",np="[object Number]",rp="[object Object]",ip="[object Promise]",op="[object RegExp]",ap="[object Set]",sp="[object String]",cp="[object WeakMap]",up="[object ArrayBuffer]",lp="[object DataView]",dp=/^\[object .+?Constructor\]$/,fp=/^(?:0|[1-9]\d*)$/,(pp={})["[object Float32Array]"]=pp["[object Float64Array]"]=pp["[object Int8Array]"]=pp["[object Int16Array]"]=pp["[object Int32Array]"]=pp["[object Uint8Array]"]=pp["[object Uint8ClampedArray]"]=pp["[object Uint16Array]"]=pp["[object Uint32Array]"]=!0,pp[Kf]=pp[Yf]=pp[up]=pp[Qf]=pp[lp]=pp[Xf]=pp[Zf]=pp[ep]=pp[tp]=pp[np]=pp[rp]=pp[op]=pp[ap]=pp[sp]=pp[cp]=!1,Tf="object"==F(B)&&B&&B.Object===Object&&B,If="object"==("undefined"==typeof self?"undefined":F(self))&&self&&self.Object===Object&&self,If=Tf||If||Function("return this")(),Cf=Cf&&!Cf.nodeType&&Cf,Rf=(Rf=Cf&&Ef&&!Ef.nodeType&&Ef)&&Rf.exports===Cf,hp=Rf&&Tf.process,Cf=function(){try{return hp&&hp.binding&&hp.binding("util")}catch(e){}}(),Tf=Cf&&Cf.isTypedArray,Cf=Array.prototype,w=Function.prototype,vp=Object.prototype,_=If["__core-js_shared__"],gp=w.toString,bp=vp.hasOwnProperty,_p=(w=/[^.]+$/.exec(_&&_.keys&&_.keys.IE_PROTO||""))?"Symbol(src)_1."+w:"",wp=vp.toString,kp=RegExp("^"+gp.call(bp).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),_=Rf?If.Buffer:void 0,w=If.Symbol,xp=If.Uint8Array,Sp=vp.propertyIsEnumerable,Ep=Cf.splice,Cp=w?w.toStringTag:void 0,Tp=Object.getOwnPropertySymbols,Rf=_?_.isBuffer:void 0,mp=Object.keys,yp=Object,Cf=ah(If,"DataView"),Ip=ah(If,"Map"),_=ah(If,"Promise"),wf=ah(If,"Set"),If=ah(If,"WeakMap"),Rp=ah(Object,"create"),Pp=sh(Cf),Op=sh(Ip),Ap=sh(_),Mp=sh(wf),Dp=sh(If),w=w?w.prototype:void 0,jp=w?w.valueOf:void 0,Hp.prototype.clear=function(){this.__data__=Rp?Rp(null):{},this.size=0},Hp.prototype.delete=function(e){e=this.has(e)&&delete this.__data__[e];return this.size-=e?1:0,e},Hp.prototype.get=function(e){var t,n=this.__data__;return Rp?(t=n[e])===Jf?void 0:t:bp.call(n,e)?n[e]:void 0},Hp.prototype.has=function(e){var t=this.__data__;return Rp?void 0!==t[e]:bp.call(t,e)},Hp.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=Rp&&void 0===t?Jf:t,this},Jp.prototype.clear=function(){this.__data__=[],this.size=0},Jp.prototype.delete=function(e){var t=this.__data__,e=Xp(t,e);return!(e<0||(e==t.length-1?t.pop():Ep.call(t,e,1),--this.size,0))},Jp.prototype.get=function(e){var t=this.__data__,e=Xp(t,e);return e<0?void 0:t[e][1]},Jp.prototype.has=function(e){return-1<Xp(this.__data__,e)},Jp.prototype.set=function(e,t){var n=this.__data__,r=Xp(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this},$p.prototype.clear=function(){this.size=0,this.__data__={hash:new Hp,map:new(Ip||Jp),string:new Hp}},$p.prototype.delete=function(e){e=oh(this,e).delete(e);return this.size-=e?1:0,e},$p.prototype.get=function(e){return oh(this,e).get(e)},$p.prototype.has=function(e){return oh(this,e).has(e)},$p.prototype.set=function(e,t){var n=oh(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this},Kp.prototype.add=Kp.prototype.push=function(e){return this.__data__.set(e,Jf),this},Kp.prototype.has=function(e){return this.__data__.has(e)},Yp.prototype.clear=function(){this.__data__=new Jp,this.size=0},Yp.prototype.delete=function(e){var t=this.__data__,e=t.delete(e);return this.size=t.size,e},Yp.prototype.get=function(e){return this.__data__.get(e)},Yp.prototype.has=function(e){return this.__data__.has(e)},Yp.prototype.set=function(e,t){var n=this.__data__;if(n instanceof Jp){var r=n.__data__;if(!Ip||r.length<199)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new $p(r)}return n.set(e,t),this.size=n.size,this},Lp=Tp?function(e){if(null==e)return[];e=Object(e);for(var t=Tp(e),n=-1,r=null==t?0:t.length,i=0,o=[];++n<r;){var a=t[n];Sp.call(e,a)&&(o[i++]=a)}return o}:function(){return[]},Np=Zp,(Cf&&Np(new Cf(new ArrayBuffer(1)))!=lp||Ip&&Np(new Ip)!=tp||_&&Np(_.resolve())!=ip||wf&&Np(new wf)!=ap||If&&Np(new If)!=cp)&&(Np=function(e){var t=Zp(e),e=t==rp?e.constructor:void 0,e=e?sh(e):"";if(e)switch(e){case Pp:return lp;case Op:return tp;case Ap:return ip;case Mp:return ap;case Dp:return cp}return t}),Up=eh(function(){return arguments}())?eh:function(e){return fh(e)&&bp.call(e,"callee")&&!Sp.call(e,"callee")},Fp=Array.isArray,Bp=Rf||function(){return!1},zp=Tf?(qp=Tf,function(e){return qp(e)}):function(e){return fh(e)&&lh(e.length)&&!!pp[Zp(e)]},Ef.exports=function(e,t){return th(e,t)};var hh=Sf.exports;var mh=oi.scope("User"),yh=function(){Ji(l,Wp);s=l,c=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var e,t,n,r,i,o,a,s,c,u=function(){var e,t=Ki(s);return $i(this,c?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function l(e,t,n,r){var i;return D(this,l),b(Vi(i=u.call(this)),"promiseToFetch",null),b(Vi(i),"updated","updated"),b(Vi(i),"userSubscribed","userSubscribed"),b(Vi(i),"userUnsubscribed","userUnsubscribed"),i.services=r,i.subscribed="initializing",i.setMaxListeners(0),i.state={identity:e,entityName:t,friendlyName:null,attributes:{},online:null,notifiable:null},i._initializationPromise=new Promise(function(e){i._resolveInitializationPromise=e}),null!==n&&i._resolveInitialization(n,e,t,!1),i}return M(l,[{key:"identity",get:function(){return this.state.identity},set:function(e){this.state.identity=e}},{key:"entityName",set:function(e){this.state.entityName=e}},{key:"attributes",get:function(){return this.state.attributes}},{key:"friendlyName",get:function(){return this.state.friendlyName}},{key:"isOnline",get:function(){return this.state.online}},{key:"isNotifiable",get:function(){return this.state.notifiable}},{key:"isSubscribed",get:function(){return"subscribed"==this.subscribed}},{key:"_update",value:(a=A(j.mark(function e(t,n){var r,i;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:r=[],mh.debug("User for",this.state.identity,"updated:",t,n),e.t0=t,e.next="friendlyName"===e.t0?7:"attributes"===e.t0?9:"reachability"===e.t0?12:15;break;case 7:return this.state.friendlyName!==n.value&&(r.push("friendlyName"),this.state.friendlyName=n.value),e.abrupt("break",16);case 9:return i=Nl(n.value,"Retrieved malformed attributes from the server for user: ".concat(this.state.identity),mh),hh(this.state.attributes,i)||(this.state.attributes=i,r.push("attributes")),e.abrupt("break",16);case 12:return this.state.online!==n.online&&(this.state.online=n.online,r.push("reachabilityOnline")),this.state.notifiable!==n.notifiable&&(this.state.notifiable=n.notifiable,r.push("reachabilityNotifiable")),e.abrupt("break",16);case 15:return e.abrupt("return");case 16:0<r.length&&this.emit("updated",{user:this,updateReasons:r});case 17:case"end":return e.stop()}},e,this)})),function(e,t){return a.apply(this,arguments)})},{key:"_updateReachabilityInfo",value:(o=A(j.mark(function e(t,n){var r=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(this.configuration.reachabilityEnabled){e.next=4;break}return e.abrupt("return",Promise.resolve());case 4:return e.abrupt("return",t.get("reachability").then(n).catch(function(e){mh.warn("Failed to get reachability info for ",r.state.identity,e)}));case 5:case"end":return e.stop()}},e,this)})),function(e,t){return o.apply(this,arguments)})},{key:"_fetch",value:(i=A(j.mark(function e(){var t=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(this.state.entityName){e.next=4;break}return e.abrupt("return",this);case 4:return this.promiseToFetch=this.services.syncClient.map({id:this.state.entityName,mode:"open_existing",includeItems:!0}).then(function(e){return(t.entity=e).on("itemUpdated",function(e){return mh.debug(t.state.entityName+" ("+t.state.identity+") itemUpdated: "+e.item.key),t._update(e.item.key,e.item.data)}),Promise.all([e.get("friendlyName").then(function(e){return t._update(e.key,e.data)}),e.get("attributes").then(function(e){return t._update(e.key,e.data)}),t._updateReachabilityInfo(e,function(e){return t._update(e.key,e.data)})])}).then(function(){return mh.debug("Fetched for",t.identity),t.subscribed="subscribed",t.emit("userSubscribed",t),t}).catch(function(e){throw t.promiseToFetch=null,e}),e.abrupt("return",this.promiseToFetch);case 6:case"end":return e.stop()}},e,this)})),function(){return i.apply(this,arguments)})},{key:"_ensureFetched",value:(r=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:return e.abrupt("return",this.promiseToFetch||this._fetch());case 3:case"end":return e.stop()}},e,this)})),function(){return r.apply(this,arguments)})},{key:"updateAttributes",value:(n=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if("unsubscribed"==this.subscribed)throw new Error("Can't modify unsubscribed object");e.next=4;break;case 4:return e.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(t)});case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"updateFriendlyName",value:(t=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if("unsubscribed"==this.subscribed)throw new Error("Can't modify unsubscribed object");e.next=4;break;case 4:return e.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{friendly_name:t});case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"unsubscribe",value:(e=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(this.promiseToFetch)return e.next=5,this.promiseToFetch;e.next=9;break;case 5:this.entity.close(),this.promiseToFetch=null,this.subscribed="unsubscribed",this.emit("userUnsubscribed",this);case 9:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"_resolveInitialization",value:function(e,t,n,r){this.configuration=e,this.identity=t,this.entityName=n,this.links={self:"".concat(this.configuration.links.users,"/").concat(encodeURIComponent(this.identity))},this._resolveInitializationPromise(),r&&this.emit("updated",{user:this,updateReasons:["friendlyName","attributes","reachabilityOnline","reachabilityNotifiable"]})}}]),l}();function vh(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function gh(e,t){var n;if(e)return"string"==typeof e?vh(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?vh(e,t):void 0}function bh(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o=[],a=!0,s=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){s=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(s)throw i}}return o}}(e,t)||gh(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}y([g(gf),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",Promise)],yh.prototype,"updateAttributes",null),y([g(["string"]),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],yh.prototype,"updateFriendlyName",null);function _h(e){Eh(e,Ph,{value:{objectID:"O"+Oh++,weakData:{}}})}function wh(n,e,t){function r(e){var n=p[e];Nh(p,e,"add"==e?function(e){return n.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(l&&!qh(e))&&n.call(this,0===e?0:e)}:"get"==e?function(e){return l&&!qh(e)?void 0:n.call(this,0===e?0:e)}:"has"==e?function(e){return!(l&&!qh(e))&&n.call(this,0===e?0:e)}:function(e,t){return n.call(this,0===e?0:e,t),this})}var i,o,a,s,c,u=-1!==n.indexOf("Map"),l=-1!==n.indexOf("Weak"),d=u?"set":"add",f=jh[n],p=f&&f.prototype,h=f,m={};Lh(n,"function"!=typeof f||!(l||p.forEach&&!zh(function(){(new f).entries().next()})))?(h=t.getConstructor(e,n,u,d),Uh.enable()):Lh(n,!0)&&(o=(i=new h)[d](l?{}:-0,1)!=i,a=zh(function(){i.has(1)}),s=Wh(function(e){new f(e)}),c=!l&&zh(function(){for(var e=new f,t=5;t--;)e[d](t,t);return!e.has(-0)}),s||(((h=e(function(e,t){Bh(e,h,n);e=Vh(new f,e,h);return null!=t&&Fh(t,e[d],{that:e,AS_ENTRIES:u}),e})).prototype=p).constructor=h),(a||c)&&(r("delete"),r("has"),u)&&r("get"),(c||o)&&r(d),l)&&p.clear&&delete p.clear,Dh({global:!0,forced:(m[n]=h)!=f},m),Gh(h,n),l||t.setStrong(h,n,u)}var w={exports:{}},Cf=!t(function(){return Object.isExtensible(Object.preventExtensions({}))}),kh=i,_=o,xh=J,Sh=be,Eh=Ie.f,Ch=ge,Th=ur,Ih=Cf,Rh=!1,Ph=Q("meta"),Oh=0,Ah=Object.isExtensible||function(){return!0},Mh=w.exports={enable:function(){Mh.enable=function(){},Rh=!0;var i=Ch.f,o=[].splice,e={};e[Ph]=1,i(e).length&&(Ch.f=function(e){for(var t=i(e),n=0,r=t.length;n<r;n++)if(t[n]===Ph){o.call(t,n,1);break}return t},kh({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:Th.f}))},fastKey:function(e,t){if(!xh(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!Sh(e,Ph)){if(!Ah(e))return"F";if(!t)return"E";_h(e)}return e[Ph].objectID},getWeakData:function(e,t){if(!Sh(e,Ph)){if(!Ah(e))return!0;if(!t)return!1;_h(e)}return e[Ph].weakData},onFreeze:function(e){return Ih&&Rh&&Ah(e)&&!Sh(e,Ph)&&_h(e),e}},Dh=(_[Ph]=!0,i),jh=n,Lh=hn,Nh=pe.exports,Uh=w.exports,Fh=oo,Bh=Zi,qh=J,zh=t,Wh=Uo,Gh=dt,Vh=pu,Hh=Ie.f,Jh=Tt,$h=Qi,Kh=An,Yh=Zi,Qh=oo,Xh=hc,Zh=Xi,em=N,tm=w.exports.fastKey,nm=_t.set,rm=_t.getterFor,wf={getConstructor:function(e,n,r,i){function o(e,t,n){var r,i=c(e),o=a(e,t);return o?o.value=n:(i.last=o={index:r=tm(t,!0),key:t,value:n,previous:t=i.last,next:void 0,removed:!1},i.first||(i.first=o),t&&(t.next=o),em?i.size++:e.size++,"F"!==r&&(i.index[r]=o)),e}function a(e,t){var n,e=c(e),r=tm(t);if("F"!==r)return e.index[r];for(n=e.first;n;n=n.next)if(n.key==t)return n}var s=e(function(e,t){Yh(e,s,n),nm(e,{type:n,index:Jh(null),first:void 0,last:void 0,size:0}),em||(e.size=0),null!=t&&Qh(t,e[i],{that:e,AS_ENTRIES:r})}),c=rm(n);return $h(s.prototype,{clear:function(){for(var e=c(this),t=e.index,n=e.first;n;)n.removed=!0,n.previous&&(n.previous=n.previous.next=void 0),delete t[n.index],n=n.next;e.first=e.last=void 0,em?e.size=0:this.size=0},delete:function(e){var t,n,r=c(this),e=a(this,e);return e&&(t=e.next,n=e.previous,delete r.index[e.index],e.removed=!0,n&&(n.next=t),t&&(t.previous=n),r.first==e&&(r.first=t),r.last==e&&(r.last=n),em?r.size--:this.size--),!!e},forEach:function(e){for(var t,n=c(this),r=Kh(e,1<arguments.length?arguments[1]:void 0,3);t=t?t.next:n.first;)for(r(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!a(this,e)}}),$h(s.prototype,r?{get:function(e){e=a(this,e);return e&&e.value},set:function(e,t){return o(this,0===e?0:e,t)}}:{add:function(e){return o(this,e=0===e?0:e,e)}}),em&&Hh(s.prototype,"size",{get:function(){return c(this).size}}),s},setStrong:function(e,t,n){var r=t+" Iterator",i=rm(t),o=rm(r);Xh(e,t,function(e,t){nm(this,{type:r,target:e,state:i(e),kind:t,last:void 0})},function(){for(var e=o(this),t=e.kind,n=e.last;n&&n.removed;)n=n.previous;return e.target&&(e.last=n=n?n.next:e.state.first)?"keys"==t?{value:n.key,done:!1}:"values"==t?{value:n.value,done:!1}:{value:[n.key,n.value],done:!1}:{value:e.target=void 0,done:!0}},n?"entries":"values",!n,!0),Zh(t)}},If=(wh("Map",function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}},wf),{}),Rf=(Object.defineProperty(If,"__esModule",{value:!0}),f.exports),Tf=m.exports,Ef=h.exports,Sf=a.exports,o=p.exports,ur=xf.exports;function im(e){return e&&"object"===F(e)&&"default"in e?e:{default:e}}var om=im(c.exports),am=im(Rf),sm=im(Tf),cm=im(Ef),um=im(Sf),lm=im(o),dm=im(ur);function fm(){}function pm(){pm.init.call(this)}function hm(e){return void 0===e._maxListeners?pm.defaultMaxListeners:e._maxListeners}function mm(e,t,n,r){var i,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return(i=e._events)?(i.newListener&&(e.emit("newListener",t,n.listener||n),i=e._events),o=i[t]):(i=e._events=new fm,e._eventsCount=0),o?("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(r=hm(e))&&0<r&&o.length>r&&(o.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",r.emitter=e,r.type=t,r.count=o.length,r=r,"function"==typeof console.warn?console.warn(r):console.log(r))):(o=i[t]=n,++e._eventsCount),e}function ym(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function vm(e){var t=this._events;if(t){t=t[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function gm(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}function bm(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=lm.default(n);return e=r?(e=lm.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),um.default(this,e)}}fm.prototype=Object.create(null),(pm.EventEmitter=pm).usingDomains=!1,pm.prototype.domain=void 0,pm.prototype._events=void 0,pm.prototype._maxListeners=void 0,pm.defaultMaxListeners=10,pm.init=function(){this.domain=null,pm.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new fm,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},pm.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},pm.prototype.getMaxListeners=function(){return hm(this)},pm.prototype.emit=function(e){var t,n,r,i,o,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(s=this.domain,a){if(a=arguments[1],s)return(a=a||new Error('Uncaught, unspecified "error" event')).domainEmitter=this,a.domain=s,a.domainThrown=!1,s.emit("error",a),!1;if(a instanceof Error)throw a;var s=new Error('Uncaught, unspecified "error" event. ('+a+")");throw s.context=a,s}if(!(t=o[e]))return!1;var c="function"==typeof t;switch(n=arguments.length){case 1:var u=t,l=c,d=this;if(l)u.call(d);else for(var f=u.length,j=gm(u,f),p=0;p<f;++p)j[p].call(d);break;case 2:var l=t,u=c,h=this,m=arguments[1];if(u)l.call(h,m);else for(var y=l.length,L=gm(l,y),v=0;v<y;++v)L[v].call(h,m);break;case 3:var g=t,b=c,_=this,w=arguments[1],k=arguments[2];if(b)g.call(_,w,k);else for(var x=g.length,N=gm(g,x),S=0;S<x;++S)N[S].call(_,w,k);break;case 4:var b=t,g=c,E=this,C=arguments[1],T=arguments[2],I=arguments[3];if(g)b.call(E,C,T,I);else for(var R=b.length,U=gm(b,R),P=0;P<R;++P)U[P].call(E,C,T,I);break;default:for(r=new Array(n-1),i=1;i<n;i++)r[i-1]=arguments[i];var O=t,F=c,A=this,M=r;if(F)O.apply(A,M);else for(var B=O.length,q=gm(O,B),D=0;D<B;++D)q[D].apply(A,M)}return!0},pm.prototype.on=pm.prototype.addListener=function(e,t){return mm(this,e,t,!1)},pm.prototype.prependListener=function(e,t){return mm(this,e,t,!0)},pm.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,ym(this,e,t)),this},pm.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,ym(this,e,t)),this},pm.prototype.removeListener=function(e,t){var n,r,i,o,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if((r=this._events)&&(n=r[e]))if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new fm:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length;0<o--;)if(n[o]===t||n[o].listener&&n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new fm,this;delete r[e]}else{var s=n;for(var c=i,u=c+1,l=s.length;u<l;c+=1,u+=1)s[c]=s[u];s.pop()}r.removeListener&&this.emit("removeListener",e,a||t)}return this},pm.prototype.off=function(e,t){return this.removeListener(e,t)},pm.prototype.removeAllListeners=function(e){var t,n;if(n=this._events)if(n.removeListener){if(0===arguments.length){for(var r,i=Object.keys(n),o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);this.removeAllListeners("removeListener"),this._events=new fm,this._eventsCount=0}else if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(;this.removeListener(e,t[t.length-1]),t[0];);}else 0===arguments.length?(this._events=new fm,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new fm:delete n[e]);return this},pm.prototype.listeners=function(e){var t=this._events;{if(t&&(t=t[e])){if("function"==typeof t)return[t.listener||t];for(var n=t,r=new Array(n.length),i=0;i<r.length;++i)r[i]=n[i].listener||n[i];return r}return[]}},pm.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):vm.call(e,t)},pm.prototype.listenerCount=vm,pm.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};cm.default(Sm,pm),wm=bm(Sm),am.default(Sm,[{key:"attempt",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.attemptNum++,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;e=this.currDelay+this.prevDelay;return this.maxDelay&&e>this.maxDelay&&(this.currDelay=this.maxDelay,e=this.maxDelay),this.currDelay=e}},{key:"randomize",value:function(e){var t=e*this.randomness,t=Math.round(Math.random()*t*2-t);return Math.max(0,e+t)}},{key:"scheduleAttempt",value:function(e){var t=this;this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount?(this.cleanup(),this.emit("failed",new Error("Maximum attempt count limit reached"))):(e=this.nextDelay(e),e=this.randomize(e),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+e?(this.cleanup(),this.emit("failed",new Error("Maximum attempt time limit reached"))):this.timeout=setTimeout(function(){return t.attempt()},e))}},{key:"cleanup",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){if(this.inProgress)throw new Error("Retrier is already in progress");this.inProgress=!0,this.startTimestamp=Date.now(),this.scheduleAttempt(this.initialDelay)}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"))}},{key:"succeeded",value:function(e){this.emit("succeeded",e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}}]);var _m,wm,km=Sm,Cf=(cm.default(xm,pm),_m=bm(xm),am.default(xm,[{key:"run",value:function(e){var n=this;return this.retrier.on("attempt",function(){e().then(function(e){return n.retrier.succeeded(e)}).catch(function(e){return n.retrier.failed(e)})}),this.retrier.on("succeeded",function(e){return n.resolve(e)}),this.retrier.on("cancelled",function(){return n.reject(new Error("Cancelled"))}),this.retrier.on("failed",function(e){return n.reject(e)}),new Promise(function(e,t){n.resolve=e,n.reject=t,n.retrier.start()})}},{key:"cancel",value:function(){this.retrier.cancel()}}]),xm);function xm(e){var t;return om.default(this,xm),t=_m.call(this),dm.default(sm.default(t),"resolve",function(){}),dm.default(sm.default(t),"reject",function(){}),t.retrier=new km(e),t}function Sm(e){var t;return om.default(this,Sm),t=wm.call(this),dm.default(sm.default(t),"timeout",null),dm.default(sm.default(t),"startTimestamp",-1),t.minDelay=e.min,t.maxDelay=e.max,t.initialDelay=e.initial||0,t.maxAttemptsCount=e.maxAttemptsCount||0,t.maxAttemptsTime=e.maxAttemptsTime||0,t.randomness=e.randomness||0,t.inProgress=!1,t.attemptNum=0,t.prevDelay=0,t.currDelay=0,t}function Em(e){return null!=e}var _=function(){cm.default(a,pm);n=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,o=function(){var e,t=lm.default(n);return e=r?(e=lm.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),um.default(this,e)};function a(e){om.default(this,a),t=o.call(this),dm.default(sm.default(t),"backoffDelay",0),dm.default(sm.default(t),"nextBackoffDelay",0),dm.default(sm.default(t),"backoffNumber",0),dm.default(sm.default(t),"timeoutID",null),dm.default(sm.default(t),"maxNumberOfRetry",-1);var t,e=e=e||{},n=e.initialDelay,r=e.maxDelay,i=e.randomisationFactor,e=e.factor;if(Em(n)&&n<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(Em(r)&&r<=1)throw new Error("The maximal timeout must be greater than 1.");if(Em(i)&&(i<0||1<i))throw new Error("The randomisation factor must be between 0 and 1.");if(Em(e)&&e<=1)throw new Error("Exponential factor should be greater than 1.");if(t.initialDelay=n||100,t.maxDelay=r||1e4,t.maxDelay<=t.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return t.randomisationFactor=i||0,t.factor=e||2,t.reset(),t}return am.default(a,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,this.timeoutID&&clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got ".concat(e));this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new a(e)}}]),a}(),Cm=If.AsyncRetrier=Cf,Tm=(If.Backoff=_,If.Retrier=km);function Im(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}M(Am,[{key:"isExpired",value:function(e){return!this.cacheLifetime||Date.now()-e>this.cacheLifetime}},{key:"cleanupCache",value:function(){var e,t=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?Im(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Im(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.cache);try{for(t.s();!(e=t.n()).done;){var n=bh(e.value,2),r=n[0],i=n[1];this.isExpired(i.timestamp)&&this.cache.delete(r)}}catch(e){t.e(e)}finally{t.f()}0===this.cache.size&&clearInterval(this.timer)}},{key:"pokeTimer",value:function(){var e=this;this.timer=this.timer||setInterval(function(){return e.cleanupCache()},2*this.cacheLifetime)}},{key:"executeWithRetry",value:function(e){var o=this,a=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return new Promise(function(t,n){var r=[502,503,504],i=(a&&r.push(429),new Tm(o.configuration.backoffConfiguration));i.on("attempt",function(){e().then(function(e){return i.succeeded(e)}).catch(function(e){-1<r.indexOf(e.status)||"Twilsock disconnected"===e.message?i.failed(e):(i.removeAllListeners(),i.cancel(),n(e))})}),i.on("succeeded",function(e){t(e)}),i.on("cancelled",function(e){return n(e)}),i.on("failed",function(e){return n(e)}),i.start()})}},{key:"get",value:(Rm=A(j.mark(function e(t){var n,r,i=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((r=this.cache.get(t))&&!this.isExpired(r.timestamp))return e.abrupt("return",r.response);e.next=3;break;case 3:return n={},e.next=6,this.executeWithRetry(function(){return i.services.transport.get(t,n,i.configuration.productId)},this.configuration.retryWhenThrottled);case 6:return r=e.sent,this.cache.set(t,{response:r,timestamp:Date.now()}),this.pokeTimer(),e.abrupt("return",r);case 10:case"end":return e.stop()}},e,this)})),function(e){return Rm.apply(this,arguments)})}]);var Rm,Pm=Am,Om=M(function e(){D(this,e)});function Am(e,t){D(this,Am),this.configuration=e,this.services=t,this.cache=new Map,this.cacheLifetime=100*this.configuration.httpCacheInterval,this.cleanupCache()}b(Om,"TYPING_INDICATOR","twilio.ipmsg.typing_indicator"),b(Om,"NEW_MESSAGE","twilio.conversations.new_message"),b(Om,"ADDED_TO_CONVERSATION","twilio.conversations.added_to_conversation"),b(Om,"REMOVED_FROM_CONVERSATION","twilio.conversations.removed_from_conversation"),b(Om,"CONSUMPTION_UPDATE","twilio.channel.consumption_update");var Mm={},hn={exports:{}};function Dm(e,t,n,r,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return n(e)}s.done?t(c):Promise.resolve(c).then(r,i)}(w=hn).exports=function(s){return function(){var e=this,a=arguments;return new Promise(function(t,n){var r=s.apply(e,a);function i(e){Dm(r,t,n,i,o,"next",e)}function o(e){Dm(r,t,n,i,o,"throw",e)}i(void 0)})}},w.exports.__esModule=!0,w.exports.default=w.exports;var jm,Lm,Nm,Um,Rf=(jm=mi).__esModule?jm:(Lm=Object.defineProperty({},"__esModule",{value:!0}),Object.keys(jm).forEach(function(e){var t=Object.getOwnPropertyDescriptor(jm,e);Object.defineProperty(Lm,e,t.get?t:{enumerable:!0,get:function(){return jm[e]}})}),Lm),Tf=pe.exports,Fm=ne,Bm=Pn,Ef=t,qm=Wu,Sf="toString",zm=RegExp.prototype,Wm=zm.toString,o=Ef(function(){return"/a/b"!=Wm.call({source:"a",flags:"b"})}),ur=Wm.name!=Sf,Cf=((o||ur)&&Tf(RegExp.prototype,Sf,function(){var e=Fm(this),t=Bm(e.source),n=e.flags;return"/"+t+"/"+Bm(void 0===n&&e instanceof RegExp&&!("flags"in zm)?qm.call(e):n)},{unsafe:!0}),wh("Set",function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}},wf),{exports:{}}),_=(Cf.exports=function(){return n=[function(e,t,n){e.exports=function(e,t){for(var n,r,i=1;i<arguments.length;i++)for(r in n=arguments[i])n.hasOwnProperty(r)&&(e[r]=n[r]);return e}},function(e,t,n){var a=n(0);e.exports={build:function(e,t){for(var n,r=t.plugins,i=0,o=r.length;i<o;i++)(n=r[i]).methods&&a(e,n.methods),n.properties&&Object.defineProperties(e,n.properties)},hook:function(e,t,n){var r,i,o,a,s=e.config.plugins,c=[e.context];for(n&&(c=c.concat(n)),r=0,i=s.length;r<i;r++)a=s[r],(o=s[r][t])&&o.apply(a,c)}}},function(e,t,n){function r(e){if(0===e.length)return e;var t,n,r=e.split(/[_-]/);if(1===r.length&&r[0][0].toLowerCase()===r[0][0])return e;for(n=r[0].toLowerCase(),t=1;t<r.length;t++)n=n+r[t].charAt(0).toUpperCase()+r[t].substring(1).toLowerCase();return n}r.prepended=function(e,t){return e+(t=r(t))[0].toUpperCase()+t.substring(1)},e.exports=r},function(e,t,n){var r=n(0),i=n(2);function o(e,t){this.options=e=e||{},this.defaults=t.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(e.init),this.data=this.configureData(e.data),this.methods=this.configureMethods(e.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(e.transitions||[]),this.plugins=this.configurePlugins(e.plugins,t.plugin)}r(o.prototype,{addState:function(e){this.map[e]||(this.states.push(e),this.addStateLifecycleNames(e),this.map[e]={})},addStateLifecycleNames:function(e){this.lifecycle.onEnter[e]=i.prepended("onEnter",e),this.lifecycle.onLeave[e]=i.prepended("onLeave",e),this.lifecycle.on[e]=i.prepended("on",e)},addTransition:function(e){this.transitions.indexOf(e)<0&&(this.transitions.push(e),this.addTransitionLifecycleNames(e))},addTransitionLifecycleNames:function(e){this.lifecycle.onBefore[e]=i.prepended("onBefore",e),this.lifecycle.onAfter[e]=i.prepended("onAfter",e),this.lifecycle.on[e]=i.prepended("on",e)},mapTransition:function(e){var t=e.name,n=e.from,r=e.to;return this.addState(n),"function"!=typeof r&&this.addState(r),this.addTransition(t),this.map[n][t]=e},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(e){return"string"==typeof e?this.mapTransition(r({},this.defaults.init,{to:e,active:!0})):"object"===F(e)?this.mapTransition(r({},this.defaults.init,e,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(e){return"function"==typeof e?e:"object"===F(e)?function(){return e}:function(){return{}}},configureMethods:function(e){return e||{}},configurePlugins:function(e,t){for(var n,r=0,i=(e=e||[]).length;r<i;r++)"function"==typeof(n=e[r])&&(e[r]=n=n()),n.configure&&n.configure(this);return e},configureTransitions:function(e){for(var t,n,r,i,o=this.defaults.wildcard,a=0;a<e.length;a++)for(n=e[a],r=Array.isArray(n.from)?n.from:[n.from||o],i=n.to||o,t=0;t<r.length;t++)this.mapTransition({name:n.name,from:r[t],to:i})},transitionFor:function(e,t){var n=this.defaults.wildcard;return this.map[e][t]||this.map[n][t]},transitionsFor:function(e){var t=this.defaults.wildcard;return Object.keys(this.map[e]).concat(Object.keys(this.map[t]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),e.exports=o},function(e,t,n){var r=n(0),i=n(6),s=n(1),a=[null,[]];function o(e,t){this.context=e,this.config=t,this.state=t.init.from,this.observers=[e]}r(o.prototype,{init:function(e){if(r(this.context,this.config.data.apply(this.context,e)),s.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(e){return Array.isArray(e)?0<=e.indexOf(this.state):this.state===e},isPending:function(){return this.pending},can:function(e){return!this.isPending()&&!!this.seek(e)},cannot:function(e){return!this.can(e)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(e,t){var n=this.config.defaults.wildcard,e=this.config.transitionFor(this.state,e),e=e&&e.to;return"function"==typeof e?e.apply(this.context,t):e===n?this.state:e},fire:function(e,t){return this.transit(e,this.state,this.seek(e,t),t)},transit:function(e,t,n,r){var i=this.config.lifecycle,o=this.config.options.observeUnchangedState||t!==n;return n?this.isPending()?this.context.onPendingTransition(e,t,n):(this.config.addState(n),this.beginTransit(),r.unshift({transition:e,from:t,to:n,fsm:this.context}),this.observeEvents([this.observersForEvent(i.onBefore.transition),this.observersForEvent(i.onBefore[e]),o?this.observersForEvent(i.onLeave.state):a,o?this.observersForEvent(i.onLeave[t]):a,this.observersForEvent(i.on.transition),o?["doTransit",[this]]:a,o?this.observersForEvent(i.onEnter.state):a,o?this.observersForEvent(i.onEnter[n]):a,o?this.observersForEvent(i.on[n]):a,this.observersForEvent(i.onAfter.transition),this.observersForEvent(i.onAfter[e]),this.observersForEvent(i.on[e])],r)):this.context.onInvalidTransition(e,t,n)},beginTransit:function(){this.pending=!0},endTransit:function(e){return this.pending=!1,e},failTransit:function(e){throw this.pending=!1,e},doTransit:function(e){this.state=e.to},observe:function(e){var t;2===e.length?((t={})[e[0]]=e[1],this.observers.push(t)):this.observers.push(e[0])},observersForEvent:function(e){for(var t,n=0,r=this.observers.length,i=[];n<r;n++)(t=this.observers[n])[e]&&i.push(t);return[e,i,!0]},observeEvents:function(e,t,n,r){var i,o,a;return 0===e.length?this.endTransit(void 0===r||r):(i=e[0][0],o=e[0][1],a=e[0][2],(t[0].event=i)&&a&&i!==n&&s.hook(this,"lifecycle",t),0===o.length?(e.shift(),this.observeEvents(e,t,i,r)):(n=(a=o.shift())[i].apply(a,t))&&"function"==typeof n.then?n.then(this.observeEvents.bind(this,e,t,i)).catch(this.failTransit.bind(this)):!1===n?this.endTransit(!1):this.observeEvents(e,t,i,n))},onInvalidTransition:function(e,t,n){throw new i("transition is invalid in current state",e,t,n,this.state)},onPendingTransition:function(e,t,n){throw new i("transition is invalid while previous transition is still in progress",e,t,n,this.state)}}),e.exports=o},function(e,t,n){var r=n(0),i=n(2),o=n(1),a=n(3),s=n(4),c={is:function(e){return this._fsm.is(e)},can:function(e){return this._fsm.can(e)},cannot:function(e){return this._fsm.cannot(e)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(e,t,n){return this._fsm.onInvalidTransition(e,t,n)},onPendingTransition:function(e,t,n){return this._fsm.onPendingTransition(e,t,n)}},u={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(e){throw Error("use transitions to change state")}}};function l(e){return d(this||{},e)}function d(e,t){return f(e,new a(t,l)),e._fsm(),e}function f(t,e){if("object"!==F(t)||Array.isArray(t))throw Error("StateMachine can only be applied to objects");o.build(t,e),Object.defineProperties(t,u),r(t,c),r(t,e.methods),e.allTransitions().forEach(function(e){t[i(e)]=function(){return this._fsm.fire(e,[].slice.call(arguments))}}),t._fsm=function(){this._fsm=new s(this,e),this._fsm.init(arguments)}}l.version="3.0.1",l.factory=function(){var e,t="function"==typeof arguments[0]?(e=arguments[0],arguments[1]||{}):(e=function(){this._fsm.apply(this,arguments)},arguments[0]||{}),t=new a(t,l);return f(e.prototype,t),e.prototype._fsm.config=t,e},l.apply=d,l.defaults={wildcard:"*",init:{name:"init",from:"none"}},e.exports=l},function(e,t,n){e.exports=function(e,t,n,r,i){this.message=e,this.transition=t,this.from=n,this.to=r,this.current=i}}],i={},r.m=n,r.c=i,r.i=function(e){return e},r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5);function r(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},n[e].call(t.exports,t,t.exports,r),t.l=!0,t)).exports}var n,i}(),{exports:{}}),Gm="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);Gm?(Nm=new Uint8Array(16),_.exports=function(){return Gm(Nm),Nm}):(Um=new Array(16),_.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),Um[t]=e>>>((3&t)<<3)&255;return Um});for(var Vm=[],Hm=0;Hm<256;++Hm)Vm[Hm]=(Hm+256).toString(16).substr(1);function Jm(e,t){var t=t||0,n=Vm;return[n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[+t]]].join("")}function $m(e,t,n){var r=t&&n||0,i=("string"==typeof e&&(t="binary"===e?new Array(16):null,e=null),(e=e||{}).random||(e.rng||ty)());if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var o=0;o<16;++o)t[r+o]=i[o];return t||ny(i)}var Km,Ym,Qm=_.exports,Xm=Jm,Zm=0,ey=0,ty=_.exports,ny=Jm,w=$m;w.v1=function(e,t,n){var r=t&&n||0,i=t||[],o=(e=e||{}).node||Km,n=void 0!==e.clockseq?e.clockseq:Ym,a=(null!=o&&null!=n||(a=Qm(),null==o&&(o=Km=[1|a[0],a[1],a[2],a[3],a[4],a[5]]),null==n&&(n=Ym=16383&(a[6]<<8|a[7]))),void 0!==e.msecs?e.msecs:(new Date).getTime()),s=void 0!==e.nsecs?e.nsecs:ey+1,c=a-Zm+(s-ey)/1e4;if(c<0&&void 0===e.clockseq&&(n=n+1&16383),1e4<=(s=(c<0||Zm<a)&&void 0===e.nsecs?0:s))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");Zm=a,Ym=n;c=(1e4*(268435455&(a+=122192928e5))+(ey=s))%4294967296,i[r++]=c>>>24&255,i[r++]=c>>>16&255,i[r++]=c>>>8&255,i[r++]=255&c,e=a/4294967296*1e4&268435455;i[r++]=e>>>8&255,i[r++]=255&e,i[r++]=e>>>24&15|16,i[r++]=e>>>16&255,i[r++]=n>>>8|128,i[r++]=255&n;for(var u=0;u<6;++u)i[r+u]=o[u];return t||Xm(i)},w.v4=$m;function ry(e){return!!ly(e)&&(e=fy(e),dy(xy,e)||dy(Sy,e))}var iy,oy,ay,sy=w,mi={exports:{}},Ef="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,o=Ef,cy=N,uy=n,ly=J,dy=be,fy=ni,py=Ce,hy=pe.exports,ur=Ie.f,Tf=u,my=ai,Sf=X,wf=Q,_=uy.Int8Array,yy=_&&_.prototype,w=uy.Uint8ClampedArray,w=w&&w.prototype,vy=_&&Tf(_),gy=yy&&Tf(yy),_=Object.prototype,by=_.isPrototypeOf,Sf=Sf("toStringTag"),_y=wf("TYPED_ARRAY_TAG"),wy=wf("TYPED_ARRAY_CONSTRUCTOR"),ky=o&&!!my&&"Opera"!==fy(uy.opera),wf=!1,xy={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Sy={BigInt64Array:8,BigUint64Array:8};for(iy in xy)(ay=(oy=uy[iy])&&oy.prototype)?py(ay,wy,oy):ky=!1;for(iy in Sy)(ay=(oy=uy[iy])&&oy.prototype)&&py(ay,wy,oy);if((!ky||"function"!=typeof vy||vy===Function.prototype)&&(vy=function(){throw TypeError("Incorrect invocation")},ky))for(iy in xy)uy[iy]&&my(uy[iy],vy);if((!ky||!gy||gy===_)&&(gy=vy.prototype,ky))for(iy in xy)uy[iy]&&my(uy[iy].prototype,gy);if(ky&&Tf(w)!==gy&&my(w,gy),cy&&!dy(gy,Sf))for(iy in wf=!0,ur(gy,Sf,{get:function(){return ly(this)?this[_y]:void 0}}),xy)uy[iy]&&py(uy[iy],_y,iy);function Ey(e){if(void 0===e)return 0;var e=Uy(e),t=Fy(e);if(e!==t)throw RangeError("Wrong length or index");return t}function Cy(e){for(var t=Vy(this),n=Jy(t.length),r=arguments.length,i=Hy(1<r?arguments[1]:void 0,n),o=void 0===(r=2<r?arguments[2]:void 0)?n:Hy(r,n);i<o;)t[i++]=e;return t}function Ty(e){return[255&e]}function Iy(e){return[255&e,e>>8&255]}function Ry(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function Py(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]}function Oy(e){return hv(e,23,4)}function Ay(e){return hv(e,52,8)}function My(e,t){tv(e.prototype,t,{get:function(){return rv(this)[t]}})}function Dy(e,t,n,r){if(n=Zy(n),e=rv(e),n+t>e.byteLength)throw pv(sv);var i=rv(e.buffer).bytes,n=n+e.byteOffset,e=i.slice(n,n+t);return r?e:e.reverse()}function jy(e,t,n,r,i,o){if(n=Zy(n),e=rv(e),n+t>e.byteLength)throw pv(sv);for(var a=rv(e.buffer).bytes,s=n+e.byteOffset,c=r(+i),u=0;u<t;u++)a[s+u]=c[o?u:t-u-1]}var o={NATIVE_ARRAY_BUFFER_VIEWS:ky,TYPED_ARRAY_CONSTRUCTOR:wy,TYPED_ARRAY_TAG:wf&&_y,aTypedArray:function(e){if(ry(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(my&&!by.call(vy,e))throw TypeError("Target is not a typed array constructor");return e},exportTypedArrayMethod:function(e,t,n){if(cy){if(n)for(var r in xy){r=uy[r];if(r&&dy(r.prototype,e))try{delete r.prototype[e]}catch(e){}}gy[e]&&!n||hy(gy,e,!n&&ky&&yy[e]||t)}},exportTypedArrayStaticMethod:function(e,t,n){var r,i;if(cy){if(my){if(n)for(r in xy)if((i=uy[r])&&dy(i,e))try{delete i[e]}catch(e){}if(vy[e]&&!n)return;try{return hy(vy,e,!n&&ky&&vy[e]||t)}catch(e){}}for(r in xy)!(i=uy[r])||i[e]&&!n||hy(i,e,t)}},isView:function(e){return!!ly(e)&&("DataView"===(e=fy(e))||dy(xy,e)||dy(Sy,e))},isTypedArray:ry,TypedArray:vy,TypedArrayPrototype:gy},_=t,Tf=Uo,Ly=n.ArrayBuffer,Ny=n.Int8Array,w=!o.NATIVE_ARRAY_BUFFER_VIEWS||!_(function(){Ny(1)})||!_(function(){new Ny(-1)})||!Tf(function(e){new Ny,new Ny(null),new Ny(1.5),new Ny(e)},!0)||_(function(){return 1!==new Ny(new Ly(2),1,void 0).length}),Uy=it,Fy=ot,By=Math.abs,qy=Math.pow,zy=Math.floor,Wy=Math.log,Gy=Math.LN2,Vy=Y,Hy=at,Jy=ot,$y=N,Ky=Ce,ur=Qi,Sf=t,Yy=Zi,Qy=it,Xy=ot,Zy=Ey,wf=function(e,t,n){var r,i,o,a=new Array(n),s=8*n-t-1,n=(1<<s)-1,c=n>>1,u=23===t?qy(2,-24)-qy(2,-77):0,l=e<0||0===e&&1/e<0?1:0,d=0;for((e=By(e))!=e||e===1/0?(i=e!=e?1:0,r=n):(r=zy(Wy(e)/Gy),e*(o=qy(2,-r))<1&&(r--,o*=2),2<=(e+=1<=r+c?u/o:u*qy(2,1-c))*o&&(r++,o/=2),n<=r+c?(i=0,r=n):1<=r+c?(i=(e*o-1)*qy(2,t),r+=c):(i=e*qy(2,c-1)*qy(2,t),r=0));8<=t;a[d++]=255&i,i/=256,t-=8);for(r=r<<t|i,s+=t;0<s;a[d++]=255&r,r/=256,s-=8);return a[--d]|=128*l,a},Tf=function(e,t){var n,r=e.length,i=8*r-t-1,o=(1<<i)-1,a=o>>1,s=i-7,c=r-1,i=e[c--],u=127&i;for(i>>=7;0<s;u=256*u+e[c],c--,s-=8);for(n=u&(1<<-s)-1,u>>=-s,s+=t;0<s;n=256*n+e[c],c--,s-=8);if(0===u)u=1-a;else{if(u===o)return n?NaN:i?-1/0:1/0;n+=qy(2,t),u-=a}return(i?-1:1)*n*qy(2,u-t)},_=u,u=ai,ev=ge.f,tv=Ie.f,nv=Cy,k=dt,rv=_t.get,iv=_t.set,ov="ArrayBuffer",av="DataView",sv="Wrong index",cv=n.ArrayBuffer,uv=cv,lv=n.DataView,dv=lv&&lv.prototype,fv=Object.prototype,pv=n.RangeError,hv=wf,mv=Tf;if(Ef){if(!Sf(function(){cv(1)})||!Sf(function(){new cv(-1)})||Sf(function(){return new cv,new cv(1.5),new cv(NaN),cv.name!=ov})){for(var yv,wf=(uv=function(e){return Yy(this,uv),new cv(Zy(e))}).prototype=cv.prototype,vv=ev(cv),gv=0;vv.length>gv;)(yv=vv[gv++])in uv||Ky(uv,yv,cv[yv]);wf.constructor=uv}u&&_(dv)!==fv&&u(dv,fv);var Tf=new lv(new uv(2)),bv=dv.setInt8;Tf.setInt8(0,2147483648),Tf.setInt8(1,2147483649),!Tf.getInt8(0)&&Tf.getInt8(1)||ur(dv,{setInt8:function(e,t){bv.call(this,e,t<<24>>24)},setUint8:function(e,t){bv.call(this,e,t<<24>>24)}},{unsafe:!0})}else uv=function(e){Yy(this,uv,ov);e=Zy(e);iv(this,{bytes:nv.call(new Array(e),0),byteLength:e}),$y||(this.byteLength=e)},lv=function(e,t,n){Yy(this,lv,av),Yy(e,uv,av);var r=rv(e).byteLength,t=Qy(t);if(t<0||r<t)throw pv("Wrong offset");if(t+(n=void 0===n?r-t:Xy(n))>r)throw pv("Wrong length");iv(this,{buffer:e,byteLength:n,byteOffset:t}),$y||(this.buffer=e,this.byteLength=n,this.byteOffset=t)},$y&&(My(uv,"byteLength"),My(lv,"buffer"),My(lv,"byteLength"),My(lv,"byteOffset")),ur(lv.prototype,{getInt8:function(e){return Dy(this,1,e)[0]<<24>>24},getUint8:function(e){return Dy(this,1,e)[0]},getInt16:function(e){e=Dy(this,2,e,1<arguments.length?arguments[1]:void 0);return(e[1]<<8|e[0])<<16>>16},getUint16:function(e){e=Dy(this,2,e,1<arguments.length?arguments[1]:void 0);return e[1]<<8|e[0]},getInt32:function(e){return Py(Dy(this,4,e,1<arguments.length?arguments[1]:void 0))},getUint32:function(e){return Py(Dy(this,4,e,1<arguments.length?arguments[1]:void 0))>>>0},getFloat32:function(e){return mv(Dy(this,4,e,1<arguments.length?arguments[1]:void 0),23)},getFloat64:function(e){return mv(Dy(this,8,e,1<arguments.length?arguments[1]:void 0),52)},setInt8:function(e,t){jy(this,1,e,Ty,t)},setUint8:function(e,t){jy(this,1,e,Ty,t)},setInt16:function(e,t){jy(this,2,e,Iy,t,2<arguments.length?arguments[2]:void 0)},setUint16:function(e,t){jy(this,2,e,Iy,t,2<arguments.length?arguments[2]:void 0)},setInt32:function(e,t){jy(this,4,e,Ry,t,2<arguments.length?arguments[2]:void 0)},setUint32:function(e,t){jy(this,4,e,Ry,t,2<arguments.length?arguments[2]:void 0)},setFloat32:function(e,t){jy(this,4,e,Oy,t,2<arguments.length?arguments[2]:void 0)},setFloat64:function(e,t){jy(this,8,e,Ay,t,2<arguments.length?arguments[2]:void 0)}});k(uv,ov),k(lv,av);function _v(e,t){if((e=function(e){e=Av(e);if(e<0)throw RangeError("The argument can't be less than 0");return e}(e))%t)throw RangeError("Wrong offset");return e}function wv(e){var t,n,r,i,o,a,s=Mv(e),e=arguments.length,c=1<e?arguments[1]:void 0,u=void 0!==c,l=Lv(s);if(null!=l&&!Nv(l))for(a=(o=jv(s,l)).next,s=[];!(i=a.call(o)).done;)s.push(i.value);for(u&&2<e&&(c=Uv(c,arguments[2],2)),n=Dv(s.length),r=new(Fv(this))(n),t=0;t<n;t++)r[t]=u?c(s[t],t):s[t];return r}function kv(e,t){for(var n=0,r=t.length,i=new(_g(e))(r);n<r;)i[n]=t[n++];return i}function xv(e,t){ug(e,t,{get:function(){return sg(this)[t]}})}function Sv(e){return e instanceof pg||"ArrayBuffer"==(e=Xv(e))||"SharedArrayBuffer"==e}function Ev(e,t){return wg(e)&&!eg(t)&&t in e&&Hv(+t)&&0<=t}function Cv(e,t){return t=Yv(t),Ev(e,t)?Gv(2,e[t]):lg(e,t)}function Tv(e,t,n){return t=Yv(t),!(Ev(e,t)&&Zv(n)&&Qv(n,"value"))||Qv(n,"get")||Qv(n,"set")||n.configurable||Qv(n,"writable")&&!n.writable||Qv(n,"enumerable")&&!n.enumerable?ug(e,t,n):(e[t]=n.value,e)}function Iv(e){return Lg(Dg(e,e[jg]))}function Rv(){return Yg.call(Zg(this))}function Pv(u){return function(e,t,n,r){pb(t);var i=hb(e),o=mb(i),a=yb(i.length),s=u?a-1:0,c=u?-1:1;if(n<2)for(;;){if(s in o){r=o[s],s+=c;break}if(s+=c,u?s<0:a<=s)throw TypeError("Reduce of empty array with no initial value")}for(;u?0<=s:s<a;s+=c)s in o&&(r=t(r,o[s],s,i));return r}}function Ov(e,t){var n=e.length,r=Ab(n/2);if(n<8){for(var i,o,a=e,s=t,c=a.length,u=1;u<c;){for(i=a[o=u];o&&0<s(a[o-1],i);)a[o]=a[--o];o!==u++&&(a[o]=i)}return a}for(var l=Ov(e.slice(0,r),t),d=Ov(e.slice(r),t),f=t,p=l.length,h=d.length,m=0,y=0,v=[];m<p||y<h;)v.push(m<p&&y<h?f(l[m],d[y])<=0?l[m++]:d[y++]:m<p?l[m++]:d[y++]);return v}var Ef={ArrayBuffer:uv,DataView:lv},Av=it,Mv=Y,Dv=ot,jv=no,Lv=to,Nv=eo,Uv=An,Fv=o.aTypedArrayConstructor,Bv=i,qv=n,zv=w,Wv=Zi,Gv=W,Vv=Ce,Hv=Id,Jv=ot,$v=Ey,Kv=_v,Yv=ee,Qv=be,Xv=ni,Zv=J,eg=me,tg=Tt,ng=ai,rg=ge.f,ig=zr.forEach,og=Xi,Sf=Ie,ev=L,ag=pu,sg=_t.get,cg=_t.set,ug=Sf.f,lg=ev.f,dg=Math.round,fg=qv.RangeError,pg=Ef.ArrayBuffer,hg=Ef.DataView,mg=o.NATIVE_ARRAY_BUFFER_VIEWS,yg=o.TYPED_ARRAY_CONSTRUCTOR,vg=o.TYPED_ARRAY_TAG,gg=o.TypedArray,bg=o.TypedArrayPrototype,_g=o.aTypedArrayConstructor,wg=o.isTypedArray,kg="BYTES_PER_ELEMENT",xg="Wrong length",Sg=(N?(mg||(ev.f=Cv,Sf.f=Tv,xv(bg,"buffer"),xv(bg,"byteOffset"),xv(bg,"byteLength"),xv(bg,"length")),Bv({target:"Object",stat:!0,forced:!mg},{getOwnPropertyDescriptor:Cv,defineProperty:Tv}),mi.exports=function(e,t,i){function u(e,r){ug(e,r,{get:function(){var e=this,t=r;return(e=sg(e)).view[n](t*l+e.byteOffset,!0)},set:function(e){var t=this,n=r;t=sg(t),i&&(e=(e=dg(e))<0?0:255<e?255:255&e),t.view[o](n*l+t.byteOffset,e,!0)},enumerable:!0})}var l=e.match(/\d+$/)[0]/8,d=e+(i?"Clamped":"")+"Array",n="get"+e,o="set"+e,a=qv[d],f=a,e=f&&f.prototype,r={};mg?zv&&(f=t(function(e,t,n,r){return Wv(e,f,d),ag(Zv(t)?Sv(t)?void 0!==r?new a(t,Kv(n,l),r):void 0!==n?new a(t,Kv(n,l)):new a(t):wg(t)?kv(f,t):wv.call(f,t):new a($v(t)),e,f)}),ng&&ng(f,gg),ig(rg(a),function(e){e in f||Vv(f,e,a[e])}),f.prototype=e):(f=t(function(e,t,n,r){Wv(e,f,d);var i,o,a=0,s=0;if(Zv(t)){if(!Sv(t))return wg(t)?kv(f,t):wv.call(f,t);var c=t,s=Kv(n,l),n=t.byteLength;if(void 0===r){if(n%l)throw fg(xg);if((i=n-s)<0)throw fg(xg)}else if((i=Jv(r)*l)+s>n)throw fg(xg);o=i/l}else o=$v(t),c=new pg(i=o*l);for(cg(e,{buffer:c,byteOffset:s,byteLength:i,length:o,view:new hg(c)});a<o;)u(e,a++)}),ng&&ng(f,gg),e=f.prototype=tg(bg)),e.constructor!==f&&Vv(e,"constructor",f),Vv(e,yg,f),vg&&Vv(e,vg,d),Bv({global:!0,forced:(r[d]=f)!=a,sham:!mg},r),kg in f||Vv(f,kg,l),kg in e||Vv(e,kg,l),og(d)}):mi.exports=function(){},(0,mi.exports)("Uint8",function(r){return function(e,t,n){return r(this,e,t,n)}}),Y),Eg=at,Cg=ot,Tg=Math.min,Ig=[].copyWithin||function(e,t){var n=Sg(this),r=Cg(n.length),i=Eg(e,r),o=Eg(t,r),e=2<arguments.length?arguments[2]:void 0,a=Tg((void 0===e?r:Eg(e,r))-o,r-i),s=1;for(o<i&&i<o+a&&(s=-1,o+=a-1,i+=a-1);0<a--;)o in n?n[i]=n[o]:delete n[i],i+=s,o+=s;return n},Rg=o.aTypedArray,Pg=((0,o.exportTypedArrayMethod)("copyWithin",function(e,t){return Ig.call(Rg(this),e,t,2<arguments.length?arguments[2]:void 0)}),zr.every),Og=o.aTypedArray,Ag=((0,o.exportTypedArrayMethod)("every",function(e){return Pg(Og(this),e,1<arguments.length?arguments[1]:void 0)}),Cy),Mg=o.aTypedArray,Dg=((0,o.exportTypedArrayMethod)("fill",function(e){return Ag.apply(Mg(this),arguments)}),Fo),jg=o.TYPED_ARRAY_CONSTRUCTOR,Lg=o.aTypedArrayConstructor,Ng=Iv,Ug=zr.filter,Fg=o.aTypedArray,Bg=((0,o.exportTypedArrayMethod)("filter",function(e){for(var e=Ug(Fg(this),e,1<arguments.length?arguments[1]:void 0),t=this,t=Ng(t),n=e,r=0,i=n.length,o=new t(i);r<i;)o[r]=n[r++];return o}),zr.find),qg=o.aTypedArray,zg=((0,o.exportTypedArrayMethod)("find",function(e){return Bg(qg(this),e,1<arguments.length?arguments[1]:void 0)}),zr.findIndex),Wg=o.aTypedArray,Gg=((0,o.exportTypedArrayMethod)("findIndex",function(e){return zg(Wg(this),e,1<arguments.length?arguments[1]:void 0)}),zr.forEach),Vg=o.aTypedArray,Hg=((0,o.exportTypedArrayMethod)("forEach",function(e){Gg(Vg(this),e,1<arguments.length?arguments[1]:void 0)}),Rt.includes),Jg=o.aTypedArray,$g=((0,o.exportTypedArrayMethod)("includes",function(e){return Hg(Jg(this),e,1<arguments.length?arguments[1]:void 0)}),Rt.indexOf),Kg=o.aTypedArray,wf=((0,o.exportTypedArrayMethod)("indexOf",function(e){return $g(Kg(this),e,1<arguments.length?arguments[1]:void 0)}),n),_=o,u=tt,fv=X("iterator"),Tf=wf.Uint8Array,Yg=u.values,Qg=u.keys,Xg=u.entries,Zg=_.aTypedArray,dv=_.exportTypedArrayMethod,ur=Tf&&Tf.prototype[fv],k=!!ur&&("values"==ur.name||null==ur.name),eb=(dv("entries",function(){return Xg.call(Zg(this))}),dv("keys",function(){return Qg.call(Zg(this))}),dv("values",Rv,!k),dv(fv,Rv,!k),o.aTypedArray),tb=[].join,nb=((0,o.exportTypedArrayMethod)("join",function(e){return tb.apply(eb(this),arguments)}),H),rb=it,ib=ot,w=os,ob=Math.min,ab=[].lastIndexOf,sb=!!ab&&1/[1].lastIndexOf(1,-0)<0,Ce=w("lastIndexOf"),cb=sb||!Ce?function(e){if(sb)return ab.apply(this,arguments)||0;var t=nb(this),n=ib(t.length),r=n-1;for((r=1<arguments.length?ob(r,rb(arguments[1])):r)<0&&(r=n+r);0<=r;r--)if(r in t&&t[r]===e)return r||0;return-1}:ab,ub=o.aTypedArray,lb=((0,o.exportTypedArrayMethod)("lastIndexOf",function(e){return cb.apply(ub(this),arguments)}),zr.map),db=Iv,fb=o.aTypedArray,pb=((0,o.exportTypedArrayMethod)("map",function(e){return lb(fb(this),e,1<arguments.length?arguments[1]:void 0,function(e,t){return new(db(e))(t)})}),Tn),hb=Y,mb=z,yb=ot,me={left:Pv(!1),right:Pv(!0)},vb=me.left,gb=o.aTypedArray,bb=((0,o.exportTypedArrayMethod)("reduce",function(e){return vb(gb(this),e,arguments.length,1<arguments.length?arguments[1]:void 0)}),me.right),_b=o.aTypedArray,wb=((0,o.exportTypedArrayMethod)("reduceRight",function(e){return bb(_b(this),e,arguments.length,1<arguments.length?arguments[1]:void 0)}),o.aTypedArray),ai=o.exportTypedArrayMethod,kb=Math.floor,xb=(ai("reverse",function(){for(var e,t=wb(this).length,n=kb(t/2),r=0;r<n;)e=this[r],this[r++]=this[--t],this[t]=e;return this}),ot),Sb=_v,Eb=Y,Cb=o.aTypedArray,Tb=((0,o.exportTypedArrayMethod)("set",function(e){Cb(this);var t=Sb(1<arguments.length?arguments[1]:void 0,1),n=this.length,r=Eb(e),i=xb(r.length),o=0;if(n<i+t)throw RangeError("Wrong length");for(;o<i;)this[t+o]=r[o++]},t(function(){new Int8Array(1).set({})})),Iv),Ib=o.aTypedArray,Rb=[].slice,Pb=((0,o.exportTypedArrayMethod)("slice",function(e,t){for(var n=Rb.call(Ib(this),e,t),e=Tb(this),r=0,i=n.length,o=new e(i);r<i;)o[r]=n[r++];return o},t(function(){new Int8Array(1).slice()})),zr.some),Ob=o.aTypedArray,Ab=((0,o.exportTypedArrayMethod)("some",function(e){return Pb(Ob(this),e,1<arguments.length?arguments[1]:void 0)}),Math.floor),ge=Ov,Ie=r.match(/firefox\/(\d+)/i),ev=!!Ie&&+Ie[1],Sf=/MSIE|Trident/.test(r),mi=r.match(/AppleWebKit\/(\d+)\./),Rt=!!mi&&+mi[1],tt=t,Mb=Tn,Db=ot,jb=ge,Lb=ev,Nb=Sf,Ub=le,Fb=Rt,Bb=o.aTypedArray,wf=o.exportTypedArrayMethod,qb=n.Uint16Array,zb=qb&&qb.prototype.sort,u=!!zb&&!tt(function(){var e=new qb(2);e.sort(null),e.sort({})}),Wb=!!zb&&!tt(function(){if(Ub)return Ub<74;if(Lb)return Lb<67;if(Nb)return!0;if(Fb)return Fb<602;for(var e,t=new qb(516),n=Array(516),r=0;r<516;r++)e=r%4,t[r]=515-r,n[r]=r-2*e+3;for(t.sort(function(e,t){return(e/4|0)-(t/4|0)}),r=0;r<516;r++)if(t[r]!==n[r])return!0}),Gb=(wf("sort",function(e){if(void 0!==e&&Mb(e),Wb)return zb.call(this,e);Bb(this);for(var n,t=Db(this.length),r=Array(t),i=0;i<t;i++)r[i]=this[i];for(r=jb(this,(n=e,function(e,t){return void 0!==n?+n(e,t)||0:t!=t?-1:e!=e?1:0===e&&0===t?0<1/e&&1/t<0?1:-1:t<e})),i=0;i<t;i++)this[i]=r[i];return this},!Wb||u),ot),Vb=at,Hb=Iv,Jb=o.aTypedArray;(0,o.exportTypedArrayMethod)("subarray",function(e,t){var n=Jb(this),r=n.length,e=Vb(e,r);return new(Hb(n))(n.buffer,n.byteOffset+e*n.BYTES_PER_ELEMENT,Gb((void 0===t?r:Vb(t,r))-e))});function $b(e){var t;return l_(e)&&(void 0!==(t=e[f_])?!!t:"RegExp"==d_(e))}var Kb,Yb,Qb,Xb,Zb,e_,t_,n_,_=t,r_=n.Int8Array,i_=o.aTypedArray,Tf=o.exportTypedArrayMethod,o_=[].toLocaleString,a_=[].slice,s_=!!r_&&_(function(){o_.call(new r_(1))}),ur=(Tf("toLocaleString",function(){return o_.apply(s_?a_.call(i_(this)):i_(this),arguments)},_(function(){return[1,2].toLocaleString()!=new r_([1,2]).toLocaleString()})||!_(function(){r_.prototype.toLocaleString.call([1,2])})),o.exportTypedArrayMethod),dv=t,fv=n.Uint8Array,k=fv&&fv.prototype||{},c_=[].toString,u_=[].join,w=(dv(function(){c_.call({})})&&(c_=function(){return u_.call(this)}),k.toString!=c_),l_=(ur("toString",c_,w),J),d_=G,f_=X("match"),Ce=Hu,p_=$b,h_=ne,m_=V,y_=Fo,v_=Ju,g_=ot,b_=Pn,__=$u,w_=ii,ai=t,k_=No.UNSUPPORTED_Y,x_=[].push,S_=Math.min,E_=4294967295,Ie=(Ce("split",function(i,h,m){var y="c"=="abbc".split(/(b)*/)[1]||4!="test".split(/(?:)/,-1).length||2!="ab".split(/(?:ab)*/).length||4!=".".split(/(.?)(.?)/).length||1<".".split(/()()/).length||"".split(/.?/).length?function(e,t){var n=b_(m_(this)),r=void 0===t?E_:t>>>0;if(0==r)return[];if(void 0===e)return[n];if(!p_(e))return h.call(n,e,r);for(var i,o,a,s=[],t=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),c=0,u=new RegExp(e.source,t+"g");(i=w_.call(u,n))&&!((o=u.lastIndex)>c&&(s.push(n.slice(c,i.index)),1<i.length&&i.index<n.length&&x_.apply(s,i.slice(1)),a=i[0].length,c=o,r<=s.length));)u.lastIndex===i.index&&u.lastIndex++;return c===n.length?!a&&u.test("")||s.push(""):s.push(n.slice(c)),r<s.length?s.slice(0,r):s}:"0".split(void 0,0).length?function(e,t){return void 0===e&&0===t?[]:h.call(this,e,t)}:h;return[function(e,t){var n=m_(this),r=null==e?void 0:e[i];return void 0!==r?r.call(e,n,t):y.call(b_(n),e,t)},function(e,t){var n=h_(this),r=b_(e),e=m(y,n,r,t,y!==h);if(e.done)return e.value;var e=y_(n,RegExp),i=n.unicode,o=(n.ignoreCase?"i":"")+(n.multiline?"m":"")+(n.unicode?"u":"")+(k_?"g":"y"),a=new e(k_?"^(?:"+n.source+")":n,o),s=void 0===t?E_:t>>>0;if(0==s)return[];if(0===r.length)return null===__(a,r)?[r]:[];for(var c=0,u=0,l=[];u<r.length;){a.lastIndex=k_?0:u;var d,f=__(a,k_?r.slice(u):r);if(null===f||(d=S_(g_(a.lastIndex+(k_?u:0)),r.length))===c)u=v_(r,u,i);else{if(l.push(r.slice(c,u)),l.length===s)return l;for(var p=1;p<=f.length-1;p++)if(l.push(f[p]),l.length===s)return l;u=c=d}}return l.push(r.slice(c)),l}]},!!ai(function(){var e=/(?:)/,t=e.exec,e=(e.exec=function(){return t.apply(this,arguments)},"ab".split(e));return 2!==e.length||"a"!==e[0]||"b"!==e[1]}),k_),{exports:{}}),r={exports:{}},tt=((mi=r).exports=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")},mi.exports.__esModule=!0,mi.exports.default=mi.exports,{exports:{}}),wf={exports:{}};function C_(e){var n="function"==typeof Map?new Map:void 0;return Kb.exports=C_=function(e){if(null===e||!Xb(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return Zb(e,arguments,Yb(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Qb(t,e)},Kb.exports.__esModule=!0,Kb.exports.default=Kb.exports,C_(e)}function T_(e,t,n){return n_()?e_.exports=T_=Reflect.construct:e_.exports=T_=function(e,t,n){var r=[null],t=(r.push.apply(r,t),new(Function.bind.apply(e,r)));return n&&t_(t,n.prototype),t},e_.exports.__esModule=!0,e_.exports.default=e_.exports,T_.apply(null,arguments)}(u=wf).exports=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}},u.exports.__esModule=!0,u.exports.default=u.exports,e_=tt,t_=l.exports,n_=wf.exports,e_.exports=T_,e_.exports.__esModule=!0,e_.exports.default=e_.exports,Kb=Ie,Yb=p.exports,Qb=l.exports,Xb=r.exports,Zb=tt.exports,Kb.exports=C_,Kb.exports.__esModule=!0,Kb.exports.default=Kb.exports;var I_,R_,Tf={exports:{}},P_=(R_=(I_=Tf).exports,function(){var P={function:!0,object:!0}["undefined"==typeof window?"undefined":F(window)]&&window||this,n=R_,e=!I_.nodeType&&I_,t=n&&e&&"object"==F(B)&&B,s=(!t||t.global!==t&&t.window!==t&&t.self!==t||(P=t),Math.pow(2,53)-1),O=/\bOpera/,t=Object.prototype,r=t.hasOwnProperty,A=t.toString;function i(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function M(e){return e=U(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:i(e)}function D(e,t){for(var n in e)r.call(e,n)&&t(e[n],n,e)}function j(e){return null==e?i(e):A.call(e).slice(8,-1)}function L(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function N(n,r){function e(e,t){i=r(i,e,t,n)}var i=null,t=n,o=-1,a=t?t.length:0;if("number"==typeof a&&-1<a&&a<=s)for(;++o<a;)e(t[o],o);else D(t,e);return i}function U(e){return String(e).replace(/^ +| +$/g,"")}t=function e(o){var t=P,n=o&&"object"==F(o)&&"String"!=j(o),r=(n&&(t=o,o=null),t.navigator||{}),i=r.userAgent||"";o=o||i;var a,s,c,u=n?!!r.likeChrome:/\bChrome\b/.test(o)&&!/internal|\n/i.test(A.toString()),l="Object",d=n?l:"ScriptBridgingProxyObject",f=n?l:"Environment",p=n&&t.java?"JavaPackage":j(t.java),l=n?l:"RuntimeObject",p=/\bJava/.test(p)&&t.java,f=p&&j(t.environment)==f,h=p?"a":"Î±",m=p?"b":"Î²",y=t.document||{},v=t.operamini||t.opera,n=O.test(n=n&&v?v["[[Class]]"]:j(v))?n:v=null,g=o,b=[],_=null,i=o==i,w=i&&v&&"function"==typeof v.version&&v.version(),k=N([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],function(e,t){return e||RegExp("\\b"+(t.pattern||L(t))+"\\b","i").exec(o)&&(t.label||t)}),x=N(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"(?:Edge|Edg|EdgA|EdgiOS)"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Vivaldi","Waterfox","WebPositive",{label:"Yandex Browser",pattern:"YaBrowser"},{label:"UC Browser",pattern:"UCBrowser"},"Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chromium","Chrome",{label:"Chrome",pattern:"(?:HeadlessChrome)"},{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"],function(e,t){return e||RegExp("\\b"+(t.pattern||L(t))+"\\b","i").exec(o)&&(t.label||t)}),S=T([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),E=N({Apple:{iPad:1,iPhone:1,iPod:1},Alcatel:{},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},Huawei:{},Lenovo:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Oppo:{},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1},Xiaomi:{Mi:1,Redmi:1}},function(e,t,n){return e||(t[S]||t[/^[a-z]+(?: +[a-z]+\b)*/i.exec(S)]||RegExp("\\b"+L(n)+"(?:\\b|\\w*\\d)","i").exec(o))&&n}),C=N(["Windows Phone","KaiOS","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian",{label:"DragonFly BSD",pattern:"DragonFly"},"Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "],function(e,t){var n,r,i=t.pattern||L(t);return!e&&(e=RegExp("\\b"+i+"(?:/[\\d.]+|[ \\w.]*)","i").exec(o))&&(n=e,i=i,t=t.label||t,r={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"},i&&t&&/^Win/i.test(n)&&!/^Windows Phone /i.test(n)&&(r=r[/[\d.]+$/.exec(n)])&&(n="Windows "+r),n=String(n),e=M((n=i&&t?n.replace(RegExp(i,"i"),t):n).replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])),e});function T(e){return N(e,function(e,t){var n=t.pattern||L(t);return!e&&(e=RegExp("\\b"+n+" *\\d+[.\\w_]*","i").exec(o)||RegExp("\\b"+n+" *\\w+-[\\w]*","i").exec(o)||RegExp("\\b"+n+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(o))&&((e=String(t.label&&!RegExp(n,"i").test(t.label)?t.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),t=t.label||t,e=M(e[0].replace(RegExp(n,"i"),t).replace(RegExp("; *(?:"+t+"[_-])?","i")," ").replace(RegExp("("+t+")[-_.]?(\\w)","i"),"$1 $2"))),e})}function I(e){return N(e,function(e,t){return e||(RegExp(t+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(o)||0)[1]||null})}if(k=k&&[k],/\bAndroid\b/.test(C)&&!S&&(a=/\bAndroid[^;]*;(.*?)(?:Build|\) AppleWebKit)\b/i.exec(o))&&(S=U(a[1]).replace(/^[a-z]{2}-[a-z]{2};\s*/i,"")||null),E&&!S?S=T([E]):E&&(S=S&&S.replace(RegExp("^("+L(E)+")[-_.\\s]","i"),E+" ").replace(RegExp("^("+L(E)+")[-_.]?(\\w)","i"),E+" $2")),(a=/\bGoogle TV\b/.exec(S))&&(S=a[0]),/\bSimulator\b/i.test(o)&&(S=(S?S+" ":"")+"Simulator"),"Opera Mini"==x&&/\bOPiOS\b/.test(o)&&b.push("running in Turbo/Uncompressed mode"),"IE"==x&&/\blike iPhone OS\b/.test(o)?(E=(a=e(o.replace(/like iPhone OS/,""))).manufacturer,S=a.product):/^iP/.test(S)?(x=x||"Safari",C="iOS"+((a=/ OS ([\d_]+)/i.exec(o))?" "+a[1].replace(/_/g,"."):"")):"Konqueror"==x&&/^Linux\b/i.test(C)?C="Kubuntu":E&&"Google"!=E&&(/Chrome/.test(x)&&!/\bMobile Safari\b/i.test(o)||/\bVita\b/.test(S))||/\bAndroid\b/.test(C)&&/^Chrome/.test(x)&&/\bVersion\//i.test(o)?(x="Android Browser",C=/\bAndroid\b/.test(C)?C:"Android"):"Silk"==x?(/\bMobi/i.test(o)||(C="Android",b.unshift("desktop mode")),/Accelerated *= *true/i.test(o)&&b.unshift("accelerated")):"UC Browser"==x&&/\bUCWEB\b/.test(o)?b.push("speed mode"):"PaleMoon"==x&&(a=/\bFirefox\/([\d.]+)\b/.exec(o))?b.push("identifying as Firefox "+a[1]):"Firefox"==x&&(a=/\b(Mobile|Tablet|TV)\b/i.exec(o))?(C=C||"Firefox OS",S=S||a[1]):!x||(a=!/\bMinefield\b/i.test(o)&&/\b(?:Firefox|Safari)\b/.exec(x))?(x&&!S&&/[\/,]|^[^(]+?\)/.test(o.slice(o.indexOf(a+"/")+8))&&(x=null),(a=S||E||C)&&(S||E||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(C))&&(x=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(C)?C:a)+" Browser")):"Electron"==x&&(a=(/\bChrome\/([\d.]+)\b/.exec(o)||0)[1])&&b.push("Chromium "+a),w=w||I(["(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|HeadlessChrome|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$)|UCBrowser|YaBrowser)","Version",L(x),"(?:Firefox|Minefield|NetFront)"]),(a=("iCab"==k&&3<parseFloat(w)?"WebKit":/\bOpera\b/.test(x)&&(/\bOPR\b/.test(o)?"Blink":"Presto"))||(/\b(?:Midori|Nook|Safari)\b/i.test(o)&&!/^(?:Trident|EdgeHTML)$/.test(k)?"WebKit":!k&&/\bMSIE\b/i.test(o)&&("Mac OS"==C?"Tasman":"Trident"))||"WebKit"==k&&/\bPlayStation\b(?! Vita\b)/i.test(x)&&"NetFront")&&(k=[a]),"IE"==x&&(a=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(o)||0)[1])?(x+=" Mobile",C="Windows Phone "+(/\+$/.test(a)?a:a+".x"),b.unshift("desktop mode")):/\bWPDesktop\b/i.test(o)?(x="IE Mobile",C="Windows Phone 8.x",b.unshift("desktop mode"),w=w||(/\brv:([\d.]+)/.exec(o)||0)[1]):"IE"!=x&&"Trident"==k&&(a=/\brv:([\d.]+)/.exec(o))&&(x&&b.push("identifying as "+x+(w?" "+w:"")),x="IE",w=a[1]),i){if(R=null!=(c=t)?F(c.global):"number",/^(?:boolean|number|string|undefined)$/.test(R)||"object"==R&&!c.global)j(a=t.runtime)==d?(x="Adobe AIR",C=a.flash.system.Capabilities.os):j(a=t.phantom)==l?(x="PhantomJS",w=(a=a.version||null)&&a.major+"."+a.minor+"."+a.patch):"number"==typeof y.documentMode&&(a=/\bTrident\/(\d+)/i.exec(o))?(w=[w,y.documentMode],(a=+a[1]+4)!=w[1]&&(b.push("IE "+w[1]+" mode"),k&&(k[1]=""),w[1]=a),w="IE"==x?String(w[1].toFixed(1)):w[0]):"number"==typeof y.documentMode&&/^(?:Chrome|Firefox)\b/.test(x)&&(b.push("masking as "+x+" "+w),x="IE",w="11.0",k=["Trident"],C="Windows");else if(p&&(g=(a=p.lang.System).getProperty("os.arch"),C=C||a.getProperty("os.name")+" "+a.getProperty("os.version")),f){try{w=t.require("ringo/engine").version.join("."),x="RingoJS"}catch(e){(a=t.system)&&a.global.system==t.system&&(x="Narwhal",C=C||a[0].os||null)}x=x||"Rhino"}else"object"==F(t.process)&&!t.process.browser&&(a=t.process)&&("object"==F(a.versions)&&("string"==typeof a.versions.electron?(b.push("Node "+a.versions.node),x="Electron",w=a.versions.electron):"string"==typeof a.versions.nw&&(b.push("Chromium "+w,"Node "+a.versions.node),x="NW.js",w=a.versions.nw)),x||(x="Node.js",g=a.arch,C=a.platform,w=(w=/[\d.]+/.exec(a.version))?w[0]:null));C=C&&M(C)}if(w&&(a=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(w)||/(?:alpha|beta)(?: ?\d)?/i.exec(o+";"+(i&&r.appMinorVersion))||/\bMinefield\b/i.test(o)&&"a")&&(_=/b/i.test(a)?"beta":"alpha",w=w.replace(RegExp(a+"\\+?$"),"")+("beta"==_?m:h)+(/\d+\+?/.exec(a)||"")),"Fennec"==x||"Firefox"==x&&/\b(?:Android|Firefox OS|KaiOS)\b/.test(C))x="Firefox Mobile";else if("Maxthon"==x&&w)w=w.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(S))"Xbox 360"==S&&(C=null),"Xbox 360"==S&&/\bIEMobile\b/.test(o)&&b.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(x)&&(!x||S||/Browser|Mobi/.test(x))||"Windows CE"!=C&&!/Mobi/i.test(o))if("IE"==x&&i)try{null===t.external&&b.unshift("platform preview")}catch(e){b.unshift("embedded")}else(/\bBlackBerry\b/.test(S)||/\bBB10\b/.test(o))&&(a=(RegExp(S.replace(/ +/g," *")+"/([.\\d]+)","i").exec(o)||0)[1]||w)?(C=((a=[a,/BB10/.test(o)])[1]?(S=null,E="BlackBerry"):"Device Software")+" "+a[0],w=null):this!=D&&"Wii"!=S&&(i&&v||/Opera/.test(x)&&/\b(?:MSIE|Firefox)\b/i.test(o)||"Firefox"==x&&/\bOS X (?:\d+\.){2,}/.test(C)||"IE"==x&&(C&&!/^Win/.test(C)&&5.5<w||/\bWindows XP\b/.test(C)&&8<w||8==w&&!/\bTrident\b/.test(o)))&&!O.test(a=e.call(D,o.replace(O,"")+";"))&&a.name&&(a="ing as "+a.name+((a=a.version)?" "+a:""),O.test(x)?(/\bIE\b/.test(a)&&"Mac OS"==C&&(C=null),a="identify"+a):(a="mask"+a,x=n?M(n.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(a)&&(C=null),i||(w=null)),k=["Presto"],b.push(a));else x+=" Mobile";(a=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(o)||0)[1])&&(a=[parseFloat(a.replace(/\.(\d)$/,".0$1")),a],"Safari"==x&&"+"==a[1].slice(-1)?(x="WebKit Nightly",_="alpha",w=a[1].slice(0,-1)):w!=a[1]&&w!=(a[2]=(/\bSafari\/([\d.]+\+?)/i.exec(o)||0)[1])||(w=null),a[1]=(/\b(?:Headless)?Chrome\/([\d.]+)/i.exec(o)||0)[1],537.36==a[0]&&537.36==a[2]&&28<=parseFloat(a[1])&&"WebKit"==k&&(k=["Blink"]),a=i&&(u||a[1])?(k&&(k[1]="like Chrome"),a[1]||((a=a[0])<530?1:a<532?2:a<532.05?3:a<533?4:a<534.03?5:a<534.07?6:a<534.1?7:a<534.13?8:a<534.16?9:a<534.24?10:a<534.3?11:a<535.01?12:a<535.02?"13+":a<535.07?15:a<535.11?16:a<535.19?17:a<536.05?18:a<536.1?19:a<537.01?20:a<537.11?"21+":a<537.13?23:a<537.18?24:a<537.24?25:a<537.36?26:"Blink"!=k?"27":"28")):(k&&(k[1]="like Safari"),(a=a[0])<400?1:a<500?2:a<526?3:a<533?4:a<534?"4+":a<535?5:a<537?6:a<538?7:a<601?8:a<602?9:a<604?10:a<606?11:a<608?12:"12"),k&&(k[1]+=" "+(a+="number"==typeof a?".x":/[.+]/.test(a)?"":"+")),"Safari"==x&&(!w||45<parseInt(w))?w=a:"Chrome"==x&&/\bHeadlessChrome/i.test(o)&&b.unshift("headless")),"Opera"==x&&(a=/\bzbov|zvav$/.exec(C))?(x+=" ",b.unshift("desktop mode"),"zvav"==a?(x+="Mini",w=null):x+="Mobile",C=C.replace(RegExp(" *"+a+"$"),"")):"Safari"==x&&/\bChrome\b/.exec(k&&k[1])?(b.unshift("desktop mode"),x="Chrome Mobile",w=null,C=/\bOS X\b/.test(C)?(E="Apple","iOS 4.3+"):null):/\bSRWare Iron\b/.test(x)&&!w&&(w=I("Chrome")),(C=w&&0==w.indexOf(a=/[\d.]+$/.exec(C))&&-1<o.indexOf("/"+a+"-")?U(C.replace(a,"")):C)&&-1!=C.indexOf(x)&&!RegExp(x+" OS").test(C)&&(C=C.replace(RegExp(" *"+L(x)+" *"),"")),k&&!/\b(?:Avant|Nook)\b/.test(x)&&(/Browser|Lunascape|Maxthon/.test(x)||"Safari"!=x&&/^iOS/.test(C)&&/\bSafari\b/.test(k[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|SRWare Iron|Vivaldi|Web)/.test(x)&&k[1])&&(a=k[k.length-1])&&b.push(a),b.length&&(b=["("+b.join("; ")+")"]),E&&S&&S.indexOf(E)<0&&b.push("on "+E),S&&b.push((/^on /.test(b[b.length-1])?"":"on ")+S),C&&(a=/ ([\d.+]+)$/.exec(C),s=a&&"/"==C.charAt(C.length-a[0].length-1),C={architecture:32,family:a&&!s?C.replace(a[0],""):C,version:a?a[1]:null,toString:function(){var e=this.version;return this.family+(e&&!s?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(a=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(g))&&!/\bi686\b/i.test(g)?(C&&(C.architecture=64,C.family=C.family.replace(RegExp(" *"+a),"")),x&&(/\bWOW64\b/i.test(o)||i&&/\w(?:86|32)$/.test(r.cpuClass||r.platform)&&!/\bWin64; x64\b/i.test(o))&&b.unshift("32-bit")):C&&/^OS X/.test(C.family)&&"Chrome"==x&&39<=parseFloat(w)&&(C.architecture=64),o=o||null;var R={};return R.description=o,R.layout=k&&k[0],R.manufacturer=E,R.name=x,R.prerelease=_,R.product=S,R.ua=o,R.version=x&&w,R.os=C||{architecture:null,family:null,version:null,toString:function(){return"null"}},R.parse=e,R.toString=function(){return this.description||""},R.version&&b.unshift(w),R.name&&b.unshift(x),C&&x&&(C!=String(C).split(" ")[0]||C!=x.split(" ")[0]&&!S)&&b.push(S?"("+C+")":"on "+C),b.length&&(R.description=b.join(" ")),R}();n&&e?D(t,function(e,t){n[t]=e}):P.platform=t}.call(B),ne),O_=ot,A_=Pn,M_=V,D_=Ju,j_=$u,_=(Hu("match",function(r,s,c){return[function(e){var t=M_(this),n=null==e?void 0:e[r];return void 0!==n?n.call(e,t):new RegExp(e)[r](A_(t))},function(e){var t=P_(this),n=A_(e),e=c(s,t,n);if(e.done)return e.value;if(!t.global)return j_(t,n);for(var r=t.unicode,i=[],o=t.lastIndex=0;null!==(a=j_(t,n));){var a=A_(a[0]);""===(i[o]=a)&&(t.lastIndex=D_(n,O_(t.lastIndex),r)),o++}return 0===o?null:i}]}),Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}),L_=ne,N_=V,U_=_,F_=Pn,B_=$u,fv=(Hu("search",function(r,i,o){return[function(e){var t=N_(this),n=null==e?void 0:e[r];return void 0!==n?n.call(e,t):new RegExp(e)[r](F_(t))},function(e){var t=L_(this),e=F_(e),n=o(i,t,e);return n.done?n.value:(n=t.lastIndex,U_(n,0)||(t.lastIndex=0),e=B_(t,e),U_(t.lastIndex,n)||(t.lastIndex=n),null===e?-1:e.index)}]}),i),q_=at,z_=it,W_=ot,G_=Y,V_=Mn,H_=Wn,dv=zn("splice"),J_=Math.max,$_=Math.min,x=(fv({target:"Array",proto:!0,forced:!dv},{splice:function(e,t){var n,r,i,o,a,s,c=G_(this),u=W_(c.length),l=q_(e,u),e=arguments.length;if(0===e?n=r=0:r=1===e?(n=0,u-l):(n=e-2,$_(J_(z_(t),0),u-l)),9007199254740991<u+n-r)throw TypeError("Maximum allowed length exceeded");for(i=V_(c,r),o=0;o<r;o++)(a=l+o)in c&&H_(i,o,c[a]);if(n<(i.length=r)){for(o=l;o<u-r;o++)s=o+n,(a=o+r)in c?c[s]=c[a]:delete c[s];for(o=u;u-r+n<o;o--)delete c[o-1]}else if(r<n)for(o=u-r;l<o;o--)s=o+n-1,(a=o+r-1)in c?c[s]=c[a]:delete c[s];for(o=0;o<n;o++)c[o+l]=arguments[o+2];return c.length=u-r+n,i}}),Mm),K_="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},k=(Object.defineProperty(x,"__esModule",{value:!0}),f.exports),ur=m.exports,w=_f.exports,ii=h.exports,No=a.exports,Ce=p.exports,ai=c.exports,mi=xf.exports,u=Rf,wf=lr.exports,l=d,r=Tr.exports,tt=Cf.exports,Y_=sy,_=Ie.exports,Q_=If,fv=Tf.exports;function X_(e){return e&&"object"===F(e)&&"default"in e?e:{default:e}}function Z_(n){var r;return n&&n.__esModule?n:(r=Object.create(null),n&&Object.keys(n).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(n,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return n[e]}}))}),r.default=n,Object.freeze(r))}var e0=X_(hn.exports),t0=X_(k),n0=X_(ur),r0=X_(w),i0=X_(ii),o0=X_(No),a0=X_(Ce),s0=X_(ai),c0=X_(mi),S=X_(u),u0=X_(wf),k=Z_(r),l0=Z_(tt),ur=X_(_),d0=Z_(fv);function f0(){}function p0(){p0.init.call(this)}function h0(e){return void 0===e._maxListeners?p0.defaultMaxListeners:e._maxListeners}function m0(e,t,n,r){var i,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return(i=e._events)?(i.newListener&&(e.emit("newListener",t,n.listener||n),i=e._events),o=i[t]):(i=e._events=new f0,e._eventsCount=0),o?("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(r=h0(e))&&0<r&&o.length>r&&(o.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",r.emitter=e,r.type=t,r.count=o.length,r=r,"function"==typeof console.warn?console.warn(r):console.log(r))):(o=i[t]=n,++e._eventsCount),e}function y0(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function v0(e){var t=this._events;if(t){t=t[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function g0(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}f0.prototype=Object.create(null),(p0.EventEmitter=p0).usingDomains=!1,p0.prototype.domain=void 0,p0.prototype._events=void 0,p0.prototype._maxListeners=void 0,p0.defaultMaxListeners=10,p0.init=function(){this.domain=null,p0.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new f0,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},p0.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},p0.prototype.getMaxListeners=function(){return h0(this)},p0.prototype.emit=function(e){var t,n,r,i,o,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(s=this.domain,a){if(a=arguments[1],s)return(a=a||new Error('Uncaught, unspecified "error" event')).domainEmitter=this,a.domain=s,a.domainThrown=!1,s.emit("error",a),!1;if(a instanceof Error)throw a;var s=new Error('Uncaught, unspecified "error" event. ('+a+")");throw s.context=a,s}if(!(t=o[e]))return!1;var c="function"==typeof t;switch(n=arguments.length){case 1:var u=t,l=c,d=this;if(l)u.call(d);else for(var f=u.length,j=g0(u,f),p=0;p<f;++p)j[p].call(d);break;case 2:var l=t,u=c,h=this,m=arguments[1];if(u)l.call(h,m);else for(var y=l.length,L=g0(l,y),v=0;v<y;++v)L[v].call(h,m);break;case 3:var g=t,b=c,_=this,w=arguments[1],k=arguments[2];if(b)g.call(_,w,k);else for(var x=g.length,N=g0(g,x),S=0;S<x;++S)N[S].call(_,w,k);break;case 4:var b=t,g=c,E=this,C=arguments[1],T=arguments[2],I=arguments[3];if(g)b.call(E,C,T,I);else for(var R=b.length,U=g0(b,R),P=0;P<R;++P)U[P].call(E,C,T,I);break;default:for(r=new Array(n-1),i=1;i<n;i++)r[i-1]=arguments[i];var O=t,F=c,A=this,M=r;if(F)O.apply(A,M);else for(var B=O.length,q=g0(O,B),D=0;D<B;++D)q[D].apply(A,M)}return!0},p0.prototype.on=p0.prototype.addListener=function(e,t){return m0(this,e,t,!1)},p0.prototype.prependListener=function(e,t){return m0(this,e,t,!0)},p0.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,y0(this,e,t)),this},p0.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,y0(this,e,t)),this},p0.prototype.removeListener=function(e,t){var n,r,i,o,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if((r=this._events)&&(n=r[e]))if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new f0:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length;0<o--;)if(n[o]===t||n[o].listener&&n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new f0,this;delete r[e]}else{var s=n;for(var c=i,u=c+1,l=s.length;u<l;c+=1,u+=1)s[c]=s[u];s.pop()}r.removeListener&&this.emit("removeListener",e,a||t)}return this},p0.prototype.off=function(e,t){return this.removeListener(e,t)},p0.prototype.removeAllListeners=function(e){var t,n;if(n=this._events)if(n.removeListener){if(0===arguments.length){for(var r,i=Object.keys(n),o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);this.removeAllListeners("removeListener"),this._events=new f0,this._eventsCount=0}else if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(;this.removeListener(e,t[t.length-1]),t[0];);}else 0===arguments.length?(this._events=new f0,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new f0:delete n[e]);return this},p0.prototype.listeners=function(e){var t=this._events;{if(t&&(t=t[e])){if("function"==typeof t)return[t.listener||t];for(var n=t,r=new Array(n.length),i=0;i<r.length;++i)r[i]=n[i].listener||n[i];return r}return[]}},p0.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):v0.call(e,t)},p0.prototype.listenerCount=v0,p0.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};var b0=k.getLogger("twilsock");function _0(e,t){return["".concat((new Date).toISOString()," Twilsock ").concat(e,":")].concat(Array.from(t))}function w0(e){s0.default(this,w0),this.id=e||"TM".concat(Y_.v4())}t0.default(S0,[{key:"setLevel",value:function(e){b0.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.trace.apply(null,_0("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.debug.apply(null,_0("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.info.apply(null,_0("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.warn.apply(null,_0("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.error.apply(null,_0("E",t))}}],[{key:"setLevel",value:function(e){b0.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.trace.apply(null,_0("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.debug.apply(null,_0("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.info.apply(null,_0("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.warn.apply(null,_0("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];b0.error.apply(null,_0("E",t))}}]);var E=new S0(""),k0=(t0.default(x0,[{key:"token",get:function(){return this._token}},{key:"continuationToken",get:function(){return this._continuationToken}},{key:"updateToken",value:function(e){this._token=e}},{key:"updateContinuationToken",value:function(e){this._continuationToken=e}}]),x0);function x0(e,t,n){s0.default(this,x0),c0.default(this,"confirmedCapabilities",new Set),this.activeGrant=t,this._token=e;t=n.region||"us1",e="wss://tsock.".concat(t,".twilio.com/v3/wsconnect"),t=n.twilsock||n.Twilsock||{};this.url=t.uri||e,this._continuationToken=n.continuationToken||null,this.logLevel=n.logLevel||"error",this.retryPolicy=n.retryPolicy||{min:1e3,max:12e4,randomness:.2},this.clientMetadata=n.clientMetadata||{},this.clientMetadata.ver="0.12.2",this.initRegistrations=n.initRegistrations||null,this.tweaks=n.tweaks||null}function S0(e){s0.default(this,S0),c0.default(this,"prefix",""),this.prefix=null!=e&&0<e.length?" "+e+":":""}var E0=function(){i0.default(s,w0);n=s,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,a=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function s(e,t,n,r,i){var o;return s0.default(this,s),o=a.call(this),c0.default(n0.default(o),"method","init"),o.token=e,o.continuation_token=t,o.metadata=n,o.registrations=r,o.tweaks=i,o.capabilities=["client_update","offline_storage","telemetry.v1"],o}return s}(),C0=function(){i0.default(c,w0);n=c,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,s=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function c(e,t,n,r,i,o,a){return s0.default(this,c),(e=s.call(this,e)).continuationToken=t,e.continuationTokenStatus=r,e.offlineStorage=i,e.initRegistrations=o,e.debugInfo=a,e.confirmedCapabilities=n,e}return c}(),T0=function(){i0.default(o,w0);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e){var t;return s0.default(this,o),t=i.call(this),c0.default(n0.default(t),"method","update"),t.token=e,t}return o}(),I0=function(){i0.default(o,w0);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e,t,n){var r;return s0.default(this,o),r=i.call(this),c0.default(n0.default(r),"method","message"),r.active_grant=e,r.payload_type=t,r.http_request=n,r}return o}(),R0=function(){i0.default(i,w0);n=i,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,t=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function i(e){return s0.default(this,i),e=t.call(this,e),c0.default(n0.default(e),"method","reply"),c0.default(n0.default(e),"payload_type","application/json"),c0.default(n0.default(e),"status",{code:200,status:"OK"}),e}return i}(),P0=function(){i0.default(i,w0);n=i,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,t=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function i(){var e;return s0.default(this,i),e=t.call(this),c0.default(n0.default(e),"method","close"),e}return i}();function O0(e,t,n,r,i,o){s0.default(this,O0),this.start=e,this.end=t,this.title=n,this.details=r,this.id=i,this.type=o}var A0=function(){i0.default(o,w0);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e){var t;return s0.default(this,o),t=i.call(this),c0.default(n0.default(t),"method","telemetry.v1"),t.events=e,t}return o}();function M0(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(Number("0x"+t))}).length}function D0(e){e=Array.prototype.map.call(e,function(e){return String.fromCharCode(e)}).join("").replace(/(.)/g,function(e,t){t=t.charCodeAt(0).toString(16).toUpperCase();return"%"+(t=t.length<2?"0"+t:t)});return decodeURIComponent(e)}function j0(e){return JSON.parse(D0(e))}t0.default(N0,null,[{key:"parse",value:function(e){var t,n,r=new Uint8Array(e),i=function(e){for(var t="",n=0;n<e.length;++n){var r=String.fromCharCode(e[n]);if(t+=r,"\r"===r){n+=2;break}}var i=t.split(" ");return{size:n,protocol:i[0],version:i[1],headerSize:Number(i[2])}}(r);if("TWILSOCK"!==i.protocol||"V3.0"!==i.version)return E.error("unsupported protocol: ".concat(i.protocol," ver ").concat(i.version)),null;try{t=j0(r.subarray(i.size,i.size+i.headerSize))}catch(t){return E.error("failed to parse message header",t,e),null}if(E.debug("message received: ",t.method),E.trace("message received: ",t),0<t.payload_size){var i=2+i.size+i.headerSize,o=t.payload_size;if(t.hasOwnProperty("payload_type")&&0!==t.payload_type.indexOf("application/json"))0===t.payload_type.indexOf("text/plain")&&(n=D0(r.subarray(i,i+o)));else try{n=j0(r.subarray(i,i+o))}catch(t){return E.error("failed to parse message body",t,e),null}}return{method:t.method,header:t,payload:n}}},{key:"createPacket",value:function(e){var n,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",e=(e.payload_size=M0(t),JSON.stringify(e)),r="TWILSOCK V3.0 "+M0(e);return E.debug("send request:",r+e+t),r=r+"\r\n"+e+"\r\n"+t,r=encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(Number("0x"+t))}),n=new Uint8Array(r.length),Array.prototype.forEach.call(r,function(e,t){n[t]=e.charCodeAt(0)}),n.buffer}}]);var L0=N0;function N0(){s0.default(this,N0)}var U0=function(e){i0.default(i,e);n=i,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,t=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function i(e){return s0.default(this,i),t.call(this,e)}return i}(ur.default(Error)),F0=function(e){i0.default(o,e);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e,t){return s0.default(this,o),(e=i.call(this,e)).reply=t,e}return o}(U0);function B0(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function q0(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?B0(Object(n),!0).forEach(function(e){c0.default(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):B0(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var z0=function(){i0.default(o,p0);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e){var t;return s0.default(this,o),t=i.call(this),c0.default(n0.default(t),"newBackoff",null),c0.default(n0.default(t),"usedBackoff",null),c0.default(n0.default(t),"retrier",null),t.options=e?q0({},e):{},t}return t0.default(o,[{key:"inProgress",get:function(){return!!this.retrier}},{key:"start",value:function(){if(this.inProgress)throw new Error("Already waiting for next attempt, call finishAttempt(success : boolean) to finish it");this.createRetrier()}},{key:"stop",value:function(){this.cleanRetrier(),this.newBackoff=null,this.usedBackoff=null}},{key:"modifyBackoff",value:function(e){this.newBackoff=e}},{key:"attemptFailed",value:function(){if(!this.inProgress)throw new Error("No attempt is in progress");var e;this.newBackoff?!this.usedBackoff||this.usedBackoff<this.newBackoff?this.createRetrier():null!=(e=this.retrier)&&e.failed(new Error):null!=(e=this.retrier)&&e.failed(new Error)}},{key:"cancel",value:function(){var e;null!=(e=this.retrier)&&e.cancel()}},{key:"cleanRetrier",value:function(){var e;null!=(e=this.retrier)&&e.removeAllListeners(),null!=(e=this.retrier)&&e.cancel(),this.retrier=null}},{key:"getRetryPolicy",value:function(){var e=q0({},this.options);return this.newBackoff&&(e.min=this.newBackoff,e.max=this.options.max&&this.options.max>this.newBackoff?this.options.max:this.newBackoff),e.maxAttemptsCount=this.options.maxAttemptsCount?this.options.maxAttemptsCount+1:void 0,e}},{key:"createRetrier",value:function(){var t=this,e=(this.cleanRetrier(),this.getRetryPolicy());this.retrier=new Q_.Retrier(e),this.retrier.once("attempt",function(){var e;null!=(e=t.retrier)&&e.on("attempt",function(){return t.emit("attempt")}),null!=(e=t.retrier)&&e.failed(new Error("Skipping first attempt"))}),this.retrier.on("failed",function(e){return t.emit("failed",e)}),this.usedBackoff=this.newBackoff,this.newBackoff=null,this.retrier.start()}}]),o}(),W0=function(){i0.default(o,p0);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var e,t,n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e,t,n){s0.default(this,o),r=i.call(this),c0.default(n0.default(r),"disconnectingTimer",null),c0.default(n0.default(r),"disconnectedPromiseResolve",null),c0.default(n0.default(r),"terminalStates",["disconnected","rejected"]),c0.default(n0.default(r),"tokenExpiredSasCode",20104),c0.default(n0.default(r),"terminationReason","Connection is not initialized"),r.websocket=e,r.websocket.on("connected",function(){return r.fsm.socketConnected()}),r.websocket.on("disconnected",function(){return r.fsm.socketClosed()}),r.websocket.on("message",function(e){return r.onIncomingMessage(e)}),r.websocket.on("socketError",function(e){return r.emit("connectionError",{terminal:!1,message:"Socket error: ".concat(e.message),httpStatusCode:null,errorCode:null})}),r.transport=t,r.config=n,r.retrier=new z0(n.retryPolicy),r.retrier.on("attempt",function(){return r.retry()}),r.retrier.on("failed",function(e){E.warn("Retrying failed: ".concat(e.message)),r.disconnect()}),"undefined"!=typeof window&&void 0!==window.addEventListener&&(window.addEventListener("online",function(){E.debug("Browser reported connectivity state: online"),r.resetBackoff(),r.fsm.systemOnline()}),window.addEventListener("offline",function(){E.debug("Browser reported connectivity state: offline"),r.websocket.close(),r.fsm.socketClosed()}));var r,e=l0.factory({init:"disconnected",transitions:[{name:"userConnect",from:["disconnected","rejected"],to:"connecting"},{name:"userConnect",from:["connecting","connected"]},{name:"userDisconnect",from:["connecting","initialising","connected","updating","retrying","rejected","waitSocketClosed","waitOffloadSocketClosed"],to:"disconnecting"},{name:"userRetry",from:["retrying"],to:"connecting"},{name:"socketConnected",from:["connecting"],to:"initialising"},{name:"socketClosed",from:["connecting","initialising","connected","updating","error","waitOffloadSocketClosed"],to:"retrying"},{name:"socketClosed",from:["disconnecting"],to:"disconnected"},{name:"socketClosed",from:["waitSocketClosed"],to:"disconnected"},{name:"socketClosed",from:["rejected"],to:"rejected"},{name:"initSuccess",from:["initialising"],to:"connected"},{name:"initError",from:["initialising"],to:"error"},{name:"tokenRejected",from:["initialising","updating"],to:"rejected"},{name:"protocolError",from:["initialising","connected","updating"],to:"error"},{name:"receiveClose",from:["initialising","connected","updating"],to:"waitSocketClosed"},{name:"receiveOffload",from:["initialising","connected","updating"],to:"waitOffloadSocketClosed"},{name:"unsupportedProtocol",from:["initialising","connected","updating"],to:"unsupported"},{name:"receiveFatalClose",from:["initialising","connected","updating"],to:"unsupported"},{name:"userUpdateToken",from:["disconnected","rejected","connecting","retrying"],to:"connecting"},{name:"userUpdateToken",from:["connected"],to:"updating"},{name:"updateSuccess",from:["updating"],to:"connected"},{name:"updateError",from:["updating"],to:"error"},{name:"userSend",from:["connected"],to:"connected"},{name:"systemOnline",from:["retrying"],to:"connecting"}],methods:{onConnecting:function(){r.setupSocket(),r.emit("connecting")},onEnterInitialising:function(){r.sendInit()},onLeaveInitialising:function(){r.cancelInit()},onEnterUpdating:function(){r.sendUpdate()},onLeaveUpdating:function(){r.cancelUpdate()},onEnterRetrying:function(){r.initRetry(),r.emit("connecting")},onEnterConnected:function(){r.resetBackoff(),r.onConnected()},onUserUpdateToken:function(){r.resetBackoff()},onTokenRejected:function(){r.resetBackoff(),r.closeSocket(!0),r.finalizeSocket()},onUserDisconnect:function(){r.closeSocket(!0)},onEnterDisconnecting:function(){r.startDisconnectTimer()},onLeaveDisconnecting:function(){r.cancelDisconnectTimer()},onEnterWaitSocketClosed:function(){r.startDisconnectTimer()},onLeaveWaitSocketClosed:function(){r.cancelDisconnectTimer()},onEnterWaitOffloadSocketClosed:function(){r.startDisconnectTimer()},onLeaveWaitOffloadSocketClosed:function(){r.cancelDisconnectTimer()},onDisconnected:function(){r.resetBackoff(),r.finalizeSocket()},onReceiveClose:function(){r.onCloseReceived()},onReceiveOffload:function(e,t){E.debug("onreceiveoffload: ",t),r.modifyBackoff(t.body),r.onCloseReceived()},onUnsupported:function(){r.closeSocket(!0),r.finalizeSocket()},onError:function(e,t){r.closeSocket(t),r.finalizeSocket()},onEnterState:function(e){"none"!==e.from&&r.changeState(e)},onInvalidTransition:function(e,t,n){E.warn("FSM: unexpected transition",t,n)}}});return r.fsm=new e,r}return t0.default(o,[{key:"changeState",value:function(e){E.debug("FSM: ".concat(e.transition,": ").concat(e.from," --\x3e ").concat(e.to)),this.lastEmittedState!==this.state&&(this.lastEmittedState=this.state,this.emit("stateChanged",this.state))}},{key:"resetBackoff",value:function(){E.trace("resetBackoff"),this.retrier.stop()}},{key:"modifyBackoff",value:function(e){E.trace("modifyBackoff",e);e=e?e.backoff_policy:null;e&&"number"==typeof e.reconnect_min_ms&&this.retrier.modifyBackoff(e.reconnect_min_ms)}},{key:"startDisconnectTimer",value:function(){var e=this;E.trace("startDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null),this.disconnectingTimer=setTimeout(function(){E.debug("disconnecting is timed out"),e.closeSocket(!0)},3e3)}},{key:"cancelDisconnectTimer",value:function(){E.trace("cancelDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null)}},{key:"isConnected",get:function(){return"connected"===this.state&&this.websocket.isConnected}},{key:"state",get:function(){switch(this.fsm.state){case"connecting":case"initialising":case"retrying":case"error":return"connecting";case"updating":case"connected":return"connected";case"rejected":return"denied";case"disconnecting":case"waitSocketClosed":case"waitOffloadSocketClosed":return"disconnecting";default:return"disconnected"}}},{key:"initRetry",value:function(){E.debug("initRetry"),this.retrier.inProgress?this.retrier.attemptFailed():this.retrier.start()}},{key:"retry",value:function(){"connecting"!=this.fsm.state?(E.trace("retry"),this.websocket.close(),this.fsm.userRetry()):E.trace("can\t retry as already connecting")}},{key:"onConnected",value:function(){this.emit("connected")}},{key:"finalizeSocket",value:function(){E.trace("finalizeSocket"),this.websocket.close(),this.emit("disconnected"),this.disconnectedPromiseResolve&&(this.disconnectedPromiseResolve(),this.disconnectedPromiseResolve=null)}},{key:"setupSocket",value:function(){E.trace("setupSocket:",this.config.token),this.emit("beforeConnect"),this.websocket.connect()}},{key:"onIncomingMessage",value:function(e){var t,n,e=L0.parse(e);e&&(n=e.method,t=e.header,e=e.payload,"reply"!==n&&this.confirmReceiving(t),"notification"===n?this.emit("message",t.message_type,e):"reply"===t.method?this.transport.processReply({id:t.id,status:t.status,header:t,body:e}):"client_update"===t.method?"token_about_to_expire"===t.client_update_type&&this.emit("tokenAboutToExpire"):"close"===t.method&&(308===t.status.code?(E.debug("Connection has been offloaded"),this.fsm.receiveOffload({status:t.status.status,body:e})):406===t.status.code?(n="Server closed connection because can't parse protocol: ".concat(JSON.stringify(t.status)),this.emitReplyConnectionError(n,t,!0),E.error(n),this.fsm.receiveFatalClose()):417===t.status.code?(E.error("Server closed connection because can't parse client reply: ".concat(JSON.stringify(t.status))),this.fsm.receiveFatalClose(t.status.status)):410===t.status.code?(E.warn("Server closed connection: ".concat(JSON.stringify(t.status))),this.fsm.receiveClose(t.status.status),this.emit("tokenExpired")):401===t.status.code?(E.error("Server closed connection: ".concat(JSON.stringify(t.status))),this.fsm.receiveClose(t.status.status)):(E.warn("unexpected message: ",t.status),this.fsm.receiveOffload({status:t.status.status,body:null}))))}},{key:"sendInit",value:(t=e0.default(S.default.mark(function e(){var t;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return E.trace("sendInit"),e.prev=1,this.emit("beforeSendInit"),e.next=5,this.transport.sendInit();case 5:t=e.sent,this.config.updateContinuationToken(t.continuationToken),this.config.confirmedCapabilities=t.confirmedCapabilities,this.fsm.initSuccess(t),this.emit("initialized",t),this.emit("tokenUpdated"),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(1),e.t0 instanceof F0?(t=!1,E.warn("Init rejected by server: ".concat(JSON.stringify(e.t0.reply.status))),this.emit("sendInitFailed"),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(t=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):429===e.t0.reply.status.code?(this.modifyBackoff(e.t0.reply.body),this.fsm.initError(!0)):500===e.t0.reply.status.code?this.fsm.initError(!1):this.fsm.initError(!0),this.emitReplyConnectionError(e.t0.message,e.t0.reply,t)):(this.terminationReason=e.t0.message,this.emit("connectionError",{terminal:!0,message:"Unknown error during connection initialisation: ".concat(e.t0.message,"\n").concat(JSON.stringify(e.t0,null,2)),httpStatusCode:null,errorCode:null}),this.fsm.initError(!0)),this.emit("tokenUpdated",e.t0);case 17:case"end":return e.stop()}},e,this,[[1,13]])})),function(){return t.apply(this,arguments)})},{key:"sendUpdate",value:(e=e0.default(S.default.mark(function e(){var t,n;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return E.trace("sendUpdate"),t=new T0(this.config.token),e.prev=2,e.next=5,this.transport.sendWithReply(t);case 5:t=e.sent,this.fsm.updateSuccess(t.body),this.emit("tokenUpdated"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),e.t0 instanceof F0?(n=!1,E.warn("Token update rejected by server: ".concat(JSON.stringify(e.t0.reply.status))),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(n=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):(429===e.t0.reply.status.code&&this.modifyBackoff(e.t0.reply.body),this.fsm.updateError(e.t0.reply.status)),this.emitReplyConnectionError(e.t0.message,e.t0.reply,n)):(this.emit("error",!1,e.t0.message,null,null),this.fsm.updateError(e.t0)),this.emit("tokenUpdated",e.t0);case 14:case"end":return e.stop()}},e,this,[[2,10]])})),function(){return e.apply(this,arguments)})},{key:"emitReplyConnectionError",value:function(e,t,n){var e=t.status&&t.status.description?t.status.description:e,r=t.status.code,t=t.status&&t.status.errorCode?t.status.errorCode:null;n&&(this.terminationReason=e),this.emit("connectionError",{terminal:n,message:"Connection error: ".concat(e),httpStatusCode:r,errorCode:t})}},{key:"cancelInit",value:function(){E.trace("cancelInit")}},{key:"cancelUpdate",value:function(){E.trace("cancelUpdate")}},{key:"confirmReceiving",value:function(e){E.trace("confirmReceiving");try{this.transport.send(new R0(e.id))}catch(e){E.debug("failed to confirm packet receiving",e)}}},{key:"closeSocket",value:function(e){var t=this;E.trace("closeSocket (graceful: ".concat(e,")")),e&&this.transport.isConnected&&this.transport.sendClose(),this.websocket.close(),setTimeout(function(){return t.fsm.socketClosed()},0)}},{key:"connect",value:function(){E.trace("connect"),this.fsm.userConnect()}},{key:"disconnect",value:function(){var t=this;return E.trace("disconnect"),this.fsm.is("disconnected")?Promise.resolve():new Promise(function(e){t.disconnectedPromiseResolve=e,t.fsm.userDisconnect()})}},{key:"updateToken",value:function(e){var r=this;return E.trace("updateToken:",e),new Promise(function(t,n){r.once("tokenUpdated",function(e){e?n(e):t()}),r.fsm.userUpdateToken()})}},{key:"isTerminalState",get:function(){return-1!==this.terminalStates.indexOf(this.fsm.state)}},{key:"getTerminationReason",get:function(){return this.terminationReason}},{key:"onCloseReceived",value:function(){this.websocket.close()}}]),o}(),G0=(t0.default(V0,null,[{key:"getMetadata",value:function(e){var t=e&&e.clientMetadata?e.clientMetadata:{},n={env:null!=(e=d0.name)?e:"unknown",envv:null!=(e=d0.version)?e:"unknown",os:null!=(e=null==(e=d0.os)?void 0:e.family)?e:"unknown",osv:null!=(e=null==(e=d0.os)?void 0:e.version)?e:"unknown",osa:null!=(e=null==(e=d0.os)?void 0:e.architecture)?e:"unknown",sdk:"js-default"},r={};return["ver","env","envv","os","osv","osa","type","sdk","sdkv","dev","devv","devt","app","appv"].filter(function(e){return e in t||e in n}).forEach(function(e){return r[e]=(e in t?t:n)[e]}),r}}]),V0);function V0(){s0.default(this,V0)}t0.default($0,[{key:"isConnected",get:function(){return this.channel.isConnected}},{key:"processReply",value:function(e){var t,n=this.activeRequests.get(e.id);n&&(clearTimeout(n.timeout),this.activeRequests.delete(e.id),200<=(t=e.status.code)&&t<300?n.resolve(e):(n.reject(new F0("Transport failure: "+e.status.status,e)),E.trace("message rejected")))}},{key:"storeRequest",value:function(e,t,n){t={resolve:t,reject:n,timeout:setTimeout(function(){E.trace("request",e,"is timed out"),n(new U0("Twilsock: request timeout: "+e))},3e4)};this.activeRequests.set(e,t)}},{key:"shutdown",value:function(){this.activeRequests.forEach(function(e){clearTimeout(e.timeout),e.reject(new U0("Twilsock: request cancelled by user"))}),this.activeRequests.clear()}},{key:"sendInit",value:(H0=e0.default(S.default.mark(function e(){var t;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return E.trace("sendInit"),t=G0.getMetadata(this.config),t=new E0(this.config.token,this.config.continuationToken,t,this.config.initRegistrations,this.config.tweaks),e.next=5,this.sendWithReply(t);case 5:return t=e.sent,e.abrupt("return",new C0(t.id,t.header.continuation_token,new Set(t.header.capabilities),t.header.continuation_token_status,t.header.offline_storage,t.header.init_registrations,t.header.debug_info));case 7:case"end":return e.stop()}},e,this)})),function(){return H0.apply(this,arguments)})},{key:"sendClose",value:function(){var e=new P0;this.send(e)}},{key:"sendWithReply",value:function(r,i){var o=this;return new Promise(function(e,t){var n=o.send(r,i);o.storeRequest(n,e,t)})}},{key:"send",value:function(e,t){e.id=e.id||"TM".concat(Y_.v4());var n=L0.createPacket(e,function(e){switch(u0.default(e)){case"undefined":return"";case"object":return JSON.stringify(e);default:return e}}(t));try{return this.channel.send(n),e.id}catch(t){throw E.debug("failed to send ",e,t),E.trace(t.stack),t}}}]);var H0,J0=$0;function $0(e,t){var n=this;s0.default(this,$0),this.config=t,this.activeRequests=new Map,this.channel=e,this.channel.on("reply",function(e){return n.processReply(e)}),this.channel.on("disconnected",function(){n.activeRequests.forEach(function(e){clearTimeout(e.timeout),e.reject(new U0("disconnected"))}),n.activeRequests.clear()})}var K0=function(){i0.default(o,p0);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e){var t;return s0.default(this,o),t=i.call(this),c0.default(n0.default(t),"socket",null),t.url=e,t.url=e,t.WebSocket=K_.WebSocket||K_.MozWebSocket||{},t}return t0.default(o,[{key:"isConnected",get:function(){return!!this.socket&&1===this.socket.readyState}},{key:"connect",value:function(){var e,t=this;E.trace("connecting to socket");try{e=new this.WebSocket(this.url)}catch(e){return E.debug("Socket error: ".concat(this.url)),void this.emit("socketError",e)}e.binaryType="arraybuffer",e.onopen=function(){E.debug("socket opened ".concat(t.url)),t.emit("connected")},e.onclose=function(e){E.debug("socket closed",e),t.emit("disconnected",e)},e.onerror=function(e){E.debug("Socket error:",e),t.emit("socketError",e)},e.onmessage=function(e){t.emit("message",e.data)},this.socket=e}},{key:"send",value:function(e){return this.socket&&this.socket.send(e)}},{key:"close",value:function(){E.trace("closing socket"),this.socket&&(this.socket.onopen=null,this.socket.onclose=null,this.socket.onerror=null,this.socket.onmessage=null,this.socket.close())}}]),o}(),Y0=function(){i0.default(u,p0);a=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,n,e,r,i,o,a,s,c=function(){var e,t=a0.default(a);return e=s?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function u(e){var t;return s0.default(this,u),(t=c.call(this)).transport=e,t.registrations=new Map,t.registrationsInProgress=new Map,t}return t0.default(u,[{key:"putNotificationContext",value:(o=e0.default(S.default.mark(function e(t,n){var r;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={method:"put_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(r,n);case 3:case"end":return e.stop()}},e,this)})),function(e,t){return o.apply(this,arguments)})},{key:"deleteNotificationContext",value:(i=e0.default(S.default.mark(function e(t){var n;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={method:"delete_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(n);case 3:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"updateRegistration",value:(r=e0.default(S.default.mark(function e(t,n){var r,i;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return E.debug("update registration for context",t),(r=this.registrationsInProgress.get(t))||(r=new Set,this.registrationsInProgress.set(t,r)),i=Y_.v4(),r.add(i),e.prev=5,e.next=8,this.putNotificationContext(t,n);case 8:E.debug("registration attempt succeeded for context",n),r.delete(i),0===r.size&&(this.registrationsInProgress.delete(t),this.emit("registered",t)),e.next=19;break;case 13:e.prev=13,e.t0=e.catch(5),E.warn("registration attempt failed for context",n),E.debug(e.t0),r.delete(i),0===r.size&&(this.registrationsInProgress.delete(t),this.emit("registrationFailed",t,e.t0));case 19:case"end":return e.stop()}},e,this,[[5,13]])})),function(e,t){return r.apply(this,arguments)})},{key:"updateRegistrations",value:(e=e0.default(S.default.mark(function e(){var n,r=this;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return E.trace("refreshing ".concat(this.registrations.size," registrations")),n=[],this.registrations.forEach(function(e,t){n.push(r.updateRegistration(t,e))}),e.next=5,Promise.all(n);case 5:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"setNotificationsContext",value:(n=e0.default(S.default.mark(function e(t,n){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&n){e.next=2;break}throw new U0("Invalid arguments provided");case 2:return this.registrations.set(t,n),e.next=5,this.updateRegistration(t,n);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"removeNotificationsContext",value:(t=e0.default(S.default.mark(function e(t){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrations.has(t)){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.deleteNotificationContext(t);case 4:this.transport.isConnected&&this.registrations.delete(t);case 5:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}]),u}(),Q0=function(e){i0.default(o,e);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,i=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function o(e,t,n){var r;return s0.default(this,o),(r=i.call(this,t)).status=e,r.description=t,r.body=n,r}return o}(U0),X0=function(e){i0.default(i,e);n=i,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,t=function(){var e,t=a0.default(n);return e=r?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function i(e){return s0.default(this,i),t.call(this,e)}return i}(U0);function Z0(e,t,n,r,i){return{to:(e=e,t=function(e){var t,n=e.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);if(n)return 0<(n={protocol:n[1],host:n[2],hostname:n[3],port:n[4],pathname:n[5],search:n[6],hash:n[7],params:{}}).search.length&&(t=n.search.substring(1),n.params=t.split("&").map(function(e){return e.split("=")}).reduce(function(e,t){return e.hasOwnProperty(t[0])?Array.isArray(e[t[0]])?e[t[0]].push(t[1]):e[t[0]]=[e[t[0]],t[1]]:e[t[0]]=t[1],e},{})),n;throw new U0("Incorrect URI: "+e)}(t=t),e={method:e,host:t.host,path:t.pathname},t.params&&(e.params=t.params),e),headers:n,body:r,grant:i}}t0.default(sw,[{key:"saveMessage",value:function(r){var i=this;return new Promise(function(e,t){var n={message:r,resolve:e,reject:t,alreadyRejected:!1,timeout:setTimeout(function(){E.debug("request is timed out"),t(new U0("request '".concat(r.to.method,"' to '").concat(r.to.host,"' timed out"))),n.alreadyRejected=!0},2e4)};i.pendingMessages.push(n)})}},{key:"sendPendingMessages",value:function(){for(var n=this;0<this.pendingMessages.length&&"break"!==function(){var t=n.pendingMessages[0];if(!t.alreadyRejected)try{var e=t.message;n.actualSend(e).then(function(e){return t.resolve(e)}).catch(function(e){return t.reject(e)}),clearTimeout(t.timeout)}catch(e){return E.debug("Failed to send pending message",e),"break"}n.pendingMessages.splice(0,1)}(););}},{key:"rejectPendingMessages",value:function(){var t=this;this.pendingMessages.forEach(function(e){e.reject(new X0("Unable to connect: "+t.twilsock.getTerminationReason)),e.alreadyRejected=!0,clearTimeout(e.timeout)}),this.pendingMessages.splice(0,this.pendingMessages.length)}},{key:"actualSend",value:(ew=e0.default(S.default.mark(function e(n){var r,i,o,a,s;return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.to,r=n.headers,i=n.body,a=null!=(a=n.grant)?a:this.config.activeGrant,o={host:o.host,path:o.path,method:o.method,params:o.params,headers:r},a=new I0(a,r["Content-Type"]||"application/json",o),E.trace("Sending upstream message",a),e.next=9,this.transport.sendWithReply(a,i);case 9:if(s=e.sent,E.trace("Received upstream message response",s),(t=s)&&t.header&&t.header.http_status&&!(200<=(t=s.header.http_status.code)&&t<300))throw new Q0(s.header.http_status.code,s.header.http_status.status,s.body);e.next=13;break;case 13:return e.abrupt("return",{status:s.header.http_status,headers:s.header.http_headers,body:s.body});case 14:case"end":return e.stop()}var t},e,this)})),function(e){return ew.apply(this,arguments)})},{key:"send",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=3<arguments.length?arguments[3]:void 0,i=4<arguments.length?arguments[4]:void 0;return this.twilsock.isTerminalState?Promise.reject(new X0("Unable to connect: "+this.twilsock.getTerminationReason)):(e=Z0(e,t,n,r,i),this.twilsock.isConnected?this.actualSend(e):this.saveMessage(e))}}]);var ew,tw=sw,nw=(t0.default(aw,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}}]),aw),rw=(t0.default(ow,null,[{key:"create",value:function(e){if(e instanceof Object&&"storage_id"in e)return new ow(e.storage_id);throw new U0('Field "storage_id" is missing')}}]),ow),w=(t0.default(iw,[{key:"sessionStorage",value:function(){try{return K_.sessionStorage}catch(e){return null}}},{key:"window",value:function(){try{return K_.window}catch(e){return null}}},{key:"storeToken",value:function(e,t){this.canStore()&&this.sessionStorage.setItem(this.getKeyName(t),e)}},{key:"getStoredToken",value:function(e){return this.canStore()?this.sessionStorage.getItem(this.getKeyName(e)):null}},{key:"initialize",value:function(){var e,t=this;this.canStore()&&(this.sessionStorage.getItem(this.initializedFlag)&&this.clear(),this.sessionStorage.setItem(this.initializedFlag,"true"),e=this.sessionStorage.removeItem,this.window.addEventListener("unload",function(){e(t.initializedFlag)}))}},{key:"clear",value:function(){if(this.canStore()){for(var e=[],t=0;t<this.sessionStorage.length;t++){var n=this.sessionStorage.key(t);n&&0===n.indexOf(this.tokenStoragePrefix)&&e.push(n)}var r=this.sessionStorage.removeItem;e.forEach(function(e){return r(e)}),r(this.initializedFlag)}}},{key:"getKeyName",value:function(e){return"".concat(this.tokenStoragePrefix).concat(e)}},{key:"canStore",value:function(){return!!(this.sessionStorage&&this.sessionStorage.length&&this.window)}}]),iw);function iw(){return s0.default(this,iw),c0.default(this,"initializedFlag","twilio_twilsock_token_storage"),c0.default(this,"tokenStoragePrefix","twilio_continuation_token_"),iw._instance||(this.initialize(),iw._instance=this),iw._instance}function ow(e){s0.default(this,ow),this.id=e}function aw(){var n=this;s0.default(this,aw),this._promise=new Promise(function(e,t){n._resolve=e,n._reject=t})}function sw(e,t,n){s0.default(this,sw),this.config=n,this.transport=e,this.pendingMessages=[],this.twilsock=t}c0.default(w,"_instance",null);var cw=new w,uw=(t0.default(lw,[{key:"toTelemetryEvent",value:function(){var e=new Date,t=this.start,n=this.end||e,r=(n<t&&(r=n,n=t,t=r),t.getTime()-e.getTime()),t=n.getTime()-e.getTime();return new O0(r,t,this.title,this.details,this.id,this.type)}}]),lw);function lw(e,t,n,r,i,o){s0.default(this,lw),this.title=e,this.details=t,this.start=n,this.type=i,this.id=o,this.end=r}x.TelemetryPoint=void 0,(ii=x.TelemetryPoint||(x.TelemetryPoint={}))[ii.Start=0]="Start",ii[ii.End=1]="End",x.EventSendingLimitation=void 0,(No=x.EventSendingLimitation||(x.EventSendingLimitation={}))[No.MinEventsPortion=0]="MinEventsPortion",No[No.AnyEvents=1]="AnyEvents",No[No.AnyEventsIncludingUnfinished=2]="AnyEventsIncludingUnfinished",t0.default(fw,[{key:"isTelemetryEnabled",get:function(){return this.config.confirmedCapabilities.has("telemetry.v1")}},{key:"canSendTelemetry",get:function(){return this._canSendTelemetry&&this.isTelemetryEnabled},set:function(e){E.debug("TelemetryTracker.canSendTelemetry: ".concat(e," TelemetryTracker.isTelemetryEnabled: ").concat(this.isTelemetryEnabled)),this._canSendTelemetry&&!e&&(this.pendingEvents.clear(),this.readyEvents=[]),(this._canSendTelemetry=e)&&this.sendTelemetry(x.EventSendingLimitation.AnyEvents),e&&!this.hasInitializationFinished&&(this.hasInitializationFinished=!0)}},{key:"addTelemetryEvent",value:function(e){!this.canSendTelemetry&&this.hasInitializationFinished||this.readyEvents.push(e)}},{key:"addPartialEvent",value:function(e,t,n){E.debug("Adding ".concat(n===x.TelemetryPoint.Start?"starting":"ending"," timepoint for '").concat(t,"' event"));var r=this.pendingEvents.has(t);n===x.TelemetryPoint.Start?(r&&E.debug("Overwriting starting point for '".concat(t,"' event")),this.pendingEvents.set(t,e)):r?(this.addTelemetryEvent(this.merge(this.pendingEvents.get(t),e)),this.pendingEvents.delete(t)):E.info("Could not find started event for '".concat(t,"' event"))}},{key:"getTelemetryToSend",value:function(e){return!this.canSendTelemetry||0==this.readyEvents.length||e==x.EventSendingLimitation.MinEventsPortion&&this.readyEvents.length<this.minEventsPortionToSend?[]:this.getTelemetryPortion(e==x.EventSendingLimitation.AnyEventsIncludingUnfinished)}},{key:"getTelemetryPortion",value:function(e){var r=this,t=Math.min(this.readyEvents.length,this.maxEventsPortionToSend),i=this.readyEvents.splice(0,t);return e&&i.length<this.maxEventsPortionToSend&&this.pendingEvents.forEach(function(e,t){var n;i.length>=r.maxEventsPortionToSend||(n=r.pendingEvents.get(t),r.pendingEvents.delete(t),i.push(new uw("[UNFINISHED] ".concat(n.title),n.details,n.start,null,n.type,n.id)))}),i}},{key:"merge",value:function(e,t){return new uw(t.title||e.title,t.details||e.details,e.start,t.end,t.type||e.type,t.id||e.id)}},{key:"sendTelemetryIfMinimalPortionCollected",value:function(){this.sendTelemetry(x.EventSendingLimitation.MinEventsPortion)}},{key:"sendTelemetry",value:function(e){var t=this.getTelemetryToSend(e);if(0!==t.length)try{this.packetInterface.send(new A0(t.map(function(e){return e.toTelemetryEvent()})))}catch(e){E.debug("Error while sending ".concat(t.length," telemetry events due to ").concat(e,"; they will be resubmitted")),this.readyEvents=this.readyEvents.concat(t)}}}]);var dw=fw;function fw(e,t){s0.default(this,fw),c0.default(this,"minEventsPortionToSend",50),c0.default(this,"maxEventsPortionToSend",100),c0.default(this,"pendingEvents",new Map),c0.default(this,"readyEvents",[]),c0.default(this,"hasInitializationFinished",!1),c0.default(this,"_canSendTelemetry",!1),this.config=e,this.packetInterface=t}function pw(){s0.default(this,pw)}function hw(e){s0.default(this,hw),this.product=e,this.type="ers",this.notification_protocol_version=0,this.message_types=[]}c0.default(pw,"TWILSOCK_CONNECT","twilsock.sdk.connect"),c0.default(pw,"TWILSOCK_INIT","twilsock.sdk.init"),x.TwilsockClient=function(){i0.default(d,p0);c=d,u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var i,o,a,r,e,t,n,s,c,u,l=function(){var e,t=a0.default(c);return e=u?(e=a0.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),o0.default(this,e)};function d(e,t,n){s0.default(this,d),r=l.call(this),c0.default(n0.default(r),"version","0.12.2"),c0.default(n0.default(r),"offlineStorageDeferred",new nw),n.continuationToken=n.continuationToken||cw.getStoredToken(t);var r,e=r.config=new k0(e,t,n),n=(E.setLevel(e.logLevel),new K0(e.url)),i=new J0(n,e);return r.channel=new W0(n,i,e),r.registrations=new Y0(i),r.upstream=new tw(i,r.channel,e),r.telemetryTracker=new dw(e,i),r.channel.on("initialized",function(){return r.telemetryTracker.canSendTelemetry=!0}),n.on("disconnected",function(){return r.telemetryTracker.canSendTelemetry=!1}),r.registrations.on("registered",function(e){return r.emit("registered",e)}),r.channel.on("message",function(e,t){return setTimeout(function(){return r.emit("message",e,t)},0)}),r.channel.on("stateChanged",function(e){return setTimeout(function(){return r.emit("stateChanged",e)},0)}),r.channel.on("connectionError",function(e){return setTimeout(function(){return r.emit("connectionError",e)},0)}),r.channel.on("tokenAboutToExpire",function(){return setTimeout(function(){return r.emit("tokenAboutToExpire")},0)}),r.channel.on("tokenExpired",function(){return setTimeout(function(){return r.emit("tokenExpired")},0)}),r.channel.on("connected",function(){return r.registrations.updateRegistrations()}),r.channel.on("connected",function(){return r.upstream.sendPendingMessages()}),r.channel.on("connected",function(){return setTimeout(function(){return r.emit("connected")},0)}),r.channel.on("beforeConnect",function(){return r.telemetryTracker.addPartialEvent(new uw("Establish WebSocket connection","",new Date),pw.TWILSOCK_CONNECT,x.TelemetryPoint.Start)}),r.channel.on("connected",function(){return r.telemetryTracker.addPartialEvent(new uw("Establish WebSocket connection","",new Date,new Date),pw.TWILSOCK_CONNECT,x.TelemetryPoint.End)}),r.channel.on("beforeSendInit",function(){return r.telemetryTracker.addPartialEvent(new uw("Send Twilsock init","",new Date),pw.TWILSOCK_INIT,x.TelemetryPoint.Start)}),r.channel.on("initialized",function(){return r.telemetryTracker.addPartialEvent(new uw("Send Twilsock init","Succeeded",new Date,new Date),pw.TWILSOCK_INIT,x.TelemetryPoint.End)}),r.channel.on("sendInitFailed",function(){return r.telemetryTracker.addPartialEvent(new uw("Send Twilsock init","Failed",new Date,new Date),pw.TWILSOCK_INIT,x.TelemetryPoint.End)}),r.channel.on("initialized",function(e){r.handleStorageId(t,e),cw.storeToken(e.continuationToken,t),setTimeout(function(){return r.emit("initialized",e)},0)}),r.channel.on("disconnected",function(){return setTimeout(function(){return r.emit("disconnected")},0)}),r.channel.on("disconnected",function(){return r.upstream.rejectPendingMessages()}),r.channel.on("disconnected",function(){return r.offlineStorageDeferred.fail(new U0("Client disconnected"))}),r.offlineStorageDeferred.promise.catch(function(){}),r}return t0.default(d,[{key:"emit",value:function(e){for(var t,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return E.debug("Emitting ".concat(e.toString(),"(").concat(r.map(function(e){return JSON.stringify(e)}).join(", "),")")),(t=r0.default(a0.default(d.prototype),"emit",this)).call.apply(t,[this,e].concat(r))}},{key:"handleStorageId",value:function(t,n){if(n.offlineStorage)if(n.offlineStorage.hasOwnProperty(t))try{this.offlineStorageDeferred.set(rw.create(n.offlineStorage[t])),E.debug("Offline storage for '".concat(t,"' product: ").concat(JSON.stringify(n.offlineStorage[t]),"."))}catch(e){this.offlineStorageDeferred.fail(new U0("Failed to parse offline storage for ".concat(t," ").concat(JSON.stringify(n.offlineStorage[t]),". ").concat(e,".")))}else this.offlineStorageDeferred.fail(new U0("No offline storage id for '".concat(t,"' product: ").concat(JSON.stringify(n.offlineStorage))));else this.offlineStorageDeferred.fail(new U0("No offline storage id"))}},{key:"storageId",value:function(){return this.offlineStorageDeferred.promise}},{key:"isConnected",get:function(){return this.channel.isConnected}},{key:"state",get:function(){return this.channel.state}},{key:"updateToken",value:(s=e0.default(S.default.mark(function e(t){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(E.trace("updating token '".concat(t,"'")),this.config.token===t)return e.abrupt("return");e.next=3;break;case 3:return this.config.updateToken(t),e.next=6,this.channel.updateToken(t);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}},e,this)})),function(e){return s.apply(this,arguments)})},{key:"setNotificationsContext",value:(n=e0.default(S.default.mark(function e(t,n){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.registrations.setNotificationsContext(t,n);case 2:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"removeNotificationsContext",value:(t=e0.default(S.default.mark(function e(t){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.registrations.removeNotificationsContext(t);case 2:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"connect",value:function(){return this.channel.connect()}},{key:"disconnect",value:(e=e0.default(S.default.mark(function e(){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.telemetryTracker.sendTelemetry(x.EventSendingLimitation.AnyEventsIncludingUnfinished),e.next=3,this.channel.disconnect();case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"get",value:(r=e0.default(S.default.mark(function e(t,n,r){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.telemetryTracker.sendTelemetry(x.EventSendingLimitation.AnyEvents),e.next=3,this.upstream.send("GET",t,n,void 0,r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)})),function(e,t,n){return r.apply(this,arguments)})},{key:"post",value:(a=e0.default(S.default.mark(function e(t,n,r,i){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.telemetryTracker.sendTelemetry(x.EventSendingLimitation.AnyEvents),e.next=3,this.upstream.send("POST",t,n,r,i);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)})),function(e,t,n,r){return a.apply(this,arguments)})},{key:"put",value:(o=e0.default(S.default.mark(function e(t,n,r,i){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.telemetryTracker.sendTelemetry(x.EventSendingLimitation.AnyEvents),e.next=3,this.upstream.send("PUT",t,n,r,i);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)})),function(e,t,n,r){return o.apply(this,arguments)})},{key:"delete",value:(i=e0.default(S.default.mark(function e(t,n,r,i){return S.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.telemetryTracker.sendTelemetry(x.EventSendingLimitation.AnyEvents),e.next=3,this.upstream.send("DELETE",t,n,r,i);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)})),function(e,t,n,r){return i.apply(this,arguments)})},{key:"addTelemetryEvent",value:function(e){this.telemetryTracker.addTelemetryEvent(e),this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}},{key:"addPartialTelemetryEvent",value:function(e,t,n){this.telemetryTracker.addPartialEvent(e,t,n),n===x.TelemetryPoint.End&&this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}}]),d}(),x.TwilsockClient=function(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":u0.default(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(a=(o<3?i(a):3<o?i(t,n,a):i(t,n))||a);return 3<o&&a&&Object.defineProperty(t,n,a),a}([l.validateConstructorTypes(l.nonEmptyString,l.nonEmptyString,[l.pureObject,"undefined",l.literal(null)]),function(e){if("object"===("undefined"==typeof Reflect?"undefined":u0.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata("design:paramtypes",e)}([String,String,Object])],x.TwilsockClient),t0.default(hw,[{key:"populateInitRegistrations",value:function(e){var t,n=new Set(this.message_types);for(t in e)n.add(e[t]);this.message_types=Array.from(n)}}]),Ce=hw,x.InitRegistration=Ce,x.TelemetryEventDescription=uw,x.TelemetryTracker=dw,x.TransportUnavailableError=X0,x.Twilsock=x.TwilsockClient,x.TwilsockError=U0;var mw={},yw=N,dv=t,vw=Cn,gw=Ct,bw=U,_w=Y,ww=z,kw=Object.assign,xw=Object.defineProperty,Cf=!kw||dv(function(){var e,t,n,r;return yw&&1!==kw({b:1},kw(xw({},"a",{enumerable:!0,get:function(){xw(this,"b",{value:3,enumerable:!1})}}),{b:2})).b||(t={},r="abcdefghijklmnopqrst",(e={})[n=Symbol()]=7,r.split("").forEach(function(e){t[e]=e}),7!=kw({},e)[n])||vw(kw({},t)).join("")!=r})?function(e,t){for(var n=_w(e),r=arguments.length,i=1,o=gw.f,a=bw.f;i<r;)for(var s,c=ww(arguments[i++]),u=o?vw(c).concat(o(c)):vw(c),l=u.length,d=0;d<l;)s=u[d++],yw&&!a.call(c,s)||(n[s]=c[s]);return n}:kw,ai=(i({target:"Object",stat:!0,forced:Object.assign!==Cf},{assign:Cf}),mw),mi=(Object.defineProperty(ai,"__esModule",{value:!0}),c.exports),u=f.exports,wf=h.exports,r=a.exports,tt=p.exports,_=Rf,fv=lr.exports,Sw=Mm,k=m.exports,ur=xf.exports,Ew=If,w=Yn.exports,ii=de.exports,l=Tr.exports,Ce=sy,Cn=d;function Cw(e){return e&&"object"===F(e)&&"default"in e?e:{default:e}}function Tw(n){var r;return n&&n.__esModule?n:(r=Object.create(null),n&&Object.keys(n).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(n,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return n[e]}}))}),r.default=n,Object.freeze(r))}var Iw=Cw(hn.exports),Rw=Cw(mi),Pw=Cw(u),Ow=Cw(wf),Aw=Cw(r),Mw=Cw(tt),Dw=Cw(_),jw=Cw(fv),Lw=Cw(k),Nw=Cw(ur),Uw=Cw(w),Fw=Cw(ii),mi=Tw(l),Bw=Tw(Ce);function qw(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":jw.default(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(a=(o<3?i(a):3<o?i(t,n,a):i(t,n))||a);return 3<o&&a&&Object.defineProperty(t,n,a),a}function zw(e,t){if("object"===("undefined"==typeof Reflect?"undefined":jw.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function Ww(){}function Gw(){Gw.init.call(this)}function Vw(e){return void 0===e._maxListeners?Gw.defaultMaxListeners:e._maxListeners}function Hw(e,t,n,r){var i,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return(i=e._events)?(i.newListener&&(e.emit("newListener",t,n.listener||n),i=e._events),o=i[t]):(i=e._events=new Ww,e._eventsCount=0),o?("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(r=Vw(e))&&0<r&&o.length>r&&(o.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",r.emitter=e,r.type=t,r.count=o.length,r=r,"function"==typeof console.warn?console.warn(r):console.log(r))):(o=i[t]=n,++e._eventsCount),e}function Jw(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function $w(e){var t=this._events;if(t){t=t[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function Kw(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}Ww.prototype=Object.create(null),(Gw.EventEmitter=Gw).usingDomains=!1,Gw.prototype.domain=void 0,Gw.prototype._events=void 0,Gw.prototype._maxListeners=void 0,Gw.defaultMaxListeners=10,Gw.init=function(){this.domain=null,Gw.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new Ww,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Gw.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},Gw.prototype.getMaxListeners=function(){return Vw(this)},Gw.prototype.emit=function(e){var t,n,r,i,o,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(s=this.domain,a){if(a=arguments[1],s)return(a=a||new Error('Uncaught, unspecified "error" event')).domainEmitter=this,a.domain=s,a.domainThrown=!1,s.emit("error",a),!1;if(a instanceof Error)throw a;var s=new Error('Uncaught, unspecified "error" event. ('+a+")");throw s.context=a,s}if(!(t=o[e]))return!1;var c="function"==typeof t;switch(n=arguments.length){case 1:var u=t,l=c,d=this;if(l)u.call(d);else for(var f=u.length,j=Kw(u,f),p=0;p<f;++p)j[p].call(d);break;case 2:var l=t,u=c,h=this,m=arguments[1];if(u)l.call(h,m);else for(var y=l.length,L=Kw(l,y),v=0;v<y;++v)L[v].call(h,m);break;case 3:var g=t,b=c,_=this,w=arguments[1],k=arguments[2];if(b)g.call(_,w,k);else for(var x=g.length,N=Kw(g,x),S=0;S<x;++S)N[S].call(_,w,k);break;case 4:var b=t,g=c,E=this,C=arguments[1],T=arguments[2],I=arguments[3];if(g)b.call(E,C,T,I);else for(var R=b.length,U=Kw(b,R),P=0;P<R;++P)U[P].call(E,C,T,I);break;default:for(r=new Array(n-1),i=1;i<n;i++)r[i-1]=arguments[i];var O=t,F=c,A=this,M=r;if(F)O.apply(A,M);else for(var B=O.length,q=Kw(O,B),D=0;D<B;++D)q[D].apply(A,M)}return!0},Gw.prototype.on=Gw.prototype.addListener=function(e,t){return Hw(this,e,t,!1)},Gw.prototype.prependListener=function(e,t){return Hw(this,e,t,!0)},Gw.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,Jw(this,e,t)),this},Gw.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,Jw(this,e,t)),this},Gw.prototype.removeListener=function(e,t){var n,r,i,o,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if((r=this._events)&&(n=r[e]))if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new Ww:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length;0<o--;)if(n[o]===t||n[o].listener&&n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new Ww,this;delete r[e]}else{var s=n;for(var c=i,u=c+1,l=s.length;u<l;c+=1,u+=1)s[c]=s[u];s.pop()}r.removeListener&&this.emit("removeListener",e,a||t)}return this},Gw.prototype.off=function(e,t){return this.removeListener(e,t)},Gw.prototype.removeAllListeners=function(e){var t,n;if(n=this._events)if(n.removeListener){if(0===arguments.length){for(var r,i=Object.keys(n),o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);this.removeAllListeners("removeListener"),this._events=new Ww,this._eventsCount=0}else if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(;this.removeListener(e,t[t.length-1]),t[0];);}else 0===arguments.length?(this._events=new Ww,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new Ww:delete n[e]);return this},Gw.prototype.listeners=function(e){var t=this._events;{if(t&&(t=t[e])){if("function"==typeof t)return[t.listener||t];for(var n=t,r=new Array(n.length),i=0;i<r.length;++i)r[i]=n[i].listener||n[i];return r}return[]}},Gw.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):$w.call(e,t)},Gw.prototype.listenerCount=$w,Gw.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};var Yw=mi.getLogger("twilio-notificatiions");function Qw(e,t){return["".concat((new Date).toISOString()," Twilio.Notifications ").concat(e,":")].concat(Array.from(t))}Pw.default(Zw,[{key:"setLevel",value:function(e){Yw.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Yw.trace.apply(null,Qw("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Yw.debug.apply(null,Qw("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Yw.info.apply(null,Qw("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Yw.warn.apply(null,Qw("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Yw.error.apply(null,Qw("E",t))}}]);var Xw=new Zw;function Zw(){Rw.default(this,Zw)}var ek,tk=Pw.default(function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new Set;Rw.default(this,e),this.token=t,this.notificationId=n,this.messageTypes=r}),nk=function(){Ow.default(o,Gw);n=o,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var e,n,r,i=function(){var e,t=Mw.default(n);return e=r?(e=Mw.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),Aw.default(this,e)};function o(e){var t;return Rw.default(this,o),t=i.call(this),Nw.default(Lw.default(t),"desiredState",new tk),Nw.default(Lw.default(t),"currentState",new tk),Nw.default(Lw.default(t),"_hasActiveAttempt",!1),t.channelType=e,t}return Pw.default(o,[{key:"setNotificationId",value:function(e){this.desiredState.notificationId=e}},{key:"isActive",value:function(){return""!==this.desiredState.notificationId}},{key:"subscribe",value:function(e){this.desiredState.messageTypes.has(e)?Xw.debug("message type '".concat(e,"' for channel ").concat(this.channelType," is already registered")):this.desiredState.messageTypes.add(e)}},{key:"unsubscribe",value:function(e){this.desiredState.messageTypes.has(e)&&this.desiredState.messageTypes.delete(e)}},{key:"updateToken",value:function(e){this.desiredState.token=e}},{key:"commitChanges",value:(e=Iw.default(Dw.default.mark(function e(){var t,n,r;return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._hasActiveAttempt)throw Xw.error("One registration attempt is already in progress"),new Error("One registration attempt is already in progress");e.next=3;break;case 3:if(t=function(e,t){var n,r,i=new Set;return e.notificationId!==t.notificationId&&i.add("notificationId"),e.token!==t.token&&i.add("token"),n=e.messageTypes,r=t.messageTypes,0<[].concat(Fw.default(Fw.default(n).filter(function(e){return!r.has(e)})),Fw.default(Fw.default(r).filter(function(e){return!n.has(e)}))).length&&i.add("messageType"),[0<i.size,i]}(this.desiredState,this.currentState),t=Uw.default(t,2),r=t[0],t=t[1],r){e.next=6;break}return e.abrupt("return");case 6:if(this.currentState.notificationId||t.delete("notificationId"),Xw.trace("Persisting ".concat(this.channelType," registration"),t,this.desiredState),e.prev=8,this._hasActiveAttempt=!0,(n=new tk).token=this.desiredState.token,n.notificationId=this.desiredState.notificationId,n.messageTypes=new Set(this.desiredState.messageTypes),0<n.messageTypes.size)return e.next=17,this.updateRegistration(n,t);e.next=24;break;case 17:r=e.sent,this.currentState.token=r.token,this.currentState.notificationId=r.notificationId,this.currentState.messageTypes=new Set(r.messageTypes),this.emit("stateChanged",this.channelType,"registered",this.currentState),e.next=30;break;case 24:return e.next=26,this.removeRegistration();case 26:this.currentState.token=n.token,this.currentState.notificationId=n.notificationId,this.currentState.messageTypes.clear(),this.emit("stateChanged",this.channelType,"unregistered",this.currentState);case 30:e.next=35;break;case 32:throw e.prev=32,e.t0=e.catch(8),e.t0;case 35:return e.prev=35,this._hasActiveAttempt=!1,e.finish(35);case 38:case"end":return e.stop()}},e,this,[[8,32,35,38]])})),function(){return e.apply(this,arguments)})}]),o}(),rk={min:2e3,max:12e4,randomness:.2},ik=function(){Ow.default(a,nk);r=a,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,e,n,r,i,o=function(){var e,t=Mw.default(r);return e=i?(e=Mw.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),Aw.default(this,e)};function a(e,t,n,r){return Rw.default(this,a),e=o.call(this,e),Nw.default(Lw.default(e),"registrationId",null),e.context=t,e.twilsock=n,e.registrarUrl=r,e}return Pw.default(a,[{key:"updateRegistration",value:(n=Iw.default(Dw.default.mark(function e(t,n){var r,i,o,a,s,c=this;return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n.has("notificationId"))return e.next=3,this.removeRegistration();e.next=3;break;case 3:if(t.notificationId&&t.notificationId.length){e.next=6;break}throw Xw.error("No push notification ID for registration"),new Error("No push notification ID for registration");case 6:return Xw.trace("Registering",this.channelType,t),r={endpoint_platform:this.context.platform,channel_type:this.channelType,version:this.context.protocolVersion.toString(),message_types:Array.from(t.messageTypes),data:{registration_id:t.notificationId}},i=this.context.productId,o="".concat(this.registrarUrl,"?productId=").concat(i),a={"Content-Type":"application/json"},Xw.trace("Creating registration for channel ".concat(this.channelType)),e.prev=12,e.next=15,new Ew.AsyncRetrier(rk).run(function(){return c.twilsock.post(o,a,r,i)});case 15:s=e.sent,this.registrationId=s.body.id,Xw.debug("Registration created: ",s),e.next=24;break;case 20:throw e.prev=20,e.t0=e.catch(12),Xw.error("Registration failed: ",e.t0),e.t0;case 24:return e.abrupt("return",t);case 25:case"end":return e.stop()}},e,this,[[12,20]])})),function(e,t){return n.apply(this,arguments)})},{key:"removeRegistration",value:(e=Iw.default(Dw.default.mark(function e(){var t,n,r,i=this;return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrationId){e.next=2;break}return e.abrupt("return");case 2:return t=this.context.productId,n="".concat(this.registrarUrl,"/").concat(this.registrationId,"?productId=").concat(t),r={"Content-Type":"application/json"},Xw.trace("Removing registration for ".concat(this.channelType)),e.prev=6,e.next=9,new Ew.AsyncRetrier(Object.assign(rk,{maxAttemptsCount:3})).run(function(){return i.twilsock.delete(n,r,{},t)});case 9:this.registrationId=null,this.currentState.notificationId="",Xw.debug("Registration removed for ".concat(this.channelType)),e.next=18;break;case 14:throw e.prev=14,e.t0=e.catch(6),Xw.error("Failed to remove registration ",this.channelType,e.t0),e.t0;case 18:case"end":return e.stop()}},e,this,[[6,14]])})),function(){return e.apply(this,arguments)})},{key:"sendDeviceRemoveRequest",value:(t=Iw.default(Dw.default.mark(function e(t){var n,r,i,o,a=this;return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(""===t)throw new Error("Empty registration ID");e.next=2;break;case 2:return n=this.context.productId,r="".concat(this.registrarUrl,"?productId=").concat(n),i={"Content-Type":"application/json"},o={binding_type:this.channelType,address:t},e.prev=6,Xw.trace("Removing old registrations for ".concat(this.channelType)),e.next=10,new Ew.AsyncRetrier(Object.assign(rk,{maxAttemptsCount:3})).run(function(){return a.twilsock.delete(r,i,o,n)});case 10:this.registrationId=null,this.currentState.notificationId="",Xw.debug("Registration removed for ".concat(this.channelType)),e.next=19;break;case 15:throw e.prev=15,e.t0=e.catch(6),Xw.error("Failed to remove registration ",this.channelType,e.t0),e.t0;case 19:case"end":return e.stop()}},e,this,[[6,15]])})),function(e){return t.apply(this,arguments)})}]),a}(),ok=function(){Ow.default(a,nk);r=a,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,e,n,r,i,o=function(){var e,t=Mw.default(r);return e=i?(e=Mw.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),Aw.default(this,e)};function a(e,t,n){var r;return Rw.default(this,a),r=o.call(this,"twilsock"),Nw.default(Lw.default(r),"contextId",Bw.v4()),r.productId=e,r.platform=t,r.twilsock=n,r}return Pw.default(a,[{key:"updateRegistration",value:(n=Iw.default(Dw.default.mark(function e(t,n){var r;return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n.has("messageType")){e.next=2;break}return e.abrupt("return",t);case 2:return r=Array.from(t.messageTypes),r={product_id:this.productId,notification_protocol_version:4,endpoint_platform:this.platform,message_types:r},e.prev=4,e.next=7,this.twilsock.setNotificationsContext(this.contextId,r);case 7:e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(4),Xw.error("Failed to update twilsock notification context: ".concat(e.t0)),e.t0;case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}},e,this,[[4,9]])})),function(e,t){return n.apply(this,arguments)})},{key:"removeRegistration",value:(e=Iw.default(Dw.default.mark(function e(){return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.twilsock.removeNotificationsContext(this.contextId);case 3:e.next=9;break;case 5:throw e.prev=5,e.t0=e.catch(0),Xw.error("Failed to remove twilsock notification context: ".concat(e.t0)),e.t0;case 9:case"end":return e.stop()}},e,this,[[0,5]])})),function(){return e.apply(this,arguments)})},{key:"sendDeviceRemoveRequest",value:(t=Iw.default(Dw.default.mark(function e(t){return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})}]),a}(),Ct=(u=Cn.literal("apn","fcm","twilsock"),ai.Notifications=ek=function(){Ow.default(u,Gw);r=u,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,e,t,r,i,c=function(){var e,t=Mw.default(r);return e=i?(e=Mw.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),Aw.default(this,e)};function u(e){var r,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=(Rw.default(this,u),r=c.call(this),t.logLevel=null!=(n=t.logLevel)?n:"error",Xw.setLevel(t.logLevel),null!=(n=t.productId)?n:"notifications"),i=!t.twilsockClient,o=t.twilsockClient=null!=(o=t.twilsockClient)?o:new Sw.TwilsockClient(e,n,t),a=null!=(a=t.notifications)?a:{},t=null!=(s=null!=(s=a.region)?s:t.region)?s:"us1",s="https://ers.".concat(t,".twilio.com/v1/registrations"),t=a.ersUrl||s,a=(r.connectors=new Map,ek._detectPlatform());return r.connectors.set("apn",new ik("apn",{protocolVersion:4,productId:n,platform:a},o,t)),r.connectors.set("fcm",new ik("fcm",{protocolVersion:3,productId:n,platform:a},o,t)),r.connectors.set("twilsock",new ok(n,a,o)),o.on("stateChanged",function(e){return r.emit("transportState",e)}),r._connector("twilsock").on("stateChanged",function(e,t,n){return r.emit("stateChanged",e,t,n)}),r._connector("apn").on("stateChanged",function(e,t,n){return r.emit("stateChanged",e,t,n)}),r._connector("fcm").on("stateChanged",function(e,t,n){return r.emit("stateChanged",e,t,n)}),o.on("message",function(e,t){return r._routeMessage(e,t)}),r.updateToken(e),i&&(o.connect(),r.twilsock=o),r}return Pw.default(u,[{key:"shutdown",value:(t=Iw.default(Dw.default.mark(function e(){return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.connectors.clear(),this.twilsock)return e.next=4,this.twilsock.disconnect();e.next=4;break;case 4:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"setPushRegistrationId",value:function(e,t){Xw.debug("Set ".concat(e," push registration id '").concat(t,"'")),this._connector(e).setNotificationId(t)}},{key:"subscribe",value:function(e,t){Xw.debug("Add ".concat(e," subscriptions for message type ").concat(t)),this._connector(e).subscribe(t)}},{key:"unsubscribe",value:function(e,t){Xw.debug("Remove ".concat(e," subscriptions for message type ").concat(t)),this._connector(e).unsubscribe(t)}},{key:"updateToken",value:function(t){this.connectors.forEach(function(e){return e.updateToken(t)})}},{key:"commitChanges",value:(e=Iw.default(Dw.default.mark(function e(){var t;return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.connectors.forEach(function(e){e.isActive()&&t.push(e.commitChanges())}),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"removeRegistrations",value:(n=Iw.default(Dw.default.mark(function e(t,n){return Dw.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._connector(t).sendDeviceRemoveRequest(n);case 2:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"handlePushNotification",value:function(e){return{messageType:e.twi_message_type,payload:e.payload}}},{key:"_routeMessage",value:function(e,t){Xw.debug("Notification message arrived: ",e,t),this.emit("message",e,t)}},{key:"_connector",value:function(e){var t=this.connectors.get(e);if(t)return t;throw new Error("Unknown channel type: ".concat(e))}}],[{key:"_detectPlatform",value:function(){var e="";return"undefined"!=typeof navigator?(e="unknown",void 0!==navigator.product&&(e=navigator.product),void 0!==navigator.userAgent&&(e=navigator.userAgent)):e="web",e.substring(0,128)}}]),u}(),qw([Cn.validateTypes(u,Cn.nonEmptyString),zw("design:type",Function),zw("design:paramtypes",[String,String]),zw("design:returntype",void 0)],ai.Notifications.prototype,"setPushRegistrationId",null),qw([Cn.validateTypes(u,Cn.nonEmptyString),zw("design:type",Function),zw("design:paramtypes",[String,String]),zw("design:returntype",void 0)],ai.Notifications.prototype,"subscribe",null),qw([Cn.validateTypes(u,Cn.nonEmptyString),zw("design:type",Function),zw("design:paramtypes",[String,String]),zw("design:returntype",void 0)],ai.Notifications.prototype,"unsubscribe",null),qw([Cn.validateTypes(Cn.nonEmptyString),zw("design:type",Function),zw("design:paramtypes",[String]),zw("design:returntype",void 0)],ai.Notifications.prototype,"updateToken",null),qw([Cn.validateTypesAsync(u,Cn.nonEmptyString),zw("design:type",Function),zw("design:paramtypes",[String,String]),zw("design:returntype",Promise)],ai.Notifications.prototype,"removeRegistrations",null),ai.Notifications=ek=qw([Cn.validateConstructorTypes(Cn.nonEmptyString,[Cn.pureObject,"undefined",Cn.literal(null)]),zw("design:paramtypes",[String,Object])],ai.Notifications),{});Object.defineProperty(Ct,"__esModule",{value:!0});var U=c.exports,z=f.exports,dv=m.exports,de=h.exports,wf=a.exports,r=p.exports,tt=xf.exports,_=Rf,fv=lr.exports,k=d,ak=Mm,ur=Ie.exports,w=Tr.exports,ii=Yn.exports,sk=If,ck=sy,l=_f.exports,Ce=Tf.exports;function uk(e){return e&&"object"===F(e)&&"default"in e?e:{default:e}}function lk(n){var r;return n&&n.__esModule?n:(r=Object.create(null),n&&Object.keys(n).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(n,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return n[e]}}))}),r.default=n,Object.freeze(r))}var C=uk(hn.exports),T=uk(U),dk=uk(z),fk=uk(dv),pk=uk(de),hk=uk(wf),mk=uk(r),yk=uk(tt),I=uk(_),vk=uk(fv),mi=uk(ur),u=lk(w),gk=uk(ii),bk=lk(ck),_k=uk(l),wk=lk(Ce);function R(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":vk.default(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(a=(o<3?i(a):3<o?i(t,n,a):i(t,n))||a);3<o&&a&&Object.defineProperty(t,n,a)}function P(e,t){if("object"===("undefined"==typeof Reflect?"undefined":vk.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function kk(){}function xk(){xk.init.call(this)}function Sk(e){return void 0===e._maxListeners?xk.defaultMaxListeners:e._maxListeners}function Ek(e,t,n,r){var i,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return(i=e._events)?(i.newListener&&(e.emit("newListener",t,n.listener||n),i=e._events),o=i[t]):(i=e._events=new kk,e._eventsCount=0),o?("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(r=Sk(e))&&0<r&&o.length>r&&(o.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",r.emitter=e,r.type=t,r.count=o.length,r=r,"function"==typeof console.warn?console.warn(r):console.log(r))):(o=i[t]=n,++e._eventsCount),e}function Ck(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function Tk(e){var t=this._events;if(t){t=t[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function Ik(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}kk.prototype=Object.create(null),(xk.EventEmitter=xk).usingDomains=!1,xk.prototype.domain=void 0,xk.prototype._events=void 0,xk.prototype._maxListeners=void 0,xk.defaultMaxListeners=10,xk.init=function(){this.domain=null,xk.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new kk,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},xk.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},xk.prototype.getMaxListeners=function(){return Sk(this)},xk.prototype.emit=function(e){var t,n,r,i,o,a="error"===e;if(o=this._events)a=a&&null==o.error;else if(!a)return!1;if(s=this.domain,a){if(a=arguments[1],s)return(a=a||new Error('Uncaught, unspecified "error" event')).domainEmitter=this,a.domain=s,a.domainThrown=!1,s.emit("error",a),!1;if(a instanceof Error)throw a;var s=new Error('Uncaught, unspecified "error" event. ('+a+")");throw s.context=a,s}if(!(t=o[e]))return!1;var c="function"==typeof t;switch(n=arguments.length){case 1:var u=t,l=c,d=this;if(l)u.call(d);else for(var f=u.length,j=Ik(u,f),p=0;p<f;++p)j[p].call(d);break;case 2:var l=t,u=c,h=this,m=arguments[1];if(u)l.call(h,m);else for(var y=l.length,L=Ik(l,y),v=0;v<y;++v)L[v].call(h,m);break;case 3:var g=t,b=c,_=this,w=arguments[1],k=arguments[2];if(b)g.call(_,w,k);else for(var x=g.length,N=Ik(g,x),S=0;S<x;++S)N[S].call(_,w,k);break;case 4:var b=t,g=c,E=this,C=arguments[1],T=arguments[2],I=arguments[3];if(g)b.call(E,C,T,I);else for(var R=b.length,U=Ik(b,R),P=0;P<R;++P)U[P].call(E,C,T,I);break;default:for(r=new Array(n-1),i=1;i<n;i++)r[i-1]=arguments[i];var O=t,F=c,A=this,M=r;if(F)O.apply(A,M);else for(var B=O.length,q=Ik(O,B),D=0;D<B;++D)q[D].apply(A,M)}return!0},xk.prototype.on=xk.prototype.addListener=function(e,t){return Ek(this,e,t,!1)},xk.prototype.prependListener=function(e,t){return Ek(this,e,t,!0)},xk.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,Ck(this,e,t)),this},xk.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,Ck(this,e,t)),this},xk.prototype.removeListener=function(e,t){var n,r,i,o,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if((r=this._events)&&(n=r[e]))if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new kk:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length;0<o--;)if(n[o]===t||n[o].listener&&n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new kk,this;delete r[e]}else{var s=n;for(var c=i,u=c+1,l=s.length;u<l;c+=1,u+=1)s[c]=s[u];s.pop()}r.removeListener&&this.emit("removeListener",e,a||t)}return this},xk.prototype.off=function(e,t){return this.removeListener(e,t)},xk.prototype.removeAllListeners=function(e){var t,n;if(n=this._events)if(n.removeListener){if(0===arguments.length){for(var r,i=Object.keys(n),o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);this.removeAllListeners("removeListener"),this._events=new kk,this._eventsCount=0}else if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(;this.removeListener(e,t[t.length-1]),t[0];);}else 0===arguments.length?(this._events=new kk,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new kk:delete n[e]);return this},xk.prototype.listeners=function(e){var t=this._events;{if(t&&(t=t[e])){if("function"==typeof t)return[t.listener||t];for(var n=t,r=new Array(n.length),i=0;i<r.length;++i)r[i]=n[i].listener||n[i];return r}return[]}},xk.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):Tk.call(e,t)},xk.prototype.listenerCount=Tk,xk.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};dk.default(Pk,[{key:"pathSegment",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"queryParam",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]);var Rk=Pk;function Pk(e){T.default(this,Pk),this.base=e,this.args=new Array,this.paths=new Array}function Ok(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=mk.default(n);return e=r?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)}}Cn=mi.default(Error),pk.default(Nk,Cn),Mk=Ok(Nk);var Ak,Mk,Dk=Nk,jk=(ai=Dk,pk.default(Lk,ai),Ak=Ok(Lk),Lk);function Lk(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length?arguments[3]:void 0;return T.default(this,Lk),(e=Ak.call(this,e,t,n)).body=r,e}function Nk(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return T.default(this,Nk),(t=Mk.call(this)).name=t.constructor.name,t.message="".concat(e," (status: ").concat(n,", code: ").concat(r,")"),t.status=n,t.code=r,t}function Uk(e){return JSON.parse(JSON.stringify(e))}function Fk(e){if(void 0!==e&&!Bk(e))throw new Dk("Invalid pageSize parameter. Expected a positive integer, was '".concat(e,"'."),400,20007)}function Bk(e){return t=e,!isNaN(parseInt(t))&&isFinite(t)&&0<e;var t}var qk=u.getLogger("twilio-sync");function zk(e,t){return["".concat((new Date).toISOString()," Sync ").concat(e,":")].concat(Array.from(t))}function Wk(e){qk.setLevel(e)}function Gk(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qk.trace.apply(null,zk("T",t))}function Vk(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qk.debug.apply(null,zk("D",t))}function Hk(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qk.error.apply(null,zk("E",t))}dk.default($k,[{key:"subscriptionsUri",get:function(){return this.settings.subscriptionsUri}},{key:"documentsUri",get:function(){return this.settings.documentsUri}},{key:"listsUri",get:function(){return this.settings.listsUri}},{key:"mapsUri",get:function(){return this.settings.mapsUri}},{key:"streamsUri",get:function(){return this.settings.streamsUri}},{key:"insightsUri",get:function(){return this.settings.insightsUri}},{key:"backoffConfig",get:function(){return this.settings.backoffConfig||{}}},{key:"sessionStorageEnabled",get:function(){return this.settings.sessionStorageEnabled}},{key:"productId",get:function(){return this.settings.productId}}]);var Jk=$k;function $k(){var e,t,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=(T.default(this,$k),n.region||"us1"),r="https://cds.".concat(r,".twilio.com"),r=n.cdsUri||r;this.settings={subscriptionsUri:r+"/v4/Subscriptions",documentsUri:r+"/v3/Documents",listsUri:r+"/v3/Lists",mapsUri:r+"/v3/Maps",streamsUri:r+"/v3/Streams",insightsUri:r+"/v3/Insights",sessionStorageEnabled:(r=n.Sync,e="enableSessionStorage",t=!0,r&&void 0!==r[e]?r[e]:t),productId:n.productId}}function Kk(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?Yk(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Yk(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Yk(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}dk.default(tx,[{key:"sid",get:function(){return this.localObject.sid}},{key:"type",get:function(){return this.localObject.type}},{key:"lastEventId",get:function(){return this.localObject.lastEventId}},{key:"indexName",get:function(){return this.localObject.indexName}},{key:"queryString",get:function(){return this.localObject.queryString}},{key:"isEstablished",get:function(){return this.established}},{key:"update",value:function(e,t){this.localObject._update(e,t)}},{key:"updatePending",value:function(e,t){this.pendingAction=e,this.pendingCorrelationId=t}},{key:"reset",value:function(){this.updatePending(null,null),this.retryCount=0,this.established=!1,this.setSubscriptionState("none")}},{key:"markAsFailed",value:function(e){this.rejectedWithError=e.error,this.updatePending(null,null),this.localObject.reportFailure(new Dk("Failed to subscribe on service events: ".concat(e.error.message),e.error.status,e.error.code))}},{key:"complete",value:function(e){this.updatePending(null,null),this.established=!0,this.localObject._advanceLastEventId(e)}},{key:"setSubscriptionState",value:function(e){this.localObject._setSubscriptionState(e)}}]);var Qk,Xk=tx,Zk=(dk.default(ex,[{key:"getSubscriptionUpdateBatch",value:function(){function e(e,t,n,r){var i,o=[],a=Kk(e);try{for(a.s();!(i=a.n()).done;){var s=gk.default(i.value,2),c=s[0],u=s[1];if(!t.get(c)&&n!==u.pendingAction&&!u.rejectedWithError&&(o.push(u),r)&&r<=o.length)break}}catch(e){a.e(e)}finally{a.f()}return o}var t=e(this.subscriptions,this.persisted,"establish",this.maxBatchSize);return 0<t.length?{action:"establish",subscriptions:t}:0<(t=e(this.persisted,this.subscriptions,"cancel",this.maxBatchSize)).length?{action:"cancel",subscriptions:t}:{action:null,subscriptions:null}}},{key:"persist",value:function(){this.backoff.backoff()}},{key:"applyNewSubscriptionUpdateBatch",value:(Qk=C.default(I.default.mark(function e(t,n){var r,i,o,a,s,c,u,l,d,f,p=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isConnected){e.next=4;break}return Vk("Twilsock connection (required for subscription) not ready; waitingâ¦"),this.backoff.reset(),e.abrupt("return");case 4:n=this.processLocalActions(t,n),r=(new Date).getTime(),i=Kk(n);try{for(i.s();!(o=i.n()).done;)a=o.value,this.recordActionAttemptOn(a,t,r)}catch(e){i.e(e)}finally{i.f()}return s=this.pendingPokeReason,this.pendingPokeReason=null,e.prev=10,e.next=13,this.request(t,r,s,n);case 13:s=e.sent,c=s.body.max_batch_size,!isNaN(parseInt(c))&&isFinite(c)&&0<c&&(this.maxBatchSize=c),this.subscriptionTtlTimer||(c=s.body.ttl_in_s,!isNaN(parseFloat(c))&&isFinite(c)&&0<c&&(this.subscriptionTtlTimer=setTimeout(function(){return p.onSubscriptionTtlElapsed()},1e3*c))),"establish"===t&&(u=s.body.estimated_delivery_in_ms,!isNaN(parseFloat(u))&&isFinite(u)&&0<u?setTimeout(function(){return p.verifyPokeDelivery(r,u,n)},u):Hk("Invalid timeout: ".concat(u)),n.filter(function(e){return e.pendingCorrelationId===r}).forEach(function(e){return e.setSubscriptionState("response_in_flight")})),this.backoff.reset(),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(10),l=Kk(n);try{for(l.s();!(d=l.n()).done;)f=d.value,this.recordActionFailureOn(f,t)}catch(e){l.e(e)}finally{l.f()}e.t0 instanceof ak.TransportUnavailableError?(Vk("Twilsock connection (required for subscription) not ready (c:".concat(r,"); waitingâ¦")),this.backoff.reset()):(Vk("Failed an attempt to ".concat(t," subscriptions (c:").concat(r,"); retrying"),e.t0),this.persist());case 26:case"end":return e.stop()}},e,this,[[10,21]])})),function(e,t){return Qk.apply(this,arguments)})},{key:"verifyPokeDelivery",value:function(t,e,n){var r=this,i=this.latestPokeResponseArrivalTimestampByCorrelationId.get(t),i=i?(new Date).getTime()-i:e;e<=i?(n.filter(function(e){return e.pendingCorrelationId===t}).forEach(function(e){e.updatePending(null,null),e.retryCount++,r.persisted.delete(e.sid)}),this.persist(),this.latestPokeResponseArrivalTimestampByCorrelationId.delete(t)):setTimeout(function(){return r.verifyPokeDelivery(t,e,n)},e-i)}},{key:"processLocalActions",value:function(e,t){return"cancel"===e?t.filter(function(e){return!e.rejectedWithError}):t}},{key:"recordActionAttemptOn",value:function(e,t,n){e.setSubscriptionState("request_in_flight"),"establish"===t?(this.persisted.set(e.sid,e),e.updatePending(t,n)):(e=this.persisted.get(e.sid))&&e.updatePending(t,n)}},{key:"recordActionFailureOn",value:function(e,t){e.setSubscriptionState("none"),e.updatePending(null,null),"establish"===t&&this.persisted.delete(e.sid)}},{key:"request",value:function(t,e,n,r){var i=r.map(function(e){return{object_sid:e.sid,object_type:e.type,last_event_id:"establish"===t?e.lastEventId:void 0,index_name:"establish"===t?e.indexName:void 0,query_string:"establish"===t?e.queryString:void 0}}),r=r.filter(function(e){return 0<e.retryCount}).length,e=(Vk("Attempting '".concat(t,"' request (c:").concat(e,"):"),i),{event_protocol_version:4,action:t,correlation_id:e,retried_requests:r,ttl_in_s:-1,requests:i});return"ttl"===n&&(e.reason=n),this.services.network.post(this.services.config.subscriptionsUri,e)}},{key:"add",value:function(e,t){Vk("Establishing intent to subscribe to ".concat(e));var n=this.subscriptions.get(e);n&&t&&n.lastEventId===t.lastEventId||(this.persisted.delete(e),this.subscriptions.set(e,new Xk(t)),this.persist())}},{key:"remove",value:function(e){Vk("Establishing intent to unsubscribe from ".concat(e)),this.subscriptions.delete(e)&&this.persist()}},{key:"acceptMessage",value:function(e,t){Gk("Subscriptions received",e);var n=e.event_type,r=void 0!==e.events?e.events:[e.event],i=e.correlation_id;i&&this.latestPokeResponseArrivalTimestampByCorrelationId.set(i,(new Date).getTime());var o,a=Kk(r);try{for(a.s();!(o=a.n()).done;){var s=o.value,c=void 0;switch(e.event_type){case"subscription_established":this.applySubscriptionEstablishedMessage(s,i);break;case"subscription_canceled":this.applySubscriptionCancelledMessage(s,i);break;case"subscription_failed":this.applySubscriptionFailedMessage(s,i);break;case(c=n.match(/^(?:map|list|document|stream|live_query)_/)||{}).input:var u=void 0;switch(c[0]){case"map_":u=s.map_sid;break;case"list_":u=s.list_sid;break;case"document_":u=s.document_sid;break;case"stream_":u=s.stream_sid;break;case"live_query_":u=s.query_id,!(t=!1)===e.strictly_ordered&&(t=!0);break;default:u=void 0}this.applyEventToSubscribedEntity(u,s,n,t);break;default:Vk("Dropping unknown message type ".concat(n))}}}catch(e){a.e(e)}finally{a.f()}}},{key:"applySubscriptionEstablishedMessage",value:function(e,t){var n=e.object_sid,r=this.persisted.get(e.object_sid);r&&r.pendingCorrelationId===t?"interrupted"===e.replay_status?(Vk("Event Replay for subscription to ".concat(n," (c:").concat(t,") interrupted; continuing eagerly.")),r.updatePending(null,null),this.persisted.delete(r.sid),this.backoff.reset()):"completed"===e.replay_status&&(Vk("Event Replay for subscription to ".concat(n," (c:").concat(t,") completed. Subscription is ready.")),r.complete(e.last_event_id),this.persisted.set(e.object_sid,r),r.setSubscriptionState("established"),this.backoff.reset()):Vk("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionCancelledMessage",value:function(e,t){var n=this.persisted.get(e.object_sid);n&&n.pendingCorrelationId===t?(n.updatePending(null,null),n.setSubscriptionState("none"),this.persisted.delete(e.object_sid)):Vk("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionFailedMessage",value:function(e,t){var n=e.object_sid,r=this.subscriptions.get(n),i=this.persisted.get(n);r&&i?i.pendingCorrelationId===t&&(Hk("Failed to subscribe on ".concat(i.sid),e.error),i.markAsFailed(e),i.setSubscriptionState("none")):!r&&i&&(this.persisted.delete(n),i.setSubscriptionState("none")),this.persist()}},{key:"applyEventToSubscribedEntity",value:function(e,t,n,r){var i;e&&(r=r||(i=this.persisted.get(e))&&i.isEstablished,(i=this.subscriptions.get(e))?(t.type=n,i.update(t,r)):Vk("Message dropped for SID '".concat(e,"', for which there is no subscription.")))}},{key:"onConnectionStateChanged",value:function(e){(this.isConnected=e)&&this.poke("reconnect")}},{key:"onSubscriptionTtlElapsed",value:function(){this.isConnected&&this.poke("ttl")}},{key:"poke",value:function(e){Vk("Triggering event replay for all subscriptions, reason=".concat(e)),this.pendingPokeReason=e,this.subscriptionTtlTimer&&(clearTimeout(this.subscriptionTtlTimer),this.subscriptionTtlTimer=null);var t,n=[],r=Kk(this.persisted.values());try{for(r.s();!(t=r.n()).done;){var i=t.value;i.reset(),i.rejectedWithError&&n.push(i)}}catch(e){r.e(e)}finally{r.f()}this.persisted.clear();for(var o=0,a=n;o<a.length;o++){var s=a[o];this.persisted.set(s.sid,s)}this.persist()}},{key:"shutdown",value:function(){this.backoff.reset(),this.subscriptions.clear()}}]),ex);function ex(e){var n=this;T.default(this,ex),yk.default(this,"isConnected",!1),yk.default(this,"maxBatchSize",100),yk.default(this,"subscriptionTtlTimer",null),yk.default(this,"pendingPokeReason",null),this.services=e,this.subscriptions=new Map,this.persisted=new Map,this.latestPokeResponseArrivalTimestampByCorrelationId=new Map,this.backoff=sk.Backoff.exponential(Object.assign({randomisationFactor:.2,initialDelay:100,maxDelay:12e4},this.services.config.backoffConfig)),this.backoff.on("ready",function(){var e=n.getSubscriptionUpdateBatch(),t=e.action,e=e.subscriptions;t?n.applyNewSubscriptionUpdateBatch(t,e):(n.backoff.reset(),Vk("All subscriptions resolved."))})}function tx(e){T.default(this,tx),this.localObject=e,this.pendingCorrelationId=null,this.pendingAction=null,this.established=!1,this.retryCount=0}function nx(e){if(e.body&&e.body.message)return e.body.message;switch(e.status){case 429:return"Throttled by server";case 404:return"Not found from server";default:return"Error from server"}}function rx(e){return e.body?e.body.code:0}function ix(e){return 409===e.status?new jk(nx(e),e.status,rx(e),e.body):e.status?new Dk(nx(e),e.status,rx(e)):e instanceof ak.TransportUnavailableError?e:new Dk(e.message,0,0)}dk.default(cx,[{key:"createHeaders",value:function(){return{"Content-Type":"application/json","Twilio-Sync-Client-Info":JSON.stringify(this.clientInfo),"Twilio-Request-Id":"RQ"+bk.v4().replace(/-/g,"")}}},{key:"backoffConfig",value:function(){return Object.assign({min:4e3,max:6e4,maxAttemptsTime:9e4,randomness:.2},this.config.backoffConfig)}},{key:"executeWithRetry",value:function(e){var o=this,a=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];return new Promise(function(t,n){var r=[502,503,504],i=(a&&r.push(429),new sk.Retrier(o.backoffConfig()));i.on("attempt",function(){e().then(function(e){return i.succeeded(e)}).catch(function(e){var t;r.includes(e.status)?(t=parseInt(e.headers?e.headers["Retry-After"]:null),i.failed(ix(e),isNaN(t)?null:1e3*t)):"Twilsock disconnected"===e.message?i.failed(ix(e)):(i.removeAllListeners(),i.cancel(),n(ix(e)))})}),i.on("succeeded",function(e){t(e)}),i.on("cancelled",function(e){return n(ix(e))}),i.on("failed",function(e){return n(ix(e))}),i.start()})}},{key:"get",value:function(e){var t=this,n=this.createHeaders();return Vk("GET",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry(function(){return t.transport.get(e,n,t.config.productId)},!0)}},{key:"post",value:function(e,t,n){var r=this,i=3<arguments.length&&void 0!==arguments[3]&&arguments[3],o=this.createHeaders();return null!=n&&(o["If-Match"]=n),Vk("POST",e,"ID:",o["Twilio-Request-Id"]),this.executeWithRetry(function(){return r.transport.post(e,o,t,r.config.productId)},i)}},{key:"put",value:function(e,t,n){var r=this,i=this.createHeaders();return null!=n&&(i["If-Match"]=n),Vk("PUT",e,"ID:",i["Twilio-Request-Id"]),this.executeWithRetry(function(){return r.transport.put(e,i,t,r.config.productId)},!1)}},{key:"delete",value:function(e){var t=this,n=this.createHeaders();return Vk("DELETE",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry(function(){return t.transport.delete(e,n,t.config.productId)},!1)}}]);var ox=cx,ax=(dk.default(sx,[{key:"storageKey",value:function(e,t){return"".concat(this.storageId,"::").concat(e,"::").concat(t)}},{key:"isReady",get:function(){return this.config.sessionStorageEnabled&&!!this.storageId}},{key:"updateStorageId",value:function(e){this.storageId=e}},{key:"store",value:function(e,t,n){return this.isReady?this._store(this.storageKey(e,t),n):null}},{key:"read",value:function(e,t){return this.isReady?this._read(this.storageKey(e,t)):null}},{key:"remove",value:function(e,t,n){if(!this.isReady)return null;try{this.storage.removeItem(this.storageKey(e,t)),n&&this.storage.removeItem(this.storageKey(e,n))}catch(e){}}},{key:"update",value:function(e,t,n,r){if(!this.isReady)return null;this._apply(this.storageKey(e,t),r),n&&this._apply(this.storageKey(e,n),r)}},{key:"_store",value:function(e,t){try{this.storage.setItem(e,JSON.stringify(t))}catch(e){}}},{key:"_read",value:function(e){try{var t=this.storage.getItem(e);if(t)return JSON.parse(t)}catch(e){}return null}},{key:"_apply",value:function(e,t){var n=this._read(e);if(!n)return!1;this._store(e,Object.assign(n,t))}}]),sx);function sx(e,t){T.default(this,sx),this.config=e,this.storageId=null;try{this.storage=t||sessionStorage}catch(e){}}function cx(e,t,n){T.default(this,cx),this.clientInfo=e,this.config=t,this.transport=n}function ux(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}dk.default(vx,[{key:"_advanceLastEventId",value:function(e,t){}},{key:"reportFailure",value:function(e){404===e.status?this.onRemoved(!1):this.broadcastEventToListeners("failure",e)}},{key:"_subscribe",value:function(){this.services.router._subscribe(this.sid,this)}},{key:"_unsubscribe",value:function(){this.services.router._unsubscribe(this.sid)}},{key:"_setSubscriptionState",value:function(e){this.subscriptionState=e,this.broadcastEventToListeners("_subscriptionStateChanged",e)}},{key:"close",value:function(){this._unsubscribe(),null!=this.removalHandler&&this.removalHandler(this.type,this.sid,this.uniqueName)}},{key:"attach",value:function(e){var t=e.listenerUuid;this._attachedListeners.get(t)||(this._attachedListeners.size||this._subscribe(),this._attachedListeners.set(t,e))}},{key:"detach",value:function(e){this._attachedListeners.delete(e),this._attachedListeners.size||this.close()}},{key:"broadcastEventToListeners",value:function(e,t){var n,r=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?ux(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?ux(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this._attachedListeners.values());try{for(r.s();!(n=r.n()).done;)n.value.emit(e,t)}catch(e){r.e(e)}finally{r.f()}}}]);var lx,dx,fx,c=vx,px=(dk.default(yx,[{key:"add",value:function(n,r){var i=this,e=new Promise(function(e,t){return i.queuedRequests.push({input:n,requestFunction:r,resolve:e,reject:t})});return this.wakeupQueue(),e}},{key:"squashAndAdd",value:function(e,t){var n,r=this.queuedRequests,i=(this.queuedRequests=[],n=0<r.length?(n=r.map(function(e){return e.input}).reduce(this.inputMergingFunction),this.inputMergingFunction(n,e)):e,this.add(n,t));return r.forEach(function(e){return i.then(e.resolve,e.reject)}),i}},{key:"isEmpty",value:function(){return 0===this.queuedRequests.length&&!this.isRequestInFlight}},{key:"wakeupQueue",value:function(){var e,t=this;0===this.queuedRequests.length||this.isRequestInFlight||(e=this.queuedRequests.shift(),this.isRequestInFlight=!0,e.requestFunction(e.input).then(e.resolve,e.reject).then(function(e){t.isRequestInFlight=!1,t.wakeupQueue()}))}}]),yx),hx=(dk.default(mx,[{key:"add",value:(fx=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,function(e){return e.add(n,r)}));case 1:case"end":return e.stop()}},e,this)})),function(e,t,n){return fx.apply(this,arguments)})},{key:"squashAndAdd",value:(dx=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,function(e){return e.squashAndAdd(n,r)}));case 1:case"end":return e.stop()}},e,this)})),function(e,t,n){return dx.apply(this,arguments)})},{key:"invokeQueueMethod",value:(lx=C.default(I.default.mark(function e(t,n){var r;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.queueByNamespaceKey.has(t)||this.queueByNamespaceKey.set(t,new px(this.inputReducer)),r=this.queueByNamespaceKey.get(t),r=n(r),this.queueByNamespaceKey.get(t).isEmpty()&&this.queueByNamespaceKey.delete(t),e.abrupt("return",r);case 5:case"end":return e.stop()}},e,this)})),function(e,t){return lx.apply(this,arguments)})}]),mx);function mx(e){T.default(this,mx),yk.default(this,"queueByNamespaceKey",new Map),this.inputReducer=e}function yx(e){T.default(this,yx),yk.default(this,"queuedRequests",[]),yk.default(this,"isRequestInFlight",!1),this.inputMergingFunction=e}function vx(e,t){T.default(this,vx),this.services=e,this.removalHandler=t,this.subscriptionState="none",this._attachedListeners=new Map}f=function(){pk.default(i,xk);n=i,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,t=function(){var e,t=mk.default(n);return e=r?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)};function i(){var e;return T.default(this,i),(e=t.call(this)).closed=!1,e.uuid=ck.v4(),e}return dk.default(i,[{key:"listenerUuid",get:function(){return this.uuid}},{key:"close",value:function(){this.removeAllListeners(),this.closed=!0}},{key:"ensureNotClosed",value:function(){if(this.closed)throw new Error("Invalid operation on closed object")}}]),i}();function gx(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=mk.default(n);return e=r?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)}}pk.default(Ux,c),Dx=gx(Ux),dk.default(Ux,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"document"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"_update",value:function(e){switch(e.date_created=new Date(e.date_created),e.type){case"document_updated":var t;e.id<=this.lastEventId?Gk("Document update skipped, current:",this.lastEventId,", remote:",e.id):(t=void 0!==this.descriptor.data?Uk(this.descriptor.data):null,this.descriptor.last_event_id=e.id,this.descriptor.revision=e.document_revision,this.descriptor.date_updated=e.date_created,this.descriptor.data=e.document_data,this.broadcastEventToListeners("updated",{data:e.document_data,isLocal:!1,previousData:t}),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.id,revision:e.document_revision,date_updated:e.date_created,data:e.document_data}));break;case"document_removed":this.onRemoved(!1)}}},{key:"set",value:(Mx=C.default(I.default.mark(function e(t,n){var r,i=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(r,function(e){return i._setUnconditionally(t,e.ttl)}));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return Mx.apply(this,arguments)})},{key:"mutate",value:(Ax=C.default(I.default.mark(function e(t,n){var r,i=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},e.abrupt("return",this.updateMergingQueue.add(r,function(e){return i._setWithIfMatch(t,e.ttl)}));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return Ax.apply(this,arguments)})},{key:"update",value:(Ox=C.default(I.default.mark(function e(t,n){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(function(e){return Object.assign(e,t)},n));case 1:case"end":return e.stop()}},e,this)})),function(e,t){return Ox.apply(this,arguments)})},{key:"setTtl",value:(Px=C.default(I.default.mark(function e(t){var n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({ttl:t});case 2:n=e.sent,this.descriptor.date_expires=n.date_expires;case 4:case"end":return e.stop()}},e,this)})),function(e){return Px.apply(this,arguments)})},{key:"_setUnconditionally",value:(Rx=C.default(I.default.mark(function e(t,n){var r;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({data:t,revision:void 0,ttl:n});case 2:return r=e.sent,this._handleSuccessfulUpdateResult(r),e.abrupt("return",this.descriptor.data);case 5:case"end":return e.stop()}},e,this)})),function(e,t){return Rx.apply(this,arguments)})},{key:"_setWithIfMatch",value:(Ix=C.default(I.default.mark(function e(t,n){var r,i;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t(Uk(this.descriptor.data)))return r=this.revision,e.prev=3,e.next=6,this._postUpdateToServer({data:i,revision:r,ttl:n});e.next=22;break;case 6:return i=e.sent,this._handleSuccessfulUpdateResult(i),e.abrupt("return",this.descriptor.data);case 11:if(e.prev=11,e.t0=e.catch(3),412===e.t0.status)return e.next=16,this._softSync();e.next=19;break;case 16:return e.abrupt("return",this._setWithIfMatch(t));case 19:throw e.t0;case 20:e.next=23;break;case 22:return e.abrupt("return",this.descriptor.data);case 23:case"end":return e.stop()}},e,this,[[3,11]])})),function(e,t){return Ix.apply(this,arguments)})},{key:"_handleSuccessfulUpdateResult",value:function(e){var t;e.last_event_id<=this.descriptor.last_event_id||(t=void 0!==this.descriptor.data?Uk(this.descriptor.data):null,this.descriptor.revision=e.revision,this.descriptor.data=e.data,this.descriptor.last_event_id=e.last_event_id,this.descriptor.date_expires=e.date_expires,this.descriptor.date_updated=new Date(e.date_updated),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.last_event_id,revision:e.revision,date_updated:e.date_updated,data:e.data}),this.broadcastEventToListeners("updated",{data:this.descriptor.data,isLocal:!0,previousData:t}))}},{key:"_postUpdateToServer",value:(Tx=C.default(I.default.mark(function e(t){var n,r;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=17;break}return r={data:t.data},void 0!==t.ttl&&(r.ttl=t.ttl),n=t.revision,e.prev=4,e.next=7,this.services.network.post(this.uri,r,n);case 7:return r=e.sent,e.abrupt("return",{revision:r.body.revision,data:t.data,last_event_id:r.body.last_event_id,date_updated:r.body.date_updated,date_expires:r.body.date_expires});case 11:throw e.prev=11,e.t0=e.catch(4),404===e.t0.status&&this.onRemoved(!1),e.t0;case 15:e.next=18;break;case 17:return e.abrupt("return",Promise.reject(new Dk("The Document has been removed",404,54100)));case 18:case"end":return e.stop()}},e,this,[[4,11]])})),function(e){return Tx.apply(this,arguments)})},{key:"_softSync",value:(Cx=C.default(I.default.mark(function e(){var t=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.network.get(this.uri).then(function(e){e={type:"document_updated",id:e.body.last_event_id,document_revision:e.body.revision,document_data:e.body.data,date_created:e.body.date_updated};return t._update(e),t}).catch(function(e){404===e.status?t.onRemoved(!1):Hk("Can't get updates for ".concat(t.sid,":"),e)}));case 1:case"end":return e.stop()}},e,this)})),function(){return Cx.apply(this,arguments)})},{key:"onRemoved",value:function(e){var t;this.isDeleted||(t=void 0!==this.descriptor.data?Uk(this.descriptor.data):null,this.isDeleted=!0,this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e,previousData:t}))}},{key:"removeDocument",value:(Ex=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=6;break}return e.next=3,this.services.network.delete(this.uri);case 3:this.onRemoved(!0),e.next=7;break;case 6:return e.abrupt("return",Promise.reject(new Dk("The Document has been removed",404,54100)));case 7:case"end":return e.stop()}},e,this)})),function(){return Ex.apply(this,arguments)})}],[{key:"type",get:function(){return"document"}}]);var bx,_x,wx,kx,xx,Sx,Ex,Cx,Tx,Ix,Rx,Px,Ox,Ax,Mx,Dx,jx=Ux,Lx=(pk.default(Nx,f),Sx=gx(Nx),dk.default(Nx,[{key:"uri",get:function(){return this.syncDocumentImpl.uri}},{key:"revision",get:function(){return this.syncDocumentImpl.revision}},{key:"lastEventId",get:function(){return this.syncDocumentImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncDocumentImpl.dateExpires}},{key:"type",get:function(){return jx.type}},{key:"sid",get:function(){return this.syncDocumentImpl.sid}},{key:"data",get:function(){return this.syncDocumentImpl.data}},{key:"dateUpdated",get:function(){return this.syncDocumentImpl.dateUpdated}},{key:"uniqueName",get:function(){return this.syncDocumentImpl.uniqueName}},{key:"set",value:(xx=C.default(I.default.mark(function e(t,n){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.set(t,n));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return xx.apply(this,arguments)})},{key:"mutate",value:(kx=C.default(I.default.mark(function e(t,n){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.mutate(t,n));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return kx.apply(this,arguments)})},{key:"update",value:(wx=C.default(I.default.mark(function e(t,n){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.update(t,n));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return wx.apply(this,arguments)})},{key:"setTtl",value:(_x=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return _x.apply(this,arguments)})},{key:"removeDocument",value:(bx=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.removeDocument());case 2:case"end":return e.stop()}},e,this)})),function(){return bx.apply(this,arguments)})},{key:"close",value:function(){_k.default(mk.default(Nx.prototype),"close",this).call(this),this.syncDocumentImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return jx.type}}]),Nx);function Nx(e){var t;return T.default(this,Nx),(t=Sx.call(this)).syncDocumentImpl=e,t.syncDocumentImpl.attach(fk.default(t)),t}function Ux(e,t,n){return T.default(this,Ux),e=Dx.call(this,e,n),yk.default(fk.default(e),"isDeleted",!1),e.updateMergingQueue=new px(function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e}),e.descriptor=t,e.descriptor.data=e.descriptor.data||{},e.descriptor.date_updated=new Date(e.descriptor.date_updated),e}yk.default(Lx,"removed","removed"),yk.default(Lx,"updated","updated"),R([k.validateTypesAsync(k.pureObject,["undefined",k.objectSchema("document metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Object,Object]),P("design:returntype",Promise)],Lx.prototype,"set",null),R([k.validateTypesAsync("function",["undefined",k.objectSchema("document metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Function,Object]),P("design:returntype",Promise)],Lx.prototype,"mutate",null),R([k.validateTypesAsync(k.pureObject,["undefined",k.objectSchema("document metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Object,Object]),P("design:returntype",Promise)],Lx.prototype,"update",null),R([k.validateTypesAsync(k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number]),P("design:returntype",Promise)],Lx.prototype,"setTtl",null);dk.default(Gx,[{key:"uri",get:function(){return this.descriptor.uri}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.lastEventId}},{key:"dateUpdated",get:function(){return this.descriptor.dateUpdated}},{key:"dateExpires",get:function(){return this.descriptor.dateExpires}},{key:"index",get:function(){return this.descriptor.index}},{key:"data",get:function(){return this.descriptor.data}},{key:"update",value:function(e,t,n,r){return this.descriptor.lastEventId=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.dateUpdated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.dateExpires=e}}]);var Fx,Bx,qx=Gx,zx=(dk.default(Wx,[{key:"hasNextPage",get:function(){return!!this.nextToken}},{key:"hasPrevPage",get:function(){return!!this.prevToken}},{key:"nextPage",value:(Bx=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasNextPage){e.next=2;break}throw new Error("No next page");case 2:return e.abrupt("return",this.source(this.nextToken));case 3:case"end":return e.stop()}},e,this)})),function(){return Bx.apply(this,arguments)})},{key:"prevPage",value:(Fx=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPrevPage){e.next=2;break}throw new Error("No previous page");case 2:return e.abrupt("return",this.source(this.prevToken));case 3:case"end":return e.stop()}},e,this)})),function(){return Fx.apply(this,arguments)})}]),Wx);function Wx(e,t,n,r){T.default(this,Wx),this.prevToken=n,this.nextToken=r,this.items=e,this.source=t}function Gx(e){T.default(this,Gx),this.descriptor=e}function Vx(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}dk.default(Kx,[{key:"isRoot",get:function(){return null===this.parent}},{key:"isLeaf",get:function(){return null===this.left&&null===this.right}},{key:"isLeftChild",get:function(){return this.parent.left===this}},{key:"update",value:function(e){this.value=e}},{key:"replace",value:function(e,t){e&&(this.left===t?this.left=t:this.right===t&&(this.right=t))}}]);var Hx=Kx,Jx=(dk.default($x,[{key:"size",get:function(){return this.count}},{key:"clear",value:function(){this.root=null,this.count=0}},{key:"set",value:function(e,t){var n=this.getNode(e);n?n.update(t):this.insert(e,t)}},{key:"insert",value:function(e,t){var n=new Hx(e,t);if(this.count++,this.root){for(var r=this.root;;)if(this.isLessThan(e,r.key)){if(!r.left){r.left=n;break}r=r.left}else{if(!r.right){r.right=n;break}r=r.right}for(n.parent=r,r=n;r.parent;){var i=r.parent,o=i.balanceFactor;if(r.isLeftChild?i.balanceFactor++:i.balanceFactor--,Math.abs(i.balanceFactor)<Math.abs(o))break;if(i.balanceFactor<-1||1<i.balanceFactor){this.rebalance(i);break}r=i}}else this.root=n}},{key:"get",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t.value;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"delete",value:function(e){var t=this.getNode(e);if(t&&t.key===e){var e=t.parent,n=t.left,r=t.right;if(!!n!=!!r){n=n||r;e||n?e&&!n?this.root=n:(e.replace(t,null),this.rebalance(e)):this.root=null}else{for(var i=t.left;i.right;)i=i.right;t=t.left===i?(t.isRoot?(this.root=i).parent=null:(t.isLeftChild?t.parent.left=i:t.parent.right=i,i.parent=t.parent),i.right=t.right,(i.right.parent=i).balanceFactor=t.balanceFactor,{parent:i,isLeftChild:!0}):(r=i.parent,n=i.left,(r.right=n)&&(n.parent=r),t.isRoot?(this.root=i).parent=null:(t.isLeftChild?t.parent.left=i:t.parent.right=i,i.parent=t.parent),i.right=t.right,(i.right.parent=i).left=t.left,(i.left.parent=i).balanceFactor=t.balanceFactor,{parent:r,isLeftChild:!1})}for(this.count--;t.parent;){var o=t.parent,a=o.balanceFactor;if(t.isLeftChild?--o.balanceFactor:o.balanceFactor+=1,Math.abs(o.balanceFactor)>Math.abs(a)){if(!(o.balanceFactor<-1||1<o.balanceFactor))break;if(this.rebalance(o),0!==o.parent.balanceFactor)break;t=o.parent}else t=o}}return null}},{key:"getNode",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"rebalance",value:function(e){e.balanceFactor<0?(0<e.right.balanceFactor&&this.rotateRight(e.right),this.rotateLeft(e)):0<e.balanceFactor&&(e.left.balanceFactor<0&&this.rotateLeft(e.left),this.rotateRight(e))}},{key:"rotateLeft",value:function(e){var t=e.right;e.right=t.left,null!==t.left&&(t.left.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,(t.left=e).parent=t,e.balanceFactor=e.balanceFactor+1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor+1-Math.max(e.balanceFactor,0)}},{key:"rotateRight",value:function(e){var t=e.left;e.left=t.right,null!==t.right&&(t.right.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,(t.right=e).parent=t,e.balanceFactor=e.balanceFactor-1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor-1-Math.max(e.balanceFactor,0)}},{key:Symbol.iterator,value:I.default.mark(function e(){var t,n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?Vx(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Vx(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.getIterator()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return n=n.value,e.next=7,n;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}},e,this,[[1,11,14,17]])})},{key:"getIterator",value:I.default.mark(function e(){var t,n,r,i=arguments;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=0<i.length&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(n){if(this.isEqual(t,n.key)||null===t&&!n.left)return e.abrupt("break",8);e.next=5}else e.next=8;break;case 5:n=this.isLessThan(t,n.key)||null===t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(r)return e.next=14,[n.key,n.value];e.next=29;break;case 14:if(r=!1,n.right){for(n=n.right;n.left;)n=n.left;r=!0,e.next=27}else e.next=21;break;case 21:n.parent?(r=n.parent.left===n,n=n.parent,e.next=27):e.next=26;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:n.parent?(r=n.parent.left===n,n=n.parent,e.next=35):e.next=34;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}},e,this)})},{key:"getReverseIterator",value:I.default.mark(function e(){var t,n,r,i=arguments;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=0<i.length&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(n){if(this.isEqual(t,n.key)||null===t&&!n.right)return e.abrupt("break",8);e.next=5}else e.next=8;break;case 5:n=this.isLessThan(t,n.key)&&null!==t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(r)return e.next=14,[n.key,n.value];e.next=29;break;case 14:if(r=!1,n.left){for(n=n.left;n.right;)n=n.right;r=!0,e.next=27}else e.next=21;break;case 21:n.parent?(r=n.parent.right===n,n=n.parent,e.next=27):e.next=26;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:n.parent?(r=n.parent.right===n,n=n.parent,e.next=35):e.next=34;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}},e,this)})}]),$x);function $x(e,t){T.default(this,$x),this.isLessThan=e||function(e,t){return e<t},this.isEqual=t||function(e,t){return e===t},this.root=null,this.count=null}function Kx(e,t){T.default(this,Kx),this.balanceFactor=0,this.key=e,this.value=t,this.parent=null,this.left=null,this.right=null}function Yx(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}dk.default(n1,[{key:"isValid",get:function(){return!0}}]);var Qx=n1,Xx=(dk.default(t1,[{key:"isValid",get:function(){return!1}}]),t1),Zx=(dk.default(e1,[{key:"store",value:function(e,t,n){var r=this.items.get(e);return r&&r.revision>n?r.isValid?r.value:null:(this.items.set(e,new Qx(t,n)),t)}},{key:"delete",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=this.items.get(e);(!r||r.revision<t||r&&!0===n)&&this.items.set(e,new Xx(t))}},{key:"isKnown",value:function(e,t){e=this.items.get(e);return e&&e.revision>=t}},{key:"get",value:function(e){e=this.items.get(e);return e&&e.isValid?e.value:null}},{key:"has",value:function(e){e=this.items.get(e);return e&&e.isValid}},{key:"forEach",value:function(e){if(this.items){var t,n=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?Yx(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Yx(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.items);try{for(n.s();!(t=n.n()).done;){var r=gk.default(t.value,2),i=r[0],o=r[1];o.isValid&&e(i,o.value)}}catch(e){n.e(e)}finally{n.f()}}}}]),e1);function e1(){T.default(this,e1),this.items=new Jx}function t1(e){T.default(this,t1),this.revision=e}function n1(e,t){T.default(this,n1),this.value=e,this.revision=t||0}function r1(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=mk.default(n);return e=r?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)}}pk.default(L1,c),A1=r1(L1),dk.default(L1,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"list"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"_addOrUpdateItemOnServer",value:(R1=C.default(I.default.mark(function e(t,n,r,i){var o;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o={data:n},void 0!==i&&(o.ttl=i),e.next=4,this.services.network.post(t,o,r);case 4:return(o=e.sent).body.data=n,o.body.date_updated=new Date(o.body.date_updated),e.abrupt("return",o.body);case 8:case"end":return e.stop()}},e,this)})),function(e,t,n,r){return R1.apply(this,arguments)})},{key:"push",value:(I1=C.default(I.default.mark(function e(t,n){var r,i;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=(n||{}).ttl,e.next=3,this._addOrUpdateItemOnServer(this.links.items,t,void 0,r);case 3:return r=e.sent,i=Number(r.index),this._handleItemMutated(i,r.url,r.last_event_id,r.revision,t,r.date_updated,r.date_expires,!0,!1),e.abrupt("return",this.cache.get(i));case 7:case"end":return e.stop()}},e,this)})),function(e,t){return I1.apply(this,arguments)})},{key:"set",value:(T1=C.default(I.default.mark(function e(t,n,r){var i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,function(e){return o._updateItemUnconditionally(t,n,e.ttl)}));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return T1.apply(this,arguments)})},{key:"_updateItemUnconditionally",value:(C1=C.default(I.default.mark(function e(t,n,r){var i;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return i=e.sent,e.next=5,this._addOrUpdateItemOnServer(i.uri,n,void 0,r);case 5:return i=e.sent,this._handleItemMutated(t,i.url,i.last_event_id,i.revision,i.data,i.date_updated,i.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 8:case"end":return e.stop()}},e,this)})),function(e,t,n){return C1.apply(this,arguments)})},{key:"_updateItemWithIfMatch",value:(E1=C.default(I.default.mark(function e(t,n,r){var i,o,a;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:if(i=e.sent,a=n(Uk(i.data)))return o=i.revision,e.prev=6,e.next=9,this._addOrUpdateItemOnServer(i.uri,a,o,r);e.next=25;break;case 9:return a=e.sent,this._handleItemMutated(t,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 14:if(e.prev=14,e.t0=e.catch(6),412===e.t0.status)return e.next=19,this._getItemFromServer(t);e.next=22;break;case 19:return e.abrupt("return",this._updateItemWithIfMatch(t,n,r));case 22:throw e.t0;case 23:e.next=26;break;case 25:return e.abrupt("return",i);case 26:case"end":return e.stop()}},e,this,[[6,14]])})),function(e,t,n){return E1.apply(this,arguments)})},{key:"mutate",value:(S1=C.default(I.default.mark(function e(t,n,r){var i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.add(t,i,function(e){return o._updateItemWithIfMatch(t,n,e.ttl)}));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return S1.apply(this,arguments)})},{key:"update",value:(x1=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,function(e){return Object.assign(e,n)},r));case 1:case"end":return e.stop()}},e,this)})),function(e,t,n){return x1.apply(this,arguments)})},{key:"remove",value:(k1=C.default(I.default.mark(function e(t){var n,r;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,n=Uk(r.data),e.next=6,this.services.network.delete(r.uri);case 6:r=e.sent,this._handleItemRemoved(t,r.body.last_event_id,n,new Date(r.body.date_updated),!1);case 8:case"end":return e.stop()}},e,this)})),function(e){return k1.apply(this,arguments)})},{key:"get",value:(O1=C.default(I.default.mark(function e(t){var n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.cache.get(t))return e.abrupt("return",n);e.next=5;break;case 5:return e.abrupt("return",this._getItemFromServer(t));case 6:case"end":return e.stop()}},e,this)})),function(e){return O1.apply(this,arguments)})},{key:"_getItemFromServer",value:(w1=C.default(I.default.mark(function e(t){var n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({index:t});case 2:if((n=e.sent).items.length<1)throw new Dk("No item with index ".concat(t," found"),404,54151);e.next=7;break;case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}},e,this)})),function(e){return w1.apply(this,arguments)})},{key:"queryItems",value:(P1=C.default(I.default.mark(function e(t){var n,r,i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new Rk(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Index",t.index).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return n=e.sent,r=n.body.items.map(function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.index)?o._handleItemMutated(e.index,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(Number(e.index),new qx({index:Number(e.index),uri:e.url,revision:e.revision,lastEventId:e.last_event_id,dateUpdated:e.date_updated,dateExpires:e.date_expires,data:e.data}),e.last_event_id),o.cache.get(e.index)}),i=n.body.meta,e.abrupt("return",new zx(r,function(e){return o.queryItems({pageToken:e})},i.previous_token,i.next_token));case 8:case"end":return e.stop()}},e,this)})),function(e){return P1.apply(this,arguments)})},{key:"getItems",value:(_1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return Fk((t=t||{}).pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}},e,this)})),function(e){return _1.apply(this,arguments)})},{key:"getContext",value:(b1=C.default(I.default.mark(function e(){var t;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.context){e.next=5;break}return e.next=3,this.services.network.get(this.links.context);case 3:t=e.sent,this._updateContextIfRequired(t.body.data,t.body.last_event_id);case 5:return e.abrupt("return",this.context);case 6:case"end":return e.stop()}},e,this)})),function(){return b1.apply(this,arguments)})},{key:"setTtl",value:(g1=C.default(I.default.mark(function e(t){var n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:n=e.sent,this.descriptor.date_expires=n.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}},e,this,[[0,8]])})),function(e){return g1.apply(this,arguments)})},{key:"setItemTtl",value:(v1=C.default(I.default.mark(function e(t,n){var r,i;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,i={ttl:n},e.next=6,this.services.network.post(r.uri,i);case 6:i=e.sent,r.updateDateExpires(i.body.date_expires);case 8:case"end":return e.stop()}},e,this)})),function(e,t){return v1.apply(this,arguments)})},{key:"removeList",value:(y1=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}},e,this)})),function(){return y1.apply(this,arguments)})},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){var n=Number(e.item_index);switch(e.date_created=new Date(e.date_created),e.type){case"list_item_added":case"list_item_updated":this._handleItemMutated(n,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"list_item_added"===e.type,!0);break;case"list_item_removed":this._handleItemRemoved(n,e.id,e.item_data,e.date_created,!0);break;case"list_context_updated":this._handleContextUpdate(e.context_data,e.id,e.date_created);break;case"list_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.list_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t)&&(this.descriptor.revision=t)}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,o,a,s,c){var u,l;this.shouldIgnoreEvent(e,n)?Gk("Item ".concat(e," update skipped, current: ").concat(this.lastEventId,", remote: ").concat(n)):(this._updateRootDateUpdated(o),(u=this.cache.get(e))?(l=Uk(u.data),u.update(n,r,i,o),this.cache.store(e,u,n),void 0!==a&&u.updateDateExpires(a),this.emitItemMutationEvent(u,c,!1,l)):(u=new qx({index:e,uri:t,lastEventId:n,revision:r,data:i,dateUpdated:o,dateExpires:a}),this.cache.store(e,u,n),this.emitItemMutationEvent(u,c,s)))}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=n?"itemAdded":"itemUpdated",e={item:e,isLocal:!t};n||(e.previousItemData=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null),this.broadcastEventToListeners(r,e)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{index:e,isLocal:!i,previousItemData:n})}},{key:"_handleContextUpdate",value:function(e,t,n){this._updateRootDateUpdated(n),this._updateContextIfRequired(e,t)&&this.broadcastEventToListeners("contextUpdated",{context:e,isLocal:!1})}},{key:"_updateContextIfRequired",value:function(e,t){return!this.contextEventId||t>this.contextEventId?(this.context=e,this.contextEventId=t,!0):(Gk("Context update skipped, current:",this.lastEventId,", remote:",t),!1)}}],[{key:"type",get:function(){return"list"}}]);var i1,o1,a1,s1,c1,u1,l1,d1,f1,p1,h1,m1,y1,v1,g1,b1,_1,w1,k1,x1,S1,E1,C1,T1,I1,R1,P1,O1,A1,M1=L1,D1=(pk.default(j1,f),m1=r1(j1),dk.default(j1,[{key:"uri",get:function(){return this.syncListImpl.uri}},{key:"revision",get:function(){return this.syncListImpl.revision}},{key:"lastEventId",get:function(){return this.syncListImpl.lastEventId}},{key:"links",get:function(){return this.syncListImpl.links}},{key:"dateExpires",get:function(){return this.syncListImpl.dateExpires}},{key:"type",get:function(){return M1.type}},{key:"sid",get:function(){return this.syncListImpl.sid}},{key:"uniqueName",get:function(){return this.syncListImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncListImpl.dateUpdated}},{key:"push",value:(h1=C.default(I.default.mark(function e(t,n){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.push(t,n));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return h1.apply(this,arguments)})},{key:"set",value:(p1=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.set(t,n,r));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return p1.apply(this,arguments)})},{key:"mutate",value:(f1=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.mutate(t,n,r));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return f1.apply(this,arguments)})},{key:"update",value:(d1=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.update(t,n,r));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return d1.apply(this,arguments)})},{key:"remove",value:(l1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.remove(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return l1.apply(this,arguments)})},{key:"get",value:(u1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.get(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return u1.apply(this,arguments)})},{key:"getContext",value:(c1=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getContext());case 2:case"end":return e.stop()}},e,this)})),function(){return c1.apply(this,arguments)})},{key:"getItems",value:(s1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getItems(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return s1.apply(this,arguments)})},{key:"setTtl",value:(a1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return a1.apply(this,arguments)})},{key:"setItemTtl",value:(o1=C.default(I.default.mark(function e(t,n){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return o1.apply(this,arguments)})},{key:"removeList",value:(i1=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.removeList());case 2:case"end":return e.stop()}},e,this)})),function(){return i1.apply(this,arguments)})},{key:"close",value:function(){_k.default(mk.default(j1.prototype),"close",this).call(this),this.syncListImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return M1.type}}]),j1);function j1(e){var t;return T.default(this,j1),(t=m1.call(this)).syncListImpl=e,t.syncListImpl.attach(fk.default(t)),t}function L1(e,t,n){return T.default(this,L1),(e=A1.call(this,e,n)).updateMergingQueue=new hx(function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e}),e.cache=new Zx,e.descriptor=t,e.descriptor.date_updated=new Date(e.descriptor.date_updated),e}yk.default(D1,"itemAdded","itemAdded"),yk.default(D1,"itemUpdated","itemUpdated"),yk.default(D1,"itemRemoved","itemRemoved"),yk.default(D1,"removed","removed"),R([k.validateTypesAsync(k.pureObject,["undefined",k.objectSchema("item metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Object,Object]),P("design:returntype",Promise)],D1.prototype,"push",null),R([k.validateTypesAsync(k.nonNegativeInteger,k.pureObject,["undefined",k.objectSchema("item metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Number,Object,Object]),P("design:returntype",Promise)],D1.prototype,"set",null),R([k.validateTypesAsync(k.nonNegativeInteger,"function",["undefined",k.objectSchema("item metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Number,Function,Object]),P("design:returntype",Promise)],D1.prototype,"mutate",null),R([k.validateTypesAsync(k.nonNegativeInteger,k.pureObject,["undefined",k.objectSchema("item metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Number,Object,Object]),P("design:returntype",Promise)],D1.prototype,"update",null),R([k.validateTypesAsync(k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number]),P("design:returntype",Promise)],D1.prototype,"remove",null),R([k.validateTypesAsync(k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number]),P("design:returntype",Promise)],D1.prototype,"get",null),R([k.validateTypesAsync(["undefined",k.objectSchema("query options",{from:[k.nonNegativeInteger,"undefined"],pageSize:[k.custom(function(e){return[Bk(e),"a positive integer"]}),"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],D1.prototype,"getItems",null),R([k.validateTypesAsync(k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number]),P("design:returntype",Promise)],D1.prototype,"setTtl",null),R([k.validateTypesAsync(k.nonNegativeInteger,k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number,Number]),P("design:returntype",Promise)],D1.prototype,"setItemTtl",null);dk.default(U1,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"key",get:function(){return this.descriptor.key}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"update",value:function(e,t,n,r){return this.descriptor.last_event_id=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.date_updated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.date_expires=e}}]);var N1=U1;function U1(e){T.default(this,U1),this.descriptor=e}function F1(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=mk.default(n);return e=r?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)}}pk.default(hS,c),lS=F1(hS),dk.default(hS,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"map"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"set",value:(sS=C.default(I.default.mark(function e(t,n,r){var i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,function(e){return o._putItemUnconditionally(t,n,e.ttl)}));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return sS.apply(this,arguments)})},{key:"get",value:(uS=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null==t)throw new Dk("SyncMapItem key may not be empty",400,54209);e.next=2;break;case 2:if(this.cache.has(t))return e.abrupt("return",this.cache.get(t));e.next=6;break;case 6:return e.abrupt("return",this._getItemFromServer(t));case 7:case"end":return e.stop()}},e,this)})),function(e){return uS.apply(this,arguments)})},{key:"_getItemFromServer",value:(aS=C.default(I.default.mark(function e(t){var n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({key:t});case 2:if((n=e.sent).items.length<1)throw new Dk("The specified Map Item does not exist",404,54201);e.next=7;break;case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}},e,this)})),function(e){return aS.apply(this,arguments)})},{key:"mutate",value:(oS=C.default(I.default.mark(function e(t,n,r){var i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.add(t,i,function(e){return o._putItemWithIfMatch(t,n,e.ttl)}));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return oS.apply(this,arguments)})},{key:"update",value:(iS=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,function(e){return Object.assign(e,n)},r));case 1:case"end":return e.stop()}},e,this)})),function(e,t,n){return iS.apply(this,arguments)})},{key:"_putItemUnconditionally",value:(rS=C.default(I.default.mark(function e(t,n,r){var i,o;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._putItemToServer(t,n,void 0,r);case 2:return i=e.sent,o=i.item,this._handleItemMutated(o.key,o.url,o.last_event_id,o.revision,o.data,o.date_updated,o.date_expires,i.added,!1),e.abrupt("return",this.cache.get(o.key));case 6:case"end":return e.stop()}},e,this)})),function(e,t,n){return rS.apply(this,arguments)})},{key:"_putItemWithIfMatch",value:(nS=C.default(I.default.mark(function e(t,n,r){var i,o,a;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t).catch(function(e){if(404===e.status)return new N1({key:t,data:{},last_event_id:-1,revision:"-1",url:null,date_updated:null,date_expires:null});throw e});case 2:if(i=e.sent,o=n(Uk(i.data)))return a=i.revision,e.prev=6,e.next=9,this._putItemToServer(t,o,a,r);e.next=26;break;case 9:return o=e.sent,a=o.item,this._handleItemMutated(a.key,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,o.added,!1),e.abrupt("return",this.cache.get(a.key));case 15:if(e.prev=15,e.t0=e.catch(6),412===e.t0.status)return e.next=20,this._getItemFromServer(t);e.next=23;break;case 20:return e.abrupt("return",this._putItemWithIfMatch(t,n,r));case 23:throw e.t0;case 24:e.next=27;break;case 26:return e.abrupt("return",i);case 27:case"end":return e.stop()}},e,this,[[6,15]])})),function(e,t,n){return nS.apply(this,arguments)})},{key:"_putItemToServer",value:(tS=C.default(I.default.mark(function e(t,n,r,i){var o,a,s;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=new Rk(this.links.items).pathSegment(t).build(),a={data:n},void 0!==i&&(a.ttl=i),e.prev=3,e.next=6,this.services.network.put(o,a,r);case 6:return o=e.sent,(a=o.body).data=n,a.date_updated=new Date(a.date_updated),s=201===o.status.code,e.abrupt("return",{added:s,item:a});case 14:throw e.prev=14,e.t0=e.catch(3),404===e.t0.status&&this.onRemoved(!1),e.t0;case 18:case"end":return e.stop()}},e,this,[[3,14]])})),function(e,t,n,r){return tS.apply(this,arguments)})},{key:"remove",value:(eS=C.default(I.default.mark(function e(t){var n,r;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,n=Uk(r.data),e.next=6,this.services.network.delete(r.uri);case 6:r=e.sent,this._handleItemRemoved(t,r.body.last_event_id,n,new Date(r.body.date_updated),!1);case 8:case"end":return e.stop()}},e,this)})),function(e){return eS.apply(this,arguments)})},{key:"queryItems",value:(cS=C.default(I.default.mark(function e(t){var n,r,i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new Rk(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Key",t.key).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return n=e.sent,r=n.body.items.map(function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.key)?o._handleItemMutated(e.key,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(e.key,new N1(e),e.last_event_id),o.cache.get(e.key)}),i=n.body.meta,e.abrupt("return",new zx(r,function(e){return o.queryItems({pageToken:e})},i.previous_token,i.next_token));case 8:case"end":return e.stop()}},e,this)})),function(e){return cS.apply(this,arguments)})},{key:"getItems",value:(Z1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return Fk((t=t||{}).pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}},e,this)})),function(e){return Z1.apply(this,arguments)})},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){switch(e.date_created=new Date(e.date_created),e.type){case"map_item_added":case"map_item_updated":this._handleItemMutated(e.item_key,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"map_item_added"===e.type,!0);break;case"map_item_removed":this._handleItemRemoved(e.item_key,e.id,e.item_data,e.date_created,!0);break;case"map_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.map_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t)&&(this.descriptor.revision=t)}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,o,a,s,c){var u,l;this.shouldIgnoreEvent(e,n)?Gk("SyncMapItem ",e," update skipped, current:",this.lastEventId,", remote:",n):(this._updateRootDateUpdated(o),(u=this.cache.get(e))?(l=Uk(u.data),u.update(n,r,i,o),this.cache.store(e,u,n),void 0!==a&&u.updateDateExpires(a),this.emitItemMutationEvent(u,c,!1,l)):(u=new N1({key:e,url:t,last_event_id:n,revision:r,data:i,date_updated:o,date_expires:a}),this.cache.store(e,u,n),this.emitItemMutationEvent(u,c,s)))}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=n?"itemAdded":"itemUpdated",e={item:e,isLocal:!t};n||(e.previousItemData=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null),this.broadcastEventToListeners(r,e)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{key:e,isLocal:!i,previousItemData:n})}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"setTtl",value:(X1=C.default(I.default.mark(function e(t){var n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:n=e.sent,this.descriptor.date_expires=n.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}},e,this,[[0,8]])})),function(e){return X1.apply(this,arguments)})},{key:"setItemTtl",value:(Q1=C.default(I.default.mark(function e(t,n){var r,i;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,i={ttl:n},e.next=6,this.services.network.post(r.uri,i);case 6:i=e.sent,r.updateDateExpires(i.body.date_expires);case 8:case"end":return e.stop()}},e,this)})),function(e,t){return Q1.apply(this,arguments)})},{key:"removeMap",value:(Y1=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}},e,this)})),function(){return Y1.apply(this,arguments)})}],[{key:"type",get:function(){return"map"}}]);var B1,q1,z1,W1,G1,V1,H1,J1,$1,K1,Y1,Q1,X1,Z1,eS,tS,nS,rS,iS,oS,aS,sS,cS,uS,lS,dS=hS,fS=(pk.default(pS,f),K1=F1(pS),dk.default(pS,[{key:"uri",get:function(){return this.syncMapImpl.uri}},{key:"links",get:function(){return this.syncMapImpl.links}},{key:"revision",get:function(){return this.syncMapImpl.revision}},{key:"lastEventId",get:function(){return this.syncMapImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncMapImpl.dateExpires}},{key:"type",get:function(){return dS.type}},{key:"sid",get:function(){return this.syncMapImpl.sid}},{key:"uniqueName",get:function(){return this.syncMapImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncMapImpl.dateUpdated}},{key:"set",value:($1=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.set(t,n,r));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return $1.apply(this,arguments)})},{key:"get",value:(J1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.get(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return J1.apply(this,arguments)})},{key:"mutate",value:(H1=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.mutate(t,n,r));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return H1.apply(this,arguments)})},{key:"update",value:(V1=C.default(I.default.mark(function e(t,n,r){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.update(t,n,r));case 2:case"end":return e.stop()}},e,this)})),function(e,t,n){return V1.apply(this,arguments)})},{key:"remove",value:(G1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.remove(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return G1.apply(this,arguments)})},{key:"getItems",value:(W1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.getItems(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return W1.apply(this,arguments)})},{key:"setTtl",value:(z1=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return z1.apply(this,arguments)})},{key:"setItemTtl",value:(q1=C.default(I.default.mark(function e(t,n){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return q1.apply(this,arguments)})},{key:"removeMap",value:(B1=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.next=3,this.syncMapImpl.removeMap();case 3:case"end":return e.stop()}},e,this)})),function(){return B1.apply(this,arguments)})},{key:"close",value:function(){_k.default(mk.default(pS.prototype),"close",this).call(this),this.syncMapImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return dS.type}}]),pS);function pS(e){var t;return T.default(this,pS),(t=K1.call(this)).syncMapImpl=e,t.syncMapImpl.attach(fk.default(t)),t}function hS(e,t,n){var r;return T.default(this,hS),(r=lS.call(this,e,n)).updateMergingQueue=new hx(function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e}),r.cache=new Zx,r.descriptor=t,r.descriptor.date_updated=new Date(r.descriptor.date_updated),t.items&&t.items.forEach(function(e){e.date_updated=new Date(e.date_updated),r.cache.store(e.key,new N1(e),e.last_event_id)}),r}function mS(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=mk.default(n);return e=r?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)}}yk.default(fS,"itemAdded","itemAdded"),yk.default(fS,"itemUpdated","itemUpdated"),yk.default(fS,"itemRemoved","itemRemoved"),yk.default(fS,"removed","removed"),R([k.validateTypesAsync("string",k.pureObject,["undefined",k.objectSchema("item metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[String,Object,Object]),P("design:returntype",Promise)],fS.prototype,"set",null),R([k.validateTypesAsync("string"),P("design:type",Function),P("design:paramtypes",[String]),P("design:returntype",Promise)],fS.prototype,"get",null),R([k.validateTypesAsync("string","function",["undefined",k.objectSchema("item metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[String,Function,Object]),P("design:returntype",Promise)],fS.prototype,"mutate",null),R([k.validateTypesAsync("string",k.pureObject,["undefined",k.objectSchema("item metadata",{ttl:[k.nonNegativeInteger,"undefined"]})]),P("design:type",Function),P("design:paramtypes",[String,Object,Object]),P("design:returntype",Promise)],fS.prototype,"update",null),R([k.validateTypesAsync("string"),P("design:type",Function),P("design:paramtypes",[String]),P("design:returntype",Promise)],fS.prototype,"remove",null),R([k.validateTypesAsync(["undefined",k.objectSchema("query options",{from:["string","undefined"],pageSize:[k.custom(function(e){return[Bk(e),"a positive integer"]}),"undefined"]})]),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],fS.prototype,"getItems",null),R([k.validateTypesAsync(k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number]),P("design:returntype",Promise)],fS.prototype,"setTtl",null),R([k.validateTypesAsync("string",k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[String,Number]),P("design:returntype",Promise)],fS.prototype,"setItemTtl",null);pk.default(wS,c),bS=mS(wS),dk.default(wS,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"stream"}},{key:"lastEventId",get:function(){return null}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"publishMessage",value:(gS=C.default(I.default.mark(function e(t){var n,r;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n={data:t},e.next=3,this.services.network.post(this.links.messages,n);case 3:return n=e.sent,r=n.body,r=this._handleMessagePublished(r.sid,t,!1),e.abrupt("return",r);case 7:case"end":return e.stop()}},e,this)})),function(e){return gS.apply(this,arguments)})},{key:"setTtl",value:(vS=C.default(I.default.mark(function e(t){var n;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:n=e.sent,this.descriptor.date_expires=n.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}},e,this,[[0,8]])})),function(e){return vS.apply(this,arguments)})},{key:"removeStream",value:(yS=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}},e,this)})),function(){return yS.apply(this,arguments)})},{key:"_update",value:function(e){switch(e.type){case"stream_message_published":this._handleMessagePublished(e.message_sid,e.message_data,!0);break;case"stream_removed":this.onRemoved(!1)}}},{key:"_handleMessagePublished",value:function(e,t,n){e={sid:e,data:t};return this.broadcastEventToListeners("messagePublished",{message:e,isLocal:!n}),e}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}}],[{key:"type",get:function(){return"stream"}}]);var yS,vS,gS,bS,_S=wS;function wS(e,t,n){return T.default(this,wS),(e=bS.call(this,e,n)).descriptor=t,e}R([k.validateTypesAsync(k.pureObject),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],_S.prototype,"publishMessage",null),R([k.validateTypesAsync(k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number]),P("design:returntype",Promise)],_S.prototype,"setTtl",null);pk.default(TS,f),ES=mS(TS),dk.default(TS,[{key:"uri",get:function(){return this.syncStreamImpl.uri}},{key:"links",get:function(){return this.syncStreamImpl.links}},{key:"dateExpires",get:function(){return this.syncStreamImpl.dateExpires}},{key:"type",get:function(){return _S.type}},{key:"lastEventId",get:function(){return null}},{key:"sid",get:function(){return this.syncStreamImpl.sid}},{key:"uniqueName",get:function(){return this.syncStreamImpl.uniqueName}},{key:"publishMessage",value:(SS=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.publishMessage(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return SS.apply(this,arguments)})},{key:"setTtl",value:(xS=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.setTtl(t));case 2:case"end":return e.stop()}},e,this)})),function(e){return xS.apply(this,arguments)})},{key:"removeStream",value:(kS=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.removeStream());case 2:case"end":return e.stop()}},e,this)})),function(){return kS.apply(this,arguments)})},{key:"close",value:function(){_k.default(mk.default(TS.prototype),"close",this).call(this),this.syncStreamImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return _S.type}}]);var kS,xS,SS,ES,CS=TS;function TS(e){var t;return T.default(this,TS),(t=ES.call(this)).syncStreamImpl=e,t.syncStreamImpl.attach(fk.default(t)),t}yk.default(CS,"messagePublished","messagePublished"),yk.default(CS,"removed","removed"),R([k.validateTypesAsync(k.pureObject),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],CS.prototype,"publishMessage",null),R([k.validateTypesAsync(k.nonNegativeInteger),P("design:type",Function),P("design:paramtypes",[Number]),P("design:returntype",Promise)],CS.prototype,"setTtl",null);function IS(e){T.default(this,IS),this.sdk="js",this.sdkVer=e,this.os=wk.os.family,this.osVer=wk.os.version,this.pl=wk.name,this.plVer=wk.version}dk.default(PS,[{key:"store",value:function(e){return this.entities.get(e.sid)||(this.entities.set(e.sid,e),e.uniqueName&&this.names.set(e.type+"::"+e.uniqueName,e.sid),e)}},{key:"getResolved",value:function(e,t){t=this.names.get(t+"::"+e);return t?this.entities.get(t):null}},{key:"get",value:function(e,t){return this.entities.get(e)||this.getResolved(e,t)||null}},{key:"remove",value:function(e){var t=this.entities.get(e);t&&(this.entities.delete(e),t.uniqueName)&&this.names.delete(t.type+"::"+t.uniqueName)}}]);var RS=PS;function PS(){T.default(this,PS),this.names=new Map,this.entities=new Map}function OS(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=mk.default(n);return e=r?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)}}pk.default(DS,c),AS=OS(DS),dk.default(DS,[{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return null}},{key:"type",get:function(){return DS.type}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"indexName",get:function(){return this.descriptor.indexName}},{key:"queryString",get:function(){return this.descriptor.queryExpression}},{key:"queryUri",get:function(){return this.descriptor.queryUri}},{key:"liveQueryDescriptor",get:function(){return this.descriptor}},{key:"onRemoved",value:function(){}},{key:"getItems",value:function(){var n={};return this.cache.forEach(function(e,t){n[e]=t.value}),n}},{key:"_update",value:function(e,t){switch(e.type){case"live_query_item_updated":this.handleItemMutated(e.item_key,e.item_data,e.item_revision);break;case"live_query_item_removed":this.handleItemRemoved(e.item_key,e.item_revision);break;case"live_query_updated":this.handleBatchUpdate(e.items)}t&&this._advanceLastEventId(e.last_event_id)}},{key:"handleItemMutated",value:function(e,t,n){this.shouldIgnoreEvent(e,n)?Gk("Item ".concat(e," update skipped, revision: ").concat(n)):(this.cache.store(e,e={key:e,value:t},n),this.broadcastEventToListeners("itemUpdated",e))}},{key:"handleItemRemoved",value:function(e,t){var n=null===t;this.shouldIgnoreEvent(e,t)?Gk("Item ".concat(e," delete skipped, revision: ").concat(t)):(this.cache.delete(e,t,n),this.broadcastEventToListeners("itemRemoved",{key:e}))}},{key:"handleBatchUpdate",value:function(e){var t,r=this,i={};for(t in null!=e&&e.forEach(function(e){i[e.key]={data:e.data,revision:e.revision}}),this.cache.forEach(function(e,t){var n=i[e];null!=n?r.handleItemMutated(e,n.data,n.revision):r.handleItemRemoved(e,null),delete i[e]}),i)this.handleItemMutated(t,i[t].data,i[t].revision)}},{key:"shouldIgnoreEvent",value:function(e,t){return null!=e&&null!=t&&this.cache.isKnown(e,t)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e)}}],[{key:"type",get:function(){return"live_query"}}]);var AS,MS=DS;function DS(e,t,n,r){var i;return T.default(this,DS),(i=AS.call(this,t,n)).descriptor=e,i.cache=new Zx,r&&r.forEach(function(e){i.cache.store(e.key,{key:e.key,value:e.data},e.revision)}),i}function jS(){return LS.apply(this,arguments)}function LS(){return(LS=C.default(I.default.mark(function e(t){var n,r,i,o,a;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.network,r=t.queryString,i=t.uri,o=t.type,null==r)throw new Dk("Invalid query",400,54507);e.next=3;break;case 3:return a={query_string:r},o===US.type&&(a.type=o),e.next=7,n.post(i,a,void 0,!0);case 7:return a=e.sent,e.abrupt("return",a.body);case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}pk.default(FS,f),NS=OS(FS),dk.default(FS,[{key:"type",get:function(){return MS.type}},{key:"lastEventId",get:function(){return this.liveQueryImpl.lastEventId}},{key:"sid",get:function(){return this.liveQueryImpl.sid}},{key:"close",value:function(){_k.default(mk.default(FS.prototype),"close",this).call(this),this.liveQueryImpl.detach(this.listenerUuid)}},{key:"getItems",value:function(){return this.ensureNotClosed(),this.liveQueryImpl.getItems()}}],[{key:"type",get:function(){return MS.type}}]);var NS,US=FS;function FS(e){var t;return T.default(this,FS),(t=NS.call(this)).liveQueryImpl=e,t.liveQueryImpl.attach(fk.default(t)),t}yk.default(US,"itemUpdated","itemUpdated"),yk.default(US,"itemRemoved","itemRemoved");pk.default(GS,xk),zS=OS(GS),dk.default(GS,[{key:"type",get:function(){return GS.type}},{key:"search",value:(qS=C.default(I.default.mark(function e(t){var n=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return this.items={},e.abrupt("return",jS({network:this.network,uri:this.queryUri,queryString:t}).then(function(e){n.queryExpression=t,e.items&&e.items.forEach(function(e){n.items[e.key]=e.data}),n.emit("searchResult",n.getItems())}).catch(function(e){throw Hk("Error '".concat(e.message,"' while executing query '").concat(t,"'")),n.queryExpression=null,e}));case 2:case"end":return e.stop()}},e,this)})),function(e){return qS.apply(this,arguments)})},{key:"subscribe",value:(BS=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null==this.queryExpression)return e.abrupt("return",Promise.reject(new Dk("Invalid query",400,54507)));e.next=2;break;case 2:return e.abrupt("return",this.liveQueryCreator(this.indexName,this.queryExpression));case 3:case"end":return e.stop()}},e,this)})),function(){return BS.apply(this,arguments)})},{key:"getItems",value:function(){return this.items}},{key:"updateIndexName",value:function(e){this.indexName=e,this.queryUri=this.generateQueryUri(this.indexName)}},{key:"generateQueryUri",value:function(e){return new Rk(this.insightsUri).pathSegment(e).pathSegment("Items").build()}}],[{key:"type",get:function(){return"instant_query"}}]);var BS,qS,zS,WS=GS;function GS(e){var t;return T.default(this,GS),t=zS.call(this),yk.default(fk.default(t),"queryExpression",null),yk.default(fk.default(t),"items",{}),Object.assign(fk.default(t),e),t.updateIndexName(e.indexName),t}function VS(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function HS(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?VS(Object(n),!0).forEach(function(e){yk.default(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):VS(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}yk.default(WS,"searchResult","searchResult"),R([k.validateTypesAsync("string"),P("design:type",Function),P("design:paramtypes",[String]),P("design:returntype",Promise)],WS.prototype,"search",null),R([k.validateTypes(k.nonEmptyString),P("design:type",Function),P("design:paramtypes",[String]),P("design:returntype",void 0)],WS.prototype,"updateIndexName",null);var JS="3.1.0";function $S(e){var t;return e?"string"==typeof e?{id:e,mode:"open_or_create"}:(t=e.mode||(e.id?"open_or_create":"create_new"),HS(HS({},e),{},{mode:t})):{mode:"create_new"}}var KS="com.twilio.rtd.cds.document",YS="com.twilio.rtd.cds.list",QS="com.twilio.rtd.cds.map",XS="twilio.sync.event",m=function(){pk.default(g,xk);m=g,y=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,n,r,e,i,o,a,s,c,u,l,d,f,p,h,m,y,v=function(){var e,t=mk.default(m);return e=y?(e=mk.default(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),hk.default(this,e)};function g(e){var n,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(T.default(this,g),n=v.call(this),!e)throw new Error("Sync library needs a valid Twilio token to be passed");t.hasOwnProperty("logLevel")?Wk(t.logLevel):Wk("silent");var r=t.productId=t.productId||"data_sync",i=(t.clientMetadata=t.clientMetadata||{},t.clientMetadata.hasOwnProperty("type")||(t.clientMetadata.type="sync"),t.clientMetadata.hasOwnProperty("sdk")||(t.clientMetadata.sdk="JS",t.clientMetadata.sdkv=JS),!t.twilsockClient),o=(t.initRegistrations||(o=new ak.InitRegistration(r),g.populateInitRegistrations(o),t.initRegistrations=[o]),t.twilsockClient=t.twilsockClient||new ak.Twilsock(e,r,t)),e=(o.on("tokenAboutToExpire",function(e){return n.emit("tokenAboutToExpire",e)}),o.on("tokenExpired",function(){return n.emit("tokenExpired")}),o.on("connectionError",function(e){return n.emit("connectionError",e)}),o.on("stateChanged",function(e){n.emit("connectionStateChanged",e),n.services.subscriptions.onConnectionStateChanged("connected"===e)}),o.on("message",function(e,t){return n._routeMessage(e,t)}),new Jk(t)),r=new ox(new IS(JS),e,o),t=new ax(e);return n.services={config:e,twilsock:o,network:r,storage:t,router:fk.default(n),subscriptions:null},n.services.subscriptions=new Zk(n.services),n.entities=new RS,i&&o.connect(),n}return dk.default(g,[{key:"_routeMessage",value:function(e,t){switch(Gk("Notification type:",e,"content:",t),e){case KS:case YS:case QS:this.services.subscriptions.acceptMessage(t,!1);break;case XS:this.services.subscriptions.acceptMessage(t,!0)}}},{key:"_subscribe",value:function(e,t){this.services.subscriptions.add(e,t)}},{key:"_unsubscribe",value:function(e){this.services.subscriptions.remove(e)}},{key:"connectionState",get:function(){return this.services.twilsock.state}},{key:"ensureReady",value:(h=C.default(I.default.mark(function e(){var t;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.services.config.sessionStorageEnabled){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.services.twilsock.storageId();case 5:t=e.sent,this.services.storage.updateStorageId(t.id),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];qk.warn.apply(null,zk("W",t))}("Failed to initialize storage",e.t0);case 12:case"end":return e.stop()}},e,this,[[2,9]])})),function(){return h.apply(this,arguments)})},{key:"storeRootInSessionCache",value:function(e,t,n){this.services.config.sessionStorageEnabled&&t&&(n=Uk(n),e!==D1.type&&e!==fS.type||(n.last_event_id=null,delete n.items),this.services.storage.store(e,t,n))}},{key:"readRootFromSessionCache",value:function(e,t){return this.services.config.sessionStorageEnabled&&t?this.services.storage.read(e,t):null}},{key:"_get",value:(p=C.default(I.default.mark(function e(t,n){var r,i,o=arguments;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=2<o.length&&void 0!==o[2]&&o[2],n){e.next=3;break}throw new Dk("Cannot get entity without id",404);case 3:return i=new Rk(t).pathSegment(n).queryParam("Include",r?"items":void 0).build(),e.next=6,this.services.network.get(i);case 6:return i=e.sent,e.abrupt("return",i.body);case 8:case"end":return e.stop()}},e,this)})),function(e,t){return p.apply(this,arguments)})},{key:"_createDocument",value:function(e,t,n){var r={unique_name:e,data:t||{}};return void 0!==n&&(r.ttl=n),this.services.network.post(this.services.config.documentsUri,r).then(function(e){return e.body.data=r.data,e.body})}},{key:"_getDocument",value:(f=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(Lx.type,t)||this._get(this.services.config.documentsUri,t));case 1:case"end":return e.stop()}},e,this)})),function(e){return f.apply(this,arguments)})},{key:"_createList",value:function(e,t,n,r){e={unique_name:e,purpose:t,context:n};return void 0!==r&&(e.ttl=r),this.services.network.post(this.services.config.listsUri,e).then(function(e){return e.body})}},{key:"_getList",value:(d=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(D1.type,t)||this._get(this.services.config.listsUri,t));case 1:case"end":return e.stop()}},e,this)})),function(e){return d.apply(this,arguments)})},{key:"_createMap",value:function(e,t){e={unique_name:e};return void 0!==t&&(e.ttl=t),this.services.network.post(this.services.config.mapsUri,e).then(function(e){return e.body})}},{key:"_getMap",value:(l=C.default(I.default.mark(function e(t){var n,r=arguments;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=1<r.length&&void 0!==r[1]&&r[1],e.abrupt("return",this.readRootFromSessionCache(fS.type,t)||this._get(this.services.config.mapsUri,t,n));case 2:case"end":return e.stop()}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"_getStream",value:(u=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(CS.type,t)||this._get(this.services.config.streamsUri,t,!1));case 1:case"end":return e.stop()}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"_createStream",value:(c=C.default(I.default.mark(function e(t,n){var r;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={unique_name:t},void 0!==n&&(r.ttl=n),e.next=4,this.services.network.post(this.services.config.streamsUri,r);case 4:return r=e.sent,e.abrupt("return",r.body);case 6:case"end":return e.stop()}},e,this)})),function(e,t){return c.apply(this,arguments)})},{key:"_getLiveQuery",value:function(e){return this.readRootFromSessionCache(US.type,e)}},{key:"getCached",value:function(e,t){return e&&this.entities.get(e,t)||null}},{key:"removeFromCacheAndSession",value:function(e,t,n){this.entities.remove(t),this.services.config.sessionStorageEnabled&&this.services.storage.remove(e,t,n)}},{key:"document",value:(s=C.default(I.default.mark(function e(t){var n,r,i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"===(n=$S(t)).mode)return e.next=6,this._createDocument(n.id,n.data,n.ttl);e.next=9;break;case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(i=this.getCached(n.id,Lx.type))return e.abrupt("return",new Lx(i));e.next=14;break;case 14:return e.prev=14,e.next=17,this._getDocument(n.id);case 20:if(e.prev=20,e.t0=e.catch(14),404!==e.t0.status||"open_existing"===n.mode)throw e.t0;e.next=26;break;case 26:return e.prev=26,e.next=29,this._createDocument(n.id,n.data,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409===e.t1.status)return e.abrupt("return",this.document(t));e.next=38;break;case 38:throw e.t1;case 39:return this.storeRootInSessionCache(Lx.type,n.id,r),i=new jx(this.services,r,function(e,t,n){return o.removeFromCacheAndSession(e,t,n)}),i=this.entities.store(i),e.abrupt("return",new Lx(i));case 43:case"end":return e.stop()}},e,this,[[14,20],[26,32]])})),function(e){return s.apply(this,arguments)})},{key:"map",value:(a=C.default(I.default.mark(function e(t){var n,r,i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"===(n=$S(t)).mode)return e.next=6,this._createMap(n.id,n.ttl);e.next=9;break;case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(i=this.getCached(n.id,fS.type))return e.abrupt("return",new fS(i));e.next=14;break;case 14:return e.prev=14,e.next=17,this._getMap(n.id,n.includeItems);case 20:if(e.prev=20,e.t0=e.catch(14),404!==e.t0.status||"open_existing"===n.mode)throw e.t0;e.next=26;break;case 26:return e.prev=26,e.next=29,this._createMap(n.id,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409===e.t1.status)return e.abrupt("return",this.map(t));e.next=38;break;case 38:throw e.t1;case 39:return this.storeRootInSessionCache(fS.type,n.id,r),i=new dS(this.services,r,function(e,t,n){return o.removeFromCacheAndSession(e,t,n)}),i=this.entities.store(i),e.abrupt("return",new fS(i));case 43:case"end":return e.stop()}},e,this,[[14,20],[26,32]])})),function(e){return a.apply(this,arguments)})},{key:"list",value:(o=C.default(I.default.mark(function e(t){var n,r,i,o=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"===(n=$S(t)).mode)return e.next=6,this._createList(n.id,n.purpose,n.context,n.ttl);e.next=9;break;case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(i=this.getCached(n.id,D1.type))return e.abrupt("return",new D1(i));e.next=14;break;case 14:return e.prev=14,e.next=17,this._getList(n.id);case 20:if(e.prev=20,e.t0=e.catch(14),404!==e.t0.status||"open_existing"===n.mode)throw e.t0;e.next=26;break;case 26:return e.prev=26,e.next=29,this._createList(n.id,n.purpose,n.context,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409===e.t1.status)return e.abrupt("return",this.list(t));e.next=38;break;case 38:throw e.t1;case 39:return this.storeRootInSessionCache(D1.type,n.id,r),i=new M1(this.services,r,function(e,t,n){return o.removeFromCacheAndSession(e,t,n)}),i=this.entities.store(i),e.abrupt("return",new D1(i));case 43:case"end":return e.stop()}},e,this,[[14,20],[26,32]])})),function(e){return o.apply(this,arguments)})},{key:"stream",value:(i=C.default(I.default.mark(function e(t){var n,r,i,o,a=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"===(n=$S(t)).mode)return e.next=6,this._createStream(n.id,n.ttl);e.next=9;break;case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(i=this.getCached(n.id,CS.type))return e.abrupt("return",new CS(i));e.next=14;break;case 14:return e.prev=14,e.next=17,this._getStream(n.id);case 20:if(e.prev=20,e.t0=e.catch(14),404!==e.t0.status||"open_existing"===n.mode)throw e.t0;e.next=26;break;case 26:return e.prev=26,e.next=29,this._createStream(n.id,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409===e.t1.status)return e.abrupt("return",this.stream(t));e.next=38;break;case 38:throw e.t1;case 39:return this.storeRootInSessionCache(CS.type,n.id,r),i=function(e,t,n){return a.removeFromCacheAndSession(e,t,n)},o=new _S(this.services,r,i),o=this.entities.store(o),e.abrupt("return",new CS(o));case 44:case"end":return e.stop()}},e,this,[[14,20],[26,32]])})),function(e){return i.apply(this,arguments)})},{key:"shutdown",value:(e=C.default(I.default.mark(function e(){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.subscriptions.shutdown();case 2:return e.next=4,this.services.twilsock.disconnect();case 4:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"updateToken",value:(r=C.default(I.default.mark(function e(t){return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.twilsock.updateToken(t).catch(function(e){var t=null==e||null==(t=e.reply)?void 0:t.status;if(401===(null==t?void 0:t.code)&&"UNAUTHORIZED"===(null==t?void 0:t.status))throw new Dk("Updated token was rejected by server",400,51130);throw e}));case 1:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"liveQuery",value:(n=C.default(I.default.mark(function e(t,n){var r,i,o,a,s,c=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return r=new Rk(this.services.config.insightsUri).pathSegment(t).pathSegment("Items").build(),e.next=5,jS({network:this.services.network,uri:r,queryString:n,type:US.type});case 5:return i=e.sent,(o=this.getCached(i.query_id,US.type))||(a=(a=this._getLiveQuery(i.query_id))||{indexName:t,queryExpression:n,sid:i.query_id,queryUri:r,last_event_id:i.last_event_id},s=function(e,t,n){return c.removeFromCacheAndSession(e,t,n)},o=new MS(a,this.services,s,i.items)),this.storeRootInSessionCache(US.type,i.query_id,o.liveQueryDescriptor),o=this.entities.store(o),e.abrupt("return",new US(o));case 11:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"instantQuery",value:(t=C.default(I.default.mark(function e(t){var n,r=this;return I.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return n=function(e,t){return r.liveQuery(e,t)},e.abrupt("return",new WS({indexName:t,network:this.services.network,insightsUri:this.services.config.insightsUri,liveQueryCreator:n}));case 4:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}],[{key:"populateInitRegistrations",value:function(e){e.populateInitRegistrations([XS,KS,YS,QS])}},{key:"version",get:function(){return JS}}]),g}(),ZS=(yk.default(m,"connectionStateChanged","connectionStateChanged"),yk.default(m,"connectionError","connectionError"),yk.default(m,"tokenAboutToExpire","tokenAboutToExpire"),yk.default(m,"tokenExpired","tokenExpired"),R([k.validateTypesAsync(["undefined","string",k.objectSchema("open document options",{id:["string","undefined"],mode:[k.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[k.nonNegativeInteger,"undefined"],data:[k.pureObject,"undefined",k.literal(null)]})]),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],m.prototype,"document",null),R([k.validateTypesAsync(["undefined","string",k.objectSchema("open map options",{id:["string","undefined"],mode:[k.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[k.nonNegativeInteger,"undefined"],data:[k.pureObject,"undefined",k.literal(null)],includeItems:["boolean","undefined"]})]),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],m.prototype,"map",null),R([k.validateTypesAsync(["undefined","string",k.objectSchema("open list options",{id:["string","undefined"],mode:[k.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[k.nonNegativeInteger,"undefined"],data:[k.pureObject,"undefined",k.literal(null)],purpose:["string","undefined"],context:[k.pureObject,"undefined"],includeItems:["boolean","undefined"]})]),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],m.prototype,"list",null),R([k.validateTypesAsync(["undefined","string",k.objectSchema("open stream options",{id:["string","undefined"],mode:[k.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[k.nonNegativeInteger,"undefined"],data:[k.pureObject,"undefined",k.literal(null)]})]),P("design:type",Function),P("design:paramtypes",[Object]),P("design:returntype",Promise)],m.prototype,"stream",null),R([k.validateTypesAsync(k.nonEmptyString),P("design:type",Function),P("design:paramtypes",[String]),P("design:returntype",Promise)],m.prototype,"updateToken",null),R([k.validateTypesAsync(k.nonEmptyString,"string"),P("design:type",Function),P("design:paramtypes",[String,String]),P("design:returntype",Promise)],m.prototype,"liveQuery",null),R([k.validateTypesAsync(k.nonEmptyString),P("design:type",Function),P("design:paramtypes",[String]),P("design:returntype",Promise)],m.prototype,"instantQuery",null),Ct.Client=m,Ct.InsightsItem=function e(){T.default(this,e)},Ct.InstantQuery=WS,Ct.LiveQuery=US,Ct.Paginator=zx,Ct.SyncClient=m);function eE(e,t,n){return(eE=function(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),1}catch(e){}}}()?Reflect.construct:function(e,t,n){var r=[null],t=(r.push.apply(r,t),new(Function.bind.apply(e,r)));return n&&Hi(t,n.prototype),t}).apply(null,arguments)}function tE(e){var n="function"==typeof Map?new Map:void 0;return(tE=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return eE(e,arguments,Ki(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Hi(t,e)})(e)}Ct.SyncDocument=Lx,Ct.SyncList=D1,Ct.SyncListItem=qx,Ct.SyncMap=fS,Ct.SyncMapItem=N1,Ct.SyncStream=CS;function nE(e){if(mE(e))throw TypeError("The method doesn't accept regular expressions");return e}function rE(t){var n=/./;try{"/./"[t](n)}catch(e){try{return n[yE]=!1,"/./"[t](n)}catch(t){}}return!1}function iE(e){return e+22+75*(e<26)}function oE(e){var t,n=[],r=(e=function(e){for(var t=[],n=0,r=e.length;n<r;){var i,o=e.charCodeAt(n++);55296<=o&&o<=56319&&n<r?56320==(64512&(i=e.charCodeAt(n++)))?t.push(((1023&o)<<10)+(1023&i)+65536):(t.push(o),n--):t.push(o)}return t}(e)).length,i=128,o=0,a=72;for(l=0;l<e.length;l++)(t=e[l])<128&&n.push(PE(t));var s=n.length,c=s;for(s&&n.push("-");c<r;){for(var u=EE,l=0;l<e.length;l++)(t=e[l])>=i&&t<u&&(u=t);var d=c+1;if(u-i>RE((EE-o)/d))throw RangeError(IE);for(o+=(u-i)*d,i=u,l=0;l<e.length;l++){if((t=e[l])<i&&++o>EE)throw RangeError(IE);if(t==i){for(var f=o,p=36;;p+=36){var h=p<=a?1:a+26<=p?26:p-a;if(f<h)break;var m=f-h,y=36-h;n.push(PE(iE(h+m%y))),f=RE(m/y)}n.push(PE(iE(f))),a=function(e,t,n){var r=0;for(e=n?RE(e/700):e>>1,e+=RE(e/t);455<e;r+=36)e=RE(e/35);return RE(r+36*e/(e+38))}(o,d,c==s),o=0,++c}}++o,++i}return n.join("")}function aE(t){try{return decodeURIComponent(t)}catch(e){return t}}function sE(e){return eC[e]}function cE(e){return encodeURIComponent(e).replace(ZE,sE)}function uE(e){this.entries.length=0,tC(this.entries,e)}function lE(e,t){if(e<t)throw TypeError("Not enough arguments")}function dE(){OE(this,dE,VE);var e,t,n,r,i,o,a,s,c=0<arguments.length?arguments[0]:void 0,u=[];if(JE(this,{type:VE,entries:u,updateURL:function(){},updateSearchParams:uE}),void 0!==c)if(LE(c))if("function"==typeof(e=qE(c)))for(n=(t=BE(c,e)).next;!(r=n.call(t)).done;){if((o=(i=(r=BE(jE(r.value))).next).call(r)).done||(a=i.call(r)).done||!i.call(r).done)throw TypeError("Expected sequence with length 2");u.push({key:NE(o.value),value:NE(a.value)})}else for(s in c)AE(c,s)&&u.push({key:s,value:NE(c[s])});else tC(u,"string"==typeof c?"?"===c.charAt(0)?c.slice(1):c:NE(c))}var fE,pE,hE={},mE=$b,yE=X("match"),h=i,a=L.f,vE=ot,gE=Pn,bE=nE,_E=V,p=rE,wE="".startsWith,kE=Math.min,lr=p("startsWith"),xE=(h({target:"String",proto:!0,forced:!(!lr&&(Ie=a(String.prototype,"startsWith"))&&!Ie.writable||lr)},{startsWith:function(e){var t=gE(_E(this)),n=(bE(e),vE(kE(1<arguments.length?arguments[1]:void 0,t.length))),e=gE(e);return wE?wE.call(t,e,n):t.slice(n,n+e.length)===e}}),me.left),Yn=le,_f=ue,Tf=(i({target:"Array",proto:!0,forced:!os("reduce")||!_f&&79<Yn&&Yn<83},{reduce:function(e){return xE(this,e,arguments.length,1<arguments.length?arguments[1]:void 0)}}),t),SE=X("iterator"),U=!Tf(function(){var e=new URL("b?a=1&b=2&c=3","http://a"),n=e.searchParams,r="";return e.pathname="c%20d",n.forEach(function(e,t){n.delete("b"),r+=t+e}),!n.sort||"http://a/c%20d?a=1&c=3"!==e.href||"3"!==n.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!n[SE]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://ÑÐµÑÑ").host||"#%D0%B1"!==new URL("http://a#Ð±").hash||"a1c3"!==r||"x"!==new URL("http://x",void 0).host}),EE=2147483647,CE=/[^\0-\u007E]/,TE=/[.\u3002\uFF0E\uFF61]/g,IE="Overflow: input needs wider integers to process",RE=Math.floor,PE=String.fromCharCode,z=i,dv=$,de=U,wf=pe.exports,r=Qi,tt=dt,_=fc,fv=_t,OE=Zi,AE=be,ME=An,DE=ni,jE=ne,LE=J,NE=Pn,UE=Tt,FE=W,BE=no,qE=to,ur=X,zE=dv("fetch"),WE=dv("Request"),w=WE&&WE.prototype,GE=dv("Headers"),ii=ur("iterator"),VE="URLSearchParams",HE="URLSearchParamsIterator",JE=fv.set,$E=fv.getterFor(VE),KE=fv.getterFor(HE),YE=/\+/g,QE=Array(4),XE=function(e){var t,n=e.replace(YE," "),r=4;try{return decodeURIComponent(n)}catch(e){for(;r;)n=n.replace((t=r--,QE[t-1]||(QE[t-1]=RegExp("((?:%[\\da-f]{2}){"+t+"})","gi"))),aE);return n}},ZE=/[!'()~]|%20/g,eC={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},tC=function(e,t){if(t)for(var n,r=t.split("&"),i=0;i<r.length;)(n=r[i++]).length&&(n=n.split("="),e.push({key:XE(n.shift()),value:XE(n.join("="))}))},nC=_(function(e,t){JE(this,{type:HE,iterator:BE($E(e).entries),kind:t})},"Iterator",function(){var e=KE(this),t=e.kind,e=e.iterator.next(),n=e.value;return e.done||(e.value="keys"===t?n.key:"values"===t?n.value:[n.key,n.value]),e}),l=dE.prototype;r(l,{append:function(e,t){lE(arguments.length,2);var n=$E(this);n.entries.push({key:NE(e),value:NE(t)}),n.updateURL()},delete:function(e){lE(arguments.length,1);for(var t=$E(this),n=t.entries,r=NE(e),i=0;i<n.length;)n[i].key===r?n.splice(i,1):i++;t.updateURL()},get:function(e){lE(arguments.length,1);for(var t=$E(this).entries,n=NE(e),r=0;r<t.length;r++)if(t[r].key===n)return t[r].value;return null},getAll:function(e){lE(arguments.length,1);for(var t=$E(this).entries,n=NE(e),r=[],i=0;i<t.length;i++)t[i].key===n&&r.push(t[i].value);return r},has:function(e){lE(arguments.length,1);for(var t=$E(this).entries,n=NE(e),r=0;r<t.length;)if(t[r++].key===n)return!0;return!1},set:function(e,t){lE(arguments.length,1);for(var n,r=$E(this),i=r.entries,o=!1,a=NE(e),s=NE(t),c=0;c<i.length;c++)(n=i[c]).key===a&&(o?i.splice(c--,1):(o=!0,n.value=s));o||i.push({key:a,value:s}),r.updateURL()},sort:function(){for(var e,t,n=$E(this),r=n.entries,i=r.slice(),o=r.length=0;o<i.length;o++){for(e=i[o],t=0;t<o;t++)if(r[t].key>e.key){r.splice(t,0,e);break}t===o&&r.push(e)}n.updateURL()},forEach:function(e){for(var t,n=$E(this).entries,r=ME(e,1<arguments.length?arguments[1]:void 0,3),i=0;i<n.length;)r((t=n[i++]).value,t.key,this)},keys:function(){return new nC(this,"keys")},values:function(){return new nC(this,"values")},entries:function(){return new nC(this,"entries")}},{enumerable:!0}),wf(l,ii,l.entries),wf(l,"toString",function(){for(var e,t=$E(this).entries,n=[],r=0;r<t.length;)e=t[r++],n.push(cE(e.key)+"="+cE(e.value));return n.join("&")},{enumerable:!0}),tt(dE,VE),z({global:!0,forced:!de},{URLSearchParams:dE}),de||"function"!=typeof GE||(fE=function(e){if(LE(e)){var t,n=e.body;if(DE(n)===VE)return(t=e.headers?new GE(e.headers):new GE).has("content-type")||t.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"),UE(e,{body:FE(0,String(n)),headers:FE(0,t)})}return e},"function"==typeof zE&&z({global:!0,enumerable:!0,forced:!0},{fetch:function(e){return zE(e,1<arguments.length?fE(arguments[1]):{})}}),"function"==typeof WE&&((w.constructor=pE=function(e){return OE(this,pE,"Request"),new WE(e,1<arguments.length?fE(arguments[1]):{})}).prototype=w,z({global:!0,forced:!0},{Request:pE})));function rC(e){var t,n,r,i;if("number"==typeof e){for(t=[],n=0;n<4;n++)t.unshift(e%256),e=kC(e/256);return t.join(".")}if("object"!=typeof e)return e;for(t="",r=function(e){for(var t=null,n=1,r=null,i=0,o=0;o<8;o++)0!==e[o]?(n<i&&(t=r,n=i),r=null,i=0):(null===r&&(r=o),++i);return n<i&&(t=r,n=i),t}(e),n=0;n<8;n++)i&&0===e[n]||(i=i&&!1,r===n?(t+=n?":":"::",i=!0):(t+=e[n].toString(16),n<7&&(t+=":")));return"["+t+"]"}function iC(e){return!e.host||e.cannotBeABaseURL||"file"==e.scheme}function oC(e,t,n,r){var i,o,a,s=n||QC,c=0,u="",l=!1,d=!1,f=!1;for(n||(e.scheme="",e.username="",e.password="",e.host=null,e.port=null,e.path=[],e.query=null,e.fragment=null,e.cannotBeABaseURL=!1,t=t.replace(LC,"")),t=t.replace(NC,""),i=hC(t);c<=i.length;){switch(o=i[c],s){case QC:if(!o||!TC.test(o)){if(n)return SC;s=ZC;continue}u+=o.toLowerCase(),s=XC;break;case XC:if(o&&(IC.test(o)||"+"==o||"-"==o||"."==o))u+=o.toLowerCase();else{if(":"!=o){if(n)return SC;u="",s=ZC,c=0;continue}if(n&&(VC(e)!=pC(GC,u)||"file"==u&&(HC(e)||null!==e.port)||"file"==e.scheme&&!e.host))return;if(e.scheme=u,n)return void(VC(e)&&GC[e.scheme]==e.port&&(e.port=null));u="","file"==e.scheme?s=lT:VC(e)&&r&&r.scheme==e.scheme?s=eT:VC(e)?s=iT:"/"==i[c+1]?(s=tT,c++):(e.cannotBeABaseURL=!0,e.path.push(""),s=mT)}break;case ZC:if(!r||r.cannotBeABaseURL&&"#"!=o)return SC;if(r.cannotBeABaseURL&&"#"==o){e.scheme=r.scheme,e.path=r.path.slice(),e.query=r.query,e.fragment="",e.cannotBeABaseURL=!0,s=vT;break}s="file"==r.scheme?lT:nT;continue;case eT:if("/"!=o||"/"!=i[c+1]){s=nT;continue}s=oT,c++;break;case tT:if("/"==o){s=aT;break}s=hT;continue;case nT:if(e.scheme=r.scheme,o==cC)e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.query=r.query;else if("/"==o||"\\"==o&&VC(e))s=rT;else if("?"==o)e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.query="",s=yT;else{if("#"!=o){e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.path.pop(),s=hT;continue}e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.query=r.query,e.fragment="",s=vT}break;case rT:if(!VC(e)||"/"!=o&&"\\"!=o){if("/"!=o){e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,s=hT;continue}s=aT}else s=oT;break;case iT:if(s=oT,"/"!=o||"/"!=u.charAt(c+1))continue;c++;break;case oT:if("/"==o||"\\"==o)break;s=aT;continue;case aT:if("@"==o){l&&(u="%40"+u);for(var l=!0,p=hC(u),h=0;h<p.length;h++){var m=p[h];":"!=m||f?(m=WC(m,zC),f?e.password+=m:e.username+=m):f=!0}u=""}else if(o==cC||"/"==o||"?"==o||"#"==o||"\\"==o&&VC(e)){if(l&&""==u)return"Invalid authority";c-=hC(u).length+1,u="",s=sT}else u+=o;break;case sT:case cT:if(n&&"file"==e.scheme){s=fT;continue}if(":"!=o||d){if(o==cC||"/"==o||"?"==o||"#"==o||"\\"==o&&VC(e)){if(VC(e)&&""==u)return EC;if(n&&""==u&&(HC(e)||null!==e.port))return;if(a=UC(e,u))return a;if(u="",s=pT,n)return;continue}"["==o?d=!0:"]"==o&&(d=!1),u+=o}else{if(""==u)return EC;if(a=UC(e,u))return a;if(u="",s=uT,n==cT)return}break;case uT:if(!RC.test(o)){if(o==cC||"/"==o||"?"==o||"#"==o||"\\"==o&&VC(e)||n){if(""!=u){var y=parseInt(u,10);if(65535<y)return CC;e.port=VC(e)&&y===GC[e.scheme]?null:y,u=""}if(n)return;s=pT;continue}return CC}u+=o;break;case lT:if(e.scheme="file","/"==o||"\\"==o)s=dT;else{if(!r||"file"!=r.scheme){s=hT;continue}if(o==cC)e.host=r.host,e.path=r.path.slice(),e.query=r.query;else if("?"==o)e.host=r.host,e.path=r.path.slice(),e.query="",s=yT;else{if("#"!=o){$C(i.slice(c).join(""))||(e.host=r.host,e.path=r.path.slice(),KC(e)),s=hT;continue}e.host=r.host,e.path=r.path.slice(),e.query=r.query,e.fragment="",s=vT}}break;case dT:if("/"==o||"\\"==o){s=fT;break}r&&"file"==r.scheme&&!$C(i.slice(c).join(""))&&(JC(r.path[0],!0)?e.path.push(r.path[0]):e.host=r.host),s=hT;continue;case fT:if(o==cC||"/"==o||"\\"==o||"?"==o||"#"==o){if(!n&&JC(u))s=hT;else{if(""==u){if(e.host="",n)return}else{if(a=UC(e,u))return a;if("localhost"==e.host&&(e.host=""),n)return;u=""}s=pT}continue}u+=o;break;case pT:if(VC(e)){if(s=hT,"/"!=o&&"\\"!=o)continue}else if(n||"?"!=o)if(n||"#"!=o){if(o!=cC&&(s=hT,"/"!=o))continue}else e.fragment="",s=vT;else e.query="",s=yT;break;case hT:if(o==cC||"/"==o||"\\"==o&&VC(e)||!n&&("?"==o||"#"==o)){if(".."===(y=(y=u).toLowerCase())||"%2e."===y||".%2e"===y||"%2e%2e"===y?(KC(e),"/"==o||"\\"==o&&VC(e)||e.path.push("")):YC(u)?"/"==o||"\\"==o&&VC(e)||e.path.push(""):("file"==e.scheme&&!e.path.length&&JC(u)&&(e.host&&(e.host=""),u=u.charAt(0)+":"),e.path.push(u)),u="","file"==e.scheme&&(o==cC||"?"==o||"#"==o))for(;1<e.path.length&&""===e.path[0];)e.path.shift();"?"==o?(e.query="",s=yT):"#"==o&&(e.fragment="",s=vT)}else u+=WC(o,qC);break;case mT:"?"==o?(e.query="",s=yT):"#"==o?(e.fragment="",s=vT):o!=cC&&(e.path[0]+=WC(o,FC));break;case yT:n||"#"!=o?o!=cC&&("'"==o&&VC(e)?e.query+="%27":e.query+="#"==o?"%23":WC(o,FC)):(e.fragment="",s=vT);break;case vT:o!=cC&&(e.fragment+=WC(o,BC))}c++}}function aC(e){var t,n,r=fC(this,aC,"URL"),i=1<arguments.length?arguments[1]:void 0,e=yC(e),o=_C(r,{type:"URL"});if(void 0!==i)if(i instanceof aC)t=wC(i);else if(n=oC(t={},yC(i)))throw TypeError(n);if(n=oC(o,e,null,t))throw TypeError(n);var a=o.searchParams=new gC;(i=bC(a)).updateSearchParams(o.query),i.updateURL=function(){o.query=String(a)||null},dC||(r.href=gT.call(r),r.origin=bT.call(r),r.protocol=_T.call(r),r.username=wT.call(r),r.password=kT.call(r),r.host=xT.call(r),r.hostname=ST.call(r),r.port=ET.call(r),r.pathname=CT.call(r),r.search=TT.call(r),r.searchParams=IT.call(r),r.hash=RT.call(r))}function sC(e,t){return{get:e,set:t,configurable:!0,enumerable:!0}}var cC,uC,lC,Ce={URLSearchParams:dE,getState:$E},mi=i,dC=N,Cn=U,ai=En,u=pe.exports,fC=Zi,pC=be,c=Cf,hC=Ls,mC=di.codeAt,yC=Pn,f=dt,k=_t,vC=n.URL,gC=Ce.URLSearchParams,bC=Ce.getState,_C=k.set,wC=k.getterFor("URL"),kC=Math.floor,xC=Math.pow,SC="Invalid scheme",EC="Invalid host",CC="Invalid port",TC=/[A-Za-z]/,IC=/[\d+-.A-Za-z]/,RC=/\d/,PC=/^0x/i,OC=/^[0-7]+$/,AC=/^\d+$/,MC=/^[\dA-Fa-f]+$/,DC=/[\0\t\n\r #%/:<>?@[\\\]^|]/,jC=/[\0\t\n\r #/:<>?@[\\\]^|]/,LC=/^[\u0000-\u0020]+|[\u0000-\u0020]+$/g,NC=/[\t\n\r]/g,UC=function(e,t){var n,r,i;if("["==t.charAt(0))return"]"==t.charAt(t.length-1)&&(n=function(e){var t,n,r,i,o,a,s,c=[0,0,0,0,0,0,0,0],u=0,l=null,d=0,f=function(){return e.charAt(d)};if(":"==f()){if(":"!=e.charAt(1))return;d+=2,l=++u}for(;f();){if(8==u)return;if(":"!=f()){for(t=n=0;n<4&&MC.test(f());)t=16*t+parseInt(f(),16),d++,n++;if("."==f()){if(0==n)return;if(d-=n,u>6)return;for(r=0;f();){if(i=null,r>0){if(!("."==f()&&r<4))return;d++}if(!RC.test(f()))return;for(;RC.test(f());){if(o=parseInt(f(),10),null===i)i=o;else{if(0==i)return;i=10*i+o}if(i>255)return;d++}c[u]=256*c[u]+i,2!=++r&&4!=r||u++}if(4!=r)return;break}if(":"==f()){if(d++,!f())return}else if(f())return;c[u++]=t}else{if(null!==l)return;d++,l=++u}}if(null!==l)for(a=u-l,u=7;0!=u&&a>0;)s=c[u],c[u--]=c[l+a-1],c[l+--a]=s;else if(8!=u)return;return c}(t.slice(1,-1)))?void(e.host=n):EC;if(VC(e))return t=function(e){for(var t,n=[],r=e.toLowerCase().replace(TE,".").split("."),i=0;i<r.length;i++)t=r[i],n.push(CE.test(t)?"xn--"+oE(t):t);return n.join(".")}(t),DC.test(t)||null===(n=function(e){var t,n,r,i,o,a,s,c=e.split(".");if(c.length&&""==c[c.length-1]&&c.pop(),(t=c.length)>4)return e;for(n=[],r=0;r<t;r++){if(""==(i=c[r]))return e;if(o=10,i.length>1&&"0"==i.charAt(0)&&(o=PC.test(i)?16:8,i=i.slice(8==o?1:2)),""===i)a=0;else{if(!(10==o?AC:8==o?OC:MC).test(i))return e;a=parseInt(i,o)}n.push(a)}for(r=0;r<t;r++)if(a=n[r],r==t-1){if(a>=xC(256,5-t))return null}else if(a>255)return null;for(s=n.pop(),r=0;r<n.length;r++)s+=n[r]*xC(256,3-r);return s}(t))?EC:void(e.host=n);if(jC.test(t))return EC;for(n="",r=hC(t),i=0;i<r.length;i++)n+=WC(r[i],FC);e.host=n},FC={},BC=c({},FC,{" ":1,'"':1,"<":1,">":1,"`":1}),qC=c({},BC,{"#":1,"?":1,"{":1,"}":1}),zC=c({},qC,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),WC=function(e,t){var n=mC(e,0);return 32<n&&n<127&&!pC(t,e)?e:encodeURIComponent(e)},GC={ftp:21,file:null,http:80,https:443,ws:80,wss:443},VC=function(e){return pC(GC,e.scheme)},HC=function(e){return""!=e.username||""!=e.password},JC=function(e,t){return 2==e.length&&TC.test(e.charAt(0))&&(":"==(e=e.charAt(1))||!t&&"|"==e)},$C=function(e){return 1<e.length&&JC(e.slice(0,2))&&(2==e.length||"/"===(e=e.charAt(2))||"\\"===e||"?"===e||"#"===e)},KC=function(e){var t=e.path,n=t.length;!n||"file"==e.scheme&&1==n&&JC(t[0],!0)||t.pop()},YC=function(e){return"."===e||"%2e"===e.toLowerCase()},QC={},XC={},ZC={},eT={},tT={},nT={},rT={},iT={},oT={},aT={},sT={},cT={},uT={},lT={},dT={},fT={},pT={},hT={},mT={},yT={},vT={},m=aC.prototype,gT=function(){var e=wC(this),t=e.scheme,n=e.username,r=e.password,i=e.host,o=e.port,a=e.path,s=e.query,c=e.fragment,u=t+":";return null!==i?(u+="//",HC(e)&&(u+=n+(r?":"+r:"")+"@"),u+=rC(i),null!==o&&(u+=":"+o)):"file"==t&&(u+="//"),u+=e.cannotBeABaseURL?a[0]:a.length?"/"+a.join("/"):"",null!==s&&(u+="?"+s),null!==c&&(u+="#"+c),u},bT=function(){var e=wC(this),t=e.scheme,n=e.port;if("blob"==t)try{return new aC(t.path[0]).origin}catch(e){return"null"}return"file"!=t&&VC(e)?t+"://"+rC(e.host)+(null!==n?":"+n:""):"null"},_T=function(){return wC(this).scheme+":"},wT=function(){return wC(this).username},kT=function(){return wC(this).password},xT=function(){var e=wC(this),t=e.host,e=e.port;return null===t?"":null===e?rC(t):rC(t)+":"+e},ST=function(){var e=wC(this).host;return null===e?"":rC(e)},ET=function(){var e=wC(this).port;return null===e?"":String(e)},CT=function(){var e=wC(this),t=e.path;return e.cannotBeABaseURL?t[0]:t.length?"/"+t.join("/"):""},TT=function(){var e=wC(this).query;return e?"?"+e:""},IT=function(){return wC(this).searchParams},RT=function(){var e=wC(this).fragment;return e?"#"+e:""};function PT(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=Ki(n);return $i(this,r?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function OT(e){return function(e){if(Array.isArray(e))return vh(e)}(e)||function(){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}()||gh(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}dC&&ai(m,{href:sC(gT,function(e){var t=wC(this),e=yC(e),e=oC(t,e);if(e)throw TypeError(e);bC(t.searchParams).updateSearchParams(t.query)}),origin:sC(bT),protocol:sC(_T,function(e){var t=wC(this);oC(t,yC(e)+":",QC)}),username:sC(wT,function(e){var t=wC(this),n=hC(yC(e));if(!iC(t)){t.username="";for(var r=0;r<n.length;r++)t.username+=WC(n[r],zC)}}),password:sC(kT,function(e){var t=wC(this),n=hC(yC(e));if(!iC(t)){t.password="";for(var r=0;r<n.length;r++)t.password+=WC(n[r],zC)}}),host:sC(xT,function(e){var t=wC(this);t.cannotBeABaseURL||oC(t,yC(e),sT)}),hostname:sC(ST,function(e){var t=wC(this);t.cannotBeABaseURL||oC(t,yC(e),cT)}),port:sC(ET,function(e){var t=wC(this);iC(t)||(""==(e=yC(e))?t.port=null:oC(t,e,uT))}),pathname:sC(CT,function(e){var t=wC(this);t.cannotBeABaseURL||(t.path=[],oC(t,yC(e),pT))}),search:sC(TT,function(e){var t=wC(this);""==(e=yC(e))?t.query=null:("?"==e.charAt(0)&&(e=e.slice(1)),t.query="",oC(t,e,yT)),bC(t.searchParams).updateSearchParams(t.query)}),searchParams:sC(IT),hash:sC(RT,function(e){var t=wC(this);""!=(e=yC(e))?("#"==e.charAt(0)&&(e=e.slice(1)),t.fragment="",oC(t,e,vT)):t.fragment=null})}),u(m,"toJSON",function(){return gT.call(this)},{enumerable:!0}),u(m,"toString",function(){return gT.call(this)},{enumerable:!0}),vC&&(uC=vC.createObjectURL,lC=vC.revokeObjectURL,uC&&u(aC,"createObjectURL",function(e){return uC.apply(vC,arguments)}),lC)&&u(aC,"revokeObjectURL",function(e){return lC.apply(vC,arguments)}),f(aC,"URL"),mi({global:!0,forced:!Cn,sham:!dC},{URL:aC});var Ct=hE,AT="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},L=(Object.defineProperty(Ct,"__esModule",{value:!0}),hn.exports),p=Rf,h=Tr.exports,MT=If,a=d;function DT(e){return e&&"object"===F(e)&&"default"in e?e:{default:e}}var jT,LT,NT,UT,FT=DT(xf.exports),BT=DT(L),qT=DT(p),zT=(jT=h)&&jT.__esModule?jT:(LT=Object.create(null),jT&&Object.keys(jT).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(jT,e),Object.defineProperty(LT,e,t.get?t:{enumerable:!0,get:function(){return jT[e]}}))}),LT.default=jT,Object.freeze(LT)),L={exports:{}},WT="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);WT?(NT=new Uint8Array(16),L.exports=function(){return WT(NT),NT}):(UT=new Array(16),L.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),UT[t]=e>>>((3&t)<<3)&255;return UT});for(var GT=[],VT=0;VT<256;++VT)GT[VT]=(VT+256).toString(16).substr(1);function HT(e,t){var t=t||0,n=GT;return[n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],"-",n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[t++]],n[e[+t]]].join("")}function JT(e,t,n){var r=t&&n||0,i=("string"==typeof e&&(t="binary"===e?new Array(16):null,e=null),(e=e||{}).random||(e.rng||tI)());if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var o=0;o<16;++o)t[r+o]=i[o];return t||nI(i)}var $T,KT,YT,QT=L.exports,XT=HT,ZT=0,eI=0,tI=L.exports,nI=HT,rI=((p=JT).v1=function(e,t,n){var r=t&&n||0,i=t||[],o=(e=e||{}).node||$T,n=void 0!==e.clockseq?e.clockseq:KT,a=(null!=o&&null!=n||(a=QT(),null==o&&(o=$T=[1|a[0],a[1],a[2],a[3],a[4],a[5]]),null==n&&(n=KT=16383&(a[6]<<8|a[7]))),void 0!==e.msecs?e.msecs:(new Date).getTime()),s=void 0!==e.nsecs?e.nsecs:eI+1,c=a-ZT+(s-eI)/1e4;if(c<0&&void 0===e.clockseq&&(n=n+1&16383),1e4<=(s=(c<0||ZT<a)&&void 0===e.nsecs?0:s))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");ZT=a,KT=n;c=(1e4*(268435455&(a+=122192928e5))+(eI=s))%4294967296,i[r++]=c>>>24&255,i[r++]=c>>>16&255,i[r++]=c>>>8&255,i[r++]=255&c,e=a/4294967296*1e4&268435455;i[r++]=e>>>8&255,i[r++]=255&e,i[r++]=e>>>24&15|16,i[r++]=e>>>16&255,i[r++]=n>>>8|128,i[r++]=255&n;for(var u=0;u<6;++u)i[r+u]=o[u];return t||XT(i)},p.v4=JT,p),iI=(Ji(oI,tE(Promise)),YT=PT(oI),M(oI,[{key:"cancel",value:function(){var e=oI.cancellationMap.get(this.id);return null!=e&&e(),this.rejectPromise&&(this.catch(function(){}),this.rejectPromise(new Error("Promise was cancelled"))),this}}]),oI);function oI(e){var t;D(this,oI);var r,i=rI.v4();return(t=YT.call(this,function(t,n){return r=n,e(function(e){oI.cancellationMap.delete(i),t(e)},function(e){oI.cancellationMap.delete(i),n(e)},function(e){oI.cancellationMap.set(i,e)})})).id=i,t.rejectPromise=r,t}function aI(e,t,n,r){var i,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":F(Reflect))&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;0<=s;s--)(i=e[s])&&(a=(o<3?i(a):3<o?i(t,n,a):i(t,n))||a);return 3<o&&a&&Object.defineProperty(t,n,a),a}function sI(e,t){if("object"===("undefined"==typeof Reflect?"undefined":F(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function cI(e,t){return["".concat((new Date).toISOString()," MCS Client ").concat(e,":")].concat(Array.from(t))}function uI(e,t){return"".concat(e.startsWith("http")?"":"https://mcs.".concat(null!=t?t:"us1",".twilio.com")).concat(e)}FT.default(iI,"cancellationMap",new Map),M(gI,[{key:"setLevel",value:function(e){zT.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.trace.apply(null,cI(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.debug.apply(null,cI(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.info.apply(null,cI(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.warn.apply(null,cI(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.error.apply(null,cI(this.prefix+"E",t))}}],[{key:"scope",value:function(e){return new gI(e)}},{key:"setLevel",value:function(e){zT.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.trace.apply(null,cI("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.debug.apply(null,cI("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.info.apply(null,cI("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.warn.apply(null,cI("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];zT.error.apply(null,cI("E",t))}}]);var lI,h=gI,dI=(M(vI,[{key:"updateToken",value:function(e){this.token=e}}],[{key:"backoffConfigDefault",get:function(){return{min:1e3,max:4e3,maxAttemptsCount:3}}},{key:"retryWhenThrottledDefault",get:function(){return!0}}]),vI),fI=(M(yI,[{key:"sid",get:function(){return this.state.sid}},{key:"serviceSid",get:function(){return this.state.serviceSid}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"fileName",get:function(){return this.state.filename}},{key:"filename",get:function(){return this.state.filename}},{key:"category",get:function(){return this.state.category}},{key:"getContentUrl",value:function(){var r,a=this;return new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=a.network.get("".concat(a.config.mediaUrl,"/").concat(a.sid)),r(function(){return i.cancel()}),e.prev=2,e.next=5,i;case 5:o=e.sent,a._update(o.body),t(a.state.contentDirectUrl),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),n(e.t0);case 13:case"end":return e.stop()}},e,null,[[2,10]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"_update",value:function(e){var t;this.state={sid:e.sid,serviceSid:e.service_sid,channelSid:e.channel_sid,messageSid:e.message_sid,dateCreated:e.date_created?new Date(e.date_created):null,dateUploadUpdated:e.date_upload_updated?new Date(e.date_upload_updated):null,dateUpdated:e.date_updated?new Date(e.date_updated):null,size:e.size,contentType:e.content_type,author:e.author,url:e.url,contentUrl:e.links.content,contentDirectUrl:null!=(t=e.links.content_direct_temporary)?t:null,filename:null!=(t=e.filename)?t:null,category:null!=(t=e.category)?t:"media",isMultipartUpstream:null!=(t=e.is_multipart_upstream)&&t}}}]),yI),pI=(Ji(mI,tE(Error)),lI=PT(mI),M(mI)),hI=AT.XMLHttpRequest||{};function mI(e,t,n,r,i){return D(this,mI),(e=lI.call(this,e)).code=t,e.body=n,e.status=r,e.headers=i,e}function yI(e,t,n){D(this,yI),this.config=e,this.network=t,this._update(n)}function vI(e,t,n,r){D(this,vI);var i,o=null!=(o=null!=(o=r.MCS)?o:r)?o:{};this.region=null!=(i=null!=(i=o.region)?i:r.region)?i:"us1",this.mediaUrl=uI(t,this.region),this.mediaSetUrl=n?uI(n):"".concat(this.mediaUrl,"Set"),this.token=e,this.retryWhenThrottledOverride=null==(r=o.retryWhenThrottledOverride)||r,this.backoffConfigOverride=null!=(i=o.backoffConfigOverride)?i:vI.backoffConfigDefault}function gI(e){D(this,gI),FT.default(this,"prefix",""),this.prefix=null!=e&&0<e.length?e+" ":""}M(SI,[{key:"get",value:function(e,t){return SI.request("GET",e,t)}},{key:"post",value:function(e,t,n){return SI.request("POST",e,t,n)}}],[{key:"request",value:function(n,r,c,u){return new iI(function(i,o,e){var t,a=new hI,s=!1;for(t in e(function(){a.abort(),s=!0}),a.open(n,r,!0),a.onreadystatechange=function(){var e,t,n,r;4!==a.readyState||s||(e=(e=a.getAllResponseHeaders())?e.split("\r\n").map(function(e){return e.split(": ")}).filter(function(e){return 2===e.length&&0<e[1].length}).reduce(function(e,t){return e[t[0]]=t[1],e},{}):{},t=function(e){var t=e.getResponseHeader("Content-Type");if(!t||0!==t.indexOf("application/json")||0===e.responseText.length)return e.responseText;try{return JSON.parse(e.responseText)}catch(t){return e.responseText}}(a),200<=a.status&&a.status<300?i({status:a.status,headers:e,body:t}):(n=null!=(n=a.statusText)?n:"NONE",r="string"==typeof t?t&&1===t.split("\n",2).length?t:2<(null==(r=null==(r=t.replace(/<.*?>/g,"").split(/\r\n/g).filter(function(e){return e.length})[0])?void 0:r.split(" "))?void 0:r.length)?null==r?void 0:r.slice(1).join(" "):"":JSON.stringify(t),r="".concat(a.status,": [").concat(n,"] ").concat(r),o(new pI(r,a.status,t,n,e))))},c)a.setRequestHeader(t,c[t]),"Content-Type"===t&&"application/json"===c[t]&&(u=JSON.stringify(u));a.send(u)})}}]);var bI=SI,_I=h.scope("Network"),wI=(M(xI,[{key:"backoffConfig",value:function(){return Object.assign(dI.backoffConfigDefault,this.config.backoffConfigOverride)}},{key:"retryWhenThrottled",value:function(){var e;return null!=(e=null!=(e=this.config.retryWhenThrottledOverride)?e:dI.retryWhenThrottledDefault)&&e}},{key:"executeWithRetry",value:function(s,n){var r,c=this;return new iI((r=BT.default(qT.default.mark(function e(t,r,i){var o,a;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=new MT.Retrier(c.backoffConfig()),a=[502,503,504],n&&a.push(429),i(function(){o.cancel(),o.removeAllListeners()}),o.on("attempt",BT.default(qT.default.mark(function e(){var t,n;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=s(),i(function(){t.cancel(),o.cancel(),o.removeAllListeners()}),e.next=5,t;case 5:n=e.sent,o.succeeded(n),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),-1<a.indexOf(e.t0.status)||"Twilsock disconnected"===e.t0.message?o.failed(e.t0):(o.removeAllListeners(),o.cancel(),r(e.t0));case 12:case"end":return e.stop()}},e,null,[[0,9]])}))),o.on("succeeded",function(e){t(e)}),o.on("cancelled",function(e){return r(e)}),o.on("failed",function(e){return r(e)}),o.start();case 9:case"end":return e.stop()}},e)})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"get",value:function(s){var r,c=this;return new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o,a;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i={"X-Twilio-Token":c.config.token},o=c.executeWithRetry(function(){return c.transport.get(s,i)},c.retryWhenThrottled()),_I.trace("sending GET request to ",s," headers ",i),r(function(){return o.cancel()}),e.prev=4,e.next=7,o;case 7:a=e.sent,_I.trace("response",a),t(a),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(4),_I.debug("get() error ".concat(e.t0)),n(e.t0);case 16:case"end":return e.stop()}},e,null,[[4,12]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"post",value:function(a,e,s,t,n){var r,c=this,u={"X-Twilio-Token":this.config.token},l=("undefined"!=typeof FormData&&s instanceof FormData||!t||Object.assign(u,{"Content-Type":t}),new URL(a));return e&&l.searchParams.append("Category",e),n&&l.searchParams.append("Filename",n),new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=c.transport.post(l.href,u,s),r(function(){return i.cancel()}),_I.trace("sending POST request to ".concat(a," with headers ").concat(u)),e.prev=3,e.next=6,i;case 6:o=e.sent,e.next=17;break;case 9:if(e.prev=9,e.t0=e.catch(3),void 0===AT.XMLHttpRequest&&s instanceof FormData)return n(new TypeError("Posting FormData supported only with browser engine's FormData")),e.abrupt("return");e.next=14;break;case 14:return _I.debug("post() error ".concat(e.t0)),n(e.t0),e.abrupt("return");case 17:_I.trace("response",o),t(o);case 19:case"end":return e.stop()}},e,null,[[3,9]])})),function(e,t,n){return r.apply(this,arguments)}))}}]),xI),kI=h.scope("");function xI(e,t){D(this,xI),this.config=e,this.transport=t}function SI(){D(this,SI)}function EI(e,t,n){var r;D(this,EI),this.options=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},this.options.logLevel=null!=(r=this.options.logLevel)?r:"silent",this.config=new dI(e,t,n,this.options),kI.setLevel(this.options.logLevel),this.options.transport=null!=(r=this.options.transport)?r:new bI,this.transport=this.options.transport,this.network=new wI(this.config,this.transport)}Ct.default=(M(EI,[{key:"updateToken",value:function(e){kI.info("updateToken"),this.config.updateToken(e)}},{key:"get",value:function(a){var r,s=this;return new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=s.network.get("".concat(s.config.mediaUrl,"/").concat(a)),r(function(){return i.cancel()}),e.prev=2,e.next=5,i;case 5:o=e.sent,t(new fI(s.config,s.network,o.body)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),n(e.t0);case 12:case"end":return e.stop()}},e,null,[[2,9]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"post",value:function(a,s,c,u){var r,l=this;return new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=l.network.post(l.config.mediaUrl,null!=c?c:"media",s,a,u),r(function(){return i.cancel()}),e.prev=2,e.next=5,i;case 5:o=e.sent,t(new fI(l.config,l.network,o.body)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),n(e.t0);case 12:case"end":return e.stop()}},e,null,[[2,9]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"postFormData",value:function(a,s){var r,c=this;return new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=c.network.post(c.config.mediaUrl,null!=s?s:"media",a),r(function(){return i.cancel()}),e.prev=2,e.next=5,i;case 5:o=e.sent,t(new fI(c.config,c.network,o.body)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),n(e.t0);case 12:case"end":return e.stop()}},e,null,[[2,9]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"mediaSetGet",value:function(s){var r,c=this;return new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o,a;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o={command:"get",list:s.map(function(e){return{media_sid:e}})},i=c.network.post("".concat(c.config.mediaSetUrl),null,o,"application/json"),r(function(){return i.cancel()}),e.prev=3,e.next=6,i;case 6:o=e.sent,a=o.body.map(function(e){if(200===e.code)return new fI(c.config,c.network,e.media_record);n("Failed to obtain detailed information about Media items (failed SID ".concat(e.media_record.sid,")"))}),t(a),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(3),n(e.t0);case 14:case"end":return e.stop()}},e,null,[[3,11]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"mediaSetGetContentUrls",value:function(s){var r,c=this;return new iI((r=BT.default(qT.default.mark(function e(t,n,r){var i,o,a;return qT.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o={command:"get",list:s.map(function(e){return{media_sid:e}})},i=c.network.post("".concat(c.config.mediaSetUrl),null,o,"application/json"),r(function(){return i.cancel()}),e.prev=3,e.next=6,i;case 6:o=e.sent,a=new Map,o.body.forEach(function(e){200===e.code?a.set(e.media_record.sid,e.media_record.links.content_direct_temporary):n("Failed to obtain detailed information about Media items (failed SID ".concat(e.media_record.sid,")"))}),t(a),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(3),n(e.t0);case 15:case"end":return e.stop()}},e,null,[[3,12]])})),function(e,t,n){return r.apply(this,arguments)}))}}]),FT.default(L=EI,"version","0.6.1"),L),aI([a.validateTypes(a.nonEmptyString),sI("design:type",Function),sI("design:paramtypes",[String]),sI("design:returntype",void 0)],Ct.default.prototype,"updateToken",null),aI([a.validateTypesAsync(a.nonEmptyString),sI("design:type",Function),sI("design:paramtypes",[String]),sI("design:returntype",iI)],Ct.default.prototype,"get",null),Ct.default=aI([a.validateConstructorTypes(a.nonEmptyString,a.nonEmptyString,[a.nonEmptyString,a.literal(null)],[a.pureObject,"undefined"]),sI("design:paramtypes",[String,String,Object,Object])],Ct.default),Ct.CancellablePromise=iI,Ct.Client=Ct.default,Ct.McsClient=Ct.default,Ct.McsMedia=fI,Ct.Media=fI;var CI=ot,TI=it,II=o.aTypedArray,Ie=((0,o.exportTypedArrayMethod)("at",function(e){var t=II(this),n=CI(t.length),e=TI(e),e=0<=e?e:n+e;return e<0||n<=e?void 0:t[e]}),Xi),lr=Ef.ArrayBuffer;i({global:!0,forced:n.ArrayBuffer!==lr},{ArrayBuffer:lr}),Ie("ArrayBuffer");var RI=oi.scope("Participant"),PI=function(){Ji(s,Wp);r=s,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,e,n,r,i,a=function(){var e,t=Ki(r);return $i(this,i?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function s(e,t,n,r,i){var o;if(D(this,s),(o=a.call(this)).conversation=n,o.links=r,o.services=i,o.state={attributes:Nl(e.attributes,"Retrieved malformed attributes from the server for participant: "+t,RI),dateCreated:e.dateCreated?Ll(e.dateCreated):null,dateUpdated:e.dateCreated?Ll(e.dateUpdated):null,sid:t,typingTimeout:null,isTyping:!1,identity:e.identity,roleSid:null!=(n=e.roleSid)?n:"",lastReadMessageIndex:Number.isInteger(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,lastReadTimestamp:e.lastConsumptionTimestamp?Ll(e.lastConsumptionTimestamp):null,type:e.type||"chat",userInfo:e.userInfo,bindings:null!=(r=e.bindings)?r:{}},e.identity||e.type)return o;throw new Error("Received invalid Participant object from server: Missing identity or type of Participant.")}return M(s,[{key:"sid",get:function(){return this.state.sid}},{key:"attributes",get:function(){return this.state.attributes}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"identity",get:function(){return this.state.identity}},{key:"isTyping",get:function(){return this.state.isTyping}},{key:"lastReadMessageIndex",get:function(){return this.state.lastReadMessageIndex}},{key:"lastReadTimestamp",get:function(){return this.state.lastReadTimestamp}},{key:"roleSid",get:function(){return this.state.roleSid}},{key:"type",get:function(){return this.state.type}},{key:"bindings",get:function(){var e;return null!=(e=this.state.bindings)?e:{}}},{key:"_startTyping",value:function(e){var t=this;return this.state.typingTimeout&&clearTimeout(this.state.typingTimeout),this.state.isTyping=!0,this.emit("typingStarted",this),this.conversation.emit("typingStarted",this),this.state.typingTimeout=Number(setTimeout(function(){return t._endTyping()},e)),this}},{key:"_endTyping",value:function(){this.state.typingTimeout&&(this.state.isTyping=!1,this.emit("typingEnded",this),this.conversation.emit("typingEnded",this),clearInterval(this.state.typingTimeout),this.state.typingTimeout=null)}},{key:"_update",value:function(e){var t=[],n=Nl(e.attributes,"Retrieved malformed attributes from the server for participant: "+this.state.sid,RI),n=(e.attributes&&!hh(this.state.attributes,n)&&(this.state.attributes=n,t.push("attributes")),Ll(e.dateUpdated)),n=(e.dateUpdated&&(null==n?void 0:n.getTime())!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=n,t.push("dateUpdated")),Ll(e.dateCreated));return e.dateCreated&&(null==n?void 0:n.getTime())!==(this.state.dateCreated&&this.state.dateCreated.getTime())&&(this.state.dateCreated=n,t.push("dateCreated")),e.roleSid&&this.state.roleSid!==e.roleSid&&(this.state.roleSid=e.roleSid,t.push("roleSid")),!Number.isInteger(e.lastConsumedMessageIndex)&&null!==e.lastConsumedMessageIndex||this.state.lastReadMessageIndex===e.lastConsumedMessageIndex||(this.state.lastReadMessageIndex=e.lastConsumedMessageIndex,t.push("lastReadMessageIndex")),e.lastConsumptionTimestamp&&(n=new Date(e.lastConsumptionTimestamp),this.state.lastReadTimestamp&&this.state.lastReadTimestamp.getTime()===n.getTime()||(this.state.lastReadTimestamp=n,t.push("lastReadTimestamp"))),e.bindings&&!hh(this.state.bindings,e.bindings)&&(this.state.bindings=e.bindings,t.push("bindings")),0<t.length&&this.emit("updated",{participant:this,updateReasons:t}),this}},{key:"getUser",value:(n=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("chat"!=this.type)throw new Error("Getting User is not supported for this Participant type: "+this.type);e.next=2;break;case 2:return e.abrupt("return",this.services.users.getUser(this.state.identity,this.state.userInfo));case 3:case"end":return e.stop()}},e,this)})),function(){return n.apply(this,arguments)})},{key:"remove",value:(e=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.conversation.removeParticipant(this));case 1:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"updateAttributes",value:(t=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(t)});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}]),s}();b(PI,"typingStarted","typingStarted"),b(PI,"typingEnded","typingEnded"),b(PI,"updated","updated"),y([g(gf),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",Promise)],PI.prototype,"updateAttributes",null);var OI=oi.scope("Participants"),AI=function(){Ji(d,Wp);c=d,u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,r,t,i,e,o,a,s,c,u,l=function(){var e,t=Ki(c);return $i(this,u?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function d(e,t,n,r,i){var o;return D(this,d),b(Vi(o=l.call(this)),"rosterEntityPromise",null),o.conversation=e,o.participants=t,o.links=n,o.configuration=r,o.services=i,o}return M(d,[{key:"unsubscribe",value:(s=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.rosterEntityPromise)return e.next=3,this.rosterEntityPromise;e.next=6;break;case 3:e.sent.close(),this.rosterEntityPromise=null;case 6:case"end":return e.stop()}},e,this)})),function(){return s.apply(this,arguments)})},{key:"subscribe",value:function(e){var r=this,e="string"==typeof e?this.services.syncClient.map({id:e,mode:"open_existing"}):Promise.resolve(e);return this.rosterEntityPromise=this.rosterEntityPromise||e.then(function(e){e.on("itemAdded",function(e){OI.debug(r.conversation.sid+" itemAdded: "+e.item.key),r.upsertParticipant(e.item.key,e.item.data).then(function(e){r.emit("participantJoined",e)})}),e.on("itemRemoved",function(e){OI.debug(r.conversation.sid+" itemRemoved: "+e.key);var t,e=e.key;r.participants.has(e)&&(t=r.participants.get(e),r.participants.delete(e),t)&&r.emit("participantLeft",t)}),e.on("itemUpdated",function(e){OI.debug(r.conversation.sid+" itemUpdated: "+e.item.key),r.upsertParticipant(e.item.key,e.item.data)});var n=[];return e.getItems().then(function e(t){return t.items.forEach(function(e){n.push(r.upsertParticipant(e.key,e.data))}),t.hasNextPage?t.nextPage().then(e):null}).then(function(){return Promise.all(n)}).then(function(){return e})}).catch(function(e){throw r.rosterEntityPromise=null,"disconnected"!=r.services.syncClient.connectionState&&OI.error("Failed to get roster object for conversation",r.conversation.sid,e),OI.debug("ERROR: Failed to get roster object for conversation",r.conversation.sid,e),e})}},{key:"upsertParticipantFromResponse",value:(a=A(j.mark(function e(t){var n,r,i,o,a,s,c;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.sid,r=t.attributes,i=t.date_created,o=t.date_updated,a=t.identity,s=t.role_sid,c=t.messaging_binding,e.next=3,this.upsertParticipant(n,{attributes:r,dateCreated:new Date(i),dateUpdated:new Date(o),identity:a,roleSid:s,lastConsumedMessageIndex:null,lastConsumptionTimestamp:null,type:null!=(n=null==c?void 0:c.type)?n:"chat"});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"upsertParticipant",value:(o=A(j.mark(function e(t,n){var r,i,o=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.participants.get(t))return e.abrupt("return",r._update(n));e.next=3;break;case 3:return i={self:"".concat(this.links.participants,"/").concat(t)},r=new PI(n,t,this.conversation,i,this.services),this.participants.set(t,r),r.on("updated",function(e){return o.emit("participantUpdated",e)}),e.abrupt("return",r);case 8:case"end":return e.stop()}},e,this)})),function(e,t){return o.apply(this,arguments)})},{key:"getParticipants",value:(e=A(j.mark(function e(){var n=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then(function(){var t=[];return n.participants.forEach(function(e){return t.push(e)}),t}):[]);case 1:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"getParticipantBySid",value:(i=A(j.mark(function e(t){var n=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then(function(){var e=n.participants.get(t);if(e)return e;throw new Error("Participant with SID "+t+" was not found")}):null);case 1:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(t=A(j.mark(function e(t){var n,r=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then(function(){if(r.participants.forEach(function(e){e.identity===t&&(n=e)}),n)return n;throw new Error("Participant with identity "+t+" was not found")}):null);case 2:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"add",value:(r=A(j.mark(function e(t,n){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.participants,{identity:t,attributes:void 0!==n?JSON.stringify(n):void 0});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"addNonChatParticipant",value:(n=A(j.mark(function e(t,n){var r,i,o=arguments;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=2<o.length&&void 0!==o[2]?o[2]:{},i=3<o.length&&void 0!==o[3]?o[3]:{},e.next=4,this.services.commandExecutor.mutateResource("post",this.links.participants,{attributes:void 0!==r?JSON.stringify(r):void 0,messaging_binding:{address:n,proxy_address:t,name:null==i||null==(r=i.email)?void 0:r.name,level:null==i||null==(r=i.email)?void 0:r.level}});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"remove",value:function(e){return this.services.commandExecutor.mutateResource("delete","".concat(this.links.participants,"/").concat(e))}}]),d}(),me=i,MI=Tn,DI=Y,jI=ot,LI=Pn,ue=t,NI=ge,_f=os,UI=ev,FI=Sf,BI=le,qI=Rt,zI=[],WI=zI.sort,Yn=ue(function(){zI.sort(void 0)}),Tf=ue(function(){zI.sort(null)}),ni=_f("sort"),GI=!ue(function(){if(BI)return BI<70;if(!(UI&&3<UI)){if(FI)return!0;if(qI)return qI<603;for(var e,t,n,r="",i=65;i<76;i++){switch(e=String.fromCharCode(i),i){case 66:case 69:case 70:case 72:t=3;break;case 68:case 71:t=4;break;default:t=2}for(n=0;n<47;n++)zI.push({k:e+n,v:t})}for(zI.sort(function(e,t){return t.v-e.v}),n=0;n<zI.length;n++)e=zI[n].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return"DGBEFHACIJK"!==r}}),VI=(me({target:"Array",proto:!0,forced:Yn||!Tf||!ni||!GI},{sort:function(e){void 0!==e&&MI(e);var t=DI(this);if(GI)return void 0===e?WI.call(t):WI.call(t,e);for(var n,r,i=[],o=jI(t.length),a=0;a<o;a++)a in t&&i.push(t[a]);for(n=(i=NI(i,(r=e,function(e,t){return void 0===t?-1:void 0===e?1:void 0!==r?+r(e,t)||0:LI(e)>LI(t)?1:-1}))).length,a=0;a<n;)t[a]=i[a++];for(;a<o;)delete t[a++];return t}}),nE),HI=V,JI=Pn,$I=(i({target:"String",proto:!0,forced:!rE("includes")},{includes:function(e){return!!~JI(HI(this)).indexOf(JI(VI(e)),1<arguments.length?arguments[1]:void 0)}}),M(eR,[{key:"sid",get:function(){return this.state.sid}},{key:"filename",get:function(){return this.state.filename}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"category",get:function(){return this.state.category}},{key:"getContentTemporaryUrl",value:function(){var r,s=this;return new hE.CancellablePromise((r=A(j.mark(function e(t,n,r){var i,o,a;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=s._fetchMcsMedia(),o=null==(a=s.mcsMedia)?void 0:a.getContentUrl(),r(function(){i.cancel(),o&&o.cancel()}),e.prev=3,s.mcsMedia){e.next=9;break}return e.next=7,i;case 7:a=e.sent,o=a.getContentUrl();case 9:if(e.t0=t,o)return e.next=13,o;e.next=16;break;case 13:e.t1=e.sent,e.next=17;break;case 16:e.t1=null;case 17:e.t2=e.t1,(0,e.t0)(e.t2),e.next=24;break;case 21:e.prev=21,e.t3=e.catch(3),n(e.t3);case 24:case"end":return e.stop()}},e,null,[[3,21]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"_fetchMcsMedia",value:function(){var r,o=this;return new hE.CancellablePromise((r=A(j.mark(function e(t,n,r){var i;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=o.services.mcsClient.get(o.state.sid),o.services.mcsClient)return r(function(){return i.cancel()}),e.prev=3,e.next=6,i;e.next=14;break;case 6:o.mcsMedia=e.sent,t(o.mcsMedia),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),n(e.t0);case 13:return e.abrupt("return");case 14:n(new Error("Media Content Service is unavailable"));case 15:case"end":return e.stop()}},e,null,[[3,10]])})),function(e,t,n){return r.apply(this,arguments)}))}}]),eR),KI=(M(ZI,[{key:"total",get:function(){return this.state.total}},{key:"sent",get:function(){return this.state.sent}},{key:"delivered",get:function(){return this.state.delivered}},{key:"read",get:function(){return this.state.read}},{key:"undelivered",get:function(){return this.state.undelivered}},{key:"failed",get:function(){return this.state.failed}},{key:"_update",value:function(e){this.state=e}},{key:"_isEquals",value:function(e){var t=this.total===e.total,n=this.sent===e.sent,r=this.delivered===e.delivered,i=this.read===e.read,o=this.undelivered===e.undelivered,e=this.failed===e.failed;return t&&n&&r&&i&&o&&e}}]),ZI),YI=(M(XI,[{key:"hasNextPage",get:function(){return!!this.state.nextToken}},{key:"hasPrevPage",get:function(){return!!this.state.prevToken}},{key:"items",get:function(){return this.state.items}},{key:"nextPage",value:function(){return this.hasNextPage?this.state.source(this.state.nextToken):Promise.reject(new Error("No next page"))}},{key:"prevPage",value:function(){return this.hasPrevPage?this.state.source(this.state.prevToken):Promise.reject(new Error("No previous page"))}}]),XI),QI=M(function e(t){D(this,e),this.sid=t.sid,this.messageSid=t.message_sid,this.conversationSid=t.conversation_sid,this.channelMessageSid=t.channel_message_sid,this.participantSid=t.participant_sid,this.status=t.status||"queued",this.errorCode=t.error_code||0,this.dateCreated=t.date_created,this.dateUpdated=t.date_updated}),Tt={};function XI(e,t,n,r){D(this,XI),this.state={prevToken:n,nextToken:r,source:t,items:e}}function ZI(e){D(this,ZI),this.state=e}function eR(e,t){D(this,eR),b(this,"mcsMedia",null),this.services=t,e instanceof hE.McsMedia&&(this.mcsMedia=e),this.state={sid:e.sid,category:e.category,filename:e.filename,contentType:e.contentType,size:e.size}}Object.defineProperty(Tt,"__esModule",{value:!0});function tR(e){var t=nR.default.getLevel();nR.default.setLevel("warn"),nR.default.warn(e),nR.default.setLevel(t)}var nR=(dv=Tr.exports)&&"object"===F(dv)&&"default"in dv?dv:{default:dv},ur=Tt.deprecated=function(o,a,s){return function(e,t,n){if("function"!=typeof n.value&&void 0===(null==n?void 0:n.get))throw new Error("The deprecated decorator can only be applied to methods or getters");var r,i;"function"!=typeof n.value?(r=n.get,n.get=function(){return tR("The getter ".concat(o," is deprecated").concat(a?", use "+a+" instead":"").concat(s?", "+s:".")),null==r?void 0:r.apply(this)}):(i=n.value,n.value=function(){tR("The method ".concat(o," is deprecated").concat(a?", use "+a+" instead":"").concat(s?", "+s:"."));for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.apply(this,t)})}},rR=Tt.deprecationWarning=tR;function iR(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function oR(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?iR(Object(n),!0).forEach(function(e){b(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):iR(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var aR=oi.scope("Message"),sR=function(){Ji(l,Wp);s=l,c=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,n,r,i,e,o,a,s,c,u=function(){var e,t=Ki(s);return $i(this,c?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function l(e,t,n,r,i,o){var a;return D(this,l),(a=u.call(this)).conversation=n,a.links=r,a.configuration=i,a.services=o,a.state={sid:t.sid,index:e,author:t.author,subject:t.subject,body:null!=(n=t.text)?n:null,timestamp:t.timestamp?new Date(t.timestamp):null,dateUpdated:t.dateUpdated?new Date(t.dateUpdated):null,lastUpdatedBy:null!=(r=t.lastUpdatedBy)?r:null,attributes:Nl(t.attributes,"Got malformed attributes for the message ".concat(t.sid),aR),type:null!=(i=t.type)?i:"text",media:"media"===t.type&&t.media?new $I(t.media,a.services):null,medias:"media"===t.type&&t.medias?t.medias.map(function(e){return new $I(e,a.services)}):"media"===t.type&&t.media&&!t.medias?[new $I(oR(oR({},t.media),{},{category:"media"}),a.services)]:null,participantSid:null!=(o=t.memberSid)?o:null,aggregatedDeliveryReceipt:t.delivery?new KI(t.delivery):null},a}return M(l,[{key:"sid",get:function(){return this.state.sid}},{key:"author",get:function(){return this.state.author}},{key:"subject",get:function(){return this.state.subject}},{key:"body",get:function(){return this.state.body}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"index",get:function(){return this.state.index}},{key:"lastUpdatedBy",get:function(){return this.state.lastUpdatedBy}},{key:"dateCreated",get:function(){return this.state.timestamp}},{key:"attributes",get:function(){return this.state.attributes}},{key:"type",get:function(){return this.state.type}},{key:"media",get:function(){return this.state.media}},{key:"attachedMedia",get:function(){return this.getMediaByCategories(["media"])}},{key:"participantSid",get:function(){return this.state.participantSid}},{key:"aggregatedDeliveryReceipt",get:function(){return this.state.aggregatedDeliveryReceipt}},{key:"getMediaByCategory",value:function(e){return this.getMediaByCategories(e)}},{key:"getMediaByCategories",value:function(t){var e;return(null!=(e=this.state.medias)?e:[]).filter(function(e){return t.includes(e.category)})}},{key:"getEmailBody",value:function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"text/plain";return null!=(e=null==(e=this.getMediaByCategories(["body"]))?void 0:e.filter(function(e){return e.contentType==t}).shift())?e:null}},{key:"getEmailHistory",value:function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"text/plain";return null!=(e=null==(e=this.getMediaByCategories(["history"]))?void 0:e.filter(function(e){return e.contentType==t}).shift())?e:null}},{key:"_update",value:function(e){var t=[],n=(!e.text&&"string"!=typeof e.text||e.text===this.state.body||(this.state.body=e.text,t.push("body")),e.subject&&e.subject!==this.state.subject&&(this.state.subject=e.subject,t.push("subject")),e.lastUpdatedBy&&e.lastUpdatedBy!==this.state.lastUpdatedBy&&(this.state.lastUpdatedBy=e.lastUpdatedBy,t.push("lastUpdatedBy")),e.author&&e.author!==this.state.author&&(this.state.author=e.author,t.push("author")),e.dateUpdated&&new Date(e.dateUpdated).getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=new Date(e.dateUpdated),t.push("dateUpdated")),e.timestamp&&new Date(e.timestamp).getTime()!==(this.state.timestamp&&this.state.timestamp.getTime())&&(this.state.timestamp=new Date(e.timestamp),t.push("dateCreated")),Nl(e.attributes,"Got malformed attributes for the message ".concat(this.sid),aR)),n=(hh(this.state.attributes,n)||(this.state.attributes=n,t.push("attributes")),e.delivery),e=this.state.aggregatedDeliveryReceipt;n&&n.total&&n.delivered&&n.failed&&n.read&&n.sent&&n.undelivered&&(e?e._isEquals(n)||(e._update(n),t.push("deliveryReceipt")):(this.state.aggregatedDeliveryReceipt=new KI(n),t.push("deliveryReceipt"))),0<t.length&&this.emit("updated",{message:this,updateReasons:t})}},{key:"getParticipant",value:(a=A(j.mark(function e(){var t,n,r=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=null,this.state.participantSid)return e.next=4,this.conversation.getParticipantBySid(this.state.participantSid).catch(function(){return aR.debug('Participant with sid "'.concat(r.participantSid,'" not found for message ').concat(r.sid)),null});e.next=5;break;case 4:t=e.sent;case 5:if(!t&&this.state.author)return e.next=8,this.conversation.getParticipantByIdentity(this.state.author).catch(function(){return aR.debug('Participant with identity "'.concat(r.author,'" not found for message ').concat(r.sid)),null});e.next=9;break;case 8:t=e.sent;case 9:if(t)return e.abrupt("return",t);e.next=11;break;case 11:throw n="Participant with ",this.state.participantSid&&(n+="SID '"+this.state.participantSid+"' "),this.state.author&&(this.state.participantSid&&(n+="or "),n+="identity '"+this.state.author+"' "),"Participant with "===n&&(n="Participant "),n+="was not found",new Error(n);case 17:case"end":return e.stop()}},e,this)})),function(){return a.apply(this,arguments)})},{key:"getDetailedDeliveryReceipts",value:(o=A(j.mark(function e(){var t,n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getDetailedDeliveryReceiptsPaginator();case 2:t=e.sent,n=t.items;case 4:if(t.hasNextPage)return e.next=7,t.nextPage();e.next=11;break;case 7:t=e.sent,n=[].concat(OT(n),OT(t.items)),e.next=4;break;case 11:return e.abrupt("return",n);case 12:case"end":return e.stop()}},e,this)})),function(){return o.apply(this,arguments)})},{key:"remove",value:(e=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("delete",this.links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"updateBody",value:(i=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{body:t});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"updateAttributes",value:(r=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:void 0!==t?JSON.stringify(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"attachTemporaryUrlsFor",value:(n=A(j.mark(function e(t){var n,r=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=null==t?void 0:t.map(function(e){return e.sid}),this.services.mcsClient&&n)return e.next=4,this.services.mcsClient.mediaSetGet(n);e.next=7;break;case 4:return e.abrupt("return",e.sent.map(function(e){return new $I(e,r.services)}));case 7:throw new Error("Media Content Service is unavailable");case 8:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)})},{key:"getTemporaryContentUrlsForMedia",value:function(e){e=e.map(function(e){return e.sid});return this.getTemporaryContentUrlsForMediaSids(e)}},{key:"getTemporaryContentUrlsForMediaSids",value:function(a){var r,s=this;return new hE.CancellablePromise((r=A(j.mark(function e(t,n,r){var i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=s.services.mcsClient.mediaSetGetContentUrls(null!=a?a:[]),s.services.mcsClient&&a){e.next=4;break}return n(new Error("Media Content Service is unavailable")),e.abrupt("return");case 4:return r(function(){i.cancel()}),e.prev=5,e.next=8,i;case 8:o=e.sent,t(o),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(5),n(e.t0);case 15:case"end":return e.stop()}},e,null,[[5,12]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"getTemporaryContentUrlsForAttachedMedia",value:function(){var e=this.attachedMedia,e=null!=(e=null==e?void 0:e.map(function(e){return e.sid}))?e:[];return this.getTemporaryContentUrlsForMediaSids(e)}},{key:"_getDetailedDeliveryReceiptsPaginator",value:(t=A(j.mark(function e(t){var n,r=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.configuration.links.messagesReceipts.replace("%s",this.conversation.sid).replace("%s",this.sid),n=new Ul(n).arg("PageToken",null==t?void 0:t.pageToken).arg("PageSize",null==t?void 0:t.pageSize).build(),e.next=4,this.services.network.get(n);case 4:return n=e.sent,e.abrupt("return",new YI(n.body.delivery_receipts.map(function(e){return new QI(e)}),function(e,t){return r._getDetailedDeliveryReceiptsPaginator({pageToken:e,pageSize:t})},n.body.meta.previous_token,n.body.meta.next_token));case 6:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}]),l}();function cR(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}b(sR,"updated","updated"),y([ur("getMediaByCategory","getMediaByCategories"),v("design:type",Function),v("design:paramtypes",[Array]),v("design:returntype",Array)],sR.prototype,"getMediaByCategory",null),y([vf([Wd,"undefined"]),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",$I)],sR.prototype,"getEmailBody",null),y([vf([Wd,"undefined"]),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",$I)],sR.prototype,"getEmailHistory",null),y([g("string"),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],sR.prototype,"updateBody",null),y([g(gf),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",Promise)],sR.prototype,"updateAttributes",null),y([ur("attachTemporaryUrlsFor","getTemporaryContentUrlsForMedia"),v("design:type",Function),v("design:paramtypes",[Array]),v("design:returntype",Promise)],sR.prototype,"attachTemporaryUrlsFor",null),y([g(zd("media",$I)),v("design:type",Function),v("design:paramtypes",[Array]),v("design:returntype",hE.CancellablePromise)],sR.prototype,"getTemporaryContentUrlsForMedia",null),y([g(zd("strings","string")),v("design:type",Function),v("design:paramtypes",[Array]),v("design:returntype",hE.CancellablePromise)],sR.prototype,"getTemporaryContentUrlsForMediaSids",null);var uR=oi.scope("Messages"),lR=function(){Ji(u,Wp);a=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var e,n,t,r,i,o,a,s,c=function(){var e,t=Ki(a);return $i(this,s?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function u(e,t,n){var r;return D(this,u),(r=c.call(this)).conversation=e,r.configuration=t,r.services=n,r.messagesByIndex=new Map,r.messagesListPromise=null,r}return M(u,[{key:"subscribe",value:(o=A(j.mark(function e(t){var n,r=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.messagesListPromise)return e.abrupt("return",this.messagesListPromise);e.next=2;break;case 2:return this.messagesListPromise="string"==typeof t?this.services.syncClient.list({id:t,mode:"open_existing"}):Promise.resolve(t),e.prev=3,e.next=6,this.messagesListPromise;case 6:return(n=e.sent).on("itemAdded",function(e){uR.debug("".concat(r.conversation.sid," itemAdded: ").concat(e.item.index));var t={self:"".concat(r.conversation._links.messages,"/").concat(e.item.data.sid),conversation:r.conversation._links.self,messages_receipts:"".concat(r.conversation._links.messages,"/").concat(e.item.data.sid,"/Receipts")},e=new sR(e.item.index,e.item.data,r.conversation,t,r.configuration,r.services);r.messagesByIndex.has(e.index)?uR.debug("Message arrived, but is already known and ignored",r.conversation.sid,e.index):(r.messagesByIndex.set(e.index,e),e.on("updated",function(e){return r.emit("messageUpdated",e)}),r.emit("messageAdded",e))}),n.on("itemRemoved",function(e){uR.debug("#{this.conversation.sid} itemRemoved: ".concat(e.index));var e=e.index;r.messagesByIndex.has(e)&&(e=r.messagesByIndex.get(e))&&(r.messagesByIndex.delete(e.index),e.removeAllListeners("updated"),r.emit("messageRemoved",e))}),n.on("itemUpdated",function(e){uR.debug("".concat(r.conversation.sid," itemUpdated: ").concat(e.item.index));var t=r.messagesByIndex.get(e.item.index);t&&t._update(e.item.data)}),e.abrupt("return",n);case 13:throw e.prev=13,e.t0=e.catch(3),this.messagesListPromise=null,"disconnected"!==this.services.syncClient.connectionState&&uR.error("Failed to get messages object for conversation",this.conversation.sid,e.t0),uR.debug("ERROR: Failed to get messages object for conversation",this.conversation.sid,e.t0),e.t0;case 19:case"end":return e.stop()}},e,this,[[3,13]])})),function(e){return o.apply(this,arguments)})},{key:"unsubscribe",value:(i=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.messagesListPromise){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.messagesListPromise;case 4:e.sent.close(),this.messagesListPromise=null;case 7:case"end":return e.stop()}},e,this)})),function(){return i.apply(this,arguments)})},{key:"sendV2",value:function(l){var r,d=this;return uR.debug("Sending message V2",l.mediaContent,l.attributes,l.emailOptions),new hE.CancellablePromise((r=A(j.mark(function e(t,n,r){var i,o,a,s,c,u;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=[],o=[],r(function(){o.forEach(function(e){return e.cancel()})}),a=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?cR(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?cR(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(l.mediaContent),e.prev=4,a.s();case 6:if((u=a.n()).done){e.next=25;break}return u=bh(u.value,2),s=u[0],u=u[1],e.prev=8,uR.debug("Adding media to a message as ".concat(u instanceof FormData?"FormData":"SendMediaOptions"),u),c=u instanceof FormData?d.services.mcsClient.postFormData(u,s):d.services.mcsClient.post(null!=(c=u.contentType)?c:"",null!=(c=u.media)?c:"",s,u.filename),o.push(c),e.t0=i,e.next=15,c;case 15:e.t1=e.sent,e.t0.push.call(e.t0,e.t1),e.next=23;break;case 19:return e.prev=19,e.t2=e.catch(8),n(e.t2),e.abrupt("return");case 23:e.next=6;break;case 25:e.next=30;break;case 27:e.prev=27,e.t3=e.catch(4),a.e(e.t3);case 30:return e.prev=30,a.f(),e.finish(30);case 33:return u=d.services.commandExecutor.mutateResource("post",d.conversation._links.messages,{body:l.text,subject:null==(s=l.emailOptions)?void 0:s.subject,media_sids:i.map(function(e){return e.sid}),attributes:void 0!==l.attributes?JSON.stringify(l.attributes):void 0}),e.prev=34,e.t4=t,e.next=38,u;case 38:e.t5=e.sent,(0,e.t4)(e.t5),e.next=45;break;case 42:e.prev=42,e.t6=e.catch(34),n(e.t6);case 45:case"end":return e.stop()}},e,null,[[4,27,30,33],[8,19],[34,42]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"send",value:(r=A(j.mark(function e(t){var n,r,i=arguments;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=1<i.length&&void 0!==i[1]?i[1]:{},r=2<i.length?i[2]:void 0,uR.debug("Sending text message",t,n,r),e.abrupt("return",this.services.commandExecutor.mutateResource("post",this.conversation._links.messages,{body:null!=t?t:"",attributes:void 0!==n?JSON.stringify(n):void 0,subject:null==r?void 0:r.subject}));case 4:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"sendMedia",value:(t=A(j.mark(function e(t){var n,r,i,o=arguments;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=1<o.length&&void 0!==o[1]?o[1]:{},r=2<o.length?o[2]:void 0,uR.debug("Sending media message",t,n,r),uR.debug("Sending media message as ".concat(t instanceof FormData?"FormData":"SendMediaOptions"),t,n),t instanceof FormData)return e.next=7,this.services.mcsClient.postFormData(t);e.next=10;break;case 7:e.t0=e.sent,e.next=13;break;case 10:return e.next=12,this.services.mcsClient.post(null!=(r=t.contentType)?r:"",null!=(i=t.media)?i:"","media",t.filename);case 12:e.t0=e.sent;case 13:return i=e.t0,e.next=16,this.services.commandExecutor.mutateResource("post",this.conversation._links.messages,{media_sids:[i.sid],attributes:void 0!==n?JSON.stringify(n):void 0});case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"getMessages",value:(n=A(j.mark(function e(t,n){var r,i=arguments;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=2<i.length&&void 0!==i[2]?i[2]:"backwards",e.abrupt("return",this._getMessages(t,n,r));case 2:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"_wrapPaginator",value:function(t,n,r){function i(){return n.nextPage().then(function(e){return a._wrapPaginator(t,e,r)})}function o(){return n.prevPage().then(function(e){return a._wrapPaginator(t,e,r)})}var a=this,s="desc"===t;return r(n.items).then(function(e){return{items:e.sort(function(e,t){return e.index-t.index}),hasPrevPage:s?n.hasNextPage:n.hasPrevPage,hasNextPage:s?n.hasPrevPage:n.hasNextPage,prevPage:s?i:o,nextPage:s?o:i}})}},{key:"_upsertMessage",value:function(e,t){var n=this,r=this.messagesByIndex.get(e);return r||(r={self:"".concat(this.conversation._links.messages,"/").concat(t.sid),conversation:this.conversation._links.self,messages_receipts:"".concat(this.conversation._links.messages,"/").concat(t.sid,"/Receipts")},e=new sR(e,t,this.conversation,r,this.configuration,this.services),this.messagesByIndex.set(e.index,e),e.on("updated",function(e){return n.emit("messageUpdated",e)}),e)}},{key:"_getMessages",value:(e=A(j.mark(function e(){var t,n,r,i,o=this,a=arguments;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=0<a.length&&void 0!==a[0]?a[0]:30,n=1<a.length&&void 0!==a[1]?a[1]:"end",r="backwards"===(2<a.length&&void 0!==a[2]?a[2]:"forward")?"desc":"asc",e.next=6,this.messagesListPromise;case 6:return i=e.sent,e.next=9,null==i?void 0:i.getItems({from:"end"!==n?n:void 0,pageSize:t,order:r,limit:t});case 9:return i=e.sent,e.next=12,this._wrapPaginator(r,i,function(e){return Promise.all(e.map(function(e){return o._upsertMessage(e.index,e.data)}))});case 12:return e.abrupt("return",e.sent);case 13:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})}]),u}(),dR=(M(hR,[{key:"send",value:function(){var r,a=this;return new hE.CancellablePromise((r=A(j.mark(function e(t,n,r){var i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=a.messagesEntity.sendV2(a),r(function(){return i.cancel()}),e.prev=2,e.next=5,i;case 5:o=e.sent,t(jl(o.index)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),n(e.t0);case 12:case"end":return e.stop()}},e,null,[[2,9]])})),function(e,t,n){return r.apply(this,arguments)}))}}]),hR),fR=(M(pR,[{key:"setBody",value:function(e){return this.message.text=e,this}},{key:"setSubject",value:function(e){return this.message.emailOptions.subject=e,this}},{key:"setAttributes",value:function(e){return this.message.attributes=e,this}},{key:"setEmailBody",value:function(e,t){return this.emailBodies.set(e,t),this}},{key:"setEmailHistory",value:function(e,t){return this.emailHistories.set(e,t),this}},{key:"addMedia",value:function(e){if("undefined"==typeof FormData&&e instanceof FormData)throw new Error("Could not add FormData content whilst not in a browser");if(!(e instanceof FormData)&&(!e.contentType||!e.media))throw new Error("Media content in SendMediaOptions must contain non-empty contentType and media");return this.message.mediaContent.push(["media",e]),this}},{key:"build",value:function(){var n=this;if(this.emailBodies.forEach(function(e,t){if(!n.limits.emailBodiesAllowedContentTypes.includes(t))throw new Error("Unsupported email body content type ".concat(t))}),this.emailHistories.forEach(function(e,t){if(!n.limits.emailHistoriesAllowedContentTypes.includes(t))throw new Error("Unsupported email history content type ".concat(t))}),this.emailBodies.size>this.limits.emailBodiesAllowedContentTypes.length)throw new Error("Too many email bodies attached to the message (".concat(this.emailBodies.size," > ").concat(this.limits.emailBodiesAllowedContentTypes.length,")"));if(this.emailHistories.size>this.limits.emailHistoriesAllowedContentTypes.length)throw new Error("Too many email histories attached to the message (".concat(this.emailHistories.size," > ").concat(this.limits.emailHistoriesAllowedContentTypes.length,")"));if(this.message.mediaContent.length>this.limits.mediaAttachmentsCountLimit)throw new Error("Too many media attachments in the message (".concat(this.message.mediaContent.length," > ").concat(this.limits.mediaAttachmentsCountLimit,")"));return this.emailBodies.forEach(function(e){n.message.mediaContent.push(["body",e])}),this.emailHistories.forEach(function(e){n.message.mediaContent.push(["history",e])}),this.message}},{key:"buildAndSend",value:function(){return this.build().send()}},{key:"getPayloadContentType",value:function(e){return"undefined"!=typeof FormData&&e instanceof FormData?e.get("Content-Type"):e.contentType}}]),pR);function pR(e,t){D(this,pR),this.limits=e,this.message=new dR(t),this.emailBodies=new Map,this.emailHistories=new Map}function hR(e){D(this,hR),b(this,"attributes",{}),b(this,"mediaContent",[]),b(this,"emailOptions",{}),this.messagesEntity=e}function mR(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var yR={lastMessage:"lastMessage",attributes:"attributes",createdBy:"createdBy",dateCreated:"dateCreated",dateUpdated:"dateUpdated",friendlyName:"friendlyName",lastConsumedMessageIndex:"lastConsumedMessageIndex",notificationLevel:"notificationLevel",sid:"sid",status:"status",uniqueName:"uniqueName",state:"state",bindings:"bindings"},vR=function(){Ji(O,Wp);I=O,R=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,e,n,r,i,o,a,s,c,u,l,d,f,p,h,m,y,v,g,b,_,w,k,x,S,E,C,T,I,R,P=function(){var e,t=Ki(I);return $i(this,R?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function O(e,t,n,r,i){D(this,O),(o=P.call(this)).sid=t,o._links=n,o._configuration=r,o._services=i,o._entityName=e.channel,o._internalState={uniqueName:e.uniqueName||null,status:"notParticipating",attributes:null!=(t=e.attributes)?t:{},createdBy:e.createdBy,dateCreated:Ll(e.dateCreated),dateUpdated:Ll(e.dateUpdated),friendlyName:e.friendlyName||null,lastReadMessageIndex:Number.isInteger(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,bindings:null!=(n=e.bindings)?n:{}},e.notificationLevel&&(o._internalState.notificationLevel=e.notificationLevel);var o,t={participants:o._links.participants};return o._participants=new Map,o._participantsEntity=new AI(Vi(o),o._participants,t,o._configuration,o._services),o._participantsEntity.on("participantJoined",function(e){return o.emit("participantJoined",e)}),o._participantsEntity.on("participantLeft",function(e){return o.emit("participantLeft",e)}),o._participantsEntity.on("participantUpdated",function(e){return o.emit("participantUpdated",e)}),o._messagesEntity=new lR(Vi(o),r,i),o._messagesEntity.on("messageAdded",function(e){return o._onMessageAdded(e)}),o._messagesEntity.on("messageUpdated",function(e){return o.emit("messageUpdated",e)}),o._messagesEntity.on("messageRemoved",function(e){return o.emit("messageRemoved",e)}),o}return M(O,[{key:"uniqueName",get:function(){return this._internalState.uniqueName}},{key:"status",get:function(){return this._internalState.status}},{key:"friendlyName",get:function(){return this._internalState.friendlyName}},{key:"dateUpdated",get:function(){return this._internalState.dateUpdated}},{key:"dateCreated",get:function(){return this._internalState.dateCreated}},{key:"createdBy",get:function(){var e;return null!=(e=this._internalState.createdBy)?e:""}},{key:"attributes",get:function(){return this._internalState.attributes}},{key:"lastReadMessageIndex",get:function(){return this._internalState.lastReadMessageIndex}},{key:"lastMessage",get:function(){var e;return null!=(e=this._internalState.lastMessage)?e:void 0}},{key:"notificationLevel",get:function(){var e;return null!=(e=this._internalState.notificationLevel)?e:"default"}},{key:"bindings",get:function(){return this._internalState.bindings}},{key:"limits",get:function(){return this._configuration.limits}},{key:"state",get:function(){return this._internalState.state}},{key:"_statusSource",get:function(){return this._dataSource}},{key:"add",value:(T=A(j.mark(function e(t,n){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._participantsEntity.add(t,null!=n?n:{}));case 1:case"end":return e.stop()}},e,this)})),function(e,t){return T.apply(this,arguments)})},{key:"addNonChatParticipant",value:(C=A(j.mark(function e(t,n){var r,i,o=arguments;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=2<o.length&&void 0!==o[2]?o[2]:{},i=3<o.length&&void 0!==o[3]?o[3]:{},e.abrupt("return",this._participantsEntity.addNonChatParticipant(t,n,null!=r?r:{},null!=i?i:{}));case 3:case"end":return e.stop()}},e,this)})),function(e,t){return C.apply(this,arguments)})},{key:"advanceLastReadMessageIndex",value:(E=A(j.mark(function e(t){var n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:if(t<(null!=(n=this.lastReadMessageIndex)?n:0))return e.next=5,this._setLastReadMessageIndex(this.lastReadMessageIndex);e.next=6;break;case 5:case 8:return e.abrupt("return",e.sent);case 6:return e.next=8,this._setLastReadMessageIndex(t);case 9:case"end":return e.stop()}},e,this)})),function(e){return E.apply(this,arguments)})},{key:"delete",value:(S=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("delete",this._links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)})),function(){return S.apply(this,arguments)})},{key:"getAttributes",value:(x=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return e.abrupt("return",this.attributes);case 3:case"end":return e.stop()}},e,this)})),function(){return x.apply(this,arguments)})},{key:"getMessages",value:(k=A(j.mark(function e(t,n,r){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._messagesEntity.getMessages(t,n,r));case 3:case"end":return e.stop()}},e,this)})),function(e,t,n){return k.apply(this,arguments)})},{key:"getParticipants",value:(w=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._participantsEntity.getParticipants());case 3:case"end":return e.stop()}},e,this)})),function(){return w.apply(this,arguments)})},{key:"getParticipantsCount",value:(_=A(j.mark(function e(){var t,n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Ul(this._configuration.links.conversations).path(this.sid).build(),e.next=3,this._services.network.get(n);case 3:return n=e.sent,e.abrupt("return",null!=(t=n.body.participants_count)?t:0);case 5:case"end":return e.stop()}},e,this)})),function(){return _.apply(this,arguments)})},{key:"getParticipantBySid",value:(b=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._participantsEntity.getParticipantBySid(t));case 1:case"end":return e.stop()}},e,this)})),function(e){return b.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(g=A(j.mark(function e(){var t,n=arguments;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=0<n.length&&void 0!==n[0]?n[0]:"",e.abrupt("return",this._participantsEntity.getParticipantByIdentity(null!=t?t:""));case 2:case"end":return e.stop()}},e,this)})),function(){return g.apply(this,arguments)})},{key:"getMessagesCount",value:(v=A(j.mark(function e(){var t,n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Ul(this._configuration.links.conversations).path(this.sid).build(),e.next=3,this._services.network.get(n);case 3:return n=e.sent,e.abrupt("return",null!=(t=n.body.messages_count)?t:0);case 5:case"end":return e.stop()}},e,this)})),function(){return v.apply(this,arguments)})},{key:"getUnreadMessagesCount",value:(y=A(j.mark(function e(){var t,n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Ul(this._configuration.links.myConversations).path(this.sid).build(),e.next=3,this._services.network.get(n);case 3:if((t=e.sent).body.conversation_sid!==this.sid)throw new Error("Conversation was not found in the user conversations list");e.next=6;break;case 6:if("number"==typeof(n=t.body.unread_messages_count))return e.abrupt("return",n);e.next=9;break;case 9:return e.abrupt("return",null);case 10:case"end":return e.stop()}},e,this)})),function(){return y.apply(this,arguments)})},{key:"join",value:(m=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post",this._links.participants,{identity:this._configuration.userIdentity});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)})),function(){return m.apply(this,arguments)})},{key:"leave",value:(h=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("joined"===this._internalState.status)return e.next=3,this._services.commandExecutor.mutateResource("delete","".concat(this._links.participants,"/").concat(this._configuration.userIdentity));e.next=3;break;case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}},e,this)})),function(){return h.apply(this,arguments)})},{key:"removeParticipant",value:(p=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._participantsEntity.remove("string"==typeof t?t:t.sid);case 2:case"end":return e.stop()}},e,this)})),function(e){return p.apply(this,arguments)})},{key:"sendMessage",value:(f=A(j.mark(function e(t,n,r){var i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof t||null===t)return e.next=3,this._messagesEntity.send(t,n,r);e.next=5;break;case 3:return o=e.sent,e.abrupt("return",null!=(o=jl(o.index))?o:0);case 5:return e.next=7,this._messagesEntity.sendMedia(t,n,r);case 7:return o=e.sent,e.abrupt("return",null!=(i=jl(o.index))?i:0);case 9:case"end":return e.stop()}},e,this)})),function(e,t,n){return f.apply(this,arguments)})},{key:"prepareMessage",value:function(){return new fR(this.limits,this._messagesEntity)}},{key:"setAllMessagesRead",value:(d=A(j.mark(function e(){var t;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this.getMessages(1);case 4:if(0<(t=e.sent).items.length)return e.abrupt("return",this.advanceLastReadMessageIndex(t.items[0].index));e.next=7;break;case 7:return e.abrupt("return",0);case 8:case"end":return e.stop()}},e,this)})),function(){return d.apply(this,arguments)})},{key:"setAllMessagesUnread",value:(l=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this._setLastReadMessageIndex(null);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}},e,this)})),function(){return l.apply(this,arguments)})},{key:"setUserNotificationLevel",value:(u=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post","".concat(this._configuration.links.myConversations,"/").concat(this.sid),{notification_level:t});case 2:case"end":return e.stop()}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"typing",value:function(){return this._services.typingIndicator.send(this.sid)}},{key:"updateAttributes",value:(c=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post",this._links.self,{attributes:void 0!==t?JSON.stringify(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)})),function(e){return c.apply(this,arguments)})},{key:"updateFriendlyName",value:(s=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._internalState.friendlyName!==t)return e.next=3,this._services.commandExecutor.mutateResource("post",this._links.self,{friendly_name:t});e.next=3;break;case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}},e,this)})),function(e){return s.apply(this,arguments)})},{key:"updateLastReadMessageIndex",value:(a=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._setLastReadMessageIndex(t));case 3:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"updateUniqueName",value:(o=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._internalState.uniqueName!==t)return t=t||"",e.next=4,this._services.commandExecutor.mutateResource("post",this._links.self,{unique_name:t});e.next=4;break;case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"_subscribe",value:(i=A(j.mark(function e(){var t=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._entityPromise)return e.abrupt("return",this._entityPromise);e.next=2;break;case 2:return this._entityPromise=this._services.syncClient.document({id:this._entityName,mode:"open_existing"}),e.prev=3,e.next=6,this._entityPromise;case 6:return this._entity=e.sent,this._entity.on("updated",function(e){return t._update(e.data)}),this._entity.on("removed",function(){return t.emit("removed",t)}),this._update(this._entity.data),e.abrupt("return",this._entity);case 13:throw e.prev=13,e.t0=e.catch(3),this._entity=null,this._entityPromise=null,"disconnected"!=this._services.syncClient.connectionState&&O._logger.error("Failed to get conversation object",e.t0),O._logger.debug("ERROR: Failed to get conversation object",e.t0),e.t0;case 20:case"end":return e.stop()}},e,this,[[3,13]])})),function(){return i.apply(this,arguments)})},{key:"_fetchStreams",value:(r=A(j.mark(function e(){var t;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return O._logger.trace("_streamsAvailable, this.entity.data=",null==(t=this._entity)?void 0:t.data),t=null==(t=this._entity)?void 0:t.data,e.next=6,this._services.syncClient.list({id:t.messages,mode:"open_existing"});case 6:return this._messagesList=e.sent,e.next=9,this._services.syncClient.map({id:t.roster,mode:"open_existing"});case 9:this._participantsMap=e.sent;case 10:case"end":return e.stop()}},e,this)})),function(){return r.apply(this,arguments)})},{key:"_subscribeStreams",value:(n=A(j.mark(function e(){var t,n,r;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._subscribe();case 3:return O._logger.trace("_subscribeStreams, this.entity.data=",null==(r=this._entity)?void 0:r.data),r=null==(r=this._entity)?void 0:r.data,n=r.messages,r=r.roster,e.next=9,Promise.all([this._messagesEntity.subscribe(null!=(t=this._messagesList)?t:n),this._participantsEntity.subscribe(null!=(t=this._participantsMap)?t:r)]);case 9:e.next=16;break;case 11:throw e.prev=11,e.t0=e.catch(0),"disconnected"!==this._services.syncClient.connectionState&&O._logger.error("Failed to subscribe on conversation objects",this.sid,e.t0),O._logger.debug("ERROR: Failed to subscribe on conversation objects",this.sid,e.t0),e.t0;case 16:case"end":return e.stop()}},e,this,[[0,11]])})),function(){return n.apply(this,arguments)})},{key:"_unsubscribe",value:(e=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._entity)return e.next=3,this._entity.close();e.next=5;break;case 3:this._entity=null,this._entityPromise=null;case 5:return e.abrupt("return",Promise.all([this._participantsEntity.unsubscribe(),this._messagesEntity.unsubscribe()]));case 6:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"_setStatus",value:function(t,e){var n=this;this._dataSource=e,this._internalState.status!==t&&("joined"!==(this._internalState.status=t)?this._entityPromise&&this._unsubscribe().catch(function(e){if(O._logger.debug("ERROR while setting conversation status "+t,e),"disconnected"!==n._services.syncClient.connectionState)throw e}):this._subscribeStreams().catch(function(e){if(O._logger.debug("ERROR while setting conversation status "+t,e),"disconnected"!==n._services.syncClient.connectionState)throw e}))}},{key:"_update",value:function(e){O._logger.trace("_update",e),O.preprocessUpdate(e,this.sid);for(var t=new Set,n=0,r=Object.keys(e);n<r.length;n++){var i=r[n],o=yR[i];if(o)switch(o){case yR.status:e.status&&"unknown"!==e.status&&this._internalState.status!==e.status&&(this._internalState.status=e.status,t.add(o));break;case yR.attributes:hh(this._internalState.attributes,e.attributes)||(this._internalState.attributes=e.attributes,t.add(o));break;case yR.lastConsumedMessageIndex:void 0!==e.lastConsumedMessageIndex&&e.lastConsumedMessageIndex!==this._internalState.lastReadMessageIndex&&(this._internalState.lastReadMessageIndex=e.lastConsumedMessageIndex,t.add("lastReadMessageIndex"));break;case yR.lastMessage:this._internalState.lastMessage&&!e.lastMessage?(delete this._internalState.lastMessage,t.add(o)):(this._internalState.lastMessage=this._internalState.lastMessage||{},void 0!==(null==(a=e.lastMessage)?void 0:a.index)&&e.lastMessage.index!==this._internalState.lastMessage.index&&(this._internalState.lastMessage.index=e.lastMessage.index,t.add(o)),void 0!==(null==(a=e.lastMessage)?void 0:a.timestamp)&&(null==(a=this._internalState.lastMessage)||null==(a=a.dateCreated)?void 0:a.getTime())!==e.lastMessage.timestamp.getTime()&&(this._internalState.lastMessage.dateCreated=e.lastMessage.timestamp,t.add(o)),hh(this._internalState.lastMessage,{})&&delete this._internalState.lastMessage);break;case yR.state:var a=e.state||void 0;void 0!==a&&(a.dateUpdated=new Date(a.dateUpdated)),hh(this._internalState.state,a)||(this._internalState.state=a,t.add(o));break;case yR.bindings:hh(this._internalState.bindings,e.bindings)||(this._internalState.bindings=e.bindings,t.add(o));break;default:var s=e[i]instanceof Date,c=s&&(null==(c=this._internalState[o])?void 0:c.getTime())===e[i].getTime(),s=!s&&this[o]===e[i];c||s||(this._internalState[o]=e[i],t.add(o))}}0<t.size&&this.emit("updated",{conversation:this,updateReasons:OT(t)})}},{key:"_onMessageAdded",value:function(e){var t,n=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?mR(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?mR(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this._participants.values());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.identity===e.author){r._endTyping();break}}}catch(e){n.e(e)}finally{n.f()}this.emit("messageAdded",e)}},{key:"_setLastReadMessageIndex",value:(t=A(j.mark(function e(t){var n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post","".concat(this._configuration.links.myConversations,"/").concat(this.sid),{last_read_message_index:t});case 2:return n=e.sent,e.abrupt("return",n.unread_messages_count);case 4:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}],[{key:"preprocessUpdate",value:function(t,n){try{"string"==typeof t.attributes?t.attributes=JSON.parse(t.attributes):t.attributes&&JSON.stringify(t.attributes)}catch(e){O._logger.warn("Retrieved malformed attributes from the server for conversation: "+n),t.attributes={}}try{t.dateCreated&&(t.dateCreated=new Date(t.dateCreated))}catch(e){O._logger.warn("Retrieved malformed dateCreated from the server for conversation: "+n),delete t.dateCreated}try{t.dateUpdated&&(t.dateUpdated=new Date(t.dateUpdated))}catch(e){O._logger.warn("Retrieved malformed dateUpdated from the server for conversation: "+n),delete t.dateUpdated}try{t.lastMessage&&t.lastMessage.timestamp&&(t.lastMessage.timestamp=new Date(t.lastMessage.timestamp))}catch(e){O._logger.warn("Retrieved malformed lastMessage.timestamp from the server for conversation: "+n),delete t.lastMessage.timestamp}}}]),O}(),gR=(b(vR,"participantJoined","participantJoined"),b(vR,"participantLeft","participantLeft"),b(vR,"participantUpdated","participantUpdated"),b(vR,"messageAdded","messageAdded"),b(vR,"messageRemoved","messageRemoved"),b(vR,"messageUpdated","messageUpdated"),b(vR,"typingEnded","typingEnded"),b(vR,"typingStarted","typingStarted"),b(vR,"updated","updated"),b(vR,"removed","removed"),b(vR,"_logger",oi.scope("Conversation")),y([g(Wd,bf),v("design:type",Function),v("design:paramtypes",[String,Object]),v("design:returntype",Promise)],vR.prototype,"add",null),y([g(Wd,Wd,bf),v("design:type",Function),v("design:paramtypes",[String,String,Object,Object]),v("design:returntype",Promise)],vR.prototype,"addNonChatParticipant",null),y([g(s),v("design:type",Function),v("design:paramtypes",[Number]),v("design:returntype",Promise)],vR.prototype,"advanceLastReadMessageIndex",null),y([g(["undefined",s],["undefined",s],["undefined",qd("backwards","forward")]),v("design:type",Function),v("design:paramtypes",[Number,Number,String]),v("design:returntype",Promise)],vR.prototype,"getMessages",null),y([g(Wd),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],vR.prototype,"getParticipantBySid",null),y([g(Wd),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],vR.prototype,"getParticipantByIdentity",null),y([g([Wd,PI]),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",Promise)],vR.prototype,"removeParticipant",null),y([g(["string",FormData,qd(null),Ud("media options",{contentType:Wd,media:Bd(function(e){var t="string"==typeof e&&0<e.length||e instanceof Uint8Array||e instanceof ArrayBuffer;return[t="function"==typeof Blob?t||e instanceof Blob:t,"a non-empty string, an instance of Buffer or an instance of Blob"]})})],bf,["undefined",qd(null),Ud("email attributes",{subject:[Wd,"undefined"]})]),v("design:type",Function),v("design:paramtypes",[Object,Object,Object]),v("design:returntype",Promise)],vR.prototype,"sendMessage",null),y([g(qd("default","muted")),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],vR.prototype,"setUserNotificationLevel",null),y([g(gf),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",Promise)],vR.prototype,"updateAttributes",null),y([g("string"),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],vR.prototype,"updateFriendlyName",null),y([g([qd(null),s]),v("design:type",Function),v("design:paramtypes",[Number]),v("design:returntype",Promise)],vR.prototype,"updateLastReadMessageIndex",null),y([g(["string",qd(null)]),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],vR.prototype,"updateUniqueName",null),M(bR,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this.current=e,this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}}]),bR);function bR(){var n=this;D(this,bR),this._promise=new Promise(function(e,t){n._resolve=e,n._reject=t})}function _R(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function wR(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}var kR=oi.scope("Conversations"),xR=function(){Ji(h,Wp);d=h,f=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var e,r,i,n,t,o,a,s,c,u,l,d,f,p=function(){var e,t=Ki(d);return $i(this,f?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function h(e,t){var n;return D(this,h),b(Vi(n=p.call(this)),"conversations",new Map),b(Vi(n),"myConversationsRead",new gR),b(Vi(n),"tombstones",new Set),b(Vi(n),"myConversationsFetched",!1),n.configuration=e,n.services=t,n}return M(h,[{key:"addConversation",value:(l=A(j.mark(function e(t){var n,r,i,o,a,s;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0!==(null==t?void 0:t.attributes)?t.attributes:{},e.next=3,this.services.commandExecutor.mutateResource("post",this.configuration.links.conversations,{friendly_name:t.friendlyName,unique_name:t.uniqueName,attributes:void 0!==n?JSON.stringify(n):void 0});case 3:if(n=e.sent,r=null!=(r=n.sid)?r:null,i=null!=(i=null==(i=n.sync_objects)?void 0:i.conversation)?i:null,o=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?wR(Object(n),!0).forEach(function(e){b(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):wR(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}({self:n.url},n.links),a=this.conversations.get(r))return e.next=11,a._subscribe();e.next=12;break;case 11:return e.abrupt("return",a);case 12:return s=new vR({channel:i,entityName:"",uniqueName:"",attributes:null,createdBy:"",friendlyName:"",lastConsumedMessageIndex:0,dateCreated:null,dateUpdated:null},r,o,this.configuration,this.services),this.conversations.set(s.sid,s),this._registerForEvents(s),e.next=17,s._subscribe();case 17:return this.emit("conversationAdded",s),e.abrupt("return",s);case 19:case"end":return e.stop()}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"fetchConversations",value:(u=A(j.mark(function e(){var t,n,r,i,o,a,s=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getMap();case 3:return(t=e.sent).on("itemAdded",function(e){kR.debug("itemAdded: ".concat(e.item.key)),s._upsertConversation("sync",e.item.key,e.item.data)}),t.on("itemRemoved",function(e){kR.debug("itemRemoved: ".concat(e.key));var e=e.key,t=(s.myConversationsFetched||s.tombstones.add(e),s.conversations.get(e));t&&("joined"===t.status&&(t._setStatus("notParticipating","sync"),s.emit("conversationLeft",t)),s.conversations.delete(e),s.emit("conversationRemoved",t),t.emit("removed",t))}),t.on("itemUpdated",function(e){kR.debug("itemUpdated: ".concat(e.item.key)),s._upsertConversation("sync",e.item.key,e.item.data)}),e.next=9,this._fetchMyConversations();case 9:t=e.sent,n=[],r=function(e,t){var n,r,i,o,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return i=!(r=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return r=e.done,e},e:function(e){i=!0,n=e},f:function(){try{r||null==a.return||a.return()}finally{if(i)throw n}}};if(Array.isArray(e)||(a=function(e){var t;if(e)return"string"==typeof e?_R(e,void 0):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_R(e,void 0):void 0}(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t);try{for(r.s();!(i=r.n()).done;)o=i.value,n.push(this._upsertConversation("rest",o.channel_sid,o))}catch(e){r.e(e)}finally{r.f()}return this.myConversationsRead.set(!0),e.next=16,Promise.all(n);case 16:return this.myConversationsFetched=!0,this.tombstones.clear(),kR.debug("The conversations list has been successfully fetched"),e.abrupt("return",this);case 22:throw e.prev=22,e.t0=e.catch(0),a="Failed to fetch the conversations list","disconnected"!==this.services.syncClient.connectionState&&kR.error(a,e.t0),kR.debug("ERROR: ".concat(a),e.t0),e.t0;case 28:case"end":return e.stop()}},e,this,[[0,22]])})),function(){return u.apply(this,arguments)})},{key:"getConversations",value:(c=A(j.mark(function e(){var t,n=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getMap();case 2:return t=e.sent,e.next=5,t.getItems();case 5:return t=e.sent,e.abrupt("return",this._wrapPaginator(t,function(e){return Promise.all(e.map(function(e){return n._upsertConversation("sync",e.key,e.data)}))}));case 7:case"end":return e.stop()}},e,this)})),function(){return c.apply(this,arguments)})},{key:"getConversation",value:(s=A(j.mark(function e(t){var n,r,i=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getMap();case 2:return n=e.sent,e.next=5,n.getItems({key:t});case 5:return n=e.sent,r=n.items.map(function(e){return i._upsertConversation("sync",e.key,e.data)}),e.abrupt("return",0<r.length?r[0]:null);case 8:case"end":return e.stop()}},e,this)})),function(e){return s.apply(this,arguments)})},{key:"getConversationByUniqueName",value:(a=A(j.mark(function e(t){var n,r,i;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Ul(this.configuration.links.myConversations).path(t).build(),e.next=3,this.services.network.get(n);case 3:return n=e.sent,i=n.body,r=i.conversation_sid,i={entityName:null,lastConsumedMessageIndex:i.last_read_message_index,status:(null==i?void 0:i.status)||"unknown",friendlyName:i.friendly_name,dateUpdated:i.date_updated,dateCreated:i.date_created,uniqueName:i.unique_name,createdBy:i.created_by,attributes:i.attributes,channel:i.sync_objects.conversation,notificationLevel:null==i?void 0:i.notification_level,sid:r},e.abrupt("return",r?this._upsertConversation("sync",r,i):null);case 8:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"peekConversation",value:(o=A(j.mark(function e(t){var n,r;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Ul(this.configuration.links.conversations).path(t).build(),e.next=3,this.services.network.get(n);case 3:return n=e.sent,r=n.body,r={entityName:null,status:(null==r?void 0:r.status)||"unknown",friendlyName:r.friendly_name,dateUpdated:r.date_updated,dateCreated:r.date_created,uniqueName:r.unique_name,createdBy:r.created_by,attributes:r.attributes,channel:"".concat(t,".channel"),sid:t},e.abrupt("return",this._upsertConversation("sync",t,r));case 7:case"end":return e.stop()}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"_getMap",value:(t=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.syncClient.map({id:this.configuration.myConversations,mode:"open_existing"});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"_wrapPaginator",value:(n=A(j.mark(function e(t,n){var r,i=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n(t.items);case 2:return r=e.sent,e.abrupt("return",{items:r.filter(function(e){return null!==e}),hasNextPage:t.hasNextPage,hasPrevPage:t.hasPrevPage,nextPage:function(){return t.nextPage().then(function(e){return i._wrapPaginator(e,n)})},prevPage:function(){return t.prevPage().then(function(e){return i._wrapPaginator(e,n)})}});case 4:case"end":return e.stop()}},e)})),function(e,t){return n.apply(this,arguments)})},{key:"_updateConversation",value:(i=A(j.mark(function e(t,n,r){var i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=void 0!==n._statusSource&&t!==n._statusSource,i="rest"!==t||"sync"===n._statusSource,o&&i&&"sync"!==t)return kR.trace("upsertConversation: conversation is known from sync and came from REST, ignoring",{sid:n.sid,data:r.status,conversation:n.status}),e.abrupt("return");e.next=5;break;case 5:if("joined"===r.status&&"joined"!==n.status)return n._setStatus("joined",t),o={},void 0!==r.notificationLevel&&(o.notificationLevel=r.notificationLevel),void 0!==r.lastConsumedMessageIndex&&(o.lastConsumedMessageIndex=r.lastConsumedMessageIndex),hh(o,{})||n._update(o),e.next=13,n._subscribe();e.next=15;break;case 13:return this.emit("conversationJoined",n),e.abrupt("return");case 15:if("notParticipating"===r.status&&"joined"===n.status)return n._setStatus("notParticipating",t),n._update(r),e.next=20,n._subscribe();e.next=22;break;case 20:return this.emit("conversationLeft",n),e.abrupt("return");case 22:if("notParticipating"===r.status)return e.next=25,n._subscribe();e.next=26;break;case 25:return e.abrupt("return");case 26:n._update(r);case 27:case"end":return e.stop()}},e,this)})),function(e,t,n){return i.apply(this,arguments)})},{key:"_upsertConversation",value:(r=A(j.mark(function e(t,n,r){var i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(kR.trace("upsertConversation called for ".concat(n),r),i=this.conversations.get(n))return kR.trace("upsertConversation: the conversation ".concat(i.sid," is known;")+"its status is known from the source ".concat(i._statusSource," ")+"and the update came from the source ".concat(t),i),e.next=6,this._updateConversation(t,i,r);e.next=9;break;case 6:return e.next=8,i._subscribe();case 8:return e.abrupt("return",i);case 9:if("rest"===t&&this.tombstones.has(n))return kR.trace("upsertChannel: the conversation is deleted but reappeared again from REST, ignoring",n),e.abrupt("return",null);e.next=12;break;case 12:return kR.trace("upsertConversation: creating a local conversation object with sid "+n,r),o="".concat(this.configuration.links.conversations,"/").concat(n),o={self:o,messages:"".concat(o,"/Messages"),participants:"".concat(o,"/Participants")},o=new vR(r,n,o,this.configuration,this.services),this.conversations.set(n,o),e.prev=17,e.next=20,o._subscribe();case 20:if("joined"===r.status)return e.next=23,o._fetchStreams();e.next=23;break;case 23:e.next=32;break;case 25:if(e.prev=25,e.t0=e.catch(17),"SyncError"!==e.t0.name)throw e.t0;e.next=29;break;case 29:return kR.trace("upsertChannel: the conversation is missing some Sync entity(ies), ignoring",n,e.t0),this.conversations.delete(n),e.abrupt("return",null);case 32:return this._registerForEvents(o),this.emit("conversationAdded",o),"joined"===r.status&&(o._setStatus("joined",t),this.emit("conversationJoined",o)),e.abrupt("return",o);case 36:case"end":return e.stop()}},e,this,[[17,25]])})),function(e,t,n){return r.apply(this,arguments)})},{key:"_fetchMyConversations",value:(e=A(j.mark(function e(){var t,n,r,i;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=null;case 2:return r=new Ul(this.configuration.links.myConversations),n&&r.arg("PageToken",n),e.next=6,this.services.network.get(r.build());case 6:r=e.sent,i=null==(i=r.body)?void 0:i.conversations.map(function(e){return{descriptor:e,channel_sid:e.conversation_sid,status:e.status,channel:e.sync_objects.conversation,messages:e.sync_objects.messages,roster:"".concat(e.conversation_sid,".roster"),lastConsumedMessageIndex:e.last_read_message_index,notificationLevel:e.notification_level}}),n=r.body.meta.next_token,t=[].concat(OT(t),OT(i));case 10:if(n){e.next=2;break}case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"_onConversationRemoved",value:function(e){var t=this.conversations.get(e);t&&(this.conversations.delete(e),this.emit("conversationRemoved",t))}},{key:"_registerForEvents",value:function(e){var t=this;e.on("removed",function(){return t._onConversationRemoved(e.sid)}),e.on("updated",function(e){return t.emit("conversationUpdated",e)}),e.on("participantJoined",function(e){return t.emit("participantJoined",e)}),e.on("participantLeft",function(e){return t.emit("participantLeft",e)}),e.on("participantUpdated",function(e){return t.emit("participantUpdated",e)}),e.on("messageAdded",function(e){return t.emit("messageAdded",e)}),e.on("messageUpdated",function(e){return t.emit("messageUpdated",e)}),e.on("messageRemoved",function(e){return t.emit("messageRemoved",e)}),e.on("typingStarted",function(e){return t.emit("typingStarted",e)}),e.on("typingEnded",function(e){return t.emit("typingEnded",e)})}}]),h}(),fv=i,SR=zr.find,_=Jc,ER=!0;"find"in[]&&Array(1).find(function(){ER=!1}),fv({target:"Array",proto:!0,forced:ER},{find:function(e){return SR(this,e,1<arguments.length?arguments[1]:void 0)}}),_("find");var CR,TR=function(){Ji(a,Wp);r=a,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var t,e,n,r,i,o=function(){var e,t=Ki(r);return $i(this,i?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function a(e,t,n){var r;return D(this,a),(r=o.call(this)).configuration=t,r.services=n,r.fifoStack=[],r.myself=e,r.myself.on("updated",function(e){return r.emit("userUpdated",e)}),r.myself.on("userSubscribed",function(){return r.emit("userSubscribed",r.myself)}),r.myself.on("userUnsubscribed",function(){r.emit("userUnsubscribed",r.myself),r.myself._ensureFetched()}),r.subscribedUsers=new Map,r}return M(a,[{key:"handleUnsubscribeUser",value:function(n){this.subscribedUsers.has(n.identity)&&this.subscribedUsers.delete(n.identity);var r=0;this.fifoStack.find(function(e,t){return e==n.identity&&(r=t,!0)})&&this.fifoStack.splice(r,1),this.emit("userUnsubscribed",n)}},{key:"handleSubscribeUser",value:function(e){var t,n;this.subscribedUsers.has(e.identity)||(this.fifoStack.length>=this.configuration.userInfosToSubscribe&&(n=this.fifoStack.shift(),null!=(t=this.subscribedUsers))&&null!=(t=t.get(n))&&t.unsubscribe(),this.fifoStack.push(e.identity),this.subscribedUsers.set(e.identity,e),this.emit("userSubscribed",e))}},{key:"getUser",value:(n=A(j.mark(function e(t,n){var r,i,o=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:if(t==this.myself.identity)return e.abrupt("return",this.myself);e.next=4;break;case 4:if(r=this.subscribedUsers.get(t))return e.abrupt("return",r);e.next=7;break;case 7:null==n?e.next=11:e.next=14;break;case 11:return e.next=13,this.getSyncUniqueName(t);case 13:n=e.sent;case 14:return(i=new yh(t,n,this.configuration,this.services)).on("updated",function(e){return o.emit("userUpdated",e)}),i.on("userSubscribed",function(){return o.handleSubscribeUser(i)}),i.on("userUnsubscribed",function(){return o.handleUnsubscribeUser(i)}),e.next=20,i._ensureFetched();case 20:return e.abrupt("return",i);case 21:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"getSubscribedUsers",value:(e=A(j.mark(function e(){var t;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:return t=[this.myself],this.subscribedUsers.forEach(function(e){return t.push(e)}),e.abrupt("return",t);case 5:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"getSyncUniqueName",value:(t=A(j.mark(function e(t){var n,r;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Ul(this.configuration.links.users).path(t).build(),e.next=3,this.services.network.get(r);case 3:return r=e.sent,e.abrupt("return",null!=(n=null==(n=r.body)?void 0:n.sync_objects.user_info_map)?n:"");case 5:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})}]),a}(),IR=oi.scope("TypingIndicator"),RR=(M(AR,[{key:"typingTimeout",get:function(){return this.configuration.typingIndicatorTimeoutOverride||this.serviceTypingTimeout||this.configuration.typingIndicatorTimeoutDefault}},{key:"initialize",value:function(){var n,r=this;this.services.notificationClient.on("message",(n=A(j.mark(function e(t,n){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t===Om.TYPING_INDICATOR)return e.next=3,r._handleRemoteTyping(n);e.next=3;break;case 3:case"end":return e.stop()}},e)})),function(e,t){return n.apply(this,arguments)}))}},{key:"_handleRemoteTyping",value:(CR=A(j.mark(function e(n){var r=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:IR.trace("Got new typing indicator ",n),this.getConversation(n.channel_sid).then(function(e){e&&e._participants.forEach(function(e){var t;e.identity===n.identity&&(t=r.configuration.typingIndicatorTimeoutOverride?r.configuration.typingIndicatorTimeoutOverride+1e3:1e3*n.typing_timeout,e._startTyping(t))})}).catch(function(e){throw IR.error(e),e});case 2:case"end":return e.stop()}},e,this)})),function(e){return CR.apply(this,arguments)})},{key:"send",value:function(e){var t=this.sentUpdates.get(e);return t&&t>Date.now()-this.typingTimeout?Promise.resolve():(this.sentUpdates.set(e,Date.now()),this._send(e))}},{key:"_send",value:function(e){var t=this,n=(IR.trace("Sending typing indicator"),this.configuration.links.typing),e="ChannelSid=".concat(e);return this.services.twilsockClient.post(n,{"Content-Type":"application/x-www-form-urlencoded"},e,this.configuration.productId).then(function(e){e.body.hasOwnProperty("typing_timeout")&&(t.serviceTypingTimeout=1e3*e.body.typing_timeout)}).catch(function(e){throw IR.error("Failed to send typing indicator:",e),e})}}]),AR),PR=M(function e(t){D(this,e),this.title=t.title||null,this.body=t.body||null,this.sound=t.sound||null,this.badge=t.badge||null,this.action=t.action||null,this.type=t.type||null,this.data=t.data||{}}),OR="2.2.1";function AR(e,t,n){D(this,AR),this.configuration=t,this.services=n,this.getConversation=e,this.serviceTypingTimeout=null,this.sentUpdates=new Map}function MR(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function DR(e){return e.replace(/(^\/+|\/+$)/g,"")}M(BR,[{key:"_preProcessUrl",value:function(e){var t=DR(e);return/^https?:\/\//.test(e)?t:"".concat(DR(this._serviceUrl),"/").concat(t)}},{key:"_makeRequest",value:(UR=A(j.mark(function e(t,n,r,i){var o,a,s,c;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=this._preProcessUrl(n),a=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?MR(Object(n),!0).forEach(function(e){b(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MR(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}({"Content-Type":"application/json; charset=utf-8"},i||{}),e.t0=t,e.next="get"===e.t0?5:"post"===e.t0?11:"delete"===e.t0?15:19;break;case 5:return c=o,r&&(c+="?"+Object.entries(r).map(function(e){return e.map(encodeURIComponent).join("=")}).join("&")),e.next=9,this._services.transport.get(c,a,this._productId);case 9:case 13:case 17:return s=e.sent,e.abrupt("break",19);case 11:return e.next=13,this._services.transport.post(o,a,JSON.stringify(r),this._productId);case 15:return e.next=17,this._services.transport.delete(o,a,{},this._productId);case 19:if(s.status.code<200||300<=s.status.code)throw new Error("Request responded with a non-success code ".concat(s.status.code));e.next=21;break;case 21:return e.abrupt("return",s);case 22:case"end":return e.stop()}},e,this)})),function(e,t,n,r){return UR.apply(this,arguments)})},{key:"fetchResource",value:(NR=A(j.mark(function e(t,n){var r,i=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=1,e.next=4,new Cm({min:50,max:1600,maxAttemptsCount:6}).run(function(){return i._makeRequest("get",t,n)});case 4:return r=e.sent,e.abrupt("return",r.body);case 8:throw e.prev=8,e.t0=e.catch(1),new Error('Fetch resource from "'.concat(t,'" failed.'));case 11:case"end":return e.stop()}},e,null,[[1,8]])})),function(e,t){return NR.apply(this,arguments)})},{key:"mutateResource",value:(LR=A(j.mark(function e(t,n,r){var i;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._makeRequest(t,n,r,{"X-Twilio-Mutation-Id":sy.v4()});case 2:if(202===(i=e.sent).status.code)return e.next=6,this.fetchResource(i.body.resource_url);e.next=7;break;case 6:return e.abrupt("return",e.sent);case 7:return e.abrupt("return",i.body);case 8:case"end":return e.stop()}},e,this)})),function(e,t,n){return LR.apply(this,arguments)})}]);var jR,LR,NR,UR,FR=BR;function BR(e,t,n){D(this,BR),this._serviceUrl=e,this._services=t,this._productId=n}function qR(t,e){var n,r=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)),r}function zR(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?qR(Object(n),!0).forEach(function(e){b(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):qR(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}var WR=M(function e(){D(this,e)});return e.Client=(r=function(){Ji(g,Wp);m=g,y=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();var n,e,t,r,i,o,a,s,c,u,l,d,f,p,h,m,y,v=function(){var e,t=Ki(m);return $i(this,y?(e=Ki(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))};function g(e){var r,t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=(D(this,g),b(Vi(r=v.call(this)),"version",OR),b(Vi(r),"connectionState","unknown"),b(Vi(r),"parsePushNotification",jR.parsePushNotification),r._fpaToken=null!=e?e:"",r._options=null!=n?n:{},r._options.disableDeepClone||(i=zR(zR({},r._options),{},{transport:void 0,twilsockClient:void 0}),t=i,(i=JSON.parse(JSON.stringify(t))).transport=r._options.transport,i.twilsockClient=r._options.twilsockClient,r._options=i),r._options.logLevel=null!=(t=r._options.logLevel)?t:"silent",jR._logger.setLevel(r._options.logLevel),r._options.productId="ip_messaging");if(r._options.clientMetadata=r._options.clientMetadata||{},r._options.clientMetadata.hasOwnProperty("type")||(r._options.clientMetadata.type="conversations"),r._options.clientMetadata.hasOwnProperty("sdk")||(r._options.clientMetadata.sdk="JS",r._options.clientMetadata.sdkv=OR),r._options.Sync=r._options.Sync||{},void 0===r._options.Sync.enableSessionStorage&&(r._options.Sync.enableSessionStorage=!0),r._options.region&&(r._options.Sync.region=r._options.region),!e)throw new Error("A valid Twilio token should be provided");r._services=new WR,r._myself=new yh("","",null,r._services);function o(){c({terminal:!0,message:"Twilsock has disconnected."})}var a=!r._options.twilsockClient,s=(r._options.initRegistrations||(s=new Mm.InitRegistration(i),jR.populateInitRegistrations(s),r._options.initRegistrations=[s]),r._services.twilsockClient=r._options.twilsockClient=null!=(s=r._options.twilsockClient)?s:new Mm.TwilsockClient(e,i,r._options),r._services.twilsockClient.on("tokenAboutToExpire",function(){return r.emit("tokenAboutToExpire")}),r._services.twilsockClient.on("tokenExpired",function(){return r.emit("tokenExpired")}),r._services.twilsockClient.on("connectionError",function(e){return r.emit("connectionError",e)}),r._services.twilsockClient.on("stateChanged",function(e){jR._logger.debug("Handling stateChanged for ConversationsClient: new state ".concat(e)),e!==r.connectionState&&(r.connectionState=e,r.emit("connectionStateChanged",r.connectionState))}),r._services.transport=r._options.transport=null!=(s=r._options.transport)?s:r._options.twilsockClient,r._services.notificationClient=r._options.notificationsClient=null!=(s=r._options.notificationsClient)?s:new mw.Notifications(e,r._options),r._services.syncClient=r._options.syncClient=null!=(s=r._options.syncClient)?s:new ZS(e,r._options),(null==n?void 0:n.Chat)||(null==n?void 0:n.IPMessaging)||n||{}),e=s.region||(null==n?void 0:n.region),n=s.apiUri||s.typingUri||"https://aim.".concat(e||"us1",".twilio.com"),c=(r._services.commandExecutor=new FR(n,{transport:r._options.transport},i),function(e){r._rejectEnsureReady(e),r.emit("stateChanged","failed"),r.emit("initFailed",{error:e})});return r._services.twilsockClient.once("connectionError",c),r._services.twilsockClient.once("disconnected",o),r._services.twilsockClient.once("connected",A(j.mark(function e(){var t,n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return jR._logger.debug("ConversationsClient started INITIALIZING"),r._services.twilsockClient.off("connectionError",c),r._services.twilsockClient.off("disconnected",o),e.prev=3,t="conversations.client.startup",r._services.twilsockClient.addPartialTelemetryEvent(new Mm.TelemetryEventDescription(t,"Conversations client startup",new Date),t,Mm.TelemetryPoint.Start),e.next=8,r._initialize();case 8:r._services.twilsockClient.addPartialTelemetryEvent(new Mm.TelemetryEventDescription("","",new Date),t,Mm.TelemetryPoint.End),e.next=17;break;case 11:e.prev=11,e.t0=e.catch(3),n={terminal:!0,message:e.t0.message},r._rejectEnsureReady(n),r.emit("stateChanged","failed"),r.emit("initFailed",{error:n});case 17:case"end":return e.stop()}},e,null,[[3,11]])}))),r._ensureReady=new Promise(function(e,t){r._resolveEnsureReady=e,r._rejectEnsureReady=t}).catch(function(){}),a&&r._services.twilsockClient.connect(),r}return M(g,[{key:"user",get:function(){return this._myself}},{key:"reachabilityEnabled",get:function(){if(this._configuration)return this._configuration.reachabilityEnabled;throw new Error("Reachability information could not yet be accessed as the client has not yet been initialized. Subscribe to the 'stateChanged' event to properly react to the client initialization.")}},{key:"token",get:function(){return this._fpaToken}},{key:"shutdown",value:(h=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._services.twilsockClient.disconnect();case 4:case"end":return e.stop()}},e,this)})),function(){return h.apply(this,arguments)})},{key:"updateToken",value:(p=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:if(jR._logger.info("updateToken"),this._fpaToken===t)return e.abrupt("return",this);e.next=5;break;case 5:return e.next=7,this._services.twilsockClient.updateToken(t);case 7:return e.next=9,this._services.notificationClient.updateToken(t);case 9:return e.next=11,this._services.mcsClient.updateToken(t);case 11:return this._fpaToken=t,e.abrupt("return",this);case 13:case"end":return e.stop()}},e,this)})),function(e){return p.apply(this,arguments)})},{key:"getConversationBySid",value:(f=A(j.mark(function e(t){var n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.myConversationsRead.promise;case 4:return e.next=6,this._conversationsEntity.getConversation(t);case 6:if(n=e.sent){e.next=12;break}return e.next=10,this.peekConversationBySid(t);case 10:(n=e.sent)&&rR("The method getConversationBySid is deprecated to retrieve conversations you're not part of. Use peekConversationBySid instead.");case 12:if(n){e.next=14;break}throw new Error("Conversation with SID ".concat(t," was not found."));case 14:return e.abrupt("return",n);case 15:case"end":return e.stop()}},e,this)})),function(e){return f.apply(this,arguments)})},{key:"peekConversationBySid",value:(d=A(j.mark(function e(t){var n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.peekConversation(t);case 4:if(n=e.sent){e.next=7;break}throw new Error("Conversation with SID ".concat(t," was not found."));case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}},e,this)})),function(e){return d.apply(this,arguments)})},{key:"getConversationByUniqueName",value:(l=A(j.mark(function e(t){var n;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.myConversationsRead.promise;case 4:return e.next=6,this._conversationsEntity.getConversationByUniqueName(t);case 6:if(n=e.sent){e.next=9;break}throw new Error("Conversation with unique name ".concat(t," was not found."));case 9:return e.abrupt("return",n);case 10:case"end":return e.stop()}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"getSubscribedConversations",value:(u=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._conversationsPromise.then(function(e){return e.getConversations()}));case 3:case"end":return e.stop()}},e,this)})),function(){return u.apply(this,arguments)})},{key:"createConversation",value:(c=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return t=t||{},e.abrupt("return",this._conversationsPromise.then(function(e){return e.addConversation(t)}));case 4:case"end":return e.stop()}},e,this)})),function(e){return c.apply(this,arguments)})},{key:"setPushRegistrationId",value:(s=A(j.mark(function e(t,n){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return this._subscribeToPushNotifications(t),this._services.notificationClient.setPushRegistrationId(t,n),e.next=6,this._services.notificationClient.commitChanges();case 6:case"end":return e.stop()}},e,this)})),function(e,t){return s.apply(this,arguments)})},{key:"unsetPushRegistrationId",value:(a=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return this._unsubscribeFromPushNotifications(t),e.next=5,this._services.notificationClient.commitChanges();case 5:case"end":return e.stop()}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"removePushRegistrations",value:(o=A(j.mark(function e(t,n){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.notificationClient.removeRegistrations(t,n);case 2:case"end":return e.stop()}},e,this)})),function(e,t){return o.apply(this,arguments)})},{key:"handlePushNotification",value:(i=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:jR._logger.debug("handlePushNotification, notificationPayload=",t),this.emit("pushNotification",jR.parsePushNotification(t));case 4:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"getUser",value:(r=A(j.mark(function e(t){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._services.users.getUser(t));case 3:case"end":return e.stop()}},e,this)})),function(e){return r.apply(this,arguments)})},{key:"getSubscribedUsers",value:(t=A(j.mark(function e(){return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._services.users.getSubscribedUsers());case 3:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"getTemporaryContentUrlsForMediaSids",value:function(a){var r,s=this;return new hE.CancellablePromise((r=A(j.mark(function e(t,n,r){var i,o;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s._services.mcsClient&&a){e.next=3;break}return n(new Error("Media Content Service is unavailable")),e.abrupt("return");case 3:return i=s._services.mcsClient.mediaSetGetContentUrls(a),r(function(){i.cancel()}),e.prev=5,e.next=8,i;case 8:o=e.sent,t(o),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(5),n(e.t0);case 15:case"end":return e.stop()}},e,null,[[5,12]])})),function(e,t,n){return r.apply(this,arguments)}))}},{key:"getTemporaryContentUrlsForMedia",value:function(e){e=e.map(function(e){return e.sid});return this.getTemporaryContentUrlsForMediaSids(e)}},{key:"_initialize",value:(e=A(j.mark(function e(){var t,n=this;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.fetchResource("Client/v2/Configuration");case 2:return t=e.sent,this._configuration=new Xc(this._options,t,jR._logger),this._myself._resolveInitialization(this._configuration,this._configuration.userIdentity,this._configuration.userInfo,!0),this._services.typingIndicator=new RR(this.getConversationBySid.bind(this),this._configuration,this._services),this._services.network=new Pm(this._configuration,this._services),this._services.users=new TR(this._myself,this._configuration,this._services),this._services.users.on("userSubscribed",function(e){n.emit("userSubscribed",e)}),this._services.users.on("userUpdated",function(e){return n.emit("userUpdated",e)}),this._services.users.on("userUnsubscribed",function(e){n.emit("userUnsubscribed",e)}),this._conversationsEntity=new xR(this._configuration,this._services),this._conversationsEntity.on("conversationAdded",function(e){n.emit("conversationAdded",e)}),this._conversationsEntity.on("conversationRemoved",function(e){n.emit("conversationRemoved",e)}),this._conversationsEntity.on("conversationJoined",function(e){n.emit("conversationJoined",e)}),this._conversationsEntity.on("conversationLeft",function(e){n.emit("conversationLeft",e)}),this._conversationsEntity.on("conversationUpdated",function(e){return n.emit("conversationUpdated",e)}),this._conversationsEntity.on("participantJoined",function(e){n.emit("participantJoined",e)}),this._conversationsEntity.on("participantLeft",function(e){n.emit("participantLeft",e)}),this._conversationsEntity.on("participantUpdated",function(e){return n.emit("participantUpdated",e)}),this._conversationsEntity.on("messageAdded",function(e){return n.emit("messageAdded",e)}),this._conversationsEntity.on("messageUpdated",function(e){return n.emit("messageUpdated",e)}),this._conversationsEntity.on("messageRemoved",function(e){return n.emit("messageRemoved",e)}),this._conversationsEntity.on("typingStarted",function(e){return n.emit("typingStarted",e)}),this._conversationsEntity.on("typingEnded",function(e){return n.emit("typingEnded",e)}),this._conversationsPromise=this._conversationsEntity.fetchConversations().then(function(){return n._conversationsEntity}).catch(function(e){throw e}),e.next=28,this._services.users.myself._ensureFetched();case 28:jR._supportedPushChannels.forEach(function(e){return n._subscribeToPushNotifications(e)}),this._services.typingIndicator.initialize(),this._services.mcsClient=new hE.McsClient(this._fpaToken,this._configuration.links.mediaService,this._configuration.links.mediaSetService,zR(zR({},this._options),{},{transport:void 0})),this._resolveEnsureReady(),this.emit("stateChanged","initialized"),this.emit("initialized");case 34:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"_subscribeToPushNotifications",value:function(t){var n=this;[Om.NEW_MESSAGE,Om.ADDED_TO_CONVERSATION,Om.REMOVED_FROM_CONVERSATION,Om.TYPING_INDICATOR,Om.CONSUMPTION_UPDATE].forEach(function(e){n._services.notificationClient.subscribe(t,e)})}},{key:"_unsubscribeFromPushNotifications",value:function(t){var n=this;[Om.NEW_MESSAGE,Om.ADDED_TO_CONVERSATION,Om.REMOVED_FROM_CONVERSATION,Om.TYPING_INDICATOR,Om.CONSUMPTION_UPDATE].forEach(function(e){n._services.notificationClient.unsubscribe(t,e)})}}],[{key:"create",value:(n=A(j.mark(function e(t,n){var r;return j.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=n&&n.twilsockClient)throw new Error("Obsolete usage of ConversationsClient.create() factory method: if you pass twilsock from the outside then you must use ConversationsClient constructor and be prepared to work with uninitialized client.");e.next=2;break;case 2:return r=new jR(t,n),e.next=5,r._ensureReady;case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}},e)})),function(e,t){return n.apply(this,arguments)})},{key:"parsePushNotification",value:function(e){if(jR._logger.debug("parsePushNotification, notificationPayload=",e),void 0!==e.aps){var t,n,r;if(e.twi_message_type)return n=jR._parsePushNotificationChatData(e),i=null,"string"==typeof(r=e.aps).alert?t=r.alert||null:(t=(null==(o=r.alert)?void 0:o.body)||null,i=(null==(o=r.alert)?void 0:o.title)||null),new PR({title:i,body:t,sound:r.sound||null,badge:r.badge||null,action:r.category||null,type:e.twi_message_type,data:n})}else{if(void 0===e.data)throw new Error("Provided push notification payload is not Programmable Chat notification");var i,o=e.data;if(o.twi_message_type)return i=jR._parsePushNotificationChatData(e.data),new PR({title:o.twi_title||null,body:o.twi_body||null,sound:o.twi_sound||null,badge:null,action:o.twi_action||null,type:o.twi_message_type,data:i})}throw new Error("Provided push notification payload does not contain Programmable Chat push notification type")}},{key:"_parsePushNotificationChatData",value:function(e){var t,n={};for(t in jR._supportedPushDataFields){var r=e[t];if(null!=r)if("message_index"!==t&&"media_count"!==t){if("media"!==t)n[jR._supportedPushDataFields[t]]=r;else if("string"==typeof r)try{n[jR._supportedPushDataFields[t]]=JSON.parse(r)}catch(e){jR._logger.debug("Media message notification parsing error")}}else{r=jl(r);null!==r&&(n[jR._supportedPushDataFields[t]]=r)}}return n}},{key:"populateInitRegistrations",value:function(e){e.populateInitRegistrations([Om.TYPING_INDICATOR]),ZS.populateInitRegistrations(e)}}]),g}(),b(r,"conversationAdded","conversationAdded"),b(r,"conversationJoined","conversationJoined"),b(r,"conversationLeft","conversationLeft"),b(r,"conversationRemoved","conversationRemoved"),b(r,"conversationUpdated","conversationUpdated"),b(r,"participantJoined","participantJoined"),b(r,"participantLeft","participantLeft"),b(r,"participantUpdated","participantUpdated"),b(r,"messageAdded","messageAdded"),b(r,"messageRemoved","messageRemoved"),b(r,"messageUpdated","messageUpdated"),b(r,"tokenAboutToExpire","tokenAboutToExpire"),b(r,"tokenExpired","tokenExpired"),b(r,"typingEnded","typingEnded"),b(r,"typingStarted","typingStarted"),b(r,"pushNotification","pushNotification"),b(r,"userSubscribed","userSubscribed"),b(r,"userUnsubscribed","userUnsubscribed"),b(r,"userUpdated","userUpdated"),b(r,"stateChanged","stateChanged"),b(r,"initialized","initialized"),b(r,"initFailed","initFailed"),b(r,"connectionStateChanged","connectionStateChanged"),b(r,"connectionError","connectionError"),b(r,"version",OR),b(r,"_logger",oi.scope("Client")),b(r,"_supportedPushChannels",["fcm","apn"]),b(r,"_supportedPushDataFields",{conversation_sid:"conversationSid",conversation_title:"conversationTitle",message_sid:"messageSid",message_index:"messageIndex",media_count:"mediaCount",media:"media"}),jR=r),y([ur("token"),v("design:type",String),v("design:paramtypes",[])],e.Client.prototype,"token",null),y([g(Wd),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],e.Client.prototype,"updateToken",null),y([g(Wd),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],e.Client.prototype,"getConversationBySid",null),y([g(Wd),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],e.Client.prototype,"peekConversationBySid",null),y([g(Wd),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],e.Client.prototype,"getConversationByUniqueName",null),y([g(["undefined",Ud("conversation options",{friendlyName:["string","undefined"],isPrivate:["boolean","undefined"],uniqueName:["string","undefined"]})]),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",Promise)],e.Client.prototype,"createConversation",null),y([g(qd("fcm","apn"),"string"),v("design:type",Function),v("design:paramtypes",[String,String]),v("design:returntype",Promise)],e.Client.prototype,"setPushRegistrationId",null),y([g(qd("fcm","apn")),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],e.Client.prototype,"unsetPushRegistrationId",null),y([g(qd("fcm","apn"),Wd),v("design:type",Function),v("design:paramtypes",[String,String]),v("design:returntype",Promise)],e.Client.prototype,"removePushRegistrations",null),y([g(Fd),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",Promise)],e.Client.prototype,"handlePushNotification",null),y([g(Wd),v("design:type",Function),v("design:paramtypes",[String]),v("design:returntype",Promise)],e.Client.prototype,"getUser",null),y([g(zd("strings","string")),v("design:type",Function),v("design:paramtypes",[Array]),v("design:returntype",hE.CancellablePromise)],e.Client.prototype,"getTemporaryContentUrlsForMediaSids",null),y([g(zd("media",$I)),v("design:type",Function),v("design:paramtypes",[Array]),v("design:returntype",hE.CancellablePromise)],e.Client.prototype,"getTemporaryContentUrlsForMedia",null),y([ur("Client.create()","new Client()"),g("string",["undefined",Fd]),v("design:type",Function),v("design:paramtypes",[String,Object]),v("design:returntype",Promise)],e.Client,"create",null),y([vf(Fd),v("design:type",Function),v("design:paramtypes",[Object]),v("design:returntype",PR)],e.Client,"parsePushNotification",null),e.Client=jR=y([yf(Wd,[Fd,"undefined"]),v("design:paramtypes",[String,Object])],e.Client),e.AggregatedDeliveryReceipt=KI,e.CancellablePromise=hE.CancellablePromise,e.Conversation=vR,e.DetailedDeliveryReceipt=QI,e.Media=$I,e.Message=sR,e.MessageBuilder=fR,e.NotificationTypes=Om,e.Participant=PI,e.PushNotification=PR,e.RestPaginator=YI,e.UnsentMessage=dR,e.User=yh,Object.defineProperty(e,"__esModule",{value:!0}),e}({}),function(e){var t=function r(i,o,a){function s(t,e){if(!o[t]){if(!i[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(c)return c(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}n=o[t]={exports:{}},i[t][0].call(n.exports,function(e){return s(i[t][1][e]||e)},n,n.exports,r,i,o,a)}return o[t].exports}for(var c="function"==typeof require&&require,e=0;e<a.length;e++)s(a[e]);return s}({1:[function(e,t,n){"use strict";t.exports=WebSocket},{}],2:[function(e,t,n){"use strict";t.exports={XMLHttpRequest:XMLHttpRequest}},{}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./twilio/call"),r=(n.Call=r.default,e("./twilio/device")),r=(n.Device=r.default,e("./twilio/errors")),r=(n.TwilioError=r,e("./twilio/log")),r=(n.Logger=r.Logger,e("./twilio/preflight/preflight"));n.PreflightTest=r.PreflightTest},{"./twilio/call":6,"./twilio/device":9,"./twilio/errors":12,"./twilio/log":15,"./twilio/preflight/preflight":17}],4:[function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,a,s,c){return new(s=s||Promise)(function(n,t){function r(e){try{o(c.next(e))}catch(e){t(e)}}function i(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,i)}o((c=c.apply(e,a||[])).next())})},s=this&&this.__generator||function(r,i){var o,a,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(s=2&t[0]?a.return:t[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3]))c.label=t[1];else if(6===t[0]&&c.label<s[1])c.label=s[1],s=t;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(t)}}t=i.call(r,c)}catch(e){t=[6,e],a=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},i=(Object.defineProperty(n,"__esModule",{value:!0}),e("./deferred"));function o(){this._operations=[]}o.prototype.enqueue=function(e){var t=!!this._operations.length,n=new i.default;return this._operations.push({deferred:n,callback:e}),t||this._processQueue(),n.promise},o.prototype._processQueue=function(){return r(this,void 0,void 0,function(){var t,n,r,i,o,a;return s(this,function(e){switch(e.label){case 0:if(!this._operations.length)return[3,5];n=this._operations[0],t=n.deferred,n=n.callback,o=i=r=void 0,e.label=1;case 1:return e.trys.push([1,3,,4]),[4,n()];case 2:return r=e.sent(),o=!0,[3,4];case 3:return a=e.sent(),i=a,[3,4];case 4:return this._operations.shift(),o?t.resolve(r):t.reject(i),[3,0];case 5:return[2]}})})},n.AsyncQueue=o},{"./deferred":8}],5:[function(e,t,n){"use strict";var r,a,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=(Object.defineProperty(n,"__esModule",{value:!0}),e("events")),s=e("./errors"),c=e("./log"),u=e("./outputdevicecollection"),l=e("./shims/mediadevices"),d=e("./util"),f=e("./shims/mediadeviceinfo"),p={audioinput:"Audio Input",audiooutput:"Audio Output"},e=(a=o.EventEmitter,i(h,a),Object.defineProperty(h.prototype,"audioConstraints",{get:function(){return this._audioConstraints},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"inputDevice",{get:function(){return this._inputDevice},enumerable:!0,configurable:!0}),Object.defineProperty(h.prototype,"inputStream",{get:function(){return this._inputStream},enumerable:!0,configurable:!0}),h.prototype._maybeStartPollingVolume=function(){var e,t,n,r=this;this.isVolumeSupported&&this._inputStream&&(this._updateVolumeSource(),!this._isPollingInputVolume)&&this._inputVolumeAnalyser&&(e=this._inputVolumeAnalyser.frequencyBinCount,t=new Uint8Array(e),this._isPollingInputVolume=!0,n=function(){var e;r._isPollingInputVolume&&(r._inputVolumeAnalyser&&(r._inputVolumeAnalyser.getByteFrequencyData(t),e=d.average(t),r.emit("inputVolume",e/255)),requestAnimationFrame(n))},requestAnimationFrame(n))},h.prototype._maybeStopPollingVolume=function(){!this.isVolumeSupported||!this._isPollingInputVolume||this._inputStream&&this.listenerCount("inputVolume")||(this._inputVolumeSource&&(this._inputVolumeSource.disconnect(),delete this._inputVolumeSource),this._isPollingInputVolume=!1)},h.prototype._unbind=function(){if(!this._mediaDevices)throw new s.NotSupportedError("Enumeration is not supported");this._mediaDevices.removeEventListener&&(this._mediaDevices.removeEventListener("devicechange",this._updateAvailableDevices),this._mediaDevices.removeEventListener("deviceinfochange",this._updateAvailableDevices))},h.prototype.setAudioConstraints=function(e){return this._audioConstraints=Object.assign({},e),delete this._audioConstraints.deviceId,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},h.prototype.setInputDevice=function(e){return d.isFirefox()?Promise.reject(new s.NotSupportedError("Firefox does not currently support opening multiple audio input tracks simultaneously, even across different tabs. As a result, Device.audio.setInputDevice is disabled on Firefox until support is added.\nRelated BugZilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324")):this._setInputDevice(e,!1)},h.prototype.unsetAudioConstraints=function(){return this._audioConstraints=null,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},h.prototype.unsetInputDevice=function(){var e=this;return this.inputDevice?this._onActiveInputChanged(null).then(function(){e._replaceStream(null),e._inputDevice=null,e._maybeStopPollingVolume()}):Promise.resolve()},h.prototype._addEnabledSounds=function(n){var t=this;Object.keys(n).forEach(function(e){t[e]=function(e,t){return void 0!==t&&(n[e]=t),n[e]}.bind(null,e)})},h.prototype._getUnknownDeviceIndex=function(e){var t=e.deviceId,e=e.kind,n=this._unknownDeviceIndexes[e][t];return n||(n=Object.keys(this._unknownDeviceIndexes[e]).length+1,this._unknownDeviceIndexes[e][t]=n),n},h.prototype._initializeEnumeration=function(){var t=this;if(!this._mediaDevices)throw new s.NotSupportedError("Enumeration is not supported");this._mediaDevices.addEventListener&&(this._mediaDevices.addEventListener("devicechange",this._updateAvailableDevices),this._mediaDevices.addEventListener("deviceinfochange",this._updateAvailableDevices)),this._updateAvailableDevices().then(function(){t.isOutputSelectionSupported&&Promise.all([t.speakerDevices.set("default"),t.ringtoneDevices.set("default")]).catch(function(e){t._log.warn("Warning: Unable to set audio output devices. "+e)})})},h.prototype._replaceStream=function(e){this._inputStream&&this._inputStream.getTracks().forEach(function(e){e.stop()}),this._inputStream=e},h.prototype._setInputDevice=function(e,t){var n=this;if("string"!=typeof e)return Promise.reject(new s.InvalidArgumentError("Must specify the device to set"));var r=this.availableInputDevices.get(e);if(!r)return Promise.reject(new s.InvalidArgumentError("Device not found: "+e));if(this._inputDevice&&this._inputDevice.deviceId===e&&this._inputStream){if(!t)return Promise.resolve();this._inputStream.getTracks().forEach(function(e){e.stop()})}t={audio:Object.assign({deviceId:{exact:e}},this.audioConstraints)};return this._getUserMedia(t).then(function(e){return n._onActiveInputChanged(e).then(function(){n._replaceStream(e),n._inputDevice=r,n._maybeStartPollingVolume()})})},h.prototype._updateDevices=function(e,r,n){var i=this,t=e.map(function(e){return e.deviceId}),o=Array.from(r.values()).map(function(e){return e.deviceId}),a=[],o=d.difference(o,t),s=(o.forEach(function(e){var t=r.get(e);t&&(r.delete(e),n(t))&&a.push(t)}),!1);e.forEach(function(e){var t=r.get(e.deviceId),n=i._wrapMediaDeviceInfo(e);t&&t.label===n.label||(r.set(e.deviceId,n),s=!0)}),(s||o.length)&&(null!==this.inputDevice&&"default"===this.inputDevice.deviceId&&(this._log.warn("Calling getUserMedia after device change to ensure that the           tracks of the active device (default) have not gone stale."),this._setInputDevice(this.inputDevice.deviceId,!0)),this.emit("deviceChange",a))},h.prototype._updateVolumeSource=function(){this._inputStream&&this._audioContext&&this._inputVolumeAnalyser&&(this._inputVolumeSource&&this._inputVolumeSource.disconnect(),this._inputVolumeSource=this._audioContext.createMediaStreamSource(this._inputStream),this._inputVolumeSource.connect(this._inputVolumeAnalyser))},h.prototype._wrapMediaDeviceInfo=function(e){var t={deviceId:e.deviceId,groupId:e.groupId,kind:e.kind,label:e.label};return t.label||("default"===t.deviceId?t.label="Default":(e=this._getUnknownDeviceIndex(e),t.label="Unknown "+p[t.kind]+" Device "+e)),new f(t)},h);function h(e,t,n,r){var i=a.call(this)||this,n=(i.availableInputDevices=new Map,i.availableOutputDevices=new Map,i._audioConstraints=null,i._inputDevice=null,i._inputStream=null,i._isPollingInputVolume=!1,i._log=c.default.getInstance(),i._unknownDeviceIndexes={audioinput:{},audiooutput:{}},i._removeLostInput=function(e){if(!i.inputDevice||i.inputDevice.deviceId!==e.deviceId)return!1;i._replaceStream(null),i._inputDevice=null,i._maybeStopPollingVolume();e=i.availableInputDevices.get("default")||Array.from(i.availableInputDevices.values())[0];return e&&i.setInputDevice(e.deviceId),!0},i._removeLostOutput=function(e){var t=i.speakerDevices.delete(e),e=i.ringtoneDevices.delete(e);return t||e},i._updateAvailableDevices=function(){return i._mediaDevices?i._mediaDevices.enumerateDevices().then(function(e){i._updateDevices(e.filter(function(e){return"audiooutput"===e.kind}),i.availableOutputDevices,i._removeLostOutput),i._updateDevices(e.filter(function(e){return"audioinput"===e.kind}),i.availableInputDevices,i._removeLostInput);var t=i.availableOutputDevices.get("default")||Array.from(i.availableOutputDevices.values())[0];[i.speakerDevices,i.ringtoneDevices].forEach(function(e){!e.get().size&&i.availableOutputDevices.size&&i.isOutputSelectionSupported&&e.set(t.deviceId).catch(function(e){i._log.warn("Unable to set audio output devices. "+e)})})}):Promise.reject("Enumeration not supported")},r=Object.assign({AudioContext:"undefined"!=typeof AudioContext&&AudioContext,setSinkId:"undefined"!=typeof HTMLAudioElement&&HTMLAudioElement.prototype.setSinkId},r),i._getUserMedia=n,i._mediaDevices=r.mediaDevices||l,i._onActiveInputChanged=t,!(!r.AudioContext&&!r.audioContext)),t=!(!i._mediaDevices||!i._mediaDevices.enumerateDevices),o="function"==typeof r.setSinkId;return i.isOutputSelectionSupported=t&&o,i.isVolumeSupported=n,r.enabledSounds&&i._addEnabledSounds(r.enabledSounds),i.isVolumeSupported&&(i._audioContext=r.audioContext||r.AudioContext&&new r.AudioContext,i._audioContext)&&(i._inputVolumeAnalyser=i._audioContext.createAnalyser(),i._inputVolumeAnalyser.fftSize=32,i._inputVolumeAnalyser.smoothingTimeConstant=.3),i.ringtoneDevices=new u.default("ringtone",i.availableOutputDevices,e,i.isOutputSelectionSupported),i.speakerDevices=new u.default("speaker",i.availableOutputDevices,e,i.isOutputSelectionSupported),i.addListener("newListener",function(e){"inputVolume"===e&&i._maybeStartPollingVolume()}),i.addListener("removeListener",function(e){"inputVolume"===e&&i._maybeStopPollingVolume()}),i.once("newListener",function(){i.isOutputSelectionSupported||i._log.warn("Warning: This browser does not support audio output selection."),i.isVolumeSupported||i._log.warn("Warning: This browser does not support Twilio's volume indicator feature.")}),t&&i._initializeEnumeration(),i}n.default=e=e||{}},{"./errors":12,"./log":15,"./outputdevicecollection":16,"./shims/mediadeviceinfo":31,"./shims/mediadevices":32,"./util":35,events:53}],6:[function(e,t,n){"use strict";var r,o,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=this&&this.__assign||function(){return(a=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},s=(Object.defineProperty(n,"__esModule",{value:!0}),e("events")),c=e("./device"),u=e("./errors"),l=e("./log"),d=e("./rtc/icecandidate"),f=e("./statsMonitor"),p=e("./util"),h=e("./uuid"),m=e("backoff"),y=e("./constants"),v=e("./rtc").PeerConnection,g=e("./rtc/sdp").getPreferredCodecInfo,b={factor:1.1,initialDelay:1,maxDelay:3e4,randomisationFactor:.5},_={disconnect:!0,info:{code:31003,message:"Connection with Twilio was interrupted.",twilioError:new u.MediaErrors.ConnectionError}},w={packetsLostFraction:{max:"packet-loss",maxAverage:"packets-lost-fraction"}},k={audioInputLevel:"audio-input-level",audioOutputLevel:"audio-output-level",bytesReceived:"bytes-received",bytesSent:"bytes-sent",jitter:"jitter",mos:"mos",rtt:"rtt"},x={max:"high-",maxAverage:"high-",maxDuration:"constant-",min:"low-",minStandardDeviation:"constant-"},e=(o=s.EventEmitter,i(S,o),Object.defineProperty(S.prototype,"direction",{get:function(){return this._direction},enumerable:!0,configurable:!0}),Object.defineProperty(S.prototype,"codec",{get:function(){return this._codec},enumerable:!0,configurable:!0}),S.prototype._setInputTracksFromStream=function(e){return this._mediaHandler.setInputTracksFromStream(e)},S.prototype._setSinkIds=function(e){return this._mediaHandler._setSinkIds(e)},S.prototype.accept=function(e){var n,r,i,o=this;this._status===S.State.Pending&&(n=(e=e||{}).rtcConfiguration||this._options.rtcConfiguration,r=e.rtcConstraints||this._options.rtcConstraints||{},i=r.audio||{audio:!0},this._status=S.State.Connecting,this._options.beforeAccept&&this._options.beforeAccept(this),((e="function"==typeof this._options.getInputStream&&this._options.getInputStream())?this._mediaHandler.setInputTracksFromStream(e):this._mediaHandler.openWithConstraints(i)).then(function(){var e,t;o._publisher.info("get-user-media","succeeded",{data:{audioConstraints:i}},o),o._status!==S.State.Connecting?(o._cleanupEventListeners(),o._mediaHandler.close()):(e=function(e,t){var n=o._direction===S.CallDirection.Incoming?"accepted-by-local":"accepted-by-remote",n=(o._publisher.info("connection",n,null,o),"string"==typeof t&&(o._signalingReconnectToken=t),g(o._mediaHandler.version.getSDP())),t=n.codecName,n=n.codecParams;o._publisher.info("settings","codec",{codec_params:n,selected_codec:t},o),o._monitor.enable(e)},t="function"==typeof o._options.getSinkIds&&o._options.getSinkIds(),Array.isArray(t)&&o._mediaHandler._setSinkIds(t).catch(function(){}),o._pstream.addListener("hangup",o._onHangup),o._direction===S.CallDirection.Incoming?(o._isAnswered=!0,o._pstream.on("answer",o._onAnswer.bind(o)),o._mediaHandler.answerIncomingCall(o.parameters.CallSid,o._options.offerSdp,r,n,e)):(t=Array.from(o.customParameters.entries()).map(function(e){return encodeURIComponent(e[0])+"="+encodeURIComponent(e[1])}).join("&"),o._pstream.on("answer",o._onAnswer.bind(o)),o._mediaHandler.makeOutgoingCall(o._pstream.token,t,o.outboundConnectionId,r,n,e)))},function(e){var t;31208===e.code||-1!==["PermissionDeniedError","NotAllowedError"].indexOf(e.name)?(t=new u.UserMediaErrors.PermissionDeniedError,o._publisher.error("get-user-media","denied",{data:{audioConstraints:i,error:e}},o)):(t=new u.UserMediaErrors.AcquisitionFailedError,o._publisher.error("get-user-media","failed",{data:{audioConstraints:i,error:e}},o)),o._disconnect(),o.emit("error",t)}))},S.prototype.disconnect=function(){this._disconnect()},S.prototype.getLocalStream=function(){return this._mediaHandler&&this._mediaHandler.stream},S.prototype.getRemoteStream=function(){return this._mediaHandler&&this._mediaHandler._remoteStream},S.prototype.ignore=function(){this._status===S.State.Pending&&(this._status=S.State.Closed,this._mediaHandler.ignore(this.parameters.CallSid),this._publisher.info("connection","ignored-by-local",null,this),this._onIgnore)&&this._onIgnore()},S.prototype.isMuted=function(){return this._mediaHandler.isMuted},S.prototype.mute=function(e){var t=this._mediaHandler.isMuted,e=(this._mediaHandler.mute(e=void 0===e?!0:e),this._mediaHandler.isMuted);t!==e&&(this._publisher.info("connection",e?"muted":"unmuted",null,this),this.emit("mute",e,this))},S.prototype.postFeedback=function(e,t){if(null==e)return this._postFeedbackDeclined();if(!Object.values(S.FeedbackScore).includes(e))throw new u.InvalidArgumentError("Feedback score must be one of: "+Object.values(S.FeedbackScore));if(null==t||Object.values(S.FeedbackIssue).includes(t))return this._publisher.info("feedback","received",{issue_name:t,quality_score:e},this,!0);throw new u.InvalidArgumentError("Feedback issue must be one of: "+Object.values(S.FeedbackIssue))},S.prototype.reject=function(){this._status===S.State.Pending&&(this._pstream.reject(this.parameters.CallSid),this._status=S.State.Closed,this.emit("reject"),this._mediaHandler.reject(this.parameters.CallSid),this._publisher.info("connection","rejected-by-local",null,this))},S.prototype.sendDigits=function(e){if(e.match(/[^0-9*#w]/))throw new u.InvalidArgumentError("Illegal character passed into sendDigits");var i=[],n=(e.split("").forEach(function(e){e="w"!==e?"dtmf"+e:"";i.push(e="dtmf#"===(e="dtmf*"===e?"dtmfs":e)?"dtmfh":e)}),!function e(t,n){var r=i.shift();r&&(n?n.play(r):t.get(r).play()),i.length&&setTimeout(e.bind(null,t),200)}(this._soundcache,this._options.dialtonePlayer),this._mediaHandler.getOrCreateDTMFSender());function r(e){var t;e.length&&((t=e.shift())&&t.length&&n.insertDTMF(t,160,70),setTimeout(r.bind(null,e),500))}if(n){if(!("canInsertDTMF"in n)||n.canInsertDTMF)return this._log.info("Sending digits using RTCDTMFSender"),void r(e.split("w"));this._log.info("RTCDTMFSender cannot insert DTMF")}this._log.info("Sending digits over PStream"),null!==this._pstream&&"disconnected"!==this._pstream.status?this._pstream.dtmf(this.parameters.CallSid,e):(e=new u.GeneralErrors.ConnectionError("Could not send DTMF: Signaling channel is disconnected"),this.emit("error",e))},S.prototype.sendMessage=function(e){var t=e.content,n=e.contentType,e=e.messageType;if(null==t)throw new u.InvalidArgumentError("`content` is empty");if("string"!=typeof e)throw new u.InvalidArgumentError("`messageType` must be an enumeration value of `Call.MessageType` or a string.");if(0===e.length)throw new u.InvalidArgumentError("`messageType` must be a non-empty string.");if(null===this._pstream)throw new u.InvalidStateError("Could not send CallMessage; Signaling channel is disconnected");var r=this.parameters.CallSid;if(void 0===this.parameters.CallSid)throw new u.InvalidStateError("Could not send CallMessage; Call has no CallSid");var i=this._voiceEventSidGenerator();return this._messages.set(i,{content:t,contentType:n,messageType:e,voiceEventSid:i}),this._pstream.sendMessage(r,t,n,e,i),i},S.prototype.status=function(){return this._status},S.prototype._checkVolume=function(e,t,n,r){var i=10<=t,n=n===e?t:0;return 10<=n?this._emitWarning("audio-level-","constant-audio-"+r+"-level",10,n,!1):i&&this._emitWarning("audio-level-","constant-audio-"+r+"-level",10,n,!0),n},S.prototype._cleanupEventListeners=function(){function e(){t._pstream&&(t._pstream.removeListener("ack",t._onAck),t._pstream.removeListener("answer",t._onAnswer),t._pstream.removeListener("cancel",t._onCancel),t._pstream.removeListener("error",t._onSignalingError),t._pstream.removeListener("hangup",t._onHangup),t._pstream.removeListener("ringing",t._onRinging),t._pstream.removeListener("transportClose",t._onTransportClose),t._pstream.removeListener("connected",t._onConnected),t._pstream.removeListener("message",t._onMessageReceived))}var t=this;e(),setTimeout(e,0)},S.prototype._createMetricPayload=function(){var e={call_sid:this.parameters.CallSid,dscp:!!this._options.dscp,sdk_version:y.RELEASE_VERSION};return this._options.gateway&&(e.gateway=this._options.gateway),e.direction=this._direction,e},S.prototype._disconnect=function(e,t){var n;e="string"==typeof e?e:null,this._status!==S.State.Open&&this._status!==S.State.Connecting&&this._status!==S.State.Reconnecting&&this._status!==S.State.Ringing||(this._log.info("Disconnecting..."),null!==this._pstream&&"disconnected"!==this._pstream.status&&this._shouldSendHangup&&(n=this.parameters.CallSid||this.outboundConnectionId)&&this._pstream.hangup(n,e),this._cleanupEventListeners(),this._mediaHandler.close(),t)||this._publisher.info("connection","disconnected-by-local",null,this)},S.prototype._maybeTransitionToOpen=function(){this._wasConnected;this._isAnswered&&(this._onSignalingReconnected(),this._signalingStatus=S.State.Open,this._mediaHandler)&&"open"===this._mediaHandler.status&&(this._status=S.State.Open,this._wasConnected||(this._wasConnected=!0,this.emit("accept",this)))},S.prototype._postFeedbackDeclined=function(){return this._publisher.info("feedback","received-none",null,this,!0)},S.prototype._publishMetrics=function(){var t=this;0!==this._metricsSamples.length&&this._publisher.postMetrics("quality-metrics-samples","metrics-sample",this._metricsSamples.splice(0),this._createMetricPayload(),this).catch(function(e){t._log.warn("Unable to post metrics to Insights. Received error:",e)})},S.prototype._setCallSid=function(e){e=e.callsid;e&&(this.parameters.CallSid=e,this._mediaHandler.callSid=e)},S.toString=function(){return"[Twilio.Call class]"},S);function S(e,t){var s=o.call(this)||this,n=(s.parameters={},s._inputVolumeStreak=0,s._isAnswered=!1,s._isCancelled=!1,s._latestInputVolume=0,s._latestOutputVolume=0,s._log=l.default.getInstance(),s._mediaStatus=S.State.Pending,s._messages=new Map,s._metricsSamples=[],s._options={MediaHandler:v,offerSdp:null,shouldPlayDisconnect:function(){return!0},voiceEventSidGenerator:h.generateVoiceEventSid},s._outputVolumeStreak=0,s._shouldSendHangup=!0,s._signalingStatus=S.State.Pending,s._soundcache=new Map,s._status=S.State.Pending,s._wasConnected=!1,s.toString=function(){return"[Twilio.Call instance]"},s._emitWarning=function(e,t,n,r,i,o){var a,e=e+"warning"+(i?"-cleared":"-raised");"constant-audio-input-level"===t&&s.isMuted()||(a="constant-audio-output-level"===t?"info":i?"info":"warning",n={threshold:n},r&&(r instanceof Array?n.values=r.map(function(e){return"number"==typeof e?Math.round(100*e)/100:r}):n.value=r),s._publisher.post(a,e,t,{data:n},s),"constant-audio-output-level"!==t&&s.emit(i?"warning-cleared":"warning",t,o&&!i?o:null))},s._onAck=function(e){var t=e.acktype,n=e.callsid,e=e.voiceeventsid;s.parameters.CallSid!==n?s._log.warn("Received ack from a different callsid: "+n):"message"===t&&s._onMessageSent(e)},s._onAnswer=function(e){"string"==typeof e.reconnect&&(s._signalingReconnectToken=e.reconnect),s._isAnswered&&s._status!==S.State.Reconnecting||(s._setCallSid(e),s._isAnswered=!0,s._maybeTransitionToOpen())},s._onCancel=function(e){e=e.callsid;s.parameters.CallSid===e&&(s._isCancelled=!0,s._publisher.info("connection","cancel",null,s),s._cleanupEventListeners(),s._mediaHandler.close(),s._status=S.State.Closed,s.emit("cancel"),s._pstream.removeListener("cancel",s._onCancel))},s._onConnected=function(){s._log.info("Received connected from pstream"),s._signalingReconnectToken&&s._pstream.reconnect(s._mediaHandler.version.getSDP(),s.parameters.CallSid,s._signalingReconnectToken)},s._onHangup=function(e){if(s.status()!==S.State.Closed){if(e.callsid&&(s.parameters.CallSid||s.outboundConnectionId)){if(e.callsid!==s.parameters.CallSid&&e.callsid!==s.outboundConnectionId)return}else if(e.callsid)return;s._log.info("Received HANGUP from gateway"),e.error&&(e=new u.GeneralErrors.ConnectionError("Error sent from gateway in HANGUP"),s._log.error("Received an error from the gateway:",e),s.emit("error",e)),s._shouldSendHangup=!1,s._publisher.info("connection","disconnected-by-remote",null,s),s._disconnect(null,!0),s._cleanupEventListeners()}},s._onMediaFailure=function(e){var t=S.MediaFailure,n=t.ConnectionDisconnected,r=t.ConnectionFailed,i=t.IceGatheringFailed,t=t.LowBytes,i=e===r||e===i;if(!p.isChrome(window,window.navigator)&&e===r)return s._mediaHandler.onerror(_);if(s._mediaStatus===S.State.Reconnecting){if(i){if(Date.now()-s._mediaReconnectStartTime>b.maxDelay)return s._log.info("Exceeded max ICE retries"),s._mediaHandler.onerror(_);try{s._mediaReconnectBackoff.backoff()}catch(e){if(!e.message||"Backoff in progress."!==e.message)throw e}}}else{var r=s._mediaHandler.version.pc,r=r&&"disconnected"===r.iceConnectionState,o=s._monitor.hasActiveWarning("bytesSent","min")||s._monitor.hasActiveWarning("bytesReceived","min");(e===t&&r||e===n&&o||i)&&(t=new u.MediaErrors.ConnectionError("Media connection failed."),s._log.warn("ICE Connection disconnected."),s._publisher.warn("connection","error",t,s),s._publisher.info("connection","reconnecting",null,s),s._mediaReconnectStartTime=Date.now(),s._status=S.State.Reconnecting,s._mediaStatus=S.State.Reconnecting,s._mediaReconnectBackoff.reset(),s._mediaReconnectBackoff.backoff(),s.emit("reconnecting",t))}},s._onMediaReconnected=function(){s._mediaStatus===S.State.Reconnecting&&(s._log.info("ICE Connection reestablished."),s._mediaStatus=S.State.Open,s._signalingStatus===S.State.Open)&&(s._publisher.info("connection","reconnected",null,s),s.emit("reconnected"),s._status=S.State.Open)},s._onMessageReceived=function(e){var t=e.callsid,n=e.content,r=e.contenttype,i=e.messagetype,e=e.voiceeventsid;s.parameters.CallSid!==t?s._log.warn("Received a message from a different callsid: "+t):s.emit("messageReceived",{content:n,contentType:r,messageType:i,voiceEventSid:e})},s._onMessageSent=function(e){var t;s._messages.has(e)?(t=s._messages.get(e),s._messages.delete(e),s.emit("messageSent",t)):s._log.warn("Received a messageSent with a voiceEventSid that doesn't exists: "+e)},s._onRinging=function(e){s._setCallSid(e),s._status!==S.State.Connecting&&s._status!==S.State.Ringing||(e=!!e.sdp,s._status=S.State.Ringing,s._publisher.info("connection","outgoing-ringing",{hasEarlyMedia:e},s),s.emit("ringing",e))},s._onRTCSample=function(e){var t=a(a({},e),{inputVolume:s._latestInputVolume,outputVolume:s._latestOutputVolume});s._codec=t.codecName,s._metricsSamples.push(t),10<=s._metricsSamples.length&&s._publishMetrics(),s.emit("sample",e)},s._onSignalingError=function(e){var t=e.callsid,n=e.voiceeventsid;s.parameters.CallSid!==t?s._log.warn("Received an error from a different callsid: "+t):n&&s._messages.has(n)&&(s._messages.delete(n),s._log.warn("Received an error while sending a message.",e))},s._onSignalingReconnected=function(){s._signalingStatus===S.State.Reconnecting&&(s._log.info("Signaling Connection reestablished."),s._signalingStatus=S.State.Open,s._mediaStatus===S.State.Open)&&(s._publisher.info("connection","reconnected",null,s),s.emit("reconnected"),s._status=S.State.Open)},s._onTransportClose=function(){s._log.error("Received transportClose from pstream"),s.emit("transportClose"),s._signalingReconnectToken?(s._status=S.State.Reconnecting,s._signalingStatus=S.State.Reconnecting,s.emit("reconnecting",new u.SignalingErrors.ConnectionDisconnected)):(s._status=S.State.Closed,s._signalingStatus=S.State.Closed)},s._reemitWarning=function(e,t){var n,r=/^audio/.test(e.name)?"audio-level-":"network-quality-",i=x[e.threshold.name];e.name in w?n=w[e.name][e.threshold.name]:e.name in k&&(n=k[e.name]),s._emitWarning(r,i+n,e.threshold.value,e.values||e.value,t,e)},s._reemitWarningCleared=function(e){s._reemitWarning(e,!0)},s._isUnifiedPlanDefault=e.isUnifiedPlanDefault,s._soundcache=e.soundcache,"function"==typeof e.onIgnore&&(s._onIgnore=e.onIgnore),t&&t.twimlParams||{}),n=(s.customParameters=new Map(Object.entries(n).map(function(e){var t=e[0],e=e[1];return[t,String(e)]})),Object.assign(s._options,t),s._options.callParameters&&(s.parameters=s._options.callParameters),s._options.reconnectToken&&(s._signalingReconnectToken=s._options.reconnectToken),s._voiceEventSidGenerator=s._options.voiceEventSidGenerator||h.generateVoiceEventSid,s._direction=s.parameters.CallSid?S.CallDirection.Incoming:S.CallDirection.Outgoing,s._direction===S.CallDirection.Incoming&&s.parameters?s.callerInfo=s.parameters.StirStatus?{isVerified:"TN-Validation-Passed-A"===s.parameters.StirStatus}:null:s.callerInfo=null,s._mediaReconnectBackoff=m.exponential(b),s._mediaReconnectBackoff.on("ready",function(){return s._mediaHandler.iceRestart()}),s.outboundConnectionId="TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),s._publisher=e.publisher),i=(s._direction===S.CallDirection.Incoming?n.info("connection","incoming",null,s):n.info("connection","outgoing",{preflight:s._options.preflight},s),s._monitor=new(s._options.StatsMonitor||f.default));return i.on("sample",s._onRTCSample),i.disableWarnings(),setTimeout(function(){return i.enableWarnings()},5e3),i.on("warning",function(e,t){"bytesSent"!==e.name&&"bytesReceived"!==e.name||s._onMediaFailure(S.MediaFailure.LowBytes),s._reemitWarning(e,t)}),i.on("warning-cleared",function(e){s._reemitWarningCleared(e)}),s._mediaHandler=new s._options.MediaHandler(e.audioHelper,e.pstream,e.getUserMedia,{codecPreferences:s._options.codecPreferences,dscp:s._options.dscp,forceAggressiveIceNomination:s._options.forceAggressiveIceNomination,isUnifiedPlan:s._isUnifiedPlanDefault,maxAverageBitrate:s._options.maxAverageBitrate,preflight:s._options.preflight}),s.on("volume",function(e,t){s._inputVolumeStreak=s._checkVolume(e,s._inputVolumeStreak,s._latestInputVolume,"input"),s._outputVolumeStreak=s._checkVolume(t,s._outputVolumeStreak,s._latestOutputVolume,"output"),s._latestInputVolume=e,s._latestOutputVolume=t}),s._mediaHandler.onvolume=function(e,t,n,r){i.addVolumes(n/255*32767,r/255*32767),s.emit("volume",e,t)},s._mediaHandler.ondtlstransportstatechange=function(e){s._publisher.post("failed"===e?"error":"debug","dtls-transport-state",e,null,s)},s._mediaHandler.onpcconnectionstatechange=function(e){var t="debug",n=s._mediaHandler.getRTCDtlsTransport();"failed"===e&&(t=n&&"failed"===n.state?"error":"warning"),s._publisher.post(t,"pc-connection-state",e,null,s)},s._mediaHandler.onicecandidate=function(e){e=new d.IceCandidate(e).toPayload();s._publisher.debug("ice-candidate","ice-candidate",e,s)},s._mediaHandler.onselectedcandidatepairchange=function(e){var t=new d.IceCandidate(e.local).toPayload(),e=new d.IceCandidate(e.remote,!0).toPayload();s._publisher.debug("ice-candidate","selected-ice-candidate-pair",{local_candidate:t,remote_candidate:e},s)},s._mediaHandler.oniceconnectionstatechange=function(e){s._publisher.post("failed"===e?"error":"debug","ice-connection-state",e,null,s)},s._mediaHandler.onicegatheringfailure=function(e){s._publisher.warn("ice-gathering-state",e,null,s),s._onMediaFailure(S.MediaFailure.IceGatheringFailed)},s._mediaHandler.onicegatheringstatechange=function(e){s._publisher.debug("ice-gathering-state",e,null,s)},s._mediaHandler.onsignalingstatechange=function(e){s._publisher.debug("signaling-state",e,null,s)},s._mediaHandler.ondisconnected=function(e){s._log.info(e),s._publisher.warn("network-quality-warning-raised","ice-connectivity-lost",{message:e},s),s.emit("warning","ice-connectivity-lost"),s._onMediaFailure(S.MediaFailure.ConnectionDisconnected)},s._mediaHandler.onfailed=function(e){s._onMediaFailure(S.MediaFailure.ConnectionFailed)},s._mediaHandler.onconnected=function(){s._status===S.State.Reconnecting&&s._onMediaReconnected()},s._mediaHandler.onreconnected=function(e){s._log.info(e),s._publisher.info("network-quality-warning-cleared","ice-connectivity-lost",{message:e},s),s.emit("warning-cleared","ice-connectivity-lost"),s._onMediaReconnected()},s._mediaHandler.onerror=function(e){!0===e.disconnect&&s._disconnect(e.info&&e.info.message);var t=e.info.twilioError||new u.GeneralErrors.UnknownError(e.info.message);s._log.error("Received an error from MediaStream:",e),s.emit("error",t)},s._mediaHandler.onopen=function(){s._status!==S.State.Open&&s._status!==S.State.Reconnecting&&(s._status===S.State.Ringing||s._status===S.State.Connecting?(s.mute(!1),s._mediaStatus=S.State.Open,s._maybeTransitionToOpen()):s._mediaHandler.close())},s._mediaHandler.onclose=function(){s._status=S.State.Closed,s._options.shouldPlayDisconnect&&s._options.shouldPlayDisconnect()&&!s._isCancelled&&s._soundcache.get(c.default.SoundName.Disconnect).play(),i.disable(),s._publishMetrics(),s._isCancelled||s.emit("disconnect",s)},s._pstream=e.pstream,s._pstream.on("ack",s._onAck),s._pstream.on("cancel",s._onCancel),s._pstream.on("error",s._onSignalingError),s._pstream.on("ringing",s._onRinging),s._pstream.on("transportClose",s._onTransportClose),s._pstream.on("connected",s._onConnected),s._pstream.on("message",s._onMessageReceived),s.on("error",function(e){s._publisher.error("connection","error",{code:e.code,message:e.message},s),s._pstream&&"disconnected"===s._pstream.status&&s._cleanupEventListeners()}),s.on("disconnect",function(){s._cleanupEventListeners()}),s}s=e=S||{},(i=s.State||(s.State={})).Closed="closed",i.Connecting="connecting",i.Open="open",i.Pending="pending",i.Reconnecting="reconnecting",i.Ringing="ringing",(i=s.FeedbackIssue||(s.FeedbackIssue={})).AudioLatency="audio-latency",i.ChoppyAudio="choppy-audio",i.DroppedCall="dropped-call",i.Echo="echo",i.NoisyCall="noisy-call",i.OneWayAudio="one-way-audio",(i=s.FeedbackScore||(s.FeedbackScore={}))[i.One=1]="One",i[i.Two=2]="Two",i[i.Three=3]="Three",i[i.Four=4]="Four",i[i.Five=5]="Five",(i=s.CallDirection||(s.CallDirection={})).Incoming="INCOMING",i.Outgoing="OUTGOING",(i=s.Codec||(s.Codec={})).Opus="opus",i.PCMU="pcmu",(i=s.IceGatheringFailureReason||(s.IceGatheringFailureReason={})).None="none",i.Timeout="timeout",(i=s.MediaFailure||(s.MediaFailure={})).ConnectionDisconnected="ConnectionDisconnected",i.ConnectionFailed="ConnectionFailed",i.IceGatheringFailed="IceGatheringFailed",i.LowBytes="LowBytes",(s.MessageType||(s.MessageType={})).UserDefinedMessage="user-defined-message",n.default=e},{"./constants":7,"./device":9,"./errors":12,"./log":15,"./rtc":23,"./rtc/icecandidate":22,"./rtc/sdp":28,"./statsMonitor":34,"./util":35,"./uuid":36,backoff:45,events:53}],7:[function(e,t,n){var r="https://sdk.twilio.com/js/client/sounds/releases/1.0.0";t.exports.COWBELL_AUDIO_URL=r+"/cowbell.mp3?cache=2.3.1",t.exports.ECHO_TEST_DURATION=2e4,t.exports.PACKAGE_NAME="@twilio/voice-sdk",t.exports.RELEASE_VERSION="2.3.1",t.exports.SOUNDS_BASE_URL=r,t.exports.USED_ERRORS=["AuthorizationErrors.AccessTokenExpired","AuthorizationErrors.AccessTokenInvalid","AuthorizationErrors.AuthenticationFailed","AuthorizationErrors.PayloadSizeExceededError","AuthorizationErrors.RateExceededError","ClientErrors.BadRequest","GeneralErrors.CallCancelledError","GeneralErrors.ConnectionError","GeneralErrors.TransportError","GeneralErrors.UnknownError","MalformedRequestErrors.MalformedRequestError","MediaErrors.ClientLocalDescFailed","MediaErrors.ClientRemoteDescFailed","MediaErrors.ConnectionError","SignalingErrors.ConnectionDisconnected","SignalingErrors.ConnectionError","UserMediaErrors.PermissionDeniedError","UserMediaErrors.AcquisitionFailedError"]},{}],8:[function(e,t,n){"use strict";function r(){var n=this;this._promise=new Promise(function(e,t){n._resolve=e,n._reject=t})}Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(r.prototype,"promise",{get:function(){return this._promise},enumerable:!0,configurable:!0}),r.prototype.reject=function(e){this._reject(e)},r.prototype.resolve=function(e){this._resolve(e)},n.default=r},{}],9:[function(e,t,n){"use strict";var r,i,o,a=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),d=this&&this.__assign||function(){return(d=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},c=this&&this.__awaiter||function(e,a,s,c){return new(s=s||Promise)(function(n,t){function r(e){try{o(c.next(e))}catch(e){t(e)}}function i(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,i)}o((c=c.apply(e,a||[])).next())})},u=this&&this.__generator||function(r,i){var o,a,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(s=2&t[0]?a.return:t[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3]))c.label=t[1];else if(6===t[0]&&c.label<s[1])c.label=s[1],s=t;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(t)}}t=i.call(r,c)}catch(e){t=[6,e],a=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},s=(Object.defineProperty(n,"__esModule",{value:!0}),e("events")),f=e("loglevel"),l=e("./audiohelper"),p=e("./call"),h=e("./dialtonePlayer"),m=e("./errors"),y=e("./log"),v=e("./preflight/preflight"),g=e("./regions"),b=e("./util"),_=e("./uuid"),w=e("./constants"),k=e("./eventpublisher"),x=e("./pstream"),S=e("./rtc"),E=e("./rtc/getusermedia"),C=e("./sound"),e=(i=s.EventEmitter,a(T,i),Object.defineProperty(T,"audioContext",{get:function(){return T._audioContext},enumerable:!0,configurable:!0}),Object.defineProperty(T,"extension",{get:function(){var t,n,e="undefined"!=typeof document?document.createElement("audio"):{canPlayType:!1};try{t=e.canPlayType&&!!e.canPlayType("audio/mpeg").replace(/no/,"")}catch(e){t=!1}try{n=e.canPlayType&&!!e.canPlayType("audio/ogg;codecs='vorbis'").replace(/no/,"")}catch(e){n=!1}return n&&!t?"ogg":"mp3"},enumerable:!0,configurable:!0}),Object.defineProperty(T,"isSupported",{get:function(){return S.enabled()},enumerable:!0,configurable:!0}),Object.defineProperty(T,"packageName",{get:function(){return w.PACKAGE_NAME},enumerable:!0,configurable:!0}),T.runPreflight=function(e,t){return new v.PreflightTest(e,d({audioContext:T._getOrCreateAudioContext()},t))},T.toString=function(){return"[Twilio.Device class]"},Object.defineProperty(T,"version",{get:function(){return w.RELEASE_VERSION},enumerable:!0,configurable:!0}),T._getOrCreateAudioContext=function(){return T._audioContext||("undefined"!=typeof AudioContext?T._audioContext=new AudioContext:"undefined"!=typeof webkitAudioContext&&(T._audioContext=new webkitAudioContext)),T._audioContext},Object.defineProperty(T.prototype,"audio",{get:function(){return this._audio},enumerable:!0,configurable:!0}),T.prototype.connect=function(r){return void 0===r&&(r={}),c(this,void 0,void 0,function(){var t,n;return u(this,function(e){switch(e.label){case 0:if(this._throwIfDestroyed(),this._activeCall)throw new m.InvalidStateError("A Call is already active");return[4,(n=this)._makeCall(r.params||{},{rtcConfiguration:r.rtcConfiguration,voiceEventSidGenerator:this._options.voiceEventSidGenerator})];case 1:return t=n._activeCall=e.sent(),this._calls.splice(0).forEach(function(e){return e.ignore()}),this._soundcache.get(T.SoundName.Incoming).stop(),t.accept({rtcConstraints:r.rtcConstraints}),this._publishNetworkChange(),[2,t]}})})},Object.defineProperty(T.prototype,"calls",{get:function(){return this._calls},enumerable:!0,configurable:!0}),T.prototype.destroy=function(){this.disconnectAll(),this._stopRegistrationTimer(),this._audio&&this._audio._unbind(),this._destroyStream(),this._destroyPublisher(),this._destroyAudioHelper(),this._networkInformation&&"function"==typeof this._networkInformation.removeEventListener&&this._networkInformation.removeEventListener("change",this._publishNetworkChange),"undefined"!=typeof window&&window.removeEventListener&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.removeEventListener("unload",this._boundDestroy),window.removeEventListener("pagehide",this._boundDestroy)),this._setState(T.State.Destroyed),s.EventEmitter.prototype.removeAllListeners.call(this)},T.prototype.disconnectAll=function(){this._calls.splice(0).forEach(function(e){return e.disconnect()}),this._activeCall&&this._activeCall.disconnect()},Object.defineProperty(T.prototype,"edge",{get:function(){return this._edge},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"home",{get:function(){return this._home},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"identity",{get:function(){return this._identity},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"isBusy",{get:function(){return!!this._activeCall},enumerable:!0,configurable:!0}),T.prototype.register=function(){return c(this,void 0,void 0,function(){var t,n=this;return u(this,function(e){switch(e.label){case 0:if(this.state!==T.State.Unregistered)throw new m.InvalidStateError('Attempt to register when device is in state "'+this.state+'". Must be "'+T.State.Unregistered+'".');return this._setState(T.State.Registering),[4,this._streamConnectedPromise||this._setupStream()];case 1:return e.sent(),t=new Promise(function(e){n.once(T.State.Registered,e)}),[4,this._sendPresence(!0)];case 2:return e.sent(),[4,t];case 3:return e.sent(),[2]}})})},Object.defineProperty(T.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(T.prototype,"token",{get:function(){return this._token},enumerable:!0,configurable:!0}),T.prototype.toString=function(){return"[Twilio.Device instance]"},T.prototype.unregister=function(){return c(this,void 0,void 0,function(){var t,n;return u(this,function(e){switch(e.label){case 0:if(this.state!==T.State.Registered)throw new m.InvalidStateError('Attempt to unregister when device is in state "'+this.state+'". Must be "'+T.State.Registered+'".');return this._shouldReRegister=!1,[4,this._streamConnectedPromise];case 1:return t=e.sent(),n=new Promise(function(e){t.on("offline",e)}),[4,this._sendPresence(!1)];case 2:return e.sent(),[4,n];case 3:return e.sent(),[2]}})})},T.prototype.updateOptions=function(e){if(void 0===e&&(e={}),this.state===T.State.Destroyed)throw new m.InvalidStateError('Attempt to "updateOptions" when device is in state "'+this.state+'".');this._options=d(d(d({},this._defaultOptions),this._options),e);var t=new Set(this._chunderURIs),e="string"==typeof this._options.chunderw?[this._options.chunderw]:Array.isArray(this._options.chunderw)&&this._options.chunderw,e=this._chunderURIs=(e||g.getChunderURIs(this._options.edge)).map(g.createSignalingEndpointURL),n=t.size!==e.length;if(!n)for(var r=0,i=e;r<i.length;r++){var o=i[r];if(!t.has(o)){n=!0;break}}if(this.isBusy&&n)throw new m.InvalidStateError("Cannot change Edge while on an active Call");this._log.setDefaultLevel("number"==typeof this._options.logLevel?this._options.logLevel:f.levels.ERROR),this._options.dscp&&(this._options.rtcConstraints||(this._options.rtcConstraints={}),this._options.rtcConstraints.optional=[{googDscp:!0}]);for(var a=0,s=Object.keys(T._defaultSounds);a<s.length;a++){var c=s[a],u=T._defaultSounds[c],l=w.SOUNDS_BASE_URL+"/"+u.filename+"."+T.extension+"?cache="+w.RELEASE_VERSION,l=this._options.sounds&&this._options.sounds[c]||l,l=new(this._options.Sound||C)(c,l,{audioContext:this._options.disableAudioContextSounds?null:T.audioContext,maxDuration:u.maxDuration,shouldLoop:u.shouldLoop});this._soundcache.set(c,l)}this._setupAudioHelper(),this._setupPublisher(),n&&this._streamConnectedPromise&&this._setupStream(),"undefined"!=typeof window&&"function"==typeof window.addEventListener&&this._options.closeProtection&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.addEventListener("beforeunload",this._boundConfirmClose))},T.prototype.updateToken=function(e){if(this.state===T.State.Destroyed)throw new m.InvalidStateError('Attempt to "updateToken" when device is in state "'+this.state+'".');if("string"!=typeof e)throw new m.InvalidArgumentError('Parameter "token" must be of type "string".');this._token=e,this._stream&&this._stream.setToken(this._token),this._publisher&&this._publisher.setToken(this._token)},T.prototype._confirmClose=function(e){var t;return this._activeCall?(t="string"!=typeof(t=this._options.closeProtection||!1)?"A call is currently in-progress. Leaving or reloading this page will end the call.":t,(e||window.event).returnValue=t):""},T.prototype._destroyAudioHelper=function(){this._audio&&(this._audio.removeAllListeners(),this._audio=null)},T.prototype._destroyPublisher=function(){this._publisher&&(this._publisher=null)},T.prototype._destroyStream=function(){this._stream&&(this._stream.removeListener("close",this._onSignalingClose),this._stream.removeListener("connected",this._onSignalingConnected),this._stream.removeListener("error",this._onSignalingError),this._stream.removeListener("invite",this._onSignalingInvite),this._stream.removeListener("offline",this._onSignalingOffline),this._stream.removeListener("ready",this._onSignalingReady),this._stream.destroy(),this._stream=null),this._onSignalingOffline(),this._streamConnectedPromise=null},T.prototype._findCall=function(t){return this._calls.find(function(e){return e.parameters.CallSid===t||e.outboundConnectionId===t})||null},T.prototype._makeCall=function(a,s){return c(this,void 0,void 0,function(){var t,n,r,i,o=this;return u(this,function(e){switch(e.label){case 0:if(void 0===T._isUnifiedPlanDefault)throw new m.InvalidStateError("Device has not been initialized.");return n={audioHelper:this._audio,getUserMedia:E,isUnifiedPlanDefault:T._isUnifiedPlanDefault,onIgnore:function(){o._soundcache.get(T.SoundName.Incoming).stop()}},[4,this._streamConnectedPromise||this._setupStream()];case 1:return n.pstream=e.sent(),n.publisher=this._publisher,n.soundcache=this._soundcache,t=n,s=Object.assign({MediaStream:this._options.MediaStream||S.PeerConnection,beforeAccept:function(e){o._activeCall&&o._activeCall!==e&&(o._activeCall.disconnect(),o._removeCall(o._activeCall))},codecPreferences:this._options.codecPreferences,dialtonePlayer:T._dialtonePlayer,dscp:this._options.dscp,forceAggressiveIceNomination:this._options.forceAggressiveIceNomination,getInputStream:function(){return o._options.fileInputStream||o._callInputStream},getSinkIds:function(){return o._callSinkIds},maxAverageBitrate:this._options.maxAverageBitrate,preflight:this._options.preflight,rtcConstraints:this._options.rtcConstraints,shouldPlayDisconnect:function(){return o._enabledSounds.disconnect},twimlParams:a,voiceEventSidGenerator:this._options.voiceEventSidGenerator},s),r=function(){null===o._activeCall&&0===o._calls.length&&o._stream.updatePreferredURI(null)},(i=new(this._options.Call||p.default)(t,s)).once("accept",function(){o._stream.updatePreferredURI(o._preferredURI),o._removeCall(i),o._activeCall=i,o._audio&&o._audio._maybeStartPollingVolume(),i.direction===p.default.CallDirection.Outgoing&&o._enabledSounds.outgoing&&o._soundcache.get(T.SoundName.Outgoing).play();var e={edge:o._edge||o._region};o._options.edge&&(e.selected_edge=Array.isArray(o._options.edge)?o._options.edge:[o._options.edge]),o._publisher.info("settings","edge",e,i)}),i.addListener("error",function(e){"closed"===i.status()&&(o._removeCall(i),r()),o._audio&&o._audio._maybeStopPollingVolume(),o._maybeStopIncomingSound()}),i.once("cancel",function(){o._log.info("Canceled: "+i.parameters.CallSid),o._removeCall(i),r(),o._audio&&o._audio._maybeStopPollingVolume(),o._maybeStopIncomingSound()}),i.once("disconnect",function(){o._audio&&o._audio._maybeStopPollingVolume(),o._removeCall(i),r(),o._maybeStopIncomingSound()}),i.once("reject",function(){o._log.info("Rejected: "+i.parameters.CallSid),o._audio&&o._audio._maybeStopPollingVolume(),o._removeCall(i),r(),o._maybeStopIncomingSound()}),i.on("transportClose",function(){i.status()===p.default.State.Pending&&(o._audio&&o._audio._maybeStopPollingVolume(),o._removeCall(i),o._maybeStopIncomingSound())}),[2,i]}})})},T.prototype._maybeStopIncomingSound=function(){this._calls.length||this._soundcache.get(T.SoundName.Incoming).stop()},T.prototype._removeCall=function(e){this._activeCall===e&&(this._activeCall=null);for(var t=this._calls.length-1;0<=t;t--)e===this._calls[t]&&this._calls.splice(t,1)},T.prototype._sendPresence=function(n){return c(this,void 0,void 0,function(){var t;return u(this,function(e){switch(e.label){case 0:return[4,this._streamConnectedPromise];case 1:return(t=e.sent())&&(t.register({audio:n}),n?this._startRegistrationTimer():this._stopRegistrationTimer()),[2]}})})},T.prototype._setState=function(e){e!==this.state&&(this._state=e,this.emit(this._stateEventMapping[e]))},T.prototype._setupAudioHelper=function(){var n=this;this._audio&&(this._log.info("Found existing audio helper; destroying..."),this._destroyAudioHelper()),this._audio=new(this._options.AudioHelper||l.default)(this._updateSinkIds,this._updateInputStream,E,{audioContext:T.audioContext,enabledSounds:this._enabledSounds}),this._audio.on("deviceChange",function(e){var t=n._activeCall,e=e.map(function(e){return e.deviceId});n._publisher.info("audio","device-change",{lost_active_device_ids:e},t),t&&t._mediaHandler._onInputDevicesChanged()})},T.prototype._setupPublisher=function(){var t=this,e=(this._publisher&&(this._log.info("Found existing publisher; destroying..."),this._destroyPublisher()),{defaultPayload:this._createDefaultPayload,log:this._log,metadata:{app_name:this._options.appName,app_version:this._options.appVersion}});return this._options.eventgw&&(e.host=this._options.eventgw),this._home&&(e.host=g.createEventGatewayURI(this._home)),this._publisher=new(this._options.Publisher||k)("twilio-js-sdk",this.token,e),!1===this._options.publishEvents?this._publisher.disable():this._publisher.on("error",function(e){t._log.warn("Cannot connect to insights.",e)}),this._publisher},T.prototype._setupStream=function(){var t=this;return this._stream&&(this._log.info("Found existing stream; destroying..."),this._destroyStream()),this._log.info("Setting up VSP"),this._stream=new(this._options.PStream||x)(this.token,this._chunderURIs,{backoffMaxMs:this._options.backoffMaxMs,maxPreferredDurationMs:this._options.maxCallSignalingTimeoutMs}),this._stream.addListener("close",this._onSignalingClose),this._stream.addListener("connected",this._onSignalingConnected),this._stream.addListener("error",this._onSignalingError),this._stream.addListener("invite",this._onSignalingInvite),this._stream.addListener("offline",this._onSignalingOffline),this._stream.addListener("ready",this._onSignalingReady),this._streamConnectedPromise=new Promise(function(e){return t._stream.once("connected",function(){e(t._stream)})})},T.prototype._showIncomingCall=function(e,t){var n,r=this;return Promise.race([t(),new Promise(function(e,t){n=setTimeout(function(){t(new Error("Playing incoming ringtone took too long; it might not play. Continuing execution..."))},2e3)})]).catch(function(e){r._log.info(e.message)}).then(function(){clearTimeout(n),r.emit(T.EventName.Incoming,e)})},T.prototype._startRegistrationTimer=function(){var e=this;this._stopRegistrationTimer(),this._regTimer=setTimeout(function(){e._sendPresence(!0)},3e4)},T.prototype._stopRegistrationTimer=function(){this._regTimer&&clearTimeout(this._regTimer)},T.prototype._throwIfDestroyed=function(){if(this.state===T.State.Destroyed)throw new m.InvalidStateError("Device has been destroyed.")},T.prototype._updateRingtoneSinkIds=function(e){return Promise.resolve(this._soundcache.get(T.SoundName.Incoming).setSinkIds(e))},T.prototype._updateSpeakerSinkIds=function(t){Array.from(this._soundcache.entries()).filter(function(e){return e[0]!==T.SoundName.Incoming}).forEach(function(e){return e[1].setSinkIds(t)}),this._callSinkIds=t;var e=this._activeCall;return e?e._setSinkIds(t):Promise.resolve()},T._defaultSounds={disconnect:{filename:"disconnect",maxDuration:3e3},dtmf0:{filename:"dtmf-0",maxDuration:1e3},dtmf1:{filename:"dtmf-1",maxDuration:1e3},dtmf2:{filename:"dtmf-2",maxDuration:1e3},dtmf3:{filename:"dtmf-3",maxDuration:1e3},dtmf4:{filename:"dtmf-4",maxDuration:1e3},dtmf5:{filename:"dtmf-5",maxDuration:1e3},dtmf6:{filename:"dtmf-6",maxDuration:1e3},dtmf7:{filename:"dtmf-7",maxDuration:1e3},dtmf8:{filename:"dtmf-8",maxDuration:1e3},dtmf9:{filename:"dtmf-9",maxDuration:1e3},dtmfh:{filename:"dtmf-hash",maxDuration:1e3},dtmfs:{filename:"dtmf-star",maxDuration:1e3},incoming:{filename:"incoming",shouldLoop:!0},outgoing:{filename:"outgoing",maxDuration:3e3}},T);function T(e,t){void 0===t&&(t={});var n,a=i.call(this)||this;if(a._activeCall=null,a._audio=null,a._callInputStream=null,a._calls=[],a._callSinkIds=["default"],a._chunderURIs=[],a._defaultOptions={allowIncomingWhileBusy:!1,closeProtection:!1,codecPreferences:[p.default.Codec.PCMU,p.default.Codec.Opus],dscp:!0,forceAggressiveIceNomination:!1,logLevel:f.levels.ERROR,maxCallSignalingTimeoutMs:0,preflight:!1,sounds:{},tokenRefreshMs:1e4,voiceEventSidGenerator:_.generateVoiceEventSid},a._edge=null,a._enabledSounds=((n={})[T.SoundName.Disconnect]=!0,n[T.SoundName.Incoming]=!0,n[T.SoundName.Outgoing]=!0,n),a._home=null,a._identity=null,a._log=y.default.getInstance(),a._options={},a._preferredURI=null,a._publisher=null,a._region=null,a._regTimer=null,a._shouldReRegister=!1,a._soundcache=new Map,a._state=T.State.Unregistered,a._stateEventMapping=((n={})[T.State.Destroyed]=T.EventName.Destroyed,n[T.State.Unregistered]=T.EventName.Unregistered,n[T.State.Registering]=T.EventName.Registering,n[T.State.Registered]=T.EventName.Registered,n),a._stream=null,a._streamConnectedPromise=null,a._tokenWillExpireTimeout=null,a._createDefaultPayload=function(e){var t,n={aggressive_nomination:a._options.forceAggressiveIceNomination,browser_extension:a._isBrowserExtension,dscp:!!a._options.dscp,ice_restart_enabled:!0,platform:S.getMediaEngine(),sdk_version:w.RELEASE_VERSION};function r(e,t){t&&(n[e]=t)}return e&&(t=e.parameters.CallSid,r("call_sid",/^TJ/.test(t)?void 0:t),r("temp_call_sid",e.outboundConnectionId),r("audio_codec",e.codec),n.direction=e.direction),r("gateway",a._stream&&a._stream.gateway),r("region",a._stream&&a._stream.region),n},a._onSignalingClose=function(){a._stream=null,a._streamConnectedPromise=null},a._onSignalingConnected=function(e){var t=g.getRegionShortcode(e.region),t=(a._edge=e.edge||g.regionToEdge[t]||e.region,a._region=t||e.region,a._home=e.home,null!=(t=a._publisher)&&t.setHost(g.createEventGatewayURI(e.home)),e.token&&(a._identity=e.token.identity,"number"==typeof e.token.ttl)&&"number"==typeof a._options.tokenRefreshMs&&(t=1e3*e.token.ttl,e=Math.max(0,t-a._options.tokenRefreshMs),a._tokenWillExpireTimeout=setTimeout(function(){a.emit("tokenWillExpire",a),a._tokenWillExpireTimeout&&(clearTimeout(a._tokenWillExpireTimeout),a._tokenWillExpireTimeout=null)},e)),g.getChunderURIs(a._edge));0<t.length?(e=t[0],a._preferredURI=g.createSignalingEndpointURL(e)):a._log.info("Could not parse a preferred URI from the stream#connected event."),a._shouldReRegister&&a.register()},a._onSignalingError=function(e){var t,n,r,i;"object"==typeof e&&(t=e.error,e=e.callsid,"object"==typeof t)&&(e="string"==typeof e&&a._findCall(e)||void 0,n=t.code,r=t.message,i=t.twilioError,"number"==typeof n&&(31201===n?i=new m.AuthorizationErrors.AuthenticationFailed(t):31204===n?i=new m.AuthorizationErrors.AccessTokenInvalid(t):31205===n?(a._stopRegistrationTimer(),i=new m.AuthorizationErrors.AccessTokenExpired(t)):m.hasErrorByCode(n)&&(i=new(m.getErrorByCode(n))(t))),i||(a._log.error("Unknown signaling error: ",t),i=new m.GeneralErrors.UnknownError(r,t)),a._log.info("Received error: ",i),a.emit(T.EventName.Error,i,e))},a._onSignalingInvite=function(o){return c(a,void 0,void 0,function(){var t,n,r,i=this;return u(this,function(e){switch(e.label){case 0:return(t=!!this._activeCall)&&!this._options.allowIncomingWhileBusy?(this._log.info("Device busy; ignoring incoming invite"),[2]):o.callsid&&o.sdp?((r=o.parameters||{}).CallSid=r.CallSid||o.callsid,n=Object.assign({},b.queryToJson(r.Params)),[4,this._makeCall(n,{callParameters:r,offerSdp:o.sdp,reconnectToken:o.reconnect,voiceEventSidGenerator:this._options.voiceEventSidGenerator})]):(this.emit(T.EventName.Error,new m.ClientErrors.BadRequest("Malformed invite from gateway")),[2]);case 1:return n=e.sent(),this._calls.push(n),n.once("accept",function(){i._soundcache.get(T.SoundName.Incoming).stop(),i._publishNetworkChange()}),r=this._enabledSounds.incoming&&!t?function(){return i._soundcache.get(T.SoundName.Incoming).play()}:function(){return Promise.resolve()},this._showIncomingCall(n,r),[2]}})})},a._onSignalingOffline=function(){a._log.info("Stream is offline"),a._edge=null,a._region=null,a._shouldReRegister=a.state!==T.State.Unregistered,a._setState(T.State.Unregistered)},a._onSignalingReady=function(){a._log.info("Stream is ready"),a._setState(T.State.Registered)},a._publishNetworkChange=function(){a._activeCall&&a._networkInformation&&a._publisher.info("network-information","network-change",{connection_type:a._networkInformation.type,downlink:a._networkInformation.downlink,downlinkMax:a._networkInformation.downlinkMax,effective_type:a._networkInformation.effectiveType,rtt:a._networkInformation.rtt},a._activeCall)},a._updateInputStream=function(e){var t=a._activeCall;return t&&!e?Promise.reject(new m.InvalidStateError("Cannot unset input device while a call is in progress.")):(a._callInputStream=e,t?t._setInputTracksFromStream(e):Promise.resolve())},a._updateSinkIds=function(t,n){return("ringtone"===t?a._updateRingtoneSinkIds(n):a._updateSpeakerSinkIds(n)).then(function(){a._publisher.info("audio",t+"-devices-set",{audio_device_ids:n},a._activeCall)},function(e){throw a._publisher.error("audio",t+"-devices-set-failed",{audio_device_ids:n,message:e.message},a._activeCall),e})},a.updateToken(e),b.isLegacyEdge())throw new m.NotSupportedError("Microsoft Edge Legacy (https://support.microsoft.com/en-us/help/4533505/what-is-microsoft-edge-legacy) is deprecated and will not be able to connect to Twilio to make or receive calls after September 1st, 2020. Please see this documentation for a list of supported browsers https://www.twilio.com/docs/voice/client/javascript#supported-browsers");if(T.isSupported||!t.ignoreBrowserSupport)return window&&(e=(n=window).msBrowser||n.browser||n.chrome,a._isBrowserExtension=!!e&&!!e.runtime&&!!e.runtime.id||!!n.safari&&!!n.safari.extension),a._isBrowserExtension&&a._log.info("Running as browser extension."),navigator&&(e=navigator,a._networkInformation=e.connection||e.mozConnection||e.webkitConnection),a._networkInformation&&"function"==typeof a._networkInformation.addEventListener&&a._networkInformation.addEventListener("change",a._publishNetworkChange),T._getOrCreateAudioContext(),T._audioContext&&!T._dialtonePlayer&&(T._dialtonePlayer=new h.default(T._audioContext)),void 0===T._isUnifiedPlanDefault&&(T._isUnifiedPlanDefault="undefined"!=typeof window&&"undefined"!=typeof RTCPeerConnection&&"undefined"!=typeof RTCRtpTransceiver&&b.isUnifiedPlanDefault(window,window.navigator,RTCPeerConnection,RTCRtpTransceiver)),a._boundDestroy=a.destroy.bind(a),a._boundConfirmClose=a._confirmClose.bind(a),"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("unload",a._boundDestroy),window.addEventListener("pagehide",a._boundDestroy)),a.updateOptions(t),a;if(window&&window.location&&"http:"===window.location.protocol)throw new m.NotSupportedError("twilio.js wasn't able to find WebRTC browser support.           This is most likely because this page is served over http rather than https,           which does not support WebRTC in many browsers. Please load this page over https and           try again.");throw new m.NotSupportedError("twilio.js 1.3+ SDKs require WebRTC browser support.         For more information, see <https://www.twilio.com/docs/api/client/twilio-js>.         If you have any questions about this announcement, please contact         Twilio Support at <help@twilio.com>.")}a=e=T||{},(o=a.EventName||(a.EventName={})).Error="error",o.Incoming="incoming",o.Destroyed="destroyed",o.Unregistered="unregistered",o.Registering="registering",o.Registered="registered",o.TokenWillExpire="tokenWillExpire",(o=a.State||(a.State={})).Destroyed="destroyed",o.Unregistered="unregistered",o.Registering="registering",o.Registered="registered",(o=a.SoundName||(a.SoundName={})).Incoming="incoming",o.Outgoing="outgoing",o.Disconnect="disconnect",o.Dtmf0="dtmf0",o.Dtmf1="dtmf1",o.Dtmf2="dtmf2",o.Dtmf3="dtmf3",o.Dtmf4="dtmf4",o.Dtmf5="dtmf5",o.Dtmf6="dtmf6",o.Dtmf7="dtmf7",o.Dtmf8="dtmf8",o.Dtmf9="dtmf9",o.DtmfS="dtmfs",o.DtmfH="dtmfh",n.default=e},{"./audiohelper":5,"./call":6,"./constants":7,"./dialtonePlayer":10,"./errors":12,"./eventpublisher":14,"./log":15,"./preflight/preflight":17,"./pstream":18,"./regions":19,"./rtc":23,"./rtc/getusermedia":21,"./sound":33,"./util":35,"./uuid":36,events:53,loglevel:55}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("./errors"),o={dtmf0:[1360,960],dtmf1:[1230,720],dtmf2:[1360,720],dtmf3:[1480,720],dtmf4:[1230,790],dtmf5:[1360,790],dtmf6:[1480,790],dtmf7:[1230,870],dtmf8:[1360,870],dtmf9:[1480,870],dtmfh:[1480,960],dtmfs:[1230,960]};function r(e){var t=this;this._context=e,this._gainNodes=[],this._gainNodes=[this._context.createGain(),this._context.createGain()],this._gainNodes.forEach(function(e){e.connect(t._context.destination),e.gain.value=.1,t._gainNodes.push(e)})}r.prototype.cleanup=function(){this._gainNodes.forEach(function(e){e.disconnect()})},r.prototype.play=function(e){var n=this,r=o[e];if(!r)throw new i.InvalidArgumentError("Invalid DTMF sound name");[this._context.createOscillator(),this._context.createOscillator()].forEach(function(e,t){e.type="sine",e.frequency.value=r[t],e.connect(n._gainNodes[t]),e.start(),e.stop(n._context.currentTime+.1),e.addEventListener("ended",function(){return e.disconnect()})})},n.default=r},{"./errors":12}],11:[function(e,L,t){"use strict";var r,n,i,o,a,s,N,c,u,l,d,f,p,h=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=(Object.defineProperty(t,"__esModule",{value:!0}),e("./twilioError")),m=(t.TwilioError=e.default,t.AuthorizationErrors||(t.AuthorizationErrors={}));function U(e,t){var n=p.call(this,e,t)||this,r=(n.causes=[],n.code=20101,n.description="Invalid access token",n.explanation="Twilio was unable to validate your Access Token",n.name="AccessTokenInvalid",n.solutions=[],Object.setPrototypeOf(n,m.AccessTokenInvalid.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}p=e.default,h(U,p),m.AccessTokenInvalid=U,y=e.default,h(F,y);var y;function F(e,t){var n=y.call(this,e,t)||this,r=(n.causes=[],n.code=20104,n.description="Access token expired or expiration date invalid",n.explanation="The Access Token provided to the Twilio API has expired, the expiration time specified in the token was invalid, or the expiration time specified was too far in the future",n.name="AccessTokenExpired",n.solutions=[],Object.setPrototypeOf(n,m.AccessTokenExpired.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}m.AccessTokenExpired=F,v=e.default,h(B,v);var v;function B(e,t){var n=v.call(this,e,t)||this,r=(n.causes=[],n.code=20151,n.description="Authentication Failed",n.explanation="The Authentication with the provided JWT failed",n.name="AuthenticationFailed",n.solutions=[],Object.setPrototypeOf(n,m.AuthenticationFailed.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}function q(e,t){var n=a.call(this,e,t)||this,r=(n.causes=[],n.code=31400,n.description="Bad Request (HTTP/SIP)",n.explanation="The request could not be understood due to malformed syntax.",n.name="BadRequest",n.solutions=[],Object.setPrototypeOf(n,o.BadRequest.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}m.AuthenticationFailed=B,o=i=t.ClientErrors||(t.ClientErrors={}),a=e.default,h(q,a),o.BadRequest=q;var g,b=s=t.GeneralErrors||(t.GeneralErrors={});function z(e,t){var n=g.call(this,e,t)||this,r=(n.causes=[],n.code=31e3,n.description="Unknown Error",n.explanation="An unknown error has occurred. See error details for more information.",n.name="UnknownError",n.solutions=[],Object.setPrototypeOf(n,b.UnknownError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}g=e.default,h(z,g),b.UnknownError=z,_=e.default,h(W,_);var _;function W(e,t){var n=_.call(this,e,t)||this,r=(n.causes=[],n.code=31005,n.description="Connection error",n.explanation="A connection error occurred during the call",n.name="ConnectionError",n.solutions=[],Object.setPrototypeOf(n,b.ConnectionError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}b.ConnectionError=W,w=e.default,h(G,w);var w;function G(e,t){var n=w.call(this,e,t)||this,r=(n.causes=["The incoming call was cancelled because it was not answered in time or it was accepted/rejected by another application instance registered with the same identity."],n.code=31008,n.description="Call cancelled",n.explanation="Unable to answer because the call has ended",n.name="CallCancelledError",n.solutions=[],Object.setPrototypeOf(n,b.CallCancelledError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}b.CallCancelledError=G,k=e.default,h(V,k);var k;function V(e,t){var n=k.call(this,e,t)||this,r=(n.causes=[],n.code=31009,n.description="Transport error",n.explanation="No transport available to send or receive messages",n.name="TransportError",n.solutions=[],Object.setPrototypeOf(n,b.TransportError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}function H(e,t){var n=u.call(this,e,t)||this,r=(n.causes=["Invalid content or MessageType passed to sendMessage method."],n.code=31100,n.description="The request had malformed syntax.",n.explanation="The request could not be understood due to malformed syntax.",n.name="MalformedRequestError",n.solutions=["Ensure content and MessageType passed to sendMessage method are valid."],Object.setPrototypeOf(n,c.MalformedRequestError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}b.TransportError=V,c=N=t.MalformedRequestErrors||(t.MalformedRequestErrors={}),u=e.default,h(H,u),c.MalformedRequestError=H;var x,S=n=t.AuthorizationErrors||(t.AuthorizationErrors={});function J(e,t){var n=x.call(this,e,t)||this,r=(n.causes=["Rate limit exceeded."],n.code=31206,n.description="Rate exceeded authorized limit.",n.explanation="The request performed exceeds the authorized limit.",n.name="RateExceededError",n.solutions=["Ensure message send rate does not exceed authorized limits."],Object.setPrototypeOf(n,S.RateExceededError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}x=e.default,h(J,x),S.RateExceededError=J,E=e.default,h($,E);var E;function $(e,t){var n=E.call(this,e,t)||this,r=(n.causes=["The payload size of Call Message Event exceeds the authorized limit."],n.code=31209,n.description="Call Message Event Payload size exceeded authorized limit.",n.explanation="The request performed to send a Call Message Event exceeds the payload size authorized limit",n.name="PayloadSizeExceededError",n.solutions=["Reduce payload size of Call Message Event to be within the authorized limit and try again."],Object.setPrototypeOf(n,S.PayloadSizeExceededError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}S.PayloadSizeExceededError=$;var C,T=l=t.UserMediaErrors||(t.UserMediaErrors={});function K(e,t){var n=C.call(this,e,t)||this,r=(n.causes=["The user denied the getUserMedia request.","The browser denied the getUserMedia request."],n.code=31401,n.description="UserMedia Permission Denied Error",n.explanation="The browser or end-user denied permissions to user media. Therefore we were unable to acquire input audio.",n.name="PermissionDeniedError",n.solutions=["The user should accept the request next time prompted. If the browser saved the deny, the user should change that permission in their browser.","The user should to verify that the browser has permission to access the microphone at this address."],Object.setPrototypeOf(n,T.PermissionDeniedError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}C=e.default,h(K,C),T.PermissionDeniedError=K,I=e.default,h(Y,I);var I;function Y(e,t){var n=I.call(this,e,t)||this,r=(n.causes=["NotFoundError - The deviceID specified was not found.","The getUserMedia constraints were overconstrained and no devices matched."],n.code=31402,n.description="UserMedia Acquisition Failed Error",n.explanation="The browser and end-user allowed permissions, however getting the media failed. Usually this is due to bad constraints, but can sometimes fail due to browser, OS or hardware issues.",n.name="AcquisitionFailedError",n.solutions=["Ensure the deviceID being specified exists.","Try acquiring media with fewer constraints."],Object.setPrototypeOf(n,T.AcquisitionFailedError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}T.AcquisitionFailedError=Y;var R,P=d=t.SignalingErrors||(t.SignalingErrors={});function Q(e,t){var n=R.call(this,e,t)||this,r=(n.causes=[],n.code=53e3,n.description="Signaling connection error",n.explanation="Raised whenever a signaling connection error occurs that is not covered by a more specific error code.",n.name="ConnectionError",n.solutions=[],Object.setPrototypeOf(n,P.ConnectionError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}R=e.default,h(Q,R),P.ConnectionError=Q,O=e.default,h(X,O);var O;function X(e,t){var n=O.call(this,e,t)||this,r=(n.causes=["The device running your application lost its Internet connection."],n.code=53001,n.description="Signaling connection disconnected",n.explanation="Raised whenever the signaling connection is unexpectedly disconnected.",n.name="ConnectionDisconnected",n.solutions=["Ensure the device running your application has access to a stable Internet connection."],Object.setPrototypeOf(n,P.ConnectionDisconnected.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}P.ConnectionDisconnected=X;var A,M=f=t.MediaErrors||(t.MediaErrors={});function Z(e,t){var n=A.call(this,e,t)||this,r=(n.causes=["The Client may not be using a supported WebRTC implementation.","The Client may not have the necessary resources to create or apply a new media description."],n.code=53400,n.description="Client is unable to create or apply a local media description",n.explanation="Raised whenever a Client is unable to create or apply a local media description.",n.name="ClientLocalDescFailed",n.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(n,M.ClientLocalDescFailed.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}A=e.default,h(Z,A),M.ClientLocalDescFailed=Z,D=e.default,h(ee,D);var D;function ee(e,t){var n=D.call(this,e,t)||this,r=(n.causes=["The Client may not be using a supported WebRTC implementation.","The Client may be connecting peer-to-peer with another Participant that is not using a supported WebRTC implementation.","The Client may not have the necessary resources to apply a new media description."],n.code=53402,n.description="Client is unable to apply a remote media description",n.explanation="Raised whenever the Client receives a remote media description but is unable to apply it.",n.name="ClientRemoteDescFailed",n.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(n,M.ClientRemoteDescFailed.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}M.ClientRemoteDescFailed=ee,j=e.default,h(te,j);var j;function te(e,t){var n=j.call(this,e,t)||this,r=(n.causes=["The Client was unable to establish a media connection.","A media connection which was active failed liveliness checks."],n.code=53405,n.description="Media connection failed",n.explanation="Raised by the Client or Server whenever a media connection fails.",n.name="ConnectionError",n.solutions=["If the problem persists, try connecting to another region.","Check your Client's network connectivity.","If you've provided custom ICE Servers then ensure that the URLs and credentials are valid."],Object.setPrototypeOf(n,M.ConnectionError.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}M.ConnectionError=te,t.errorsByCode=new Map([[20101,n.AccessTokenInvalid],[20104,n.AccessTokenExpired],[20151,n.AuthenticationFailed],[31400,i.BadRequest],[31e3,s.UnknownError],[31005,s.ConnectionError],[31008,s.CallCancelledError],[31009,s.TransportError],[31100,N.MalformedRequestError],[31206,n.RateExceededError],[31209,n.PayloadSizeExceededError],[31401,l.PermissionDeniedError],[31402,l.AcquisitionFailedError],[53e3,d.ConnectionError],[53001,d.ConnectionDisconnected],[53400,f.ClientLocalDescFailed],[53402,f.ClientRemoteDescFailed],[53405,f.ConnectionError]]),Object.freeze(t.errorsByCode)},{"./twilioError":13}],12:[function(e,t,n){"use strict";var r,i,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=(Object.defineProperty(n,"__esModule",{value:!0}),e("./generated")),s=(n.AuthorizationErrors=a.AuthorizationErrors,n.ClientErrors=a.ClientErrors,n.GeneralErrors=a.GeneralErrors,n.MediaErrors=a.MediaErrors,n.SignalingErrors=a.SignalingErrors,n.TwilioError=a.TwilioError,n.UserMediaErrors=a.UserMediaErrors,i=Error,o(c,i),c);function c(e){e=i.call(this,e)||this;return e.name="InvalidArgumentError",e}n.InvalidArgumentError=s;u=Error,o(l,u);var u,e=l;function l(e){e=u.call(this,e)||this;return e.name="InvalidStateError",e}n.InvalidStateError=e;d=Error,o(f,d);var d,e=f;function f(e){e=d.call(this,e)||this;return e.name="NotSupportedError",e}n.NotSupportedError=e,n.getErrorByCode=function(e){var t=a.errorsByCode.get(e);if(t)return t;throw new s("Error code "+e+" not found")},n.hasErrorByCode=function(e){return a.errorsByCode.has(e)}},{"./generated":11}],13:[function(e,t,n){"use strict";var r,i,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=(Object.defineProperty(n,"__esModule",{value:!0}),i=Error,o(a,i),a);function a(e,t){var n=i.call(this)||this,r=(Object.setPrototypeOf(n,a.prototype),"string"==typeof e?e:n.explanation),e="object"==typeof e?e:t;return n.message=n.name+" ("+n.code+"): "+r,n.originalError=e,n}n.default=o},{}],14:[function(e,t,n){"use strict";function c(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}var r=e("events").EventEmitter,u=e("./request"),e=function(){var e=s,t=r;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);function s(e,t,n){var r,i,o,a;if(this instanceof s)return(r=c(this,(s.__proto__||Object.getPrototypeOf(s)).call(this)))instanceof s?("function"!=typeof(i=(n=Object.assign({defaultPayload:function(){return{}}},n)).defaultPayload)&&(i=function(){return Object.assign({},n.defaultPayload)}),o=!0,a=Object.assign({app_name:void 0,app_version:void 0},n.metadata),Object.defineProperties(r,{_defaultPayload:{value:i},_isEnabled:{get:function(){return o},set:function(e){o=e}},_host:{value:n.host,writable:!0},_log:{value:n.log},_request:{value:n.request||u,writable:!0},_token:{value:t,writable:!0},isEnabled:{enumerable:!0,get:function(){return o}},metadata:{enumerable:!0,get:function(){return a}},productName:{enumerable:!0,value:e},token:{enumerable:!0,get:function(){return this._token}}}),r):c(r,new s(e,t,n));throw new TypeError("Cannot call a class as a function")}return e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t),s}();function l(e){return{timestamp:new Date(e.timestamp).toISOString(),total_packets_received:e.totals.packetsReceived,total_packets_lost:e.totals.packetsLost,total_packets_sent:e.totals.packetsSent,total_bytes_received:e.totals.bytesReceived,total_bytes_sent:e.totals.bytesSent,packets_received:e.packetsReceived,packets_lost:e.packetsLost,packets_lost_fraction:e.packetsLostFraction&&Math.round(100*e.packetsLostFraction)/100,bytes_received:e.bytesReceived,bytes_sent:e.bytesSent,audio_codec:e.codecName,audio_level_in:e.audioInputLevel,audio_level_out:e.audioOutputLevel,call_volume_input:e.inputVolume,call_volume_output:e.outputVolume,jitter:e.jitter,rtt:e.rtt,mos:e.mos&&Math.round(100*e.mos)/100}}e.prototype._post=function(e,t,n,r,i,o,a){var s,c=this;return(this.isEnabled||a)&&this._host&&o&&(o.parameters&&o.parameters.CallSid||o.outboundConnectionId)?(a={publisher:this.productName,group:n,name:r,timestamp:(new Date).toISOString(),level:t.toUpperCase(),payload_type:"application/json",private:!1,payload:i&&i.forEach?i.slice(0):Object.assign(this._defaultPayload(o),i)},this.metadata&&(a.publisher_metadata=this.metadata),s={url:"https://"+this._host+"/v4/"+e,body:a,headers:{"Content-Type":"application/json","X-Twilio-Token":this.token}},new Promise(function(t,n){c._request.post(s,function(e){e?(c.emit("error",e),n(e)):t()})}).catch(function(e){c._log.warn("Unable to post "+n+" "+r+" event to Insights. Received error: "+e)})):Promise.resolve()},e.prototype.post=function(e,t,n,r,i,o){return this._post("EndpointEvents",e,t,n,r,i,o)},e.prototype.debug=function(e,t,n,r){return this.post("debug",e,t,n,r)},e.prototype.info=function(e,t,n,r){return this.post("info",e,t,n,r)},e.prototype.warn=function(e,t,n,r){return this.post("warning",e,t,n,r)},e.prototype.error=function(e,t,n,r){return this.post("error",e,t,n,r)},e.prototype.postMetrics=function(n,r,i,o,a){var s=this;return new Promise(function(e){var t=i.map(l).map(function(e){return Object.assign(e,o)});e(s._post("EndpointMetrics","info",n,r,t,a))})},e.prototype.setHost=function(e){this._host=e},e.prototype.setToken=function(e){this._token=e},e.prototype.enable=function(){this._isEnabled=!0},e.prototype.disable=function(){this._isEnabled=!1},t.exports=e},{"./request":20,events:53}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("loglevel"),i=e("./constants"),e=(o.getInstance=function(){return o.instance=o.instance?o.instance:new o},o.prototype.debug=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).debug.apply(e,t)},o.prototype.error=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).error.apply(e,t)},o.prototype.getLogLevelInstance=function(){return this._log},o.prototype.info=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).info.apply(e,t)},o.prototype.setDefaultLevel=function(e){this._log.setDefaultLevel(e)},o.prototype.warn=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];(e=this._log).warn.apply(e,t)},o.levels=r.levels,o);function o(e){this._log=(e&&e.LogLevelModule?e.LogLevelModule:r).getLogger(i.PACKAGE_NAME)}n.Logger=e.getInstance().getLogLevelInstance(),n.default=e},{"./constants":7,loglevel:55}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("./constants"),o=e("./errors"),i=r.SOUNDS_BASE_URL+"/outgoing.mp3";function a(e,t,n,r){this._name=e,this._availableDevices=t,this._beforeChange=n,this._isSupported=r,this._activeDevices=new Set}a.prototype.delete=function(e){var e=!!this._activeDevices.delete(e),t=this._availableDevices.get("default")||Array.from(this._availableDevices.values())[0],t=(!this._activeDevices.size&&t&&this._activeDevices.add(t),Array.from(this._activeDevices.values()).map(function(e){return e.deviceId}));return this._beforeChange(this._name,t),!!e},a.prototype.get=function(){return this._activeDevices},a.prototype.set=function(e){var t,n,r,i=this;return this._isSupported?(t=Array.isArray(e)?e:[e]).length?(n=[],r=t.map(function(e){var t=i._availableDevices.get(e);return t||n.push(e),t}),n.length?Promise.reject(new o.InvalidArgumentError("Devices not found: "+n.join(", "))):new Promise(function(e){e(i._beforeChange(i._name,t))}).then(function(){i._activeDevices.clear(),r.forEach(i._activeDevices.add,i._activeDevices)})):Promise.reject(new o.InvalidArgumentError("Must specify at least one device to set")):Promise.reject(new o.NotSupportedError("This browser does not support audio output selection"))},a.prototype.test=function(n){return void 0===n&&(n=i),this._isSupported?this._activeDevices.size?Promise.all(Array.from(this._activeDevices).map(function(e){var t;return new Promise(function(e){(t=new Audio(n)).oncanplay=e}).then(function(){return t.setSinkId(e.deviceId).then(function(){return t.play()})})})):Promise.reject(new o.InvalidStateError("No active output devices to test")):Promise.reject(new o.NotSupportedError("This browser does not support audio output selection"))},n.default=a},{"./constants":7,"./errors":12}],17:[function(e,t,n){"use strict";var r,i,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=this&&this.__assign||function(){return(a=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},s=this&&this.__awaiter||function(e,a,s,c){return new(s=s||Promise)(function(n,t){function r(e){try{o(c.next(e))}catch(e){t(e)}}function i(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,i)}o((c=c.apply(e,a||[])).next())})},c=this&&this.__generator||function(r,i){var o,a,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,a&&(s=2&t[0]?a.return:t[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3]))c.label=t[1];else if(6===t[0]&&c.label<s[1])c.label=s[1],s=t;else{if(!(s&&c.label<s[2])){s[2]&&c.ops.pop(),c.trys.pop();continue}c.label=s[2],c.ops.push(t)}}t=i.call(r,c)}catch(e){t=[6,e],a=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},u=(Object.defineProperty(n,"__esModule",{value:!0}),e("events")),l=e("../call"),d=e("../device"),f=e("../errors"),p=e("../rtc/stats"),e=e("../constants"),h=e.COWBELL_AUDIO_URL,m=e.ECHO_TEST_DURATION,e=(i=u.EventEmitter,o(y,i),y.prototype.stop=function(){var e=this,t=new f.GeneralErrors.CallCancelledError;this._device?(this._device.once(d.default.EventName.Unregistered,function(){return e._onFailed(t)}),this._device.destroy()):this._onFailed(t)},y.prototype._emitWarning=function(e,t,n){e={name:e,description:t};n&&(e.rtcWarning=n),this._warnings.push(e),this.emit(y.Events.Warning,e)},y.prototype._getCallQuality=function(e){return 4.2<e?y.CallQuality.Excellent:4.1<=e&&e<=4.2?y.CallQuality.Great:3.7<=e&&e<=4?y.CallQuality.Good:3.1<=e&&e<=3.6?y.CallQuality.Fair:y.CallQuality.Degraded},y.prototype._getReport=function(){var e=this._getRTCStats(),t={start:this._startTime},t=(this._endTime&&(t.end=this._endTime,t.duration=this._endTime-this._startTime),{callSid:this._callSid,edge:this._edge,iceCandidateStats:this._rtcIceCandidateStatsReport.iceCandidateStats,networkTiming:this._networkTiming,samples:this._samples,selectedEdge:this._options.edge,stats:e,testTiming:t,totals:this._getRTCSampleTotals(),warnings:this._warnings}),n=this._rtcIceCandidateStatsReport.selectedIceCandidatePairStats;return n&&(t.selectedIceCandidatePairStats=n,t.isTurnRequired="relay"===n.localCandidate.candidateType||"relay"===n.remoteCandidate.candidateType),e&&(t.callQuality=this._getCallQuality(e.mos.average)),t},y.prototype._getRTCSampleTotals=function(){if(this._latestSample)return a({},this._latestSample.totals)},y.prototype._getRTCStats=function(){var e=this._samples.findIndex(function(e){return"number"==typeof e.mos&&0<e.mos}),r=0<=e?this._samples.slice(e):[];if(r&&r.length)return["jitter","mos","rtt"].reduce(function(e,t){var n=r.map(function(e){return e[t]});return a(a({},e),((e={})[t]={average:Number((n.reduce(function(e,t){return e+t})/n.length).toPrecision(5)),max:Math.max.apply(Math,n),min:Math.min.apply(Math,n)},e))},{})},y.prototype._getStreamFromFile=function(){var e,t,n=this._options.audioContext;if(n)return(e=new Audio(h)).addEventListener("canplaythrough",function(){return e.play()}),"function"==typeof e.setAttribute&&e.setAttribute("crossorigin","anonymous"),t=n.createMediaElementSource(e),n=n.createMediaStreamDestination(),t.connect(n),n.stream;throw new f.NotSupportedError("Cannot fake input audio stream: AudioContext is not supported by this browser.")},y.prototype._initDevice=function(e,t){var n=this;try{this._device=new(t.deviceFactory||d.default)(e,{codecPreferences:t.codecPreferences,edge:t.edge,fileInputStream:t.fileInputStream,logLevel:t.logLevel,preflight:!0}),this._device.once(d.default.EventName.Registered,function(){n._onDeviceRegistered()}),this._device.once(d.default.EventName.Error,function(e){n._onDeviceError(e)}),this._device.register()}catch(e){return void setTimeout(function(){n._onFailed(e)})}this._signalingTimeoutTimer=setTimeout(function(){n._onDeviceError(new f.SignalingErrors.ConnectionError("WebSocket Connection Timeout"))},t.signalingTimeoutMs)},y.prototype._onDeviceError=function(e){this._device.destroy(),this._onFailed(e)},y.prototype._onDeviceRegistered=function(){return s(this,void 0,void 0,function(){var t,n,r=this;return c(this,function(e){switch(e.label){case 0:return clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),[4,(t=this)._device.connect({rtcConfiguration:this._options.rtcConfiguration})];case 1:return t._call=e.sent(),this._networkTiming.signaling={start:Date.now()},this._setupCallHandlers(this._call),this._edge=this._device.edge||void 0,this._options.fakeMicInput&&(this._echoTimer=setTimeout(function(){return r._device.disconnectAll()},m),n=this._device.audio)&&(n.disconnect(!1),n.outgoing(!1)),this._call.once("disconnect",function(){r._device.once(d.default.EventName.Unregistered,function(){return r._onUnregistered()}),r._device.destroy()}),this._call._publisher.on("error",function(){r._hasInsightsErrored||r._emitWarning("insights-connection-error","Received an error when attempting to connect to Insights gateway"),r._hasInsightsErrored=!0}),[2]}})})},y.prototype._onFailed=function(e){clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=y.Status.Failed,this.emit(y.Events.Failed,e)},y.prototype._onUnregistered=function(){var e=this;setTimeout(function(){e._status!==y.Status.Failed&&(clearTimeout(e._echoTimer),clearTimeout(e._signalingTimeoutTimer),e._releaseHandlers(),e._endTime=Date.now(),e._status=y.Status.Completed,e._report=e._getReport(),e.emit(y.Events.Completed,e._report))},10)},y.prototype._releaseHandlers=function(){[this._device,this._call].forEach(function(t){t&&t.eventNames().forEach(function(e){return t.removeAllListeners(e)})})},y.prototype._setupCallHandlers=function(i){var o=this;this._options.fakeMicInput&&i.once("volume",function(){i._mediaHandler.outputs.forEach(function(e){return e.audio.muted=!0})}),i.on("warning",function(e,t){o._emitWarning(e,"Received an RTCWarning. See .rtcWarning for the RTCWarning",t)}),i.once("accept",function(){o._callSid=i._mediaHandler.callSid,o._status=y.Status.Connected,o.emit(y.Events.Connected)}),i.on("sample",function(n){return s(o,void 0,void 0,function(){var t;return c(this,function(e){switch(e.label){case 0:return this._latestSample?[3,2]:[4,((t=this)._options.getRTCIceCandidateStatsReport||p.getRTCIceCandidateStatsReport)(i._mediaHandler.version.pc)];case 1:t._rtcIceCandidateStatsReport=e.sent(),e.label=2;case 2:return this._latestSample=n,this._samples.push(n),this.emit(y.Events.Sample,n),[2]}})})}),[{reportLabel:"peerConnection",type:"pcconnection"},{reportLabel:"ice",type:"iceconnection"},{reportLabel:"dtls",type:"dtlstransport"},{reportLabel:"signaling",type:"signaling"}].forEach(function(e){var t=e.type,n=e.reportLabel,e="on"+t+"statechange",r=i._mediaHandler[e];i._mediaHandler[e]=function(e){var t=o._networkTiming[n]=o._networkTiming[n]||{start:0};"connecting"===e||"checking"===e?t.start=Date.now():"connected"!==e&&"stable"!==e||t.duration||(t.end=Date.now(),t.duration=t.end-t.start),r(e)}})},Object.defineProperty(y.prototype,"callSid",{get:function(){return this._callSid},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"endTime",{get:function(){return this._endTime},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"latestSample",{get:function(){return this._latestSample},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"report",{get:function(){return this._report},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"startTime",{get:function(){return this._startTime},enumerable:!0,configurable:!0}),Object.defineProperty(y.prototype,"status",{get:function(){return this._status},enumerable:!0,configurable:!0}),y);function y(e,t){var n=i.call(this)||this;return n._hasInsightsErrored=!1,n._networkTiming={},n._options={codecPreferences:[l.default.Codec.PCMU,l.default.Codec.Opus],edge:"roaming",fakeMicInput:!1,logLevel:"error",signalingTimeoutMs:1e4},n._status=y.Status.Connecting,Object.assign(n._options,t),n._samples=[],n._warnings=[],n._startTime=Date.now(),n._initDevice(e,a(a({},n._options),{fileInputStream:n._options.fakeMicInput?n._getStreamFromFile():void 0})),n}n.PreflightTest=e,u=e=n.PreflightTest||(n.PreflightTest={}),(o=u.CallQuality||(u.CallQuality={})).Excellent="excellent",o.Great="great",o.Good="good",o.Fair="fair",o.Degraded="degraded",(o=u.Events||(u.Events={})).Completed="completed",o.Connected="connected",o.Failed="failed",o.Sample="sample",o.Warning="warning",(o=u.Status||(u.Status={})).Connecting="connecting",o.Connected="connected",o.Completed="completed",o.Failed="failed",n.PreflightTest=e},{"../call":6,"../constants":7,"../device":9,"../errors":12,"../rtc/stats":29,events:53}],18:[function(e,t,n){"use strict";function c(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}var r=e("./constants"),i=e("events").EventEmitter,u=e("./log").default,l=e("./wstransport").default,e=e("./errors"),o=e.GeneralErrors,a=e.SignalingErrors,e=function(){var e=s,t=i;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);function s(e,t,n){if(!(this instanceof s))throw new TypeError("Cannot call a class as a function");var r=c(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));if(!(r instanceof s))return c(r,new s(e,t,n));var i,o={TransportFactory:l};for(i in n=n||{},o)i in n||(n[i]=o[i]);r.options=n,r.token=e||"",r.status="disconnected",r.gateway=null,r.region=null,r._messageQueue=[],r._preferredUri=null,r._uris=t,r._handleTransportClose=r._handleTransportClose.bind(r),r._handleTransportError=r._handleTransportError.bind(r),r._handleTransportMessage=r._handleTransportMessage.bind(r),r._handleTransportOpen=r._handleTransportOpen.bind(r),r._log=u.getInstance(),r.on("error",function(){});var a=r;return r.addListener("ready",function(){a.status="ready"}),r.addListener("offline",function(){a.status="offline"}),r.addListener("close",function(){a._log.info('Received "close" from server. Destroying PStream...'),a._destroy()}),r.transport=new r.options.TransportFactory(r._uris,{backoffMaxMs:r.options.backoffMaxMs,maxPreferredDurationMs:r.options.maxPreferredDurationMs}),Object.defineProperties(r,{uri:{enumerable:!0,get:function(){return this.transport.uri}}}),r.transport.on("close",r._handleTransportClose),r.transport.on("error",r._handleTransportError),r.transport.on("message",r._handleTransportMessage),r.transport.on("open",r._handleTransportOpen),r.transport.open(),c(r,r)}return e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t),s}();e.prototype._handleTransportClose=function(){this.emit("transportClose"),"disconnected"!==this.status&&("offline"!==this.status&&this.emit("offline",this),this.status="disconnected")},e.prototype._handleTransportError=function(e){e?this.emit("error",void 0!==e.code?{error:e}:e):this.emit("error",{error:{code:31e3,message:"Websocket closed without a provided reason",twilioError:new a.ConnectionDisconnected}})},e.prototype._handleTransportMessage=function(e){var t;e&&e.data&&"string"==typeof e.data&&(t=(e=JSON.parse(e.data)).type,e=e.payload,this.gateway=(e=void 0===e?{}:e).gateway||this.gateway,this.region=e.region||this.region,"error"===t&&e.error&&(e.error.twilioError=new a.ConnectionError),this.emit(t,e))},e.prototype._handleTransportOpen=function(){var t=this;this.status="connected",this.setToken(this.token),this.emit("transportOpen"),this._messageQueue.splice(0,this._messageQueue.length).forEach(function(e){return t._publish.apply(t,function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(e))})},e.toString=function(){return"[Twilio.PStream class]"},e.prototype.toString=function(){return"[Twilio.PStream instance]"},e.prototype.setToken=function(e){this._log.info("Setting token and publishing listen");e={token:this.token=e,browserinfo:(e="undefined"!=typeof navigator?navigator:{},{p:"browser",v:r.RELEASE_VERSION,browser:{userAgent:e.userAgent||"unknown",platform:e.platform||"unknown"},plugin:"rtc"})};this._publish("listen",e)},e.prototype.sendMessage=function(e,t){this._publish("message",{callsid:e,content:t,contenttype:2<arguments.length&&void 0!==arguments[2]?arguments[2]:"application/json",messagetype:arguments[3],voiceeventsid:arguments[4]},!0)},e.prototype.register=function(e){this._publish("register",{media:e},!0)},e.prototype.invite=function(e,t,n,r){this._publish("invite",{callsid:t,sdp:e,preflight:!!n,twilio:r?{params:r}:{}},!0)},e.prototype.reconnect=function(e,t,n,r){this._publish("invite",{callsid:t,sdp:e,reconnect:n,preflight:!1,twilio:r?{params:r}:{}},!0)},e.prototype.answer=function(e,t){this._publish("answer",{sdp:e,callsid:t},!0)},e.prototype.dtmf=function(e,t){this._publish("dtmf",{callsid:e,dtmf:t},!0)},e.prototype.hangup=function(e,t){this._publish("hangup",t?{callsid:e,message:t}:{callsid:e},!0)},e.prototype.reject=function(e){this._publish("reject",{callsid:e},!0)},e.prototype.reinvite=function(e,t){this._publish("reinvite",{sdp:e,callsid:t},!1)},e.prototype._destroy=function(){this.transport.removeListener("close",this._handleTransportClose),this.transport.removeListener("error",this._handleTransportError),this.transport.removeListener("message",this._handleTransportMessage),this.transport.removeListener("open",this._handleTransportOpen),this.transport.close(),this.emit("offline",this)},e.prototype.destroy=function(){return this._log.info("PStream.destroy() called..."),this._destroy(),this},e.prototype.updatePreferredURI=function(e){this._preferredUri=e,this.transport.updatePreferredURI(e)},e.prototype.updateURIs=function(e){this._uris=e,this.transport.updateURIs(this._uris)},e.prototype.publish=function(e,t){return this._publish(e,t,!0)},e.prototype._publish=function(e,t,n){var r=JSON.stringify({type:e,version:"1.6",payload:t});!this.transport.send(r)&&(this.emit("error",{error:{code:31009,message:"No transport available to send or receive messages",twilioError:new o.TransportError}}),n)&&this._messageQueue.push([e,t,!0])},t.exports=e},{"./constants":7,"./errors":12,"./log":15,"./wstransport":37,events:53}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r,i,o=e("./errors");(r=e=n.Edge||(n.Edge={})).Sydney="sydney",r.SaoPaulo="sao-paulo",r.Dublin="dublin",r.Frankfurt="frankfurt",r.Tokyo="tokyo",r.Singapore="singapore",r.Ashburn="ashburn",r.Umatilla="umatilla",r.Roaming="roaming",r.AshburnIx="ashburn-ix",r.SanJoseIx="san-jose-ix",r.LondonIx="london-ix",r.FrankfurtIx="frankfurt-ix",r.SingaporeIx="singapore-ix",r.SydneyIx="sydney-ix",r.TokyoIx="tokyo-ix",(i=r=n.Region||(n.Region={})).Au1="au1",i.Au1Ix="au1-ix",i.Br1="br1",i.De1="de1",i.De1Ix="de1-ix",i.Gll="gll",i.Ie1="ie1",i.Ie1Ix="ie1-ix",i.Ie1Tnx="ie1-tnx",i.Jp1="jp1",i.Jp1Ix="jp1-ix",i.Sg1="sg1",i.Sg1Ix="sg1-ix",i.Sg1Tnx="sg1-tnx",i.Us1="us1",i.Us1Ix="us1-ix",i.Us1Tnx="us1-tnx",i.Us2="us2",i.Us2Ix="us2-ix",i.Us2Tnx="us2-tnx",n.regionShortcodes={ASIAPAC_SINGAPORE:r.Sg1,ASIAPAC_SYDNEY:r.Au1,ASIAPAC_TOKYO:r.Jp1,EU_FRANKFURT:r.De1,EU_IRELAND:r.Ie1,SOUTH_AMERICA_SAO_PAULO:r.Br1,US_EAST_VIRGINIA:r.Us1,US_WEST_OREGON:r.Us2},n.regionToEdge=((i={})[r.Au1]=e.Sydney,i[r.Br1]=e.SaoPaulo,i[r.Ie1]=e.Dublin,i[r.De1]=e.Frankfurt,i[r.Jp1]=e.Tokyo,i[r.Sg1]=e.Singapore,i[r.Us1]=e.Ashburn,i[r.Us2]=e.Umatilla,i[r.Gll]=e.Roaming,i[r.Us1Ix]=e.AshburnIx,i[r.Us2Ix]=e.SanJoseIx,i[r.Ie1Ix]=e.LondonIx,i[r.De1Ix]=e.FrankfurtIx,i[r.Sg1Ix]=e.SingaporeIx,i[r.Au1Ix]=e.SydneyIx,i[r.Jp1Ix]=e.TokyoIx,i[r.Us1Tnx]=e.AshburnIx,i[r.Us2Tnx]=e.AshburnIx,i[r.Ie1Tnx]=e.LondonIx,i[r.Sg1Tnx]=e.SingaporeIx,i),n.defaultEdge=e.Roaming;function a(e){return"voice-js."+e+".twilio.com"}n.createEventGatewayURI=function(e){return e?"eventgw."+e+".twilio.com":"eventgw.twilio.com"},n.createSignalingEndpointURL=function(e){return"wss://"+e+"/signal"},n.getChunderURIs=function(e){if(e&&"string"!=typeof e&&!Array.isArray(e))throw new o.InvalidArgumentError("If `edge` is provided, it must be of type `string` or an array of strings.");return e?(Array.isArray(e)?e:[e]).map(a):[a(n.defaultEdge)]},n.getRegionShortcode=function(e){return n.regionShortcodes[e]||null}},{"./errors":12}],20:[function(e,t,n){"use strict";var a=e("xmlhttprequest").XMLHttpRequest;e=function(e,t,n){var r,i={},o=(i.XMLHttpRequest=i.XMLHttpRequest||a,new i.XMLHttpRequest);for(r in o.open(e,t.url,!0),o.onreadystatechange=function(){4===o.readyState&&(200<=o.status&&o.status<300?n(null,o.responseText):n(new Error(o.responseText)))},t.headers)o.setRequestHeader(r,t.headers[r]);o.send(JSON.stringify(t.body))};e.get=function(e,t){return new this("GET",e,t)},e.post=function(e,t){return new this("POST",e,t)},t.exports=e},{xmlhttprequest:2}],21:[function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=e("../errors").NotSupportedError,a=e("../util");t.exports=function(n,r){return(r=r||{}).util=r.util||a,r.navigator=r.navigator||("undefined"!=typeof navigator?navigator:null),new Promise(function(e,t){if(!r.navigator)throw new o("getUserMedia is not supported");switch("function"){case i(r.navigator.mediaDevices&&r.navigator.mediaDevices.getUserMedia):return e(r.navigator.mediaDevices.getUserMedia(n));case i(r.navigator.webkitGetUserMedia):return r.navigator.webkitGetUserMedia(n,e,t);case i(r.navigator.mozGetUserMedia):return r.navigator.mozGetUserMedia(n,e,t);case i(r.navigator.getUserMedia):return r.navigator.getUserMedia(n,e,t);default:throw new o("getUserMedia is not supported")}}).catch(function(e){throw r.util.isFirefox()&&"NotReadableError"===e.name?new o("Firefox does not currently support opening multiple audio input trackssimultaneously, even across different tabs.\nRelated Bugzilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324"):e})}},{"../errors":12,"../util":35}],22:[function(e,t,n){"use strict";function r(e,t){void 0===t&&(t=!1),this.deleted=!1;var n,r=e.candidate.split("network-cost ");r[1]&&(n=parseInt(r[1],10)),this.candidateType=e.type,this.ip=e.ip||e.address,this.isRemote=t,this.networkCost=n,this.port=e.port,this.priority=e.priority,this.protocol=e.protocol,this.relatedAddress=e.relatedAddress,this.relatedPort=e.relatedPort,this.tcpType=e.tcpType,this.transportId=e.sdpMid}Object.defineProperty(n,"__esModule",{value:!0}),r.prototype.toPayload=function(){return{candidate_type:this.candidateType,deleted:this.deleted,ip:this.ip,is_remote:this.isRemote,"network-cost":this.networkCost,port:this.port,priority:this.priority,protocol:this.protocol,related_address:this.relatedAddress,related_port:this.relatedPort,tcp_type:this.tcpType,transport_id:this.transportId}},n.IceCandidate=r},{}],23:[function(e,t,n){"use strict";var r=e("./peerconnection"),i=e("./rtcpc").test;t.exports={enabled:function(){return i()},getMediaEngine:function(){return"undefined"!=typeof RTCIceGatherer?"ORTC":"WebRTC"},PeerConnection:r}},{"./peerconnection":26,"./rtcpc":27}],24:[function(e,t,n){var r="undefined"!=typeof window?window.RTCStatsReport:void 0;function i(e){if(!(this instanceof i))return new i(e);var t=this;Object.defineProperties(this,{size:{enumerable:!0,get:function(){return t._map.size}},_map:{value:e}}),this[Symbol.iterator]=e[Symbol.iterator]}function l(e){return{type:"transport",id:e.id,timestamp:Date.parse(e.timestamp),bytesSent:void 0,bytesReceived:void 0,rtcpTransportStatsId:void 0,dtlsState:void 0,selectedCandidatePairId:e.stat("selectedCandidatePairId"),localCertificateId:e.stat("localCertificateId"),remoteCertificateId:e.stat("remoteCertificateId")}}function d(e,t){return{id:e.id,timestamp:Date.parse(e.timestamp),ssrc:e.stat("ssrc"),associateStatsId:void 0,isRemote:void 0,mediaType:e.stat("mediaType"),trackId:"track-"+e.id,transportId:e.stat("transportId"),codecId:"codec-"+e.id,firCount:t?h(e,"googFirsSent"):void 0,pliCount:h(e,t?"googPlisSent":"googPlisReceived"),nackCount:h(e,t?"googNacksSent":"googNacksReceived"),sliCount:void 0,qpSum:h(e,"qpSum")}}function f(e,t){return{type:t?"remote-candidate":"local-candidate",id:e.id,timestamp:Date.parse(e.timestamp),transportId:void 0,isRemote:t,ip:e.stat("ipAddress"),port:h(e,"portNumber"),protocol:e.stat("transport"),candidateType:function(e){switch(e){case"peerreflexive":return"prflx";case"serverreflexive":return"srflx";default:return e}}(e.stat("candidateType")),priority:m(e,"priority"),url:void 0,relayProtocol:void 0,deleted:void 0}}function p(e){return isNaN(e)||""===e?void 0:parseInt(e,10)/1e3}function h(e,t){var n=e.stat(t);return v(e,t)?parseInt(n,10):void 0}function m(e,t){var n=e.stat(t);return v(e,t)?parseFloat(n):void 0}function y(e,t){var n=e.stat(t);return v(e,t)?"true"===n||!0===n:void 0}function v(e,t){e=e.stat(t);return void 0!==e&&""!==e}r&&((i.prototype=Object.create(r.prototype)).constructor=i),["entries","forEach","get","has","keys","values"].forEach(function(r){i.prototype[r]=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return(e=this._map)[r].apply(e,t)}}),i.fromArray=function(e){return new i(e.reduce(function(e,t){return e.set(t.id,t),e},new Map))},i.fromRTCStatsResponse=function(e){var c,t,u=new Map,e=e.result().reduce(function(e,t){var n,r,i,o,a=t.id;switch(t.type){case"googCertificate":e.set(a,{type:"certificate",id:(o=t).id,timestamp:Date.parse(o.timestamp),fingerprint:o.stat("googFingerprint"),fingerprintAlgorithm:o.stat("googFingerprintAlgorithm"),base64Certificate:o.stat("googDerBase64"),issuerCertificateId:o.stat("googIssuerId")});break;case"datachannel":e.set(a,{type:"data-channel",id:(o=t).id,timestamp:Date.parse(o.timestamp),label:o.stat("label"),protocol:o.stat("protocol"),datachannelid:o.stat("datachannelid"),transportId:o.stat("transportId"),state:o.stat("state"),messagesSent:void 0,bytesSent:void 0,messagesReceived:void 0,bytesReceived:void 0});break;case"googCandidatePair":y(t,"googActiveConnection")&&(c=a),e.set(a,{type:"candidate-pair",id:(i=t).id,timestamp:Date.parse(i.timestamp),transportId:i.stat("googChannelId"),localCandidateId:i.stat("localCandidateId"),remoteCandidateId:i.stat("remoteCandidateId"),state:void 0,priority:void 0,nominated:void 0,writable:y(i,"googWritable"),readable:void 0,bytesSent:h(i,"bytesSent"),bytesReceived:h(i,"bytesReceived"),lastPacketSentTimestamp:void 0,lastPacketReceivedTimestamp:void 0,totalRoundTripTime:void 0,currentRoundTripTime:p(i.stat("googRtt")),availableOutgoingBitrate:void 0,availableIncomingBitrate:void 0,requestsReceived:h(i,"requestsReceived"),requestsSent:h(i,"requestsSent"),responsesReceived:h(i,"responsesReceived"),responsesSent:h(i,"responsesSent"),retransmissionsReceived:void 0,retransmissionsSent:void 0,consentRequestsSent:h(i,"consentRequestsSent")});break;case"localcandidate":e.set(a,f(t,!1));break;case"remotecandidate":e.set(a,f(t,!0));break;case"ssrc":v(t,"packetsReceived")?e.set("rtp-"+a,(r=d(i=t,!0),Object.assign(r,{type:"inbound-rtp",packetsReceived:h(i,"packetsReceived"),bytesReceived:h(i,"bytesReceived"),packetsLost:h(i,"packetsLost"),jitter:p(i.stat("googJitterReceived")),fractionLost:void 0,roundTripTime:p(i.stat("googRtt")),packetsDiscarded:void 0,packetsRepaired:void 0,burstPacketsLost:void 0,burstPacketsDiscarded:void 0,burstLossCount:void 0,burstDiscardCount:void 0,burstLossRate:void 0,burstDiscardRate:void 0,gapLossRate:void 0,gapDiscardRate:void 0,framesDecoded:h(i,"framesDecoded")}),r)):e.set("rtp-"+a,(n=d(r=t,!1),Object.assign(n,{type:"outbound-rtp",remoteTimestamp:void 0,packetsSent:h(r,"packetsSent"),bytesSent:h(r,"bytesSent"),targetBitrate:void 0,framesEncoded:h(r,"framesEncoded")}),n)),e.set("track-"+a,{type:"track",id:(n=t).id,timestamp:Date.parse(n.timestamp),trackIdentifier:n.stat("googTrackId"),remoteSource:void 0,ended:void 0,kind:n.stat("mediaType"),detached:void 0,ssrcIds:void 0,frameWidth:v(n,"googFrameWidthReceived")?h(n,"googFrameWidthReceived"):h(n,"googFrameWidthSent"),frameHeight:v(n,"googFrameHeightReceived")?h(n,"googFrameHeightReceived"):h(n,"googFrameHeightSent"),framesPerSecond:void 0,framesSent:h(n,"framesEncoded"),framesReceived:void 0,framesDecoded:h(n,"framesDecoded"),framesDropped:void 0,framesCorrupted:void 0,partialFramesLost:void 0,fullFramesLost:void 0,audioLevel:v(n,"audioOutputLevel")?h(n,"audioOutputLevel")/32767:(h(n,"audioInputLevel")||0)/32767,echoReturnLoss:m(n,"googEchoCancellationReturnLoss"),echoReturnLossEnhancement:m(n,"googEchoCancellationReturnLossEnhancement")}),e.set("codec-"+a,{type:"codec",id:(s=t).id,timestamp:Date.parse(s.timestamp),payloadType:void 0,mimeType:s.stat("mediaType")+"/"+s.stat("googCodecName"),clockRate:void 0,channels:void 0,sdpFmtpLine:void 0,implementation:void 0});break;case"googComponent":var s=l(t);u.set(s.selectedCandidatePairId,a),e.set(a,l(t))}return e},new Map);return c&&(t=u.get(c))&&(e.get(t).dtlsState="connected"),new i(e)},t.exports=i},{}],25:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});function r(e,t,n){if("number"!=typeof e||"number"!=typeof t||"number"!=typeof n||!o(e)||!o(t)||!o(n))return null;var r=e+2*t+10,i=0;switch(!0){case r<160:i=94.768-r/40;break;case r<1e3:i=94.768-(r-120)/10}return 1+.035*(i=!0==n<=i/2.5?Math.max(i-2.5*n,6.52):0)+7e-6*i*(i-60)*(100-i)}function o(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)&&0<=e}n.calculate=r,n.isNonNegativeNumber=o,n.default={calculate:r,isNonNegativeNumber:o}},{}],26:[function(e,t,n){"use strict";var r=e("../errors"),a=r.InvalidArgumentError,l=r.MediaErrors,i=r.NotSupportedError,o=r.SignalingErrors,s=e("../log").default,c=e("../util"),u=e("./rtcpc"),d=e("./sdp").setIceAggressiveNomination;function f(e,t,n,r){if(!e||!t||!n)throw new a("Audiohelper, pstream and getUserMedia are required arguments");if(!(this instanceof f))return new f(e,t,n,r);function i(){}this.onopen=i,this.onerror=i,this.onclose=i,this.ondisconnected=i,this.onfailed=i,this.onconnected=i,this.onreconnected=i,this.onsignalingstatechange=i,this.ondtlstransportstatechange=i,this.onicegatheringfailure=i,this.onicegatheringstatechange=i,this.oniceconnectionstatechange=i,this.onpcconnectionstatechange=i,this.onicecandidate=i,this.onselectedcandidatepairchange=i,this.onvolume=i,this.version=null,this.pstream=t,this.stream=null,this.sinkIds=new Set(["default"]),this.outputs=new Map,this.status="connecting",this.callSid=null,this.isMuted=!1,this.getUserMedia=n;t="undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext);return this._isSinkSupported=!!t&&"undefined"!=typeof HTMLAudioElement&&HTMLAudioElement.prototype.setSinkId,this._audioContext=t&&e._audioContext,this._hasIceCandidates=!1,this._hasIceGatheringFailures=!1,this._iceGatheringTimeoutId=null,this._masterAudio=null,this._masterAudioDeviceId=null,this._mediaStreamSource=null,this._dtmfSender=null,this._dtmfSenderUnsupported=!1,this._callEvents=[],this._nextTimeToPublish=Date.now(),this._onAnswerOrRinging=i,this._onHangup=i,this._remoteStream=null,this._shouldManageStream=!0,this._iceState="new",this._isUnifiedPlan=r.isUnifiedPlan,this.options=r=r||{},this.navigator=r.navigator||("undefined"!=typeof navigator?navigator:null),this.util=r.util||c,this.codecPreferences=r.codecPreferences,this._log=s.getInstance(),this}function p(t,n){"function"==typeof t.addTrack?n.getAudioTracks().forEach(function(e){t.addTrack(e,n)}):t.addStream(n)}function h(e){var t=new("undefined"!=typeof MediaStream?MediaStream:webkitMediaStream);return e.getAudioTracks().forEach(t.addTrack,t),t}function m(e,t){if(void 0!==e.srcObject)e.srcObject=t;else if(void 0!==e.mozSrcObject)e.mozSrcObject=t;else{if(void 0===e.src)return;var n=e.options.window||window;e.src=(n.URL||n.webkitURL).createObjectURL(t)}return 1}f.prototype.uri=function(){return this._uri},f.prototype.openWithConstraints=function(e){return this.getUserMedia({audio:e}).then(this._setInputTracksFromStream.bind(this,!1))},f.prototype.setInputTracksFromStream=function(e){var t=this;return this._setInputTracksFromStream(!0,e).then(function(){t._shouldManageStream=!1})},f.prototype._createAnalyser=function(e,t){t=Object.assign({fftSize:32,smoothingTimeConstant:.3},t);var n,r=e.createAnalyser();for(n in t)r[n]=t[n];return r},f.prototype._setVolumeHandler=function(e){this.onvolume=e},f.prototype._startPollingVolume=function(){var e,o,t,a,s;this._audioContext&&this.stream&&this._remoteStream&&(e=this._audioContext,t=(this._inputAnalyser=this._createAnalyser(e)).frequencyBinCount,o=new Uint8Array(t),this._inputAnalyser2=this._createAnalyser(e,{minDecibels:-127,maxDecibels:0,smoothingTimeConstant:0}),t=(this._outputAnalyser=this._createAnalyser(e)).frequencyBinCount,a=new Uint8Array(t),this._outputAnalyser2=this._createAnalyser(e,{minDecibels:-127,maxDecibels:0,smoothingTimeConstant:0}),this._updateInputStreamSource(this.stream),this._updateOutputStreamSource(this._remoteStream),s=this,setTimeout(function e(){var t,n,r,i;s._audioContext&&("closed"===s.status?(s._inputAnalyser.disconnect(),s._outputAnalyser.disconnect(),s._inputAnalyser2.disconnect(),s._outputAnalyser2.disconnect()):(s._inputAnalyser.getByteFrequencyData(o),t=s.util.average(o),s._inputAnalyser2.getByteFrequencyData(o),n=s.util.average(o),s._outputAnalyser.getByteFrequencyData(a),r=s.util.average(a),s._outputAnalyser2.getByteFrequencyData(a),i=s.util.average(a),s.onvolume(t/255,r/255,n,i),setTimeout(e,50)))},50))},f.prototype._stopStream=function(e){this._shouldManageStream&&("function"==typeof MediaStreamTrack.prototype.stop?("function"==typeof e.getAudioTracks?e.getAudioTracks():e.audioTracks).forEach(function(e){e.stop()}):e.stop())},f.prototype._updateInputStreamSource=function(e){this._inputStreamSource&&this._inputStreamSource.disconnect(),this._inputStreamSource=this._audioContext.createMediaStreamSource(e),this._inputStreamSource.connect(this._inputAnalyser),this._inputStreamSource.connect(this._inputAnalyser2)},f.prototype._updateOutputStreamSource=function(e){this._outputStreamSource&&this._outputStreamSource.disconnect(),this._outputStreamSource=this._audioContext.createMediaStreamSource(e),this._outputStreamSource.connect(this._outputAnalyser),this._outputStreamSource.connect(this._outputAnalyser2)},f.prototype._setInputTracksFromStream=function(e,t){return this._isUnifiedPlan?this._setInputTracksForUnifiedPlan(e,t):this._setInputTracksForPlanB(e,t)},f.prototype._setInputTracksForPlanB=function(e,t){var n,r,i,o=this;return t?t.getAudioTracks().length?((n=this.stream)?(this._stopStream(n),r=this.version.pc,i=n,"function"==typeof r.removeTrack?r.getSenders().forEach(function(e){r.removeTrack(e)}):r.removeStream(i),n.getAudioTracks().forEach(n.removeTrack,n),t.getAudioTracks().forEach(n.addTrack,n),p(this.version.pc,t),this._updateInputStreamSource(this.stream)):this.stream=e?h(t):t,this.mute(this.isMuted),this.version?new Promise(function(e,t){o.version.createOffer(o.options.maxAverageBitrate,o.codecPreferences,{audio:!0},function(){o.version.processAnswer(o.codecPreferences,o._answerSdp,function(){e(o.stream)},t)},t)}):Promise.resolve(this.stream)):Promise.reject(new a("Supplied input stream has no audio tracks")):Promise.reject(new a("Can not set input stream to null while in a call"))},f.prototype._setInputTracksForUnifiedPlan=function(e,t){var n,r,i=this;return t?t.getAudioTracks().length?(n=this.stream,r=function(){return i.mute(i.isMuted),Promise.resolve(i.stream)},n?(this._shouldManageStream&&this._stopStream(n),this._sender||(this._sender=this.version.pc.getSenders()[0]),this._sender.replaceTrack(t.getAudioTracks()[0]).then(function(){return i._updateInputStreamSource(t),r()})):(this.stream=e?h(t):t,r())):Promise.reject(new a("Supplied input stream has no audio tracks")):Promise.reject(new a("Can not set input stream to null while in a call"))},f.prototype._onInputDevicesChanged=function(){this.stream&&this.stream.getAudioTracks().every(function(e){return"ended"===e.readyState})&&this._shouldManageStream&&this.openWithConstraints(!0)},f.prototype._onIceGatheringFailure=function(e){this._hasIceGatheringFailures=!0,this.onicegatheringfailure(e)},f.prototype._onMediaConnectionStateChange=function(e){var t=this._iceState;if(t!==e&&("connected"===e||"disconnected"===e||"failed"===e)){var n=void 0;switch(this._iceState=e){case"connected":"disconnected"===t||"failed"===t?(this._log.info(n="ICE liveliness check succeeded. Connection with Twilio restored"),this.onreconnected(n)):(this._log.info(n="Media connection established."),this.onconnected(n)),this._stopIceGatheringTimeout(),this._hasIceGatheringFailures=!1;break;case"disconnected":this._log.info(n="ICE liveliness check failed. May be having trouble connecting to Twilio"),this.ondisconnected(n);break;case"failed":this._log.info(n="Connection with Twilio was interrupted."),this.onfailed(n)}}},f.prototype._setSinkIds=function(e){return this._isSinkSupported?(this.sinkIds=new Set(e.forEach?e:[e]),this.version?this._updateAudioOutputs():Promise.resolve()):Promise.reject(new i("Audio output selection is not supported by this browser"))},f.prototype._startIceGatheringTimeout=function(){var e=this;this._stopIceGatheringTimeout(),this._iceGatheringTimeoutId=setTimeout(function(){e._onIceGatheringFailure("timeout")},15e3)},f.prototype._stopIceGatheringTimeout=function(){clearInterval(this._iceGatheringTimeoutId)},f.prototype._updateAudioOutputs=function(){var e=Array.from(this.sinkIds).filter(function(e){return!this.outputs.has(e)},this),t=Array.from(this.outputs.keys()).filter(function(e){return!this.sinkIds.has(e)},this),n=this,e=e.map(this._createAudioOutput,this);return Promise.all(e).then(function(){return Promise.all(t.map(n._removeAudioOutput,n))})},f.prototype._createAudio=function(e){return new Audio(e)},f.prototype._createAudioOutput=function(e){var t=this._audioContext.createMediaStreamDestination(),n=(this._mediaStreamSource.connect(t),this._createAudio()),r=(m(n,t.stream),this);return n.setSinkId(e).then(function(){return n.play()}).then(function(){r.outputs.set(e,{audio:n,dest:t})})},f.prototype._removeAudioOutputs=function(){return this._masterAudio&&void 0!==this._masterAudioDeviceId&&(this._disableOutput(this,this._masterAudioDeviceId),this.outputs.delete(this._masterAudioDeviceId),this._masterAudioDeviceId=null,this._masterAudio.paused||this._masterAudio.pause(),void 0!==this._masterAudio.srcObject?this._masterAudio.srcObject=null:this._masterAudio.src="",this._masterAudio=null),Array.from(this.outputs.keys()).map(this._removeAudioOutput,this)},f.prototype._disableOutput=function(e,t){e=e.outputs.get(t);e&&(e.audio&&(e.audio.pause(),e.audio.src=""),e.dest)&&e.dest.disconnect()},f.prototype._reassignMasterOutput=function(e,t){var n=e.outputs.get(t),r=(e.outputs.delete(t),this),i=Array.from(e.outputs.keys())[0]||"default";return n.audio.setSinkId(i).then(function(){r._disableOutput(e,i),e.outputs.set(i,n),e._masterAudioDeviceId=i}).catch(function(){e.outputs.set(t,n),r._log.info("Could not reassign master output. Attempted to roll back.")})},f.prototype._removeAudioOutput=function(e){return this._masterAudioDeviceId===e?this._reassignMasterOutput(this,e):(this._disableOutput(this,e),this.outputs.delete(e),Promise.resolve())},f.prototype._onAddTrack=function(e,t){var n=e._masterAudio=this._createAudio(),r=(m(n,t),n.play(),Array.from(e.outputs.keys())[0]||"default");e._masterAudioDeviceId=r,e.outputs.set(r,{audio:n}),e._mediaStreamSource=e._audioContext.createMediaStreamSource(t),e.pcStream=t,e._updateAudioOutputs()},f.prototype._fallbackOnAddTrack=function(e,t){var n=document&&document.createElement("audio");n.autoplay=!0,m(n,t)||e._log.info("Error attaching stream to element."),e.outputs.set("default",{audio:n})},f.prototype._setEncodingParameters=function(e){e&&this._sender&&"function"==typeof this._sender.getParameters&&"function"==typeof this._sender.setParameters&&((e=this._sender.getParameters()).priority||e.encodings&&e.encodings.length)&&(e.priority="high",e.encodings&&e.encodings.length&&e.encodings.forEach(function(e){e.priority="high",e.networkPriority="high"}),this._sender.setParameters(e))},f.prototype._setupPeerConnection=function(e,t){var n=this,r=this,i=new(this.options.rtcpcFactory||u),e=(i.create(e,t),p(i.pc,this.stream),"ontrack"in i.pc?"ontrack":"onaddstream");return i.pc[e]=function(e){e=r._remoteStream=e.stream||e.streams[0];"function"==typeof i.pc.getSenders&&(n._sender=i.pc.getSenders()[0]),r._isSinkSupported?r._onAddTrack(r,e):r._fallbackOnAddTrack(r,e),r._startPollingVolume()},i},f.prototype._maybeSetIceAggressiveNomination=function(e){return this.options.forceAggressiveIceNomination?d(e):e},f.prototype._setupChannel=function(){var t=this,n=this.version.pc;this.version.pc.onopen=function(){t.status="open",t.onopen()},this.version.pc.onstatechange=function(){t.version.pc&&"stable"===t.version.pc.readyState&&(t.status="open",t.onopen())},this.version.pc.onsignalingstatechange=function(){var e=n.signalingState;t._log.info('signalingState is "'+e+'"'),t.version.pc&&"stable"===t.version.pc.signalingState&&(t.status="open",t.onopen()),t.onsignalingstatechange(n.signalingState)},n.onconnectionstatechange=function(){t._log.info('pc.connectionState is "'+n.connectionState+'"'),t.onpcconnectionstatechange(n.connectionState),t._onMediaConnectionStateChange(n.connectionState)},n.onicecandidate=function(e){e=e.candidate;e&&(t._hasIceCandidates=!0,t.onicecandidate(e),t._setupRTCIceTransportListener()),t._log.info("ICE Candidate: "+JSON.stringify(e))},n.onicegatheringstatechange=function(){var e=n.iceGatheringState;("gathering"===e||"complete"===e&&(t._stopIceGatheringTimeout(),t._hasIceCandidates||t._onIceGatheringFailure("none"),t._hasIceCandidates)&&t._hasIceGatheringFailures)&&t._startIceGatheringTimeout(),t._log.info('pc.iceGatheringState is "'+n.iceGatheringState+'"'),t.onicegatheringstatechange(e)},n.oniceconnectionstatechange=function(){t._log.info('pc.iceConnectionState is "'+n.iceConnectionState+'"'),t.oniceconnectionstatechange(n.iceConnectionState),t._onMediaConnectionStateChange(n.iceConnectionState)}},f.prototype._initializeMediaStream=function(e,t){return"open"!==this.status&&("disconnected"===this.pstream.status?(this.onerror({info:{code:31e3,message:"Cannot establish connection. Client is disconnected",twilioError:new o.ConnectionDisconnected}}),this.close(),!1):(this.version=this._setupPeerConnection(e,t),this._setupChannel(),!0))},f.prototype._removeReconnectionListeners=function(){this.pstream&&(this.pstream.removeListener("answer",this._onAnswerOrRinging),this.pstream.removeListener("hangup",this._onHangup))},f.prototype._setupRTCDtlsTransportListener=function(){var e,t=this,n=this.getRTCDtlsTransport();n&&!n.onstatechange&&((e=function(){t._log.info('dtlsTransportState is "'+n.state+'"'),t.ondtlstransportstatechange(n.state)})(),n.onstatechange=e)},f.prototype._setupRTCIceTransportListener=function(){var e=this,t=this._getRTCIceTransport();t&&!t.onselectedcandidatepairchange&&(t.onselectedcandidatepairchange=function(){return e.onselectedcandidatepairchange(t.getSelectedCandidatePair())})},f.prototype.iceRestart=function(){var n=this;this._log.info("Attempting to restart ICE..."),this._hasIceCandidates=!1,this.version.createOffer(this.options.maxAverageBitrate,this.codecPreferences,{iceRestart:!0}).then(function(){n._removeReconnectionListeners(),n._onAnswerOrRinging=function(e){var t;n._removeReconnectionListeners(),e.sdp&&"have-local-offer"===n.version.pc.signalingState?(t=n._maybeSetIceAggressiveNomination(e.sdp),n._answerSdp=t,"closed"!==n.status&&n.version.processAnswer(n.codecPreferences,t,null,function(e){e=e&&e.message?e.message:e;n._log.info("Failed to process answer during ICE Restart. Error: "+e)})):(t="Invalid state or param during ICE Restart:hasSdp:"+!!e.sdp+", signalingState:"+n.version.pc.signalingState,n._log.info(t))},n._onHangup=function(){n._log.info("Received hangup during ICE Restart"),n._removeReconnectionListeners()},n.pstream.on("answer",n._onAnswerOrRinging),n.pstream.on("hangup",n._onHangup),n.pstream.reinvite(n.version.getSDP(),n.callSid)}).catch(function(e){e=e&&e.message?e.message:e;n._log.info("Failed to createOffer during ICE Restart. Error: "+e),n.onfailed(e)})},f.prototype.makeOutgoingCall=function(e,t,n,r,i,o){var a,s=this;function c(){a.options&&a._setEncodingParameters(a.options.dscp),o(a.version.pc)}function u(e){e=e.message||e;a.onerror({info:{code:31e3,message:"Error processing answer: "+e,twilioError:new l.ClientRemoteDescFailed}})}this._initializeMediaStream(r,i)&&((a=this).callSid=n,this._onAnswerOrRinging=function(e){e.sdp&&(e=s._maybeSetIceAggressiveNomination(e.sdp),a._answerSdp=e,"closed"!==a.status&&a.version.processAnswer(s.codecPreferences,e,c,u),a.pstream.removeListener("answer",a._onAnswerOrRinging),a.pstream.removeListener("ringing",a._onAnswerOrRinging))},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("ringing",this._onAnswerOrRinging),this.version.createOffer(this.options.maxAverageBitrate,this.codecPreferences,{audio:!0},function(){"closed"!==a.status&&(a.pstream.invite(a.version.getSDP(),a.callSid,a.options.preflight,t),a._setupRTCDtlsTransportListener())},function(e){e=e.message||e,a.onerror({info:{code:31e3,message:"Error creating the offer: "+e,twilioError:new l.ClientLocalDescFailed}})}))},f.prototype.answerIncomingCall=function(e,t,n,r,i){var o;this._initializeMediaStream(n,r)&&(t=this._maybeSetIceAggressiveNomination(t),this._answerSdp=t.replace(/^a=setup:actpass$/gm,"a=setup:passive"),this.callSid=e,(o=this).version.processSDP(this.options.maxAverageBitrate,this.codecPreferences,t,{audio:!0},function(){"closed"!==o.status&&(o.pstream.answer(o.version.getSDP(),e),o.options&&o._setEncodingParameters(o.options.dscp),i(o.version.pc),o._setupRTCDtlsTransportListener())},function(e){e=e.message||e,o.onerror({info:{code:31e3,message:"Error creating the answer: "+e,twilioError:new l.ClientRemoteDescFailed}})}))},f.prototype.close=function(){this.version&&this.version.pc&&("closed"!==this.version.pc.signalingState&&this.version.pc.close(),this.version.pc=null),this.stream&&(this.mute(!1),this._stopStream(this.stream)),this.stream=null,this._removeReconnectionListeners(),this._stopIceGatheringTimeout(),Promise.all(this._removeAudioOutputs()).catch(function(){}),this._mediaStreamSource&&this._mediaStreamSource.disconnect(),this._inputAnalyser&&this._inputAnalyser.disconnect(),this._outputAnalyser&&this._outputAnalyser.disconnect(),this._inputAnalyser2&&this._inputAnalyser2.disconnect(),this._outputAnalyser2&&this._outputAnalyser2.disconnect(),this.status="closed",this.onclose()},f.prototype.reject=function(e){this.callSid=e},f.prototype.ignore=function(e){this.callSid=e},f.prototype.mute=function(t){this.isMuted=t,this.stream&&(this._sender&&this._sender.track?this._sender.track.enabled=!t:("function"==typeof this.stream.getAudioTracks?this.stream.getAudioTracks():this.stream.audioTracks).forEach(function(e){e.enabled=!t}))},f.prototype.getOrCreateDTMFSender=function(){if(this._dtmfSender||this._dtmfSenderUnsupported)return this._dtmfSender||null;var t=this,e=this.version.pc;if(e){if("function"==typeof e.getSenders&&("function"==typeof RTCDTMFSender||"function"==typeof RTCDtmfSender)){var n=e.getSenders().find(function(e){return e.dtmf});if(n)return this._log.info("Using RTCRtpSender#dtmf"),this._dtmfSender=n.dtmf,this._dtmfSender}if("function"==typeof e.createDTMFSender&&"function"==typeof e.getLocalStreams)return(n=e.getLocalStreams().map(function(e){e=t._getAudioTracks(e);return e&&e[0]})[0])?(this._log.info("Creating RTCDTMFSender"),this._dtmfSender=e.createDTMFSender(n),this._dtmfSender):(this._log.info("No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender"),null);this._log.info("RTCPeerConnection does not support RTCDTMFSender"),this._dtmfSenderUnsupported=!0}else this._log.info("No RTCPeerConnection available to call createDTMFSender on");return null},f.prototype.getRTCDtlsTransport=function(){var e=this.version&&this.version.pc&&"function"==typeof this.version.pc.getSenders&&this.version.pc.getSenders()[0];return e&&e.transport||null},f.prototype._canStopMediaStreamTrack=function(){return"function"==typeof MediaStreamTrack.prototype.stop},f.prototype._getAudioTracks=function(e){return"function"==typeof e.getAudioTracks?e.getAudioTracks():e.audioTracks},f.prototype._getRTCIceTransport=function(){var e=this.getRTCDtlsTransport();return e&&e.iceTransport||null},f.protocol=u.test()?new u:null,f.enabled=u.test(),t.exports=f},{"../errors":12,"../log":15,"../util":35,"./rtcpc":27,"./sdp":28}],27:[function(f,p,e){!function(d){!function(){"use strict";var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e=f("rtcpeerconnection-shim"),n=f("../log").default,r=f("./sdp"),s=r.setCodecPreferences,a=r.setMaxAverageBitrate,i=f("../util");function o(){"undefined"==typeof window?this.log.info("No RTCPeerConnection implementation available. The window object was not found."):i.isLegacyEdge()?this.RTCPeerConnection=new e("undefined"!=typeof window?window:d):"function"==typeof window.RTCPeerConnection?this.RTCPeerConnection=window.RTCPeerConnection:"function"==typeof window.webkitRTCPeerConnection?this.RTCPeerConnection=webkitRTCPeerConnection:"function"==typeof window.mozRTCPeerConnection?(this.RTCPeerConnection=mozRTCPeerConnection,window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate):this.log.info("No RTCPeerConnection implementation available")}function c(r,i,o){return function(){var n=Array.prototype.slice.call(arguments);return new Promise(function(e){e(r.apply(i,n))}).catch(function(){return new Promise(function(e,t){r.apply(i,o?[e,t].concat(n):n.concat([e,t]))})})}}function u(e,t){return c(e,t,!0)}function l(e,t){return c(e,t,!1)}o.prototype.create=function(e,t){this.log=n.getInstance(),this.pc=new this.RTCPeerConnection(t,e)},o.prototype.createModernConstraints=function(e){var t;return void 0===e?null:(t=Object.assign({},e),"undefined"==typeof webkitRTCPeerConnection||i.isLegacyEdge()?(void 0!==e.audio&&(t.offerToReceiveAudio=e.audio),void 0!==e.video&&(t.offerToReceiveVideo=e.video)):(t.mandatory={},void 0!==e.audio&&(t.mandatory.OfferToReceiveAudio=e.audio),void 0!==e.video&&(t.mandatory.OfferToReceiveVideo=e.video)),delete t.audio,delete t.video,t)},o.prototype.createOffer=function(t,n,e,r,i){var o=this;return e=this.createModernConstraints(e),u(this.pc.createOffer,this.pc)(e).then(function(e){return o.pc?(e=a(e.sdp,t),l(o.pc.setLocalDescription,o.pc)(new RTCSessionDescription({type:"offer",sdp:s(e,n)}))):Promise.resolve()}).then(r,i)},o.prototype.createAnswer=function(t,n,e,r,i){var o=this;return e=this.createModernConstraints(e),u(this.pc.createAnswer,this.pc)(e).then(function(e){return o.pc?(e=a(e.sdp,t),l(o.pc.setLocalDescription,o.pc)(new RTCSessionDescription({type:"answer",sdp:s(e,n)}))):Promise.resolve()}).then(r,i)},o.prototype.processSDP=function(e,t,n,r,i,o){var a=this,n=(n=s(n,t),new RTCSessionDescription({sdp:n,type:"offer"}));return l(this.pc.setRemoteDescription,this.pc)(n).then(function(){a.createAnswer(e,t,r,i,o)})},o.prototype.getSDP=function(){return this.pc.localDescription.sdp},o.prototype.processAnswer=function(e,t,n,r){return this.pc?(t=s(t,e),l(this.pc.setRemoteDescription,this.pc)(new RTCSessionDescription({sdp:t,type:"answer"})).then(n,r)):Promise.resolve()},o.test=function(){if("object"===("undefined"==typeof navigator?"undefined":t(navigator))){var e=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(i.isLegacyEdge(navigator))return!1;if(e&&"function"==typeof window.RTCPeerConnection)return!0;if(e&&"function"==typeof window.webkitRTCPeerConnection)return!0;if(e&&"function"==typeof window.mozRTCPeerConnection){try{if("function"!=typeof(new window.mozRTCPeerConnection).getLocalStreams)return!1}catch(e){return!1}return!0}if("undefined"!=typeof RTCIceGatherer)return!0}return!1},p.exports=o}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../log":15,"../util":35,"./sdp":28,"rtcpeerconnection-shim":61}],28:[function(e,t,n){"use strict";var r=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var n=t,r=[],i=!0,t=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!n||r.length!==n);i=!0);}catch(e){t=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(t)throw o}}return r}throw new TypeError("Invalid attempt to destructure non-iterable instance")},u=e("../util"),l={0:"PCMU",8:"PCMA"};t.exports={getPreferredCodecInfo:function(e){var t=/a=rtpmap:(\d+) (\S+)/m.exec(e)||[null,"",""],n=(t=r(t,3))[1],t=t[2],n=new RegExp("a=fmtp:"+n+" (\\S+)","m").exec(e)||[null,""];return{codecName:t,codecParams:r(n,2)[1]}},setCodecPreferences:function(e,c){var r,i,t=e.replace(/\r\n\r\n$/,"\r\n").split("\r\nm=").slice(1).map(function(e){return"m="+e}).filter(function(e){var t=new RegExp("m="+(r||".*"),"gm"),n=new RegExp("a="+(i||".*"),"gm");return t.test(e)&&n.test(e)});return[e.split("\r\nm=")[0]].concat(t.map(function(e){var t,n,r,i,o,a,s;return/^m=(audio|video)/.test(e)?(t=e.match(/^m=(audio|video)/)[1],n=Array.from(function(r){return function(e){e=e.split("\r\n")[0].match(/([0-9]+)/g);return e?e.slice(1).map(function(e){return parseInt(e,10)}):[]}(r).reduce(function(e,t){var n=new RegExp("a=rtpmap:"+t+" ([^/]+)"),n=r.match(n),n=n?n[1].toLowerCase():l[t]?l[t].toLowerCase():"";return e.set(t,n)},new Map)}(e)).reduce(function(e,t){var n=t[0],t=t[1],r=e.get(t)||[];return e.set(t,r.concat(n))},new Map),r=n,o=(o=c).map(function(e){return e.toLowerCase()}),i=u.flatMap(o,function(e){return r.get(e)||[]}),o=u.difference(Array.from(r.keys()),o),o=u.flatMap(o,function(e){return r.get(e)}),i=i.concat(o),o=i,s=(s=e).split("\r\n"),a=s[0],s=s.slice(1),o=[a=a.replace(/([0-9]+\s?)+$/,o.join(" "))].concat(s).join("\r\n"),a=n.get("pcma")||[],s=n.get("pcmu")||[],("audio"===t?new Set(a.concat(s)):new Set).has(i[0])?o.replace(/\r\nb=(AS|TIAS):([0-9]+)/g,""):o):e})).join("\r\n")},setIceAggressiveNomination:function(e){return u.isChrome(window,window.navigator)?e.split("\n").filter(function(e){return-1===e.indexOf("a=ice-lite")}).join("\n"):e},setMaxAverageBitrate:function(e,t){var n,r;return"number"!=typeof t||t<6e3||51e4<t?e:(n=(n=/a=rtpmap:(\d+) opus/m.exec(e))&&n.length?n[1]:111,r=new RegExp("a=fmtp:"+n),e.split("\n").map(function(e){return r.test(e)?e+";maxaveragebitrate="+t:e}).join("\n"))}}},{"../util":35}],29:[function(e,t,n){var s=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r},r=e("../errors"),i=r.NotSupportedError,o=r.InvalidArgumentError,a=e("./mockrtcstatsreport"),c="PeerConnection is null",u="WebRTC statistics are unsupported";function l(t){if(!t)return Promise.reject(new o(c));if("function"!=typeof t.getStats)return Promise.reject(new i(u));var n;try{n=t.getStats()}catch(e){n=new Promise(function(e){return t.getStats(e)}).then(a.fromRTCStatsResponse)}return n}function d(){}function f(i){var o,e,t,a=null,s=new d,n=(Array.from(i.values()).forEach(function(e){if(!e.isRemote){var t,n,r=e.type.replace("-","");switch(o=o||e.timestamp,e.remoteId&&(t=i.get(e.remoteId))&&t.roundTripTime&&(s.rtt=1e3*t.roundTripTime),r){case"inboundrtp":s.timestamp=s.timestamp||e.timestamp,s.jitter=1e3*e.jitter,s.packetsLost=e.packetsLost,s.packetsReceived=e.packetsReceived,s.bytesReceived=e.bytesReceived;break;case"outboundrtp":s.timestamp=e.timestamp,s.packetsSent=e.packetsSent,s.bytesSent=e.bytesSent,e.codecId&&(n=i.get(e.codecId),s.codecName=n?n.mimeType&&n.mimeType.match(/(.*\/)?(.*)/)[2]:e.codecId);break;case"transport":a=e.id}}}),s.timestamp||(s.timestamp=o),i.get(a));return n&&(n=i.get(n.selectedCandidatePairId))&&(e=i.get(n.localCandidateId),t=i.get(n.remoteCandidateId),s.rtt||(s.rtt=n&&1e3*n.currentRoundTripTime),Object.assign(s,{localAddress:e&&e.ip,remoteAddress:t&&t.ip})),s}t.exports={getRTCStats:function(e,t){return t=Object.assign({createRTCSample:f},t),l(e).then(t.createRTCSample)},getRTCIceCandidateStatsReport:function(e){return l(e).then(function(e){var t,e=Array.from(e.values()).reduce(function(t,e){switch(["candidatePairs","localCandidates","remoteCandidates"].forEach(function(e){t[e]||(t[e]=[])}),e.type){case"candidate-pair":t.candidatePairs.push(e);break;case"local-candidate":t.localCandidates.push(e);break;case"remote-candidate":t.remoteCandidates.push(e);break;case"transport":e.selectedCandidatePairId&&(t.transport=e)}return t},{}),n=e.candidatePairs,r=e.localCandidates,i=e.remoteCandidates,o=e.transport,a=n.find(function(e){return e.selected||o&&e.id===o.selectedCandidatePairId});return a&&(t={localCandidate:r.find(function(e){return e.id===a.localCandidateId}),remoteCandidate:i.find(function(e){return e.id===a.remoteCandidateId})}),{iceCandidateStats:s(r,i),selectedIceCandidatePairStats:t}})}}},{"../errors":12,"./mockrtcstatsreport":24}],30:[function(e,t,n){var r=e("events").EventEmitter;function i(){Object.defineProperties(this,{_eventEmitter:{value:new r},_handlers:{value:{}}})}i.prototype.dispatchEvent=function(e){return this._eventEmitter.emit(e.type,e)},i.prototype.addEventListener=function(){var e;return(e=this._eventEmitter).addListener.apply(e,arguments)},i.prototype.removeEventListener=function(){var e;return(e=this._eventEmitter).removeListener.apply(e,arguments)},i.prototype._defineEventHandler=function(n){var r=this;Object.defineProperty(this,"on"+n,{get:function(){return r._handlers[n]},set:function(e){var t=r._handlers[n];!t||"function"!=typeof e&&null!=e||(r._handlers[n]=null,r.removeEventListener(n,t)),"function"==typeof e&&(r._handlers[n]=e,r.addEventListener(n,e))}})},t.exports=i},{events:53}],31:[function(e,t,n){"use strict";t.exports=function e(t){if(!(this instanceof e))throw new TypeError("Cannot call a class as a function");Object.defineProperties(this,{deviceId:{get:function(){return t.deviceId}},groupId:{get:function(){return t.groupId}},kind:{get:function(){return t.kind}},label:{get:function(){return t.label}}})}},{}],32:[function(e,t,n){var r,i,o=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),e=e("./eventtarget"),a="undefined"!=typeof navigator&&navigator.mediaDevices,o=(o(s,i=e),s);function s(){var e=i.call(this)||this,t=(e._defineEventHandler("devicechange"),e._defineEventHandler("deviceinfochange"),[]);return Object.defineProperties(e,{_deviceChangeIsNative:{value:c(e,"devicechange")},_deviceInfoChangeIsNative:{value:c(e,"deviceinfochange")},_knownDevices:{value:t},_pollInterval:{value:null,writable:!0}}),"function"==typeof a.enumerateDevices&&a.enumerateDevices().then(function(e){e.sort(u).forEach([].push,t)}),e._eventEmitter.on("newListener",function(e){"devicechange"!==e&&"deviceinfochange"!==e||(this._pollInterval=this._pollInterval||setInterval(function(o){a.enumerateDevices().then(function(e){var t,n,r=o._knownDevices,i=r.slice();[].splice.apply(r,[0,r.length].concat(e.sort(u))),!o._deviceChangeIsNative&&(e=i,(t=r).length!==e.length||function(n,e,r){return e.some(function(e,t){return e[n]!==r[t][n]})}("deviceId",t,e))&&o.dispatchEvent(new Event("devicechange")),!o._deviceInfoChangeIsNative&&(t=r,n=i.reduce(function(e,t){return e.set(t.deviceId,t.label||null)},new Map),t.some(function(e){var t=n.get(e.deviceId);return void 0!==t&&t!==e.label}))&&o.dispatchEvent(new Event("deviceinfochange"))})}.bind(null,this),500))}.bind(e)),e._eventEmitter.on("removeListener",function(){var n;!this._pollInterval||(n=this,0<["devicechange","deviceinfochange"].reduce(function(e,t){return e+n._eventEmitter.listenerCount(t)},0))||(clearInterval(this._pollInterval),this._pollInterval=null)}.bind(e)),e}function c(t,e){var n="on"+e;function r(e){t.dispatchEvent(e)}return n in a&&("addEventListener"in a?a.addEventListener(e,r):a[n]=r,!0)}function u(e,t){return e.deviceId<t.deviceId}a&&"function"==typeof a.enumerateDevices&&(o.prototype.enumerateDevices=function(){return a.enumerateDevices.apply(a,arguments)}),o.prototype.getUserMedia=function(){return a.getUserMedia.apply(a,arguments)},t.exports=a?new o:null},{"./eventtarget":30}],33:[function(e,t,n){"use strict";var r=e("./asyncQueue").AsyncQueue,i=e("@twilio/audioplayer"),o=e("./errors").InvalidArgumentError;function a(e,t,n){if(!(this instanceof a))return new a(e,t,n);if(!e||!t)throw new o("name and url are required arguments");(n=Object.assign({AudioFactory:"undefined"!=typeof Audio?Audio:null,maxDuration:0,shouldLoop:!1},n)).AudioPlayer=n.audioContext?i.bind(i,n.audioContext):n.AudioFactory,Object.defineProperties(this,{_activeEls:{value:new Map},_Audio:{value:n.AudioPlayer},_isSinkSupported:{value:null!==n.AudioFactory&&"function"==typeof n.AudioFactory.prototype.setSinkId},_maxDuration:{value:n.maxDuration},_maxDurationTimeout:{value:null,writable:!0},_operations:{value:new r},_playPromise:{value:null,writable:!0},_shouldLoop:{value:n.shouldLoop},_sinkIds:{value:["default"]},isPlaying:{enumerable:!0,get:function(){return!!this._playPromise}},name:{enumerable:!0,value:e},url:{enumerable:!0,value:t}}),this._Audio&&this._play(!0,!1)}function s(e){e&&(e.pause(),e.src="",e.srcObject=null,e.load())}a.prototype._playAudioElement=function(t,e,n){var r=this,i=this._activeEls.get(t);if(i)return i.muted=!!e,i.loop=!!n,i.play().then(function(){return i}).catch(function(e){throw s(i),r._activeEls.delete(t),e});throw new o('sinkId: "'+t+"\" doesn't have an audio element")},a.prototype._play=function(n,r){this.isPlaying&&this._stop(),0<this._maxDuration&&(this._maxDurationTimeout=setTimeout(this._stop.bind(this),this._maxDuration)),r="boolean"==typeof r?r:this._shouldLoop;var i=this;return this._playPromise=Promise.all(this._sinkIds.map(function(e){var t;return i._Audio?(t=i._activeEls.get(e))?i._playAudioElement(e,n,r):("function"==typeof(t=new i._Audio(i.url)).setAttribute&&t.setAttribute("crossorigin","anonymous"),new Promise(function(e){t.addEventListener("canplaythrough",e)}).then(function(){return(i._isSinkSupported?t.setSinkId(e):Promise.resolve()).then(function(){return i._activeEls.set(e,t),i._playPromise?i._playAudioElement(e,n,r):Promise.resolve()})})):Promise.resolve()}))},a.prototype._stop=function(){var n=this;this._activeEls.forEach(function(e,t){n._sinkIds.includes(t)?(e.pause(),e.currentTime=0):(s(e),n._activeEls.delete(t))}),clearTimeout(this._maxDurationTimeout),this._playPromise=null,this._maxDurationTimeout=null},a.prototype.setSinkIds=function(e){this._isSinkSupported&&(e=e.forEach?e:[e],[].splice.apply(this._sinkIds,[0,this._sinkIds.length].concat(e)))},a.prototype.stop=function(){var e=this;this._operations.enqueue(function(){return e._stop(),Promise.resolve()})},a.prototype.play=function(){var e=this;return this._operations.enqueue(function(){return e._play()})},t.exports=a},{"./asyncQueue":4,"./errors":12,"@twilio/audioplayer":41}],34:[function(e,t,n){"use strict";var r,i=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},h=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var r=Array(e),i=0,t=0;t<n;t++)for(var o=arguments[t],a=0,s=o.length;a<s;a++,i++)r[i]=o[a];return r},a=(Object.defineProperty(n,"__esModule",{value:!0}),e("events")),s=e("./errors"),c=e("./rtc/mos"),m=e("./util"),u=e("./rtc/stats").getRTCStats,l={audioInputLevel:{minStandardDeviation:327.67,sampleCount:10},audioOutputLevel:{minStandardDeviation:327.67,sampleCount:10},bytesReceived:{clearCount:2,min:1,raiseCount:3,sampleCount:3},bytesSent:{clearCount:2,min:1,raiseCount:3,sampleCount:3},jitter:{max:30},mos:{min:3},packetsLostFraction:[{max:1},{clearValue:1,maxAverage:3,sampleCount:7}],rtt:{max:400}};d=a.EventEmitter,i(f,d),f.prototype.addVolumes=function(e,t){this._inputVolumes.push(e),this._outputVolumes.push(t)},f.prototype.disable=function(){return clearInterval(this._sampleInterval),delete this._sampleInterval,this},f.prototype.disableWarnings=function(){return this._warningsEnabled&&this._activeWarnings.clear(),this._warningsEnabled=!1,this},f.prototype.enable=function(e){if(e){if(this._peerConnection&&e!==this._peerConnection)throw new s.InvalidArgumentError("Attempted to replace an existing PeerConnection in StatsMonitor.enable");this._peerConnection=e}if(this._peerConnection)return this._sampleInterval=this._sampleInterval||setInterval(this._fetchSample.bind(this),1e3),this;throw new s.InvalidArgumentError("Can not enable StatsMonitor without a PeerConnection")},f.prototype.enableWarnings=function(){return this._warningsEnabled=!0,this},f.prototype.hasActiveWarning=function(e,t){return!!this._activeWarnings.get(e+":"+t)},f.prototype._addSample=function(e){var t=this._sampleBuffer;t.push(e),t.length>this._maxSampleCount&&t.splice(0,t.length-this._maxSampleCount)},f.prototype._clearWarning=function(e,t,n){var r=e+":"+t,i=this._activeWarnings.get(r);!i||Date.now()-i.timeRaised<5e3||(this._activeWarnings.delete(r),this.emit("warning-cleared",o(o({},n),{name:e,threshold:{name:t,value:this._thresholds[e][t]}})))},f.prototype._createSample=function(e,t){var n=t&&t.totals.bytesSent||0,r=t&&t.totals.bytesReceived||0,i=t&&t.totals.packetsSent||0,o=t&&t.totals.packetsReceived||0,a=t&&t.totals.packetsLost||0,n=e.bytesSent-n,r=e.bytesReceived-r,i=e.packetsSent-i,o=e.packetsReceived-o,a=e.packetsLost-a,s=o+a,s=0<s?a/s*100:0,c=e.packetsReceived+e.packetsLost,c=0<c?e.packetsLost/c*100:100,u=("number"!=typeof e.rtt&&t?t:e).rtt,l=this._inputVolumes.splice(0),d=(this._supplementalSampleBuffers.audioInputLevel.push(l),this._outputVolumes.splice(0));return this._supplementalSampleBuffers.audioOutputLevel.push(d),{audioInputLevel:Math.round(m.average(l)),audioOutputLevel:Math.round(m.average(d)),bytesReceived:r,bytesSent:n,codecName:e.codecName,jitter:e.jitter,mos:this._mos.calculate(u,e.jitter,t&&s),packetsLost:a,packetsLostFraction:s,packetsReceived:o,packetsSent:i,rtt:u,timestamp:e.timestamp,totals:{bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,packetsLost:e.packetsLost,packetsLostFraction:c,packetsReceived:e.packetsReceived,packetsSent:e.packetsSent}}},f.prototype._fetchSample=function(){var t=this;this._getSample().then(function(e){t._addSample(e),t._raiseWarnings(),t.emit("sample",e)}).catch(function(e){t.disable(),t.emit("error",e)})},f.prototype._getSample=function(){var n=this;return this._getRTCStats(this._peerConnection).then(function(e){var t=null;return n._sampleBuffer.length&&(t=n._sampleBuffer[n._sampleBuffer.length-1]),n._createSample(e,t)})},f.prototype._raiseWarning=function(e,t,n){var r,i=e+":"+t;this._activeWarnings.has(i)||(this._activeWarnings.set(i,{timeRaised:Date.now()}),i=this._thresholds[e],Array.isArray(i)?(i=i.find(function(e){return t in e}))&&(r=i[t]):r=this._thresholds[e][t],this.emit("warning",o(o({},n),{name:e,threshold:{name:t,value:r}})))},f.prototype._raiseWarnings=function(){var t=this;this._warningsEnabled&&Object.keys(this._thresholds).forEach(function(e){return t._raiseWarningsForStat(e)})},f.prototype._raiseWarningsForStat=function(f){var p=this;(Array.isArray(this._thresholds[f])?this._thresholds[f]:[this._thresholds[f]]).forEach(function(r){var n,i,e,t,o=p._sampleBuffer,a=r.clearCount||0,s=r.raiseCount||3,c=r.sampleCount||p._maxSampleCount,u=o.slice(-c),l=u.map(function(e){return e[f]}),d=l.some(function(e){return null==e});if(!d){if("number"==typeof r.max&&(n=r.max,s<=(e=l.reduce(function(e,t){return e+(n<t?1:0)},0))?p._raiseWarning(f,"max",{values:l,samples:u}):e<=a&&p._clearWarning(f,"max",{values:l,samples:u})),"number"==typeof r.min&&(i=r.min,s<=(e=l.reduce(function(e,t){return e+(t<i?1:0)},0))?p._raiseWarning(f,"min",{values:l,samples:u}):e<=a&&p._clearWarning(f,"min",{values:l,samples:u})),"number"==typeof r.maxDuration&&1<o.length&&(d=(u=o.slice(-2))[0][f],s=u[1][f],e=p._currentStreaks.get(f)||0,p._currentStreaks.set(f,a=d===s?e+1:0),a>=r.maxDuration?p._raiseWarning(f,"maxDuration",{value:a}):0===a&&p._clearWarning(f,"maxDuration",{value:e})),"number"==typeof r.minStandardDeviation){o=p._supplementalSampleBuffers[f];if(!o||o.length<r.sampleCount)return;o.length>r.sampleCount&&o.splice(0,o.length-r.sampleCount);d=o.slice(-c).reduce(function(e,t){return h(e,t)},[]),a=(s=d).length<=0?null:(t=s.reduce(function(e,t){return e+t},0)/s.length,s=s.map(function(e){return Math.pow(e-t,2)}),Math.sqrt(s.reduce(function(e,t){return e+t},0)/s.length));if("number"!=typeof a)return;a<r.minStandardDeviation?p._raiseWarning(f,"minStandardDeviation",{value:a}):p._clearWarning(f,"minStandardDeviation",{value:a})}[["maxAverage",function(e,t){return t<e}],["minAverage",function(e,t){return e<t}]].forEach(function(e){var t,n=e[0],e=e[1];"number"==typeof r[n]&&l.length>=c&&(e(t=m.average(l),r[n])?p._raiseWarning(f,n,{values:l,samples:u}):e(t,r.clearValue||r[n])||p._clearWarning(f,n,{values:l,samples:u}))})}})};var d,e=f;function f(e){var t=d.call(this)||this,e=(t._activeWarnings=new Map,t._currentStreaks=new Map,t._inputVolumes=[],t._outputVolumes=[],t._sampleBuffer=[],t._supplementalSampleBuffers={audioInputLevel:[],audioOutputLevel:[]},t._warningsEnabled=!0,t._getRTCStats=(e=e||{}).getRTCStats||u,t._mos=e.Mos||c.default,t._peerConnection=e.peerConnection,t._thresholds=o(o({},l),e.thresholds),Object.values(t._thresholds).map(function(e){return e.sampleCount}).filter(function(e){return!!e}));return t._maxSampleCount=Math.max.apply(Math,h([5],e)),t._peerConnection&&t.enable(t._peerConnection),t}n.default=e},{"./errors":12,"./rtc/mos":25,"./rtc/stats":29,"./util":35,events:53}],35:[function(e,t,r){!function(n){!function(){function t(e){if(!(this instanceof t))return new t(e);this.message=e}function i(e){return!!e.userAgent.match("Electron")}function o(e,t){var n=!!t.userAgent.match("CriOS"),r=!!t.userAgent.match("HeadlessChrome"),e=void 0!==e.chrome&&"Google Inc."===t.vendor&&-1===t.userAgent.indexOf("OPR")&&-1===t.userAgent.indexOf("Edge");return n||i(t)||e||r}function a(e){return!!(e=e||("undefined"==typeof window?n:window).navigator)&&"string"==typeof e.userAgent&&/firefox|fxios/i.test(e.userAgent)}function s(e){return!!e.vendor&&-1!==e.vendor.indexOf("Apple")&&e.userAgent&&-1===e.userAgent.indexOf("CriOS")&&-1===e.userAgent.indexOf("FxiOS")}t.prototype.toString=function(){return"Twilio.Exception: "+this.message},r.Exception=t,r.average=function(e){return e&&e.length?e.reduce(function(e,t){return e+t})/e.length:0},r.difference=function(e,t,n){n=n||function(e){return e};var r=new Set(t.map(n));return e.filter(function(e){return!r.has(n(e))})},r.isElectron=i,r.isChrome=o,r.isFirefox=a,r.isLegacyEdge=function(e){return!!(e=e||("undefined"==typeof window?n:window).navigator)&&"string"==typeof e.userAgent&&/edge\/\d+/i.test(e.userAgent)},r.isSafari=s,r.isUnifiedPlanDefault=function(e,t,n,r){if(void 0===e||void 0===t||void 0===n||void 0===r||void 0===n.prototype||void 0===r.prototype)return!1;if(o(e,t)&&n.prototype.addTransceiver){e=new n,n=!0;try{e.addTransceiver("audio")}catch(e){n=!1}return e.close(),n}return!!a(t)||!!s(t)&&"currentDirection"in r.prototype},r.queryToJson=function(e){return e?e.split("&").reduce(function(e,t){var t=t.split("="),n=t[0],t=decodeURIComponent((t[1]||"").replace(/\+/g,"%20"));return n&&(e[n]=t),e},{}):""},r.flatMap=function(e,n){return e=e instanceof Map||e instanceof Set?Array.from(e.values()):e,n=n||function(e){return e},e.reduce(function(e,t){t=n(t);return e.concat(t)},[])}}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],36:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=e("md5"),i=e("../twilio/errors");n.generateVoiceEventSid=function(){return"KX"+function(){if("object"!=typeof window)throw new i.NotSupportedError("This platform is not supported.");var e=window.crypto;if("object"!=typeof e)throw new i.NotSupportedError("The `crypto` module is not available on this platform.");if(void 0===(e.randomUUID||e.getRandomValues))throw new i.NotSupportedError("Neither `crypto.randomUUID` or `crypto.getRandomValues` are available on this platform.");if(void 0===window.Uint32Array)throw new i.NotSupportedError("The `Uint32Array` module is not available on this platform.");var t="function"==typeof e.randomUUID?function(){return e.randomUUID()}:function(){return e.getRandomValues(new Uint32Array(32)).toString()};return r(t())}()}},{"../twilio/errors":12,md5:56}],37:[function(e,t,n){"use strict";var r,i,o,a=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},c=(Object.defineProperty(n,"__esModule",{value:!0}),e("events")),u=e("ws"),l=e("./errors"),d=e("./log"),f=e("backoff"),e=((e=i=n.WSTransportState||(n.WSTransportState={})).Connecting="connecting",e.Closed="closed",e.Open="open",o=c.EventEmitter,a(p,o),p.prototype.close=function(){this._log.info("WSTransport.close() called..."),this._close()},p.prototype.open=function(){this._log.info("WSTransport.open() called..."),!this._socket||this._socket.readyState!==u.CONNECTING&&this._socket.readyState!==u.OPEN?this._preferredUri?this._connect(this._preferredUri):this._connect(this._uris[this._uriIndex]):this._log.info("WebSocket already open.")},p.prototype.send=function(e){if(!this._socket||this._socket.readyState!==u.OPEN)return!1;try{this._socket.send(e)}catch(e){return this._log.info("Error while sending message:",e.message),this._closeSocket(),!1}return!0},p.prototype.updatePreferredURI=function(e){this._preferredUri=e},p.prototype.updateURIs=function(e){this._uris=e="string"==typeof e?[e]:e,this._uriIndex=0},p.prototype._close=function(){this._setState(i.Closed),this._closeSocket()},p.prototype._closeSocket=function(){clearTimeout(this._connectTimeout),clearTimeout(this._heartbeatTimeout),this._log.info("Closing and cleaning up WebSocket..."),this._socket?(this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("error",this._onSocketError),this._socket.removeEventListener("message",this._onSocketMessage),this._socket.removeEventListener("open",this._onSocketOpen),this._socket.readyState!==u.CONNECTING&&this._socket.readyState!==u.OPEN||this._socket.close(),this._timeOpened&&1e4<Date.now()-this._timeOpened&&this._resetBackoffs(),this.state!==i.Closed&&this._performBackoff(),delete this._socket,this.emit("close")):this._log.info("No WebSocket to clean up.")},p.prototype._connect=function(e,t){var n=this;this._log.info("number"==typeof t?"Attempting to reconnect (retry #"+t+")...":"Attempting to connect..."),this._closeSocket(),this._setState(i.Connecting),this._connectedUri=e;try{this._socket=new this._options.WebSocket(this._connectedUri)}catch(e){return this._log.info("Could not connect to endpoint:",e.message),this._close(),void this.emit("error",{code:31e3,message:e.message||"Could not connect to "+this._connectedUri,twilioError:new l.SignalingErrors.ConnectionDisconnected})}this._socket.addEventListener("close",this._onSocketClose),this._socket.addEventListener("error",this._onSocketError),this._socket.addEventListener("message",this._onSocketMessage),this._socket.addEventListener("open",this._onSocketOpen),delete this._timeOpened,this._connectTimeout=setTimeout(function(){n._log.info("WebSocket connection attempt timed out."),n._moveUriIndex(),n._closeSocket()},this._options.connectTimeoutMs)},p.prototype._performBackoff=function(){(this._preferredUri?(this._log.info("Preferred URI set; backing off."),this._backoff.preferred):(this._log.info("Preferred URI not set; backing off."),this._backoff.primary)).backoff()},p.prototype._resetBackoffs=function(){this._backoff.preferred.reset(),this._backoff.primary.reset(),this._backoffStartTime.preferred=null,this._backoffStartTime.primary=null},p.prototype._setHeartbeatTimeout=function(){var e=this;clearTimeout(this._heartbeatTimeout),this._heartbeatTimeout=setTimeout(function(){e._log.info("No messages received in 15 seconds. Reconnecting..."),e._shouldFallback=!0,e._closeSocket()},15e3)},p.prototype._setState=function(e){this._previousState=this.state,this.state=e},p.prototype._setupBackoffs=function(){var n=this,e={factor:2,maxDelay:this._options.maxPreferredDelayMs,randomisationFactor:.4},e=(this._log.info("Initializing preferred transport backoff using config: ",e),f.exponential(e)),t=(e.on("backoff",function(e,t){n.state===i.Closed?n._log.info("Preferred backoff initiated but transport state is closed; not attempting a connection."):(n._log.info("Will attempt to reconnect Websocket to preferred URI in "+t+"ms"),0===e&&(n._backoffStartTime.preferred=Date.now(),n._log.info("Preferred backoff start; "+n._backoffStartTime.preferred)))}),e.on("ready",function(e,t){n.state===i.Closed?n._log.info("Preferred backoff ready but transport state is closed; not attempting a connection."):null===n._backoffStartTime.preferred?n._log.info("Preferred backoff start time invalid; not attempting a connection."):Date.now()-n._backoffStartTime.preferred>n._options.maxPreferredDurationMs?(n._log.info("Max preferred backoff attempt time exceeded; falling back to primary backoff."),n._preferredUri=null,n._backoff.primary.backoff()):"string"!=typeof n._preferredUri?(n._log.info("Preferred URI cleared; falling back to primary backoff."),n._preferredUri=null,n._backoff.primary.backoff()):n._connect(n._preferredUri,e+1)}),{factor:2,initialDelay:this._uris&&1<this._uris.length?Math.floor(4001*Math.random())+1e3:100,maxDelay:this._options.maxPrimaryDelayMs,randomisationFactor:.4}),t=(this._log.info("Initializing primary transport backoff using config: ",t),f.exponential(t));return t.on("backoff",function(e,t){n.state===i.Closed?n._log.info("Primary backoff initiated but transport state is closed; not attempting a connection."):(n._log.info("Will attempt to reconnect WebSocket in "+t+"ms"),0===e&&(n._backoffStartTime.primary=Date.now(),n._log.info("Primary backoff start; "+n._backoffStartTime.primary)))}),t.on("ready",function(e,t){n.state===i.Closed?n._log.info("Primary backoff ready but transport state is closed; not attempting a connection."):null===n._backoffStartTime.primary?n._log.info("Primary backoff start time invalid; not attempting a connection."):Date.now()-n._backoffStartTime.primary>n._options.maxPrimaryDurationMs?n._log.info("Max primary backoff attempt time exceeded; not attempting a connection."):n._connect(n._uris[n._uriIndex],e+1)}),{preferred:e,primary:t}},Object.defineProperty(p.prototype,"uri",{get:function(){return this._connectedUri},enumerable:!0,configurable:!0}),p.defaultConstructorOptions={WebSocket:u,connectTimeoutMs:5e3,maxPreferredDelayMs:1e3,maxPreferredDurationMs:15e3,maxPrimaryDelayMs:2e4,maxPrimaryDurationMs:1/0},p);function p(e,t){void 0===t&&(t={});var n=o.call(this)||this;return n.state=i.Closed,n._backoffStartTime={preferred:null,primary:null},n._connectedUri=null,n._log=d.default.getInstance(),n._shouldFallback=!1,n._uriIndex=0,n._moveUriIndex=function(){n._uriIndex++,n._uriIndex>=n._uris.length&&(n._uriIndex=0)},n._onSocketClose=function(e){n._log.info("Received websocket close event code: "+e.code+". Reason: "+e.reason),1006!==e.code&&1015!==e.code||(n.emit("error",{code:31005,message:e.reason||"Websocket connection to Twilio's signaling servers were unexpectedly ended. If this is happening consistently, there may be an issue resolving the hostname provided. If a region or an edge is being specified in Device setup, ensure it is valid.",twilioError:new l.SignalingErrors.ConnectionError}),e=n.state===i.Open||n._previousState===i.Open,!n._shouldFallback&&e||n._moveUriIndex(),n._shouldFallback=!0),n._closeSocket()},n._onSocketError=function(e){n._log.info("WebSocket received error: "+e.message),n.emit("error",{code:31e3,message:e.message||"WSTransport socket error",twilioError:new l.SignalingErrors.ConnectionDisconnected})},n._onSocketMessage=function(e){n._setHeartbeatTimeout(),n._socket&&"\n"===e.data?n._socket.send("\n"):n.emit("message",e)},n._onSocketOpen=function(){n._log.info("WebSocket opened successfully."),n._timeOpened=Date.now(),n._shouldFallback=!1,n._setState(i.Open),clearTimeout(n._connectTimeout),n._resetBackoffs(),n._setHeartbeatTimeout(),n.emit("open")},n._options=s(s({},p.defaultConstructorOptions),t),n._uris=e,n._backoff=n._setupBackoffs(),n}n.default=e},{"./errors":12,"./log":15,backoff:45,events:53,ws:1}],38:[function(e,t,n){"use strict";var r=e("babel-runtime/regenerator"),s=(r=r)&&r.__esModule?r:{default:r},i=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c=function(o,a,s,c){return new(s=s||Promise)(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(n,r)}i((c=c.apply(o,a||[])).next())})},u=(Object.defineProperty(n,"__esModule",{value:!0}),e("./Deferred")),r=function(e){var t=a;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);function a(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=this,o=a;if(i instanceof o)return(t=function(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(this,(a.__proto__||Object.getPrototypeOf(a)).call(this)))._audioNode=null,t._pendingPlayDeferreds=[],t._loop=!1,t._src="",t._sinkId="default","string"!=typeof n&&(r=n),t._audioContext=e,t._audioElement=new(r.AudioFactory||Audio),t._bufferPromise=t._createPlayDeferred().promise,t._destination=t._audioContext.destination,t._gainNode=t._audioContext.createGain(),t._gainNode.connect(t._destination),t._XMLHttpRequest=r.XMLHttpRequestFactory||XMLHttpRequest,t.addEventListener("canplaythrough",function(){t._resolvePlayDeferreds()}),"string"==typeof n&&(t.src=n),t;throw new TypeError("Cannot call a class as a function")}return t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e),i(a,[{key:"load",value:function(){this._load(this._src)}},{key:"pause",value:function(){this.paused||(this._audioElement.pause(),this._audioNode.stop(),this._audioNode.disconnect(this._gainNode),this._audioNode=null,this._rejectPlayDeferreds(new Error("The play() request was interrupted by a call to pause().")))}},{key:"play",value:function(){return c(this,void 0,void 0,s.default.mark(function e(){var t,n=this;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.paused){e.next=6;break}return e.next=3,this._bufferPromise;case 3:if(this.paused){e.next=5;break}return e.abrupt("return");case 5:throw new Error("The play() request was interrupted by a call to pause().");case 6:return this._audioNode=this._audioContext.createBufferSource(),this._audioNode.loop=this.loop,this._audioNode.addEventListener("ended",function(){n._audioNode&&n._audioNode.loop||n.dispatchEvent("ended")}),e.next=11,this._bufferPromise;case 11:if(t=e.sent,this.paused)throw new Error("The play() request was interrupted by a call to pause().");e.next=14;break;case 14:if(this._audioNode.buffer=t,this._audioNode.connect(this._gainNode),this._audioNode.start(),this._audioElement.srcObject)return e.abrupt("return",this._audioElement.play());e.next=19;break;case 19:case"end":return e.stop()}},e,this)}))}},{key:"setSinkId",value:function(t){return c(this,void 0,void 0,s.default.mark(function e(){return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("function"!=typeof this._audioElement.setSinkId)throw new Error("This browser does not support setSinkId.");e.next=2;break;case 2:if(t===this.sinkId)return e.abrupt("return");e.next=4;break;case 4:if("default"===t)return this.paused||this._gainNode.disconnect(this._destination),this._audioElement.srcObject=null,this._destination=this._audioContext.destination,this._gainNode.connect(this._destination),this._sinkId=t,e.abrupt("return");e.next=11;break;case 11:return e.next=13,this._audioElement.setSinkId(t);case 13:if(this._audioElement.srcObject)return e.abrupt("return");e.next=15;break;case 15:this._gainNode.disconnect(this._audioContext.destination),this._destination=this._audioContext.createMediaStreamDestination(),this._audioElement.srcObject=this._destination.stream,this._sinkId=t,this._gainNode.connect(this._destination);case 20:case"end":return e.stop()}},e,this)}))}},{key:"_createPlayDeferred",value:function(){var e=new u.default;return this._pendingPlayDeferreds.push(e),e}},{key:"_load",value:function(r){var t=this;this._src&&this._src!==r&&this.pause(),this._src=r,this._bufferPromise=new Promise(function(n,e){return c(t,void 0,void 0,s.default.mark(function e(){var t;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}return e.abrupt("return",this._createPlayDeferred().promise);case 2:return e.next=4,function(r,i,o){return c(this,void 0,void 0,s.default.mark(function e(){var t,n;return s.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(t=new i).open("GET",o,!0),t.responseType="arraybuffer",e.next=5,new Promise(function(e){t.addEventListener("load",e),t.send()});case 5:return n=e.sent,e.prev=6,e.abrupt("return",r.decodeAudioData(n.target.response));case 10:return e.prev=10,e.t0=e.catch(6),e.abrupt("return",new Promise(function(e){r.decodeAudioData(n.target.response,e)}));case 13:case"end":return e.stop()}},e,this,[[6,10]])}))}(this._audioContext,this._XMLHttpRequest,r);case 4:t=e.sent,this.dispatchEvent("canplaythrough"),n(t);case 7:case"end":return e.stop()}},e,this)}))})}},{key:"_rejectPlayDeferreds",value:function(t){var e=this._pendingPlayDeferreds;e.splice(0,e.length).forEach(function(e){return(0,e.reject)(t)})}},{key:"_resolvePlayDeferreds",value:function(t){var e=this._pendingPlayDeferreds;e.splice(0,e.length).forEach(function(e){return(0,e.resolve)(t)})}},{key:"destination",get:function(){return this._destination}},{key:"loop",get:function(){return this._loop},set:function(e){var t;e||!this.loop||this.paused||(t=this)._audioNode.addEventListener("ended",function e(){t._audioNode.removeEventListener("ended",e),t.pause()}),this._loop=e}},{key:"muted",get:function(){return 0===this._gainNode.gain.value},set:function(e){this._gainNode.gain.value=e?0:1}},{key:"paused",get:function(){return null===this._audioNode}},{key:"src",get:function(){return this._src},set:function(e){this._load(e)}},{key:"srcObject",get:function(){return this._audioElement.srcObject},set:function(e){this._audioElement.srcObject=e}},{key:"sinkId",get:function(){return this._sinkId}}]),a}(e("./EventTarget").default);n.default=r},{"./Deferred":39,"./EventTarget":40,"babel-runtime/regenerator":44}],39:[function(e,t,n){"use strict";var r=function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e};function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(){var n=this;if(!(this instanceof o))throw new TypeError("Cannot call a class as a function");this.promise=new Promise(function(e,t){n._resolve=e,n._reject=t})}Object.defineProperty(n,"__esModule",{value:!0}),r(o,[{key:"reject",get:function(){return this._reject}},{key:"resolve",get:function(){return this._resolve}}]),n.default=o},{}],40:[function(e,t,n){"use strict";var r=function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e};function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}Object.defineProperty(n,"__esModule",{value:!0});var o=e("events"),e=(r(a,[{key:"addEventListener",value:function(e,t){return this._eventEmitter.addListener(e,t)}},{key:"dispatchEvent",value:function(e){for(var t,n=arguments.length,r=Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(t=this._eventEmitter).emit.apply(t,[e].concat(r))}},{key:"removeEventListener",value:function(e,t){return this._eventEmitter.removeListener(e,t)}}]),a);function a(){if(!(this instanceof a))throw new TypeError("Cannot call a class as a function");this._eventEmitter=new o.EventEmitter}n.default=e},{events:53}],41:[function(e,t,n){"use strict";e=e("./AudioPlayer");t.exports=e.default},{"./AudioPlayer":38}],42:[function(e,t,n){var r=function(){return this}()||Function("return this")(),i=r.regeneratorRuntime&&0<=Object.getOwnPropertyNames(r).indexOf("regeneratorRuntime"),o=i&&r.regeneratorRuntime;if(r.regeneratorRuntime=void 0,t.exports=e("./runtime"),i)r.regeneratorRuntime=o;else try{delete r.regeneratorRuntime}catch(e){r.regeneratorRuntime=void 0}},{"./runtime":43}],43:[function(e,T,t){!function(e){"use strict";var c,u,l,d,f,p,t,n=Object.prototype,h=n.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag",r="object"==typeof T,s=e.regeneratorRuntime;function m(e,t,n,r){var i,o,a,s,t=t&&t.prototype instanceof v?t:v,t=Object.create(t.prototype),r=new S(r||[]);return t._invoke=(i=e,o=n,a=r,s=u,function(e,t){if(s===d)throw new Error("Generator is already running");if(s===f){if("throw"===e)throw t;return C()}for(a.method=e,a.arg=t;;){var n=a.delegate;if(n){n=function e(t,n){var r=t.iterator[n.method];if(r===c){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=c,e(t,n),"throw"===n.method))return p;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}r=y(r,t.iterator,n.arg);if("throw"===r.type)return n.method="throw",n.arg=r.arg,n.delegate=null,p;r=r.arg;if(!r)return n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,p;{if(!r.done)return r;n[t.resultName]=r.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=c)}n.delegate=null;return p}(n,a);if(n){if(n===p)continue;return n}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if(s===u)throw s=f,a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);s=d;n=y(i,o,a);if("normal"===n.type){if(s=a.done?f:l,n.arg!==p)return{value:n.arg,done:a.done}}else"throw"===n.type&&(s=f,a.method="throw",a.arg=n.arg)}}),t}function y(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}function v(){}function g(){}function b(){}function _(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function w(a){var t;this._invoke=function(n,r){function e(){return new Promise(function(e,t){!function t(e,n,r,i){e=y(a[e],a,n);if("throw"===e.type)i(e.arg);else{var o=e.arg;if((n=o.value)&&"object"==typeof n&&h.call(n,"__await"))return Promise.resolve(n.__await).then(function(e){t("next",e,r,i)},function(e){t("throw",e,r,i)});Promise.resolve(n).then(function(e){o.value=e,r(o)},i)}}(n,r,e,t)})}return t=t?t.then(e,e):e()}}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function E(t){if(t){var n,e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return n=-1,(e=function e(){for(;++n<t.length;)if(h.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=c,e.done=!0,e}).next=e}return{next:C}}function C(){return{value:c,done:!0}}s?r&&(T.exports=s):((s=e.regeneratorRuntime=r?T.exports:{}).wrap=m,u="suspendedStart",l="suspendedYield",d="executing",f="completed",p={},(e={})[i]=function(){return this},r=(r=Object.getPrototypeOf)&&r(r(E([]))),r&&r!==n&&h.call(r,i)&&(e=r),t=b.prototype=v.prototype=Object.create(e),(g.prototype=t.constructor=b).constructor=g,b[a]=g.displayName="GeneratorFunction",s.isGeneratorFunction=function(e){e="function"==typeof e&&e.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},s.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(t),e},s.awrap=function(e){return{__await:e}},_(w.prototype),w.prototype[o]=function(){return this},s.AsyncIterator=w,s.async=function(e,t,n,r){var i=new w(m(e,t,n,r));return s.isGeneratorFunction(t)?i:i.next().then(function(e){return e.done?e.value:i.next()})},_(t),t[a]="Generator",t[i]=function(){return this},t.toString=function(){return"[object Generator]"},s.keys=function(n){var e,r=[];for(e in n)r.push(e);return r.reverse(),function e(){for(;r.length;){var t=r.pop();if(t in n)return e.value=t,e.done=!1,e}return e.done=!0,e}},s.values=E,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=c,this.done=!1,this.delegate=null,this.method="next",this.arg=c,this.tryEntries.forEach(x),!e)for(var t in this)"t"===t.charAt(0)&&h.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=c)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var r=this;function e(e,t){return o.type="throw",o.arg=n,r.next=e,t&&(r.method="next",r.arg=c),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var i=this.tryEntries[t],o=i.completion;if("root"===i.tryLoc)return e("end");if(i.tryLoc<=this.prev){var a=h.call(i,"catchLoc"),s=h.call(i,"finallyLoc");if(a&&s){if(this.prev<i.catchLoc)return e(i.catchLoc,!0);if(this.prev<i.finallyLoc)return e(i.finallyLoc)}else if(a){if(this.prev<i.catchLoc)return e(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return e(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&h.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}var o=(i=i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc?null:i)?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,p):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),x(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var n,r,i=this.tryEntries[t];if(i.tryLoc===e)return"throw"===(n=i.completion).type&&(r=n.arg,x(i)),r}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:E(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=c),p}})}(function(){return this}()||Function("return this")())},{}],44:[function(e,t,n){t.exports=e("regenerator-runtime")},{"regenerator-runtime":42}],45:[function(e,t,n){var r=e("./lib/backoff"),i=e("./lib/strategy/exponential"),o=e("./lib/strategy/fibonacci"),a=e("./lib/function_call.js.js.js.js");t.exports.Backoff=r,t.exports.FunctionCall=a,t.exports.FibonacciStrategy=o,t.exports.ExponentialStrategy=i,t.exports.fibonacci=function(e){return new r(new o(e))},t.exports.exponential=function(e){return new r(new i(e))},t.exports.call=function(e,t,n){var r=Array.prototype.slice.call(arguments);return e=r[0],t=r.slice(1,r.length-1),n=r[r.length-1],new a(e,t,n)}},{"./lib/backoff":46,"./lib/function_call.js":47,"./lib/strategy/exponential":48,"./lib/strategy/fibonacci":49}],46:[function(e,t,n){var r=e("events"),i=e("precond");function o(e){r.EventEmitter.call(this),this.backoffStrategy_=e,this.maxNumberOfRetry_=-1,this.backoffNumber_=0,this.backoffDelay_=0,this.timeoutID_=-1,this.handlers={backoff:this.onBackoff_.bind(this)}}e("util").inherits(o,r.EventEmitter),o.prototype.failAfter=function(e){i.checkArgument(0<e,"Expected a maximum number of retry greater than 0 but got %s.",e),this.maxNumberOfRetry_=e},o.prototype.backoff=function(e){i.checkState(-1===this.timeoutID_,"Backoff in progress."),this.backoffNumber_===this.maxNumberOfRetry_?(this.emit("fail",e),this.reset()):(this.backoffDelay_=this.backoffStrategy_.next(),this.timeoutID_=setTimeout(this.handlers.backoff,this.backoffDelay_),this.emit("backoff",this.backoffNumber_,this.backoffDelay_,e))},o.prototype.onBackoff_=function(){this.timeoutID_=-1,this.emit("ready",this.backoffNumber_,this.backoffDelay_),this.backoffNumber_++},o.prototype.reset=function(){this.backoffNumber_=0,this.backoffStrategy_.reset(),clearTimeout(this.timeoutID_),this.timeoutID_=-1},t.exports=o},{events:53,precond:57,util:65}],47:[function(e,t,n){var r=e("events"),i=e("precond"),o=e("util"),a=e("./backoff"),s=e("./strategy/fibonacci");function c(e,t,n){r.EventEmitter.call(this),i.checkIsFunction(e,"Expected fn to be a function."),i.checkIsArray(t,"Expected args to be an array."),i.checkIsFunction(n,"Expected callback to be a function."),this.function_=e,this.arguments_=t,this.callback_=n,this.lastResult_=[],this.numRetries_=0,this.backoff_=null,this.strategy_=null,this.failAfter_=-1,this.retryPredicate_=c.DEFAULT_RETRY_PREDICATE_,this.state_=c.State_.PENDING}o.inherits(c,r.EventEmitter),c.State_={PENDING:0,RUNNING:1,COMPLETED:2,ABORTED:3},c.DEFAULT_RETRY_PREDICATE_=function(e){return!0},c.prototype.isPending=function(){return this.state_==c.State_.PENDING},c.prototype.isRunning=function(){return this.state_==c.State_.RUNNING},c.prototype.isCompleted=function(){return this.state_==c.State_.COMPLETED},c.prototype.isAborted=function(){return this.state_==c.State_.ABORTED},c.prototype.setStrategy=function(e){return i.checkState(this.isPending(),"FunctionCall in progress."),this.strategy_=e,this},c.prototype.retryIf=function(e){return i.checkState(this.isPending(),"FunctionCall in progress."),this.retryPredicate_=e,this},c.prototype.getLastResult=function(){return this.lastResult_.concat()},c.prototype.getNumRetries=function(){return this.numRetries_},c.prototype.failAfter=function(e){return i.checkState(this.isPending(),"FunctionCall in progress."),this.failAfter_=e,this},c.prototype.abort=function(){this.isCompleted()||this.isAborted()||(this.isRunning()&&this.backoff_.reset(),this.state_=c.State_.ABORTED,this.lastResult_=[new Error("Backoff aborted.")],this.emit("abort"),this.doCallback_())},c.prototype.start=function(e){i.checkState(!this.isAborted(),"FunctionCall is aborted."),i.checkState(this.isPending(),"FunctionCall already started.");var t=this.strategy_||new s;this.backoff_=e?e(t):new a(t),this.backoff_.on("ready",this.doCall_.bind(this,!0)),this.backoff_.on("fail",this.doCallback_.bind(this)),this.backoff_.on("backoff",this.handleBackoff_.bind(this)),0<this.failAfter_&&this.backoff_.failAfter(this.failAfter_),this.state_=c.State_.RUNNING,this.doCall_(!1)},c.prototype.doCall_=function(e){e&&this.numRetries_++;e=["call"].concat(this.arguments_),r.EventEmitter.prototype.emit.apply(this,e),e=this.handleFunctionCallback_.bind(this);this.function_.apply(null,this.arguments_.concat(e))},c.prototype.doCallback_=function(){this.callback_.apply(null,this.lastResult_)},c.prototype.handleFunctionCallback_=function(){var e;this.isAborted()||(e=Array.prototype.slice.call(arguments),this.lastResult_=e,r.EventEmitter.prototype.emit.apply(this,["callback"].concat(e)),(e=e[0])&&this.retryPredicate_(e)?this.backoff_.backoff(e):(this.state_=c.State_.COMPLETED,this.doCallback_()))},c.prototype.handleBackoff_=function(e,t,n){this.emit("backoff",e,t,n)},t.exports=c},{"./backoff":46,"./strategy/fibonacci":49,events:53,precond:57,util:65}],48:[function(e,t,n){var r=e("util"),i=e("precond"),o=e("./strategy");function a(e){o.call(this,e),this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay(),this.factor_=a.DEFAULT_FACTOR,e&&void 0!==e.factor&&(i.checkArgument(1<e.factor,"Exponential factor should be greater than 1 but got %s.",e.factor),this.factor_=e.factor)}r.inherits(a,o),a.DEFAULT_FACTOR=2,a.prototype.next_=function(){return this.backoffDelay_=Math.min(this.nextBackoffDelay_,this.getMaxDelay()),this.nextBackoffDelay_=this.backoffDelay_*this.factor_,this.backoffDelay_},a.prototype.reset_=function(){this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay()},t.exports=a},{"./strategy":50,precond:57,util:65}],49:[function(e,t,n){var r=e("util"),i=e("./strategy");function o(e){i.call(this,e),this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay()}r.inherits(o,i),o.prototype.next_=function(){var e=Math.min(this.nextBackoffDelay_,this.getMaxDelay());return this.nextBackoffDelay_+=this.backoffDelay_,this.backoffDelay_=e},o.prototype.reset_=function(){this.nextBackoffDelay_=this.getInitialDelay(),this.backoffDelay_=0},t.exports=o},{"./strategy":50,util:65}],50:[function(e,t,n){e("events"),e("util");function r(e){return null!=e}function i(e){if(r((e=e||{}).initialDelay)&&e.initialDelay<1)throw new Error("The initial timeout must be greater than 0.");if(r(e.maxDelay)&&e.maxDelay<1)throw new Error("The maximal timeout must be greater than 0.");if(this.initialDelay_=e.initialDelay||100,this.maxDelay_=e.maxDelay||1e4,this.maxDelay_<=this.initialDelay_)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");if(r(e.randomisationFactor)&&(e.randomisationFactor<0||1<e.randomisationFactor))throw new Error("The randomisation factor must be between 0 and 1.");this.randomisationFactor_=e.randomisationFactor||0}i.prototype.getMaxDelay=function(){return this.maxDelay_},i.prototype.getInitialDelay=function(){return this.initialDelay_},i.prototype.next=function(){var e=this.next_(),t=1+Math.random()*this.randomisationFactor_;return Math.round(e*t)},i.prototype.next_=function(){throw new Error("BackoffStrategy.next_() unimplemented.")},i.prototype.reset=function(){this.reset_()},i.prototype.reset_=function(){throw new Error("BackoffStrategy.reset_() unimplemented.")},t.exports=i},{events:53,util:65}],51:[function(e,t,n){var r={utf8:{stringToBytes:function(e){return r.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(r.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],n=0;n<e.length;n++)t.push(255&e.charCodeAt(n));return t},bytesToString:function(e){for(var t=[],n=0;n<e.length;n++)t.push(String.fromCharCode(e[n]));return t.join("")}}};t.exports=r},{}],52:[function(e,t,n){var o,r;o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];0<e;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],n=0,r=0;n<e.length;n++,r+=8)t[r>>>5]|=e[n]<<24-r%32;return t},wordsToBytes:function(e){for(var t=[],n=0;n<32*e.length;n+=8)t.push(e[n>>>5]>>>24-n%32&255);return t},bytesToHex:function(e){for(var t=[],n=0;n<e.length;n++)t.push((e[n]>>>4).toString(16)),t.push((15&e[n]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return t},bytesToBase64:function(e){for(var t=[],n=0;n<e.length;n+=3)for(var r=e[n]<<16|e[n+1]<<8|e[n+2],i=0;i<4;i++)8*n+6*i<=8*e.length?t.push(o.charAt(r>>>6*(3-i)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],n=0,r=0;n<e.length;r=++n%4)0!=r&&t.push((o.indexOf(e.charAt(n-1))&Math.pow(2,-2*r+8)-1)<<2*r|o.indexOf(e.charAt(n))>>>6-2*r);return t}},t.exports=r},{}],53:[function(e,t,n){var d=Object.create||function(e){function t(){}return t.prototype=e,new t},a=Object.keys||function(e){var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return t},r=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function i(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=d(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}((t.exports=i).EventEmitter=i).prototype._events=void 0,i.prototype._maxListeners=void 0;var o,s=10;try{var c={};Object.defineProperty&&Object.defineProperty(c,"x",{value:0}),o=0===c.x}catch(e){o=!1}function u(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function l(e,t,n,r){var i,o;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return(i=e._events)?(i.newListener&&(e.emit("newListener",t,n.listener||n),i=e._events),o=i[t]):(i=e._events=d(null),e._eventsCount=0),o?("function"==typeof o?o=i[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),o.warned||(r=u(e))&&0<r&&o.length>r&&(o.warned=!0,(r=new Error("Possible EventEmitter memory leak detected. "+o.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.')).name="MaxListenersExceededWarning",r.emitter=e,r.type=t,r.count=o.length,"object"==typeof console)&&console.warn&&console.warn("%s: %s",r.name,r.message)):(o=i[t]=n,++e._eventsCount),e}function f(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function p(e,t,n){e={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},t=r.call(f,e);return t.listener=n,e.wrapFn=t}function h(e,t,n){e=e._events;if(!e)return[];e=e[t];if(!e)return[];if("function"==typeof e)return n?[e.listener||e]:[e];if(n){for(var r=e,i=new Array(r.length),o=0;o<i.length;++o)i[o]=r[o].listener||r[o];return i}return z(e,e.length)}function m(e){var t=this._events;if(t){t=t[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function z(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}o?Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');s=e}}):i.defaultMaxListeners=s,i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return u(this)},i.prototype.emit=function(e){var t,n,r,i,o="error"===e,a=this._events;if(a)o=o&&null==a.error;else if(!o)return!1;if(o)throw(t=1<arguments.length?arguments[1]:t)instanceof Error?t:((o=new Error('Unhandled "error" event. ('+t+")")).context=t,o);if(!(n=a[e]))return!1;var s,c="function"==typeof n;switch(s=arguments.length){case 1:var u=n,l=c,d=this;if(l)u.call(d);else for(var f=u.length,j=z(u,f),p=0;p<f;++p)j[p].call(d);break;case 2:var l=n,u=c,h=this,m=arguments[1];if(u)l.call(h,m);else for(var y=l.length,L=z(l,y),v=0;v<y;++v)L[v].call(h,m);break;case 3:var g=n,b=c,_=this,w=arguments[1],k=arguments[2];if(b)g.call(_,w,k);else for(var x=g.length,N=z(g,x),S=0;S<x;++S)N[S].call(_,w,k);break;case 4:var b=n,g=c,E=this,C=arguments[1],T=arguments[2],I=arguments[3];if(g)b.call(E,C,T,I);else for(var R=b.length,U=z(b,R),P=0;P<R;++P)U[P].call(E,C,T,I);break;default:for(r=new Array(s-1),i=1;i<s;i++)r[i-1]=arguments[i];var O=n,F=c,A=this,M=r;if(F)O.apply(A,M);else for(var B=O.length,q=z(O,B),D=0;D<B;++D)q[D].apply(A,M)}return!0},i.prototype.on=i.prototype.addListener=function(e,t){return l(this,e,t,!1)},i.prototype.prependListener=function(e,t){return l(this,e,t,!0)},i.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,p(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,p(this,e,t)),this},i.prototype.removeListener=function(e,t){var n,r,i,o,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if((r=this._events)&&(n=r[e]))if(n===t||n.listener===t)0==--this._eventsCount?this._events=d(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;0<=o;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;if(0===i)n.shift();else{for(var s=n,c=i,u=c+1,l=s.length;u<l;c+=1,u+=1)s[c]=s[u];s.pop()}1===n.length&&(r[e]=n[0]),r.removeListener&&this.emit("removeListener",e,a||t)}return this},i.prototype.removeAllListeners=function(e){var t,n=this._events;if(n)if(n.removeListener){if(0===arguments.length){for(var r,i=a(n),o=0;o<i.length;++o)"removeListener"!==(r=i[o])&&this.removeAllListeners(r);this.removeAllListeners("removeListener"),this._events=d(null),this._eventsCount=0}else if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(o=t.length-1;0<=o;o--)this.removeListener(e,t[o])}else 0===arguments.length?(this._events=d(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=d(null):delete n[e]);return this},i.prototype.listeners=function(e){return h(this,e,!0)},i.prototype.rawListeners=function(e){return h(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},i.prototype.listenerCount=m,i.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]}},{}],54:[function(e,t,n){function r(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}t.exports=function(e){return null!=e&&(r(e)||"function"==typeof(t=e).readFloatLE&&"function"==typeof t.slice&&r(t.slice(0,0))||!!e._isBuffer);var t}},{}],55:[function(e,n,t){!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof n&&n.exports?n.exports=t():e.log=t()}(this,function(){"use strict";var i=function(){},s="undefined",r=typeof window!==s&&typeof window.navigator!==s&&/Trident\/|MSIE /.test(window.navigator.userAgent),c=["trace","debug","info","warn","error"];function o(t,e){var n=t[e];if("function"==typeof n.bind)return n.bind(t);try{return Function.prototype.bind.call(n,t)}catch(e){return function(){return Function.prototype.apply.apply(n,[t,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function u(e,t){for(var n=0;n<c.length;n++){var r=c[n];this[r]=n<e?i:this.methodFactory(r,e,t)}this.log=this.debug}function l(e,t,n){return"debug"===(e=e)&&(e="log"),typeof console!==s&&("trace"===e&&r?a:void 0!==console[e]?o(console,e):void 0!==console.log?o(console,"log"):i)||function(e,t,n){return function(){typeof console!==s&&(u.call(this,t,n),this[e].apply(this,arguments))}}.apply(this,arguments)}function t(n,e,t){var r,i=this,o="loglevel";function a(){var e;if(typeof window!==s){try{e=window.localStorage[o]}catch(e){}if(typeof e===s)try{var t=window.document.cookie,n=t.indexOf(encodeURIComponent(o)+"=");-1!==n&&(e=/^([^;]+)/.exec(t.slice(n))[1])}catch(e){}return e=void 0===i.levels[e]?void 0:e}}n&&(o+=":"+n),i.name=n,i.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},i.methodFactory=t||l,i.getLevel=function(){return r},i.setLevel=function(e,t){if(!("number"==typeof(e="string"==typeof e&&void 0!==i.levels[e.toUpperCase()]?i.levels[e.toUpperCase()]:e)&&0<=e&&e<=i.levels.SILENT))throw"log.setLevel() called with invalid level: "+e;if(r=e,!1!==t&&!function(e){if(e=(c[e]||"silent").toUpperCase(),typeof window!==s){try{return window.localStorage[o]=e}catch(e){}try{window.document.cookie=encodeURIComponent(o)+"="+e+";"}catch(e){}}}(e),u.call(i,e,n),typeof console===s&&e<i.levels.SILENT)return"No console available for logging"},i.setDefaultLevel=function(e){a()||i.setLevel(e,!1)},i.enableAll=function(e){i.setLevel(i.levels.TRACE,e)},i.disableAll=function(e){i.setLevel(i.levels.SILENT,e)};t=a();i.setLevel(t=null==t?null==e?"WARN":e:t,!1)}var n=new t,d={},e=(n.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");return d[e]||(d[e]=new t(e,n.getLevel(),n.methodFactory))},typeof window!==s?window.log:void 0);return n.noConflict=function(){return typeof window!==s&&window.log===n&&(window.log=e),n},n.getLoggers=function(){return d},n})},{}],56:[function(e,t,n){function y(e,t){e.constructor==String?e=(t&&"binary"===t.encoding?_:g).stringToBytes(e):b(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||e.constructor===Uint8Array||(e=e.toString());for(var n=v.bytesToWords(e),t=8*e.length,r=1732584193,i=-271733879,o=-1732584194,a=271733878,s=0;s<n.length;s++)n[s]=16711935&(n[s]<<8|n[s]>>>24)|4278255360&(n[s]<<24|n[s]>>>8);n[t>>>5]|=128<<t%32,n[14+(64+t>>>9<<4)]=t;for(var c=y._ff,u=y._gg,l=y._hh,d=y._ii,s=0;s<n.length;s+=16){var f=r,p=i,h=o,m=a,r=c(r,i,o,a,n[s+0],7,-680876936),a=c(a,r,i,o,n[s+1],12,-389564586),o=c(o,a,r,i,n[s+2],17,606105819),i=c(i,o,a,r,n[s+3],22,-1044525330);r=c(r,i,o,a,n[s+4],7,-176418897),a=c(a,r,i,o,n[s+5],12,1200080426),o=c(o,a,r,i,n[s+6],17,-1473231341),i=c(i,o,a,r,n[s+7],22,-45705983),r=c(r,i,o,a,n[s+8],7,1770035416),a=c(a,r,i,o,n[s+9],12,-1958414417),o=c(o,a,r,i,n[s+10],17,-42063),i=c(i,o,a,r,n[s+11],22,-1990404162),r=c(r,i,o,a,n[s+12],7,1804603682),a=c(a,r,i,o,n[s+13],12,-40341101),o=c(o,a,r,i,n[s+14],17,-1502002290),r=u(r,i=c(i,o,a,r,n[s+15],22,1236535329),o,a,n[s+1],5,-165796510),a=u(a,r,i,o,n[s+6],9,-1069501632),o=u(o,a,r,i,n[s+11],14,643717713),i=u(i,o,a,r,n[s+0],20,-373897302),r=u(r,i,o,a,n[s+5],5,-701558691),a=u(a,r,i,o,n[s+10],9,38016083),o=u(o,a,r,i,n[s+15],14,-660478335),i=u(i,o,a,r,n[s+4],20,-405537848),r=u(r,i,o,a,n[s+9],5,568446438),a=u(a,r,i,o,n[s+14],9,-1019803690),o=u(o,a,r,i,n[s+3],14,-187363961),i=u(i,o,a,r,n[s+8],20,1163531501),r=u(r,i,o,a,n[s+13],5,-1444681467),a=u(a,r,i,o,n[s+2],9,-51403784),o=u(o,a,r,i,n[s+7],14,1735328473),r=l(r,i=u(i,o,a,r,n[s+12],20,-1926607734),o,a,n[s+5],4,-378558),a=l(a,r,i,o,n[s+8],11,-2022574463),o=l(o,a,r,i,n[s+11],16,1839030562),i=l(i,o,a,r,n[s+14],23,-35309556),r=l(r,i,o,a,n[s+1],4,-1530992060),a=l(a,r,i,o,n[s+4],11,1272893353),o=l(o,a,r,i,n[s+7],16,-155497632),i=l(i,o,a,r,n[s+10],23,-1094730640),r=l(r,i,o,a,n[s+13],4,681279174),a=l(a,r,i,o,n[s+0],11,-358537222),o=l(o,a,r,i,n[s+3],16,-722521979),i=l(i,o,a,r,n[s+6],23,76029189),r=l(r,i,o,a,n[s+9],4,-640364487),a=l(a,r,i,o,n[s+12],11,-421815835),o=l(o,a,r,i,n[s+15],16,530742520),r=d(r,i=l(i,o,a,r,n[s+2],23,-995338651),o,a,n[s+0],6,-198630844),a=d(a,r,i,o,n[s+7],10,1126891415),o=d(o,a,r,i,n[s+14],15,-1416354905),i=d(i,o,a,r,n[s+5],21,-57434055),r=d(r,i,o,a,n[s+12],6,1700485571),a=d(a,r,i,o,n[s+3],10,-1894986606),o=d(o,a,r,i,n[s+10],15,-1051523),i=d(i,o,a,r,n[s+1],21,-2054922799),r=d(r,i,o,a,n[s+8],6,1873313359),a=d(a,r,i,o,n[s+15],10,-30611744),o=d(o,a,r,i,n[s+6],15,-1560198380),i=d(i,o,a,r,n[s+13],21,1309151649),r=d(r,i,o,a,n[s+4],6,-145523070),a=d(a,r,i,o,n[s+11],10,-1120210379),o=d(o,a,r,i,n[s+2],15,718787259),i=d(i,o,a,r,n[s+9],21,-343485551),r=r+f>>>0,i=i+p>>>0,o=o+h>>>0,a=a+m>>>0}return v.endian([r,i,o,a])}var v,g,b,_;v=e("crypt"),g=e("charenc").utf8,b=e("is-buffer"),_=e("charenc").bin,y._ff=function(e,t,n,r,i,o,a){e=e+(t&n|~t&r)+(i>>>0)+a;return(e<<o|e>>>32-o)+t},y._gg=function(e,t,n,r,i,o,a){e=e+(t&r|n&~r)+(i>>>0)+a;return(e<<o|e>>>32-o)+t},y._hh=function(e,t,n,r,i,o,a){e=e+(t^n^r)+(i>>>0)+a;return(e<<o|e>>>32-o)+t},y._ii=function(e,t,n,r,i,o,a){e=e+(n^(t|~r))+(i>>>0)+a;return(e<<o|e>>>32-o)+t},y._blocksize=16,y._digestsize=16,t.exports=function(e,t){if(null==e)throw new Error("Illegal argument "+e);e=v.wordsToBytes(y(e,t));return t&&t.asBytes?e:t&&t.asString?_.bytesToString(e):v.bytesToHex(e)}},{charenc:51,crypt:52,"is-buffer":54}],57:[function(e,t,n){t.exports=e("./lib/checks")},{"./lib/checks":58}],58:[function(e,t,n){var i=e("util"),o=t.exports=e("./errors");function a(e,t,n,r){e=new e(i.format.apply(this,[n=n||""].concat(r)));throw Error.captureStackTrace(e,t),e}function s(e,t,n){a(o.IllegalArgumentError,e,t,n)}function c(e){var t=typeof e;if("object"==t){if(!e)return"null";if(e instanceof Array)return"array"}return t}function r(r){return function(e,t){var n=c(e);if(n==r)return e;s(arguments.callee,t||'Expected "'+r+'" but got "'+n+'".',Array.prototype.slice.call(arguments,2))}}t.exports.checkArgument=function(e,t){e||s(arguments.callee,t,Array.prototype.slice.call(arguments,2))},t.exports.checkState=function(e,t){var n,r,i;e||(n=arguments.callee,r=t,i=Array.prototype.slice.call(arguments,2),a(o.IllegalStateError,n,r,i))},t.exports.checkIsDef=function(e,t){if(void 0!==e)return e;s(arguments.callee,t||"Expected value to be defined but was undefined.",Array.prototype.slice.call(arguments,2))},t.exports.checkIsDefAndNotNull=function(e,t){if(null!=e)return e;s(arguments.callee,t||'Expected value to be defined and not null but got "'+c(e)+'".',Array.prototype.slice.call(arguments,2))},t.exports.checkIsString=r("string"),t.exports.checkIsArray=r("array"),t.exports.checkIsNumber=r("number"),t.exports.checkIsBoolean=r("boolean"),t.exports.checkIsFunction=r("function"),t.exports.checkIsObject=r("object")},{"./errors":59,util:65}],59:[function(e,t,n){e=e("util");function r(e){Error.call(this,e),this.message=e}function i(e){Error.call(this,e),this.message=e}e.inherits(r,Error),r.prototype.name="IllegalArgumentError",e.inherits(i,Error),i.prototype.name="IllegalStateError",t.exports.IllegalStateError=i,t.exports.IllegalArgumentError=r},{util:65}],60:[function(e,t,n){var r,i,t=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}try{r="function"==typeof setTimeout?setTimeout:o}catch(e){r=o}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(e){i=a}function s(t){if(r===setTimeout)return setTimeout(t,0);if((r===o||!r)&&setTimeout)return(r=setTimeout)(t,0);try{return r(t,0)}catch(e){try{return r.call(null,t,0)}catch(e){return r.call(this,t,0)}}}var c,u=[],l=!1,d=-1;function f(){l&&c&&(l=!1,c.length?u=c.concat(u):d=-1,u.length)&&p()}function p(){if(!l){for(var e=s(f),t=(l=!0,u.length);t;){for(c=u,u=[];++d<t;)c&&c[d].run();d=-1,t=u.length}c=null,l=!1,!function(t){if(i===clearTimeout)return clearTimeout(t);if((i===a||!i)&&clearTimeout)return(i=clearTimeout)(t);try{i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function m(){}t.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new h(e,t)),1!==u.length||l||s(p)},h.prototype.run=function(){this.fun.apply(null,this.array)},t.title="browser",t.browser=!0,t.env={},t.argv=[],t.version="",t.versions={},t.on=m,t.addListener=m,t.once=m,t.off=m,t.removeListener=m,t.removeAllListeners=m,t.emit=m,t.prependListener=m,t.prependOnceListener=m,t.listeners=function(e){return[]},t.binding=function(e){throw new Error("process.binding is not supported")},t.cwd=function(){return"/"},t.chdir=function(e){throw new Error("process.chdir is not supported")},t.umask=function(){return 0}},{}],61:[function(e,t,n){"use strict";var O=e("sdp");function a(e,t,n,r,i){t=O.writeRtpDescription(e.kind,t);return t=(t=(t+=O.writeIceParameters(e.iceGatherer.getLocalParameters()))+O.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":i||"active"))+("a=mid:"+e.mid+"\r\n"),e.rtpSender&&e.rtpReceiver?t+="a=sendrecv\r\n":e.rtpSender?t+="a=sendonly\r\n":e.rtpReceiver?t+="a=recvonly\r\n":t+="a=inactive\r\n",e.rtpSender&&(n=e.rtpSender._initialTrackId||e.rtpSender.track.id,e.rtpSender._initialTrackId=n,t=t+"a="+(i="msid:"+(r?r.id:"-")+" "+n+"\r\n")+"a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+i,e.sendEncodingParameters[0].rtx)&&(t=(t+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+i)+"a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"),t+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+O.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(t+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+O.localCName+"\r\n"),t}function f(r,i){function o(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]}var a={codecs:[],headerExtensions:[],fecMechanisms:[]};return r.codecs.forEach(function(n){for(var e=0;e<i.codecs.length;e++){var t=i.codecs[e];if(n.name.toLowerCase()===t.name.toLowerCase()&&n.clockRate===t.clockRate&&("rtx"!==n.name.toLowerCase()||!n.parameters||!t.parameters.apt||function(e,t,n,r){e=o(e.parameters.apt,n),n=o(t.parameters.apt,r);return e&&n&&e.name.toLowerCase()===n.name.toLowerCase()}(n,t,r.codecs,i.codecs))){(t=JSON.parse(JSON.stringify(t))).numChannels=Math.min(n.numChannels,t.numChannels),a.codecs.push(t),t.rtcpFeedback=t.rtcpFeedback.filter(function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),r.headerExtensions.forEach(function(e){for(var t=0;t<i.headerExtensions.length;t++){var n=i.headerExtensions[t];if(e.uri===n.uri){a.headerExtensions.push(n);break}}}),a}function o(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function A(e,t){var n=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return n||e.addRemoteCandidate(t),!n}function p(e,t){t=new Error(t);return t.name=e,t}t.exports=function(I,R){function P(e,t){t.addTrack(e),t.dispatchEvent(new I.MediaStreamTrackEvent("addtrack",{track:e}))}function i(e,t,n,r){var i=new Event("track");i.track=t,i.receiver=n,i.transceiver={receiver:n},i.streams=r,I.setTimeout(function(){e._dispatchEvent("track",i)})}function r(e){var t,r,i,n=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){n[e]=o[e].bind(o)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this.localDescription=null,this.remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",e=JSON.parse(JSON.stringify(e||{})),this.usingBundle="max-bundle"===e.bundlePolicy,"negotiate"===e.rtcpMuxPolicy)throw p("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(e.rtcpMuxPolicy||(e.rtcpMuxPolicy="require"),e.iceTransportPolicy){case"all":case"relay":break;default:e.iceTransportPolicy="all"}switch(e.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:e.bundlePolicy="balanced"}if(e.iceServers=(t=e.iceServers||[],r=R,i=!1,(t=JSON.parse(JSON.stringify(t))).filter(function(e){var t,n;if(e&&(e.urls||e.url))return n=e.urls||e.url,e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead."),n=(n=(t="string"==typeof n)?[n]:n).filter(function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||i?0===e.indexOf("stun:")&&14393<=r&&-1===e.indexOf("?transport=udp"):i=!0}),delete e.url,e.urls=t?n[0]:n,!!n.length})),this._iceGatherers=[],e.iceCandidatePoolSize)for(var a=e.iceCandidatePoolSize;0<a;a--)this._iceGatherers.push(new I.RTCIceGatherer({iceServers:e.iceServers,gatherPolicy:e.iceTransportPolicy}));else e.iceCandidatePoolSize=0;this._config=e,this.transceivers=[],this._sdpSessionId=O.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1}r.prototype.onicecandidate=null,r.prototype.onaddstream=null,r.prototype.ontrack=null,r.prototype.onremovestream=null,r.prototype.onsignalingstatechange=null,r.prototype.oniceconnectionstatechange=null,r.prototype.onicegatheringstatechange=null,r.prototype.onnegotiationneeded=null,r.prototype.ondatachannel=null,r.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},r.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},r.prototype.getConfiguration=function(){return this._config},r.prototype.getLocalStreams=function(){return this.localStreams},r.prototype.getRemoteStreams=function(){return this.remoteStreams},r.prototype._createTransceiver=function(e){var t=0<this.transceivers.length,e={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};return this.usingBundle&&t?(e.iceTransport=this.transceivers[0].iceTransport,e.dtlsTransport=this.transceivers[0].dtlsTransport):(t=this._createIceAndDtlsTransports(),e.iceTransport=t.iceTransport,e.dtlsTransport=t.dtlsTransport),this.transceivers.push(e),e},r.prototype.addTrack=function(t,e){if(this._isClosed)throw p("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find(function(e){return e.track===t}))throw p("InvalidAccessError","Track already exists.");for(var r=0;r<this.transceivers.length;r++)this.transceivers[r].track||this.transceivers[r].kind!==t.kind||(n=this.transceivers[r]);return n=n||this._createTransceiver(t.kind),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(e)&&this.localStreams.push(e),n.track=t,n.stream=e,n.rtpSender=new I.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},r.prototype.addStream=function(t){var r,n=this;15025<=R?t.getTracks().forEach(function(e){n.addTrack(e,t)}):(r=t.clone(),t.getTracks().forEach(function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),r.getTracks().forEach(function(e){n.addTrack(e,r)}))},r.prototype.removeTrack=function(t){if(this._isClosed)throw p("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof I.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var e=this.transceivers.find(function(e){return e.rtpSender===t});if(!e)throw p("InvalidAccessError","Sender was not created by this connection.");var n=e.stream;e.rtpSender.stop(),e.rtpSender=null,e.track=null,e.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(n)&&-1<this.localStreams.indexOf(n)&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},r.prototype.removeStream=function(e){var n=this;e.getTracks().forEach(function(t){var e=n.getSenders().find(function(e){return e.track===t});e&&n.removeTrack(e)})},r.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},r.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},r.prototype._createIceGatherer=function(n,e){var r,i=this;return e&&0<n?this.transceivers[0].iceGatherer:this._iceGatherers.length?this._iceGatherers.shift():(r=new I.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy}),Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[n].bufferedCandidateEvents=[],this.transceivers[n].bufferCandidates=function(e){var t=!e.candidate||0===Object.keys(e.candidate).length;r.state=t?"completed":"gathering",null!==i.transceivers[n].bufferedCandidateEvents&&i.transceivers[n].bufferedCandidateEvents.push(e)},r.addEventListener("localcandidate",this.transceivers[n].bufferCandidates),r)},r.prototype._gather=function(r,i){var e,o=this,a=this.transceivers[i].iceGatherer;a.onlocalcandidate||(e=this.transceivers[i].bufferedCandidateEvents,this.transceivers[i].bufferedCandidateEvents=null,a.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),a.onlocalcandidate=function(e){var t,n;o.usingBundle&&0<i||((t=new Event("icecandidate")).candidate={sdpMid:r,sdpMLineIndex:i},(n=!(e=e.candidate)||0===Object.keys(e).length)?"new"!==a.state&&"gathering"!==a.state||(a.state="completed"):("new"===a.state&&(a.state="gathering"),e.component=1,e=O.writeCandidate(e),t.candidate=Object.assign(t.candidate,O.parseCandidate(e)),t.candidate.candidate=e),(e=O.getMediaSections(o.localDescription.sdp))[t.candidate.sdpMLineIndex]+=n?"a=end-of-candidates\r\n":"a="+t.candidate.candidate+"\r\n",o.localDescription.sdp=O.getDescription(o.localDescription.sdp)+e.join(""),e=o.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}),"gathering"!==o.iceGatheringState&&(o.iceGatheringState="gathering",o._emitGatheringStateChange()),n||o._dispatchEvent("icecandidate",t),e&&(o._dispatchEvent("icecandidate",new Event("icecandidate")),o.iceGatheringState="complete",o._emitGatheringStateChange()))},I.setTimeout(function(){e.forEach(function(e){a.onlocalcandidate(e)})},0))},r.prototype._createIceAndDtlsTransports=function(){var e=this,t=new I.RTCIceTransport(null),n=(t.onicestatechange=function(){e._updateConnectionState()},new I.RTCDtlsTransport(t));return n.ondtlsstatechange=function(){e._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),e._updateConnectionState()},{iceTransport:t,dtlsTransport:n}},r.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer,t=(t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer),this.transceivers[e].iceTransport),t=(t&&(delete t.onicestatechange,delete this.transceivers[e].iceTransport),this.transceivers[e].dtlsTransport);t&&(delete t.ondtlsstatechange,delete t.onerror,delete this.transceivers[e].dtlsTransport)},r.prototype._transceive=function(e,t,n){var r=f(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(r.encodings=e.sendEncodingParameters,r.rtcp={cname:O.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(r.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(r)),n&&e.rtpReceiver&&0<r.codecs.length&&("video"===e.kind&&e.recvEncodingParameters&&R<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?r.encodings=e.recvEncodingParameters:r.encodings=[{}],r.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(r.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(r.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(r))},r.prototype.setLocalDescription=function(e){var t,u,l,d=this;return-1===["offer","answer"].indexOf(e.type)?Promise.reject(p("TypeError",'Unsupported type "'+e.type+'"')):!o("setLocalDescription",e.type,d.signalingState)||d._isClosed?Promise.reject(p("InvalidStateError","Can not set local "+e.type+" in state "+d.signalingState)):("offer"===e.type?(t=O.splitSections(e.sdp),u=t.shift(),t.forEach(function(e,t){e=O.parseRtpParameters(e);d.transceivers[t].localCapabilities=e}),d.transceivers.forEach(function(e,t){d._gather(e.mid,t)})):"answer"===e.type&&(u=(t=O.splitSections(d.remoteDescription.sdp)).shift(),l=0<O.matchPrefix(u,"a=ice-lite").length,t.forEach(function(e,t){var n,r=d.transceivers[t],i=r.iceGatherer,o=r.iceTransport,a=r.dtlsTransport,s=r.localCapabilities,c=r.remoteCapabilities;O.isRejected(e)&&0===O.matchPrefix(e,"a=bundle-only").length||r.isDatachannel||(n=O.getIceParameters(e,u),e=O.getDtlsParameters(e,u),l&&(e.role="server"),d.usingBundle&&0!==t||(d._gather(r.mid,t),"new"===o.state&&o.start(i,n,l?"controlling":"controlled"),"new"===a.state&&a.start(e)),t=f(s,c),d._transceive(r,0<t.codecs.length,!1))})),d.localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?d._updateSignalingState("have-local-offer"):d._updateSignalingState("stable"),Promise.resolve())},r.prototype.setRemoteDescription=function(w){var k,x,e,S,E,C,t,T=this;return-1===["offer","answer"].indexOf(w.type)?Promise.reject(p("TypeError",'Unsupported type "'+w.type+'"')):!o("setRemoteDescription",w.type,T.signalingState)||T._isClosed?Promise.reject(p("InvalidStateError","Can not set remote "+w.type+" in state "+T.signalingState)):(k={},T.remoteStreams.forEach(function(e){k[e.id]=e}),x=[],e=O.splitSections(w.sdp),S=e.shift(),E=0<O.matchPrefix(S,"a=ice-lite").length,C=0<O.matchPrefix(S,"a=group:BUNDLE ").length,T.usingBundle=C,t=O.matchPrefix(S,"a=ice-options:")[0],T.canTrickleIceCandidates=!!t&&0<=t.substr(14).split(" ").indexOf("trickle"),e.forEach(function(e,t){var n,r,i,o,a,s,c,u,l,d,f,p,h,m=O.splitLines(e),y=O.getKind(e),v=O.isRejected(e)&&0===O.matchPrefix(e,"a=bundle-only").length,m=m[0].substr(2).split(" ")[2],g=O.getDirection(e,S),b=O.parseMsid(e),_=O.getMid(e)||O.generateIdentifier();"application"===y&&"DTLS/SCTP"===m?T.transceivers[t]={mid:_,isDatachannel:!0}:(m=O.parseRtpParameters(e),v||(a=O.getIceParameters(e,S),(s=O.getDtlsParameters(e,S)).role="client"),i=O.parseRtpEncodingParameters(e),c=O.parseRtcpParameters(e),u=0<O.matchPrefix(e,"a=end-of-candidates",S).length,e=O.matchPrefix(e,"a=candidate:").map(function(e){return O.parseCandidate(e)}).filter(function(e){return 1===e.component}),("offer"===w.type||"answer"===w.type)&&!v&&C&&0<t&&T.transceivers[t]&&(T._disposeIceAndDtlsTransports(t),T.transceivers[t].iceGatherer=T.transceivers[0].iceGatherer,T.transceivers[t].iceTransport=T.transceivers[0].iceTransport,T.transceivers[t].dtlsTransport=T.transceivers[0].dtlsTransport,T.transceivers[t].rtpSender&&T.transceivers[t].rtpSender.setTransport(T.transceivers[0].dtlsTransport),T.transceivers[t].rtpReceiver)&&T.transceivers[t].rtpReceiver.setTransport(T.transceivers[0].dtlsTransport),"offer"!==w.type||v?"answer"!==w.type||v||(v=(n=T.transceivers[t]).iceGatherer,p=n.iceTransport,r=n.dtlsTransport,h=n.rtpReceiver,l=n.sendEncodingParameters,o=n.localCapabilities,T.transceivers[t].recvEncodingParameters=i,T.transceivers[t].remoteCapabilities=m,T.transceivers[t].rtcpParameters=c,e.length&&"new"===p.state&&(!E&&!u||C&&0!==t?e.forEach(function(e){A(n.iceTransport,e)}):p.setRemoteCandidates(e)),C&&0!==t||("new"===p.state&&p.start(v,a,"controlling"),"new"===r.state&&r.start(s)),T._transceive(n,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!h||"sendrecv"!==g&&"sendonly"!==g?delete n.rtpReceiver:(f=h.track,b?(k[b.stream]||(k[b.stream]=new I.MediaStream),P(f,k[b.stream]),x.push([f,h,k[b.stream]])):(k.default||(k.default=new I.MediaStream),P(f,k.default),x.push([f,h,k.default])))):((n=T.transceivers[t]||T._createTransceiver(y)).mid=_,n.iceGatherer||(n.iceGatherer=T._createIceGatherer(t,C)),e.length&&"new"===n.iceTransport.state&&(!u||C&&0!==t?e.forEach(function(e){A(n.iceTransport,e)}):n.iceTransport.setRemoteCandidates(e)),o=I.RTCRtpReceiver.getCapabilities(y),R<15019&&(o.codecs=o.codecs.filter(function(e){return"rtx"!==e.name})),l=n.sendEncodingParameters||[{ssrc:1001*(2*t+2)}],p=!1,"sendrecv"===g||"sendonly"===g?(p=!n.rtpReceiver,h=n.rtpReceiver||new I.RTCRtpReceiver(n.dtlsTransport,y),p&&(f=h.track,(d=b&&"-"===b.stream?d:b?(k[b.stream]||(k[b.stream]=new I.MediaStream,Object.defineProperty(k[b.stream],"id",{get:function(){return b.stream}})),Object.defineProperty(f,"id",{get:function(){return b.track}}),k[b.stream]):(k.default||(k.default=new I.MediaStream),k.default))&&(P(f,d),n.associatedRemoteMediaStreams.push(d)),x.push([f,h,d]))):n.rtpReceiver&&n.rtpReceiver.track&&(n.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===n.rtpReceiver.track.id});t&&(t=t,(e=e).removeTrack(t),e.dispatchEvent(new I.MediaStreamTrackEvent("removetrack",{track:t})))}),n.associatedRemoteMediaStreams=[]),n.localCapabilities=o,n.remoteCapabilities=m,n.rtpReceiver=h,n.rtcpParameters=c,n.sendEncodingParameters=l,n.recvEncodingParameters=i,T._transceive(T.transceivers[t],!1,p)))}),void 0===T._dtlsRole&&(T._dtlsRole="offer"===w.type?"active":"passive"),T.remoteDescription={type:w.type,sdp:w.sdp},"offer"===w.type?T._updateSignalingState("have-remote-offer"):T._updateSignalingState("stable"),Object.keys(k).forEach(function(e){var t,r=k[e];r.getTracks().length&&(-1===T.remoteStreams.indexOf(r)&&(T.remoteStreams.push(r),(t=new Event("addstream")).stream=r,I.setTimeout(function(){T._dispatchEvent("addstream",t)})),x.forEach(function(e){var t=e[0],n=e[1];r.id===e[2].id&&i(T,t,n,[r])}))}),x.forEach(function(e){e[2]||i(T,e[0],e[1],[])}),I.setTimeout(function(){T&&T.transceivers&&T.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&0<e.iceTransport.getRemoteCandidates().length&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve())},r.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},r.prototype._updateSignalingState=function(e){this.signalingState=e;e=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",e)},r.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,I.setTimeout(function(){var e;t.needNegotiation&&(t.needNegotiation=!1,e=new Event("negotiationneeded"),t._dispatchEvent("negotiationneeded",e))},0))},r.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++}),t.connected+=t.completed,e="new",0<t.failed?e="failed":0<t.connecting||0<t.checking?e="connecting":0<t.disconnected?e="disconnected":0<t.new?e="new":(0<t.connected||0<t.completed)&&(e="connected"),e!==this.iceConnectionState&&(this.iceConnectionState=e,e=new Event("iceconnectionstatechange"),this._dispatchEvent("iceconnectionstatechange",e))},r.prototype.createOffer=function(){var o=this;if(o._isClosed)return Promise.reject(p("InvalidStateError","Can not call createOffer after close"));var t=o.transceivers.filter(function(e){return"audio"===e.kind}).length,n=o.transceivers.filter(function(e){return"video"===e.kind}).length,e=arguments[0];if(e){if(e.mandatory||e.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==e.offerToReceiveAudio&&(t=!0===e.offerToReceiveAudio?1:!1===e.offerToReceiveAudio?0:e.offerToReceiveAudio),void 0!==e.offerToReceiveVideo&&(n=!0===e.offerToReceiveVideo?1:!1===e.offerToReceiveVideo?0:e.offerToReceiveVideo)}for(o.transceivers.forEach(function(e){"audio"===e.kind?--t<0&&(e.wantReceive=!1):"video"===e.kind&&--n<0&&(e.wantReceive=!1)});0<t||0<n;)0<t&&(o._createTransceiver("audio"),t--),0<n&&(o._createTransceiver("video"),n--);var r=O.writeSessionBoilerplate(o._sdpSessionId,o._sdpSessionVersion++),e=(o.transceivers.forEach(function(e,t){var n=e.track,r=e.kind,i=e.mid||O.generateIdentifier(),i=(e.mid=i,e.iceGatherer||(e.iceGatherer=o._createIceGatherer(t,o.usingBundle)),I.RTCRtpSender.getCapabilities(r)),t=(R<15019&&(i.codecs=i.codecs.filter(function(e){return"rtx"!==e.name})),i.codecs.forEach(function(t){"H264"===t.name&&void 0===t.parameters["level-asymmetry-allowed"]&&(t.parameters["level-asymmetry-allowed"]="1"),e.remoteCapabilities&&e.remoteCapabilities.codecs&&e.remoteCapabilities.codecs.forEach(function(e){t.name.toLowerCase()===e.name.toLowerCase()&&t.clockRate===e.clockRate&&(t.preferredPayloadType=e.payloadType)})}),i.headerExtensions.forEach(function(t){(e.remoteCapabilities&&e.remoteCapabilities.headerExtensions||[]).forEach(function(e){t.uri===e.uri&&(t.id=e.id)})}),e.sendEncodingParameters||[{ssrc:1001*(2*t+1)}]);n&&15019<=R&&"video"===r&&!t[0].rtx&&(t[0].rtx={ssrc:t[0].ssrc+1}),e.wantReceive&&(e.rtpReceiver=new I.RTCRtpReceiver(e.dtlsTransport,r)),e.localCapabilities=i,e.sendEncodingParameters=t}),"max-compat"!==o._config.bundlePolicy&&(r+="a=group:BUNDLE "+o.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),r+="a=ice-options:trickle\r\n",o.transceivers.forEach(function(e,t){r=r+a(e,e.localCapabilities,"offer",e.stream,o._dtlsRole)+"a=rtcp-rsize\r\n",!e.iceGatherer||"new"===o.iceGatheringState||0!==t&&o.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,r+="a="+O.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(r+="a=end-of-candidates\r\n"))}),new I.RTCSessionDescription({type:"offer",sdp:r}));return Promise.resolve(e)},r.prototype.createAnswer=function(){var r,i,e,o=this;return o._isClosed?Promise.reject(p("InvalidStateError","Can not call createAnswer after close")):(r=O.writeSessionBoilerplate(o._sdpSessionId,o._sdpSessionVersion++),o.usingBundle&&(r+="a=group:BUNDLE "+o.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),i=O.getMediaSections(o.remoteDescription.sdp).length,o.transceivers.forEach(function(e,t){var n;i<t+1||(e.isDatachannel?r+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+e.mid+"\r\n":(e.stream&&("audio"===e.kind?n=e.stream.getAudioTracks()[0]:"video"===e.kind&&(n=e.stream.getVideoTracks()[0]),n)&&15019<=R&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}),!(t=f(e.localCapabilities,e.remoteCapabilities)).codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,r+=a(e,t,"answer",e.stream,o._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(r+="a=rtcp-rsize\r\n")))}),e=new I.RTCSessionDescription({type:"answer",sdp:r}),Promise.resolve(e))},r.prototype.addIceCandidate=function(s){var c,u=this;return s&&void 0===s.sdpMLineIndex&&!s.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(e,t){if(!u.remoteDescription)return t(p("InvalidStateError","Can not add ICE candidate without a remote description"));if(s&&""!==s.candidate){var n=s.sdpMLineIndex;if(s.sdpMid)for(var r=0;r<u.transceivers.length;r++)if(u.transceivers[r].mid===s.sdpMid){n=r;break}var i=u.transceivers[n];if(!i)return t(p("OperationError","Can not add ICE candidate"));if(i.isDatachannel)return e();var o=0<Object.keys(s.candidate).length?O.parseCandidate(s.candidate):{};if("tcp"===o.protocol&&(0===o.port||9===o.port))return e();if(o.component&&1!==o.component)return e();if((0===n||0<n&&i.iceTransport!==u.transceivers[0].iceTransport)&&!A(i.iceTransport,o))return t(p("OperationError","Can not add ICE candidate"));i=s.candidate.trim();0===i.indexOf("a=")&&(i=i.substr(2)),(c=O.getMediaSections(u.remoteDescription.sdp))[n]+="a="+(o.type?i:"end-of-candidates")+"\r\n",u.remoteDescription.sdp=c.join("")}else for(var a=0;a<u.transceivers.length&&(u.transceivers[a].isDatachannel||(u.transceivers[a].iceTransport.addRemoteCandidate({}),(c=O.getMediaSections(u.remoteDescription.sdp))[a]+="a=end-of-candidates\r\n",u.remoteDescription.sdp=O.getDescription(u.remoteDescription.sdp)+c.join(""),!u.usingBundle));a++);e()})},r.prototype.getStats=function(){var n=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(e){t[e]&&n.push(t[e].getStats())})});return new Promise(function(t){var r=new Map;Promise.all(n).then(function(e){e.forEach(function(n){Object.keys(n).forEach(function(e){var t;n[e].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(t=n[e]).type]||t.type,r.set(e,n[e])})}),t(r)})})};var e=["createOffer","createAnswer"];return e.forEach(function(e){var n=r.prototype[e];r.prototype[e]=function(){var t=arguments;return"function"==typeof t[0]||"function"==typeof t[1]?n.apply(this,[arguments[2]]).then(function(e){"function"==typeof t[0]&&t[0].apply(null,[e])},function(e){"function"==typeof t[1]&&t[1].apply(null,[e])}):n.apply(this,arguments)}}),(e=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var n=r.prototype[e];r.prototype[e]=function(){var t=arguments;return"function"==typeof t[1]||"function"==typeof t[2]?n.apply(this,arguments).then(function(){"function"==typeof t[1]&&t[1].apply(null)},function(e){"function"==typeof t[2]&&t[2].apply(null,[e])}):n.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=r.prototype[e];r.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),r}},{sdp:62}],62:[function(e,t,n){"use strict";var u={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};u.localCName=u.generateIdentifier(),u.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},u.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"})},u.getDescription=function(e){e=u.splitSections(e);return e&&e[0]},u.getMediaSections=function(e){e=u.splitSections(e);return e.shift(),e},u.matchPrefix=function(e,t){return u.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},u.parseCandidate=function(e){for(var t=(0===e.indexOf("a=candidate:")?e.substring(12):e.substring(10)).split(" "),n={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1]}return n},u.writeCandidate=function(e){var t=[],n=(t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port),e.type);return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},u.parseIceOptions=function(e){return e.substr(14).split(" ")},u.parseRtpMap=function(e){var e=e.substr(9).split(" "),t={payloadType:parseInt(e.shift(),10)},e=e[0].split("/");return t.name=e[0],t.clockRate=parseInt(e[1],10),t.channels=3===e.length?parseInt(e[2],10):1,t.numChannels=t.channels,t},u.writeRtpMap=function(e){var t=e.payloadType,n=(void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),e.channels||e.numChannels||1);return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},u.parseExtmap=function(e){e=e.substr(9).split(" ");return{id:parseInt(e[0],10),direction:0<e[0].indexOf("/")?e[0].split("/")[1]:"sendrecv",uri:e[1]}},u.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},u.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},u.writeFmtp=function(t){var n,e="",r=t.payloadType;return void 0!==t.preferredPayloadType&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length&&(n=[],Object.keys(t.parameters).forEach(function(e){t.parameters[e]?n.push(e+"="+t.parameters[e]):n.push(e)}),e+="a=fmtp:"+r+" "+n.join(";")+"\r\n"),e},u.parseRtcpFb=function(e){e=e.substr(e.indexOf(" ")+1).split(" ");return{type:e.shift(),parameter:e.join(" ")}},u.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},u.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return-1<r?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},u.parseSsrcGroup=function(e){e=e.substr(13).split(" ");return{semantics:e.shift(),ssrcs:e.map(function(e){return parseInt(e,10)})}},u.getMid=function(e){e=u.matchPrefix(e,"a=mid:")[0];if(e)return e.substr(6)},u.parseFingerprint=function(e){e=e.substr(14).split(" ");return{algorithm:e[0].toLowerCase(),value:e[1]}},u.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:u.matchPrefix(e+t,"a=fingerprint:").map(u.parseFingerprint)}},u.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},u.parseCryptoLine=function(e){e=e.substr(9).split(" ");return{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}},u.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?u.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},u.parseCryptoKeyParams=function(e){return 0!==e.indexOf("inline:")?null:{keyMethod:"inline",keySalt:(e=e.substr(7).split("|"))[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:void 0,mkiLength:e[2]?e[2].split(":")[1]:void 0}},u.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},u.getCryptoParameters=function(e,t){return u.matchPrefix(e+t,"a=crypto:").map(u.parseCryptoLine)},u.getIceParameters=function(e,t){var n=u.matchPrefix(e+t,"a=ice-ufrag:")[0],e=u.matchPrefix(e+t,"a=ice-pwd:")[0];return n&&e?{usernameFragment:n.substr(12),password:e.substr(10)}:null},u.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},u.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=u.splitLines(e)[0].split(" "),r=3;r<n.length;r++){var i=n[r],o=u.matchPrefix(e,"a=rtpmap:"+i+" ")[0];if(o){var a=u.parseRtpMap(o),o=u.matchPrefix(e,"a=fmtp:"+i+" ");switch(a.parameters=o.length?u.parseFmtp(o[0]):{},a.rtcpFeedback=u.matchPrefix(e,"a=rtcp-fb:"+i+" ").map(u.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return u.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(u.parseExtmap(e))}),t},u.writeRtpDescription=function(e,t){var n="",r=(n=(n=(n=(n+="m="+e+" ")+(0<t.codecs.length?"9":"0")+" UDP/TLS/RTP/SAVPF ")+(t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n"))+"c=IN IP4 0.0.0.0\r\n"+"a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n=(n=(n+=u.writeRtpMap(e))+u.writeFmtp(e))+u.writeRtcpFb(e)}),0);return t.codecs.forEach(function(e){e.maxptime>r&&(r=e.maxptime)}),0<r&&(n+="a=maxptime:"+r+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){n+=u.writeExtmap(e)}),n},u.parseRtpEncodingParameters=function(e){var t,n=[],r=u.parseRtpParameters(e),i=-1!==r.fecMechanisms.indexOf("RED"),o=-1!==r.fecMechanisms.indexOf("ULPFEC"),a=u.matchPrefix(e,"a=ssrc:").map(function(e){return u.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),s=0<a.length&&a[0].ssrc,a=u.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})}),c=(0<a.length&&1<a[0].length&&a[0][0]===s&&(t=a[0][1]),r.codecs.forEach(function(e){"RTX"===e.name.toUpperCase()&&e.parameters.apt&&(e={ssrc:s,codecPayloadType:parseInt(e.parameters.apt,10)},s&&t&&(e.rtx={ssrc:t}),n.push(e),i)&&((e=JSON.parse(JSON.stringify(e))).fec={ssrc:s,mechanism:o?"red+ulpfec":"red"},n.push(e))}),0===n.length&&s&&n.push({ssrc:s}),u.matchPrefix(e,"b="));return c.length&&(c=0===c[0].indexOf("b=TIAS:")?parseInt(c[0].substr(7),10):0===c[0].indexOf("b=AS:")?1e3*parseInt(c[0].substr(5),10)*.95-16e3:void 0,n.forEach(function(e){e.maxBitrate=c})),n},u.parseRtcpParameters=function(e){var t={},n=u.matchPrefix(e,"a=ssrc:").map(function(e){return u.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0],n=(n&&(t.cname=n.value,t.ssrc=n.ssrc),u.matchPrefix(e,"a=rtcp-rsize")),n=(t.reducedSize=0<n.length,t.compound=0===n.length,u.matchPrefix(e,"a=rtcp-mux"));return t.mux=0<n.length,t},u.parseMsid=function(e){var t,n=u.matchPrefix(e,"a=msid:");return 1===n.length?{stream:(t=n[0].substr(7).split(" "))[0],track:t[1]}:0<(n=u.matchPrefix(e,"a=ssrc:").map(function(e){return u.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute})).length?{stream:(t=n[0].value.split(" "))[0],track:t[1]}:void 0},u.parseSctpDescription=function(e){var t,n=u.parseMLine(e),r=u.matchPrefix(e,"a=max-message-size:"),r=(0<r.length&&(t=parseInt(r[0].substr(19),10)),isNaN(t)&&(t=65536),u.matchPrefix(e,"a=sctp-port:"));return 0<r.length?{port:parseInt(r[0].substr(12),10),protocol:n.fmt,maxMessageSize:t}:0<u.matchPrefix(e,"a=sctpmap:").length?(r=u.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" "),{port:parseInt(r[0],10),protocol:r[1],maxMessageSize:t}):void 0},u.writeSctpDescription=function(e,t){var n=[],n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"];return void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},u.generateSessionId=function(){return Math.random().toString().substr(2,21)},u.writeSessionBoilerplate=function(e,t,n){t=void 0!==t?t:2,e=e||u.generateSessionId();return"v=0\r\no="+(n||"thisisadapterortc")+" "+e+" "+t+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},u.writeMediaSection=function(e,t,n,r){t=u.writeRtpDescription(e.kind,t);return t=(t=(t+=u.writeIceParameters(e.iceGatherer.getLocalParameters()))+u.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"))+("a=mid:"+e.mid+"\r\n"),e.direction?t+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?t+="a=sendrecv\r\n":e.rtpSender?t+="a=sendonly\r\n":e.rtpReceiver?t+="a=recvonly\r\n":t+="a=inactive\r\n",e.rtpSender&&(t=t+"a="+(n="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n")+"a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+n,e.sendEncodingParameters[0].rtx)&&(t=(t+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+n)+"a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"),t+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+u.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(t+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+u.localCName+"\r\n"),t},u.getDirection=function(e,t){for(var n=u.splitLines(e),r=0;r<n.length;r++)switch(n[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[r].substr(2)}return t?u.getDirection(t):"sendrecv"},u.getKind=function(e){return u.splitLines(e)[0].split(" ")[0].substr(2)},u.isRejected=function(e){return"0"===e.split(" ",2)[1]},u.parseMLine=function(e){e=u.splitLines(e)[0].substr(2).split(" ");return{kind:e[0],port:parseInt(e[1],10),protocol:e[2],fmt:e.slice(3).join(" ")}},u.parseOLine=function(e){e=u.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:e[0],sessionId:e[1],sessionVersion:parseInt(e[2],10),netType:e[3],addressType:e[4],address:e[5]}},u.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=u.splitLines(e),n=0;n<t.length;n++)if(t[n].length<2||"="!==t[n].charAt(1))return!1;return!0},"object"==typeof t&&(t.exports=u)},{}],63:[function(e,t,n){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;function n(){}n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},{}],64:[function(e,t,n){t.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},{}],65:[function(C,e,T){!function(S,E){!function(){var e,s=/%[sdj%]/g,r=(T.format=function(e){if(!v(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(c(arguments[n]));return t.join(" ")}for(var n=1,r=arguments,i=r.length,o=String(e).replace(s,function(e){if("%%"===e)return"%";if(i<=n)return e;switch(e){case"%s":return String(r[n++]);case"%d":return Number(r[n++]);case"%j":try{return JSON.stringify(r[n++])}catch(e){return"[Circular]"}default:return e}}),a=r[n];n<i;a=r[++n])m(a)||!u(a)?o+=" "+a:o+=" "+c(a);return o},T.deprecate=function(e,t){var n;return g(E.process)?function(){return T.deprecate(e,t).apply(this,arguments)}:!0===S.noDeprecation?e:(n=!1,function(){if(!n){if(S.throwDeprecation)throw new Error(t);S.traceDeprecation?console.trace(t):console.error(t),n=!0}return e.apply(this,arguments)})},{});function c(e,t){var n={seen:[],stylize:o};return 3<=arguments.length&&(n.depth=arguments[2]),4<=arguments.length&&(n.colors=arguments[3]),h(t)?n.showHidden=t:t&&T._extend(n,t),g(n.showHidden)&&(n.showHidden=!1),g(n.depth)&&(n.depth=2),g(n.colors)&&(n.colors=!1),g(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=i),l(n,e,n.depth)}function i(e,t){t=c.styles[t];return t?"["+c.colors[t][0]+"m"+e+"["+c.colors[t][1]+"m":e}function o(e,t){return e}function l(t,n,r){if(t.customInspect&&n&&k(n.inspect)&&n.inspect!==T.inspect&&(!n.constructor||n.constructor.prototype!==n))return v(e=n.inspect(r,t))?e:l(t,e,r);var e=function(e,t){if(g(t))return e.stylize("undefined","undefined");{var n;if(v(t))return n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'",e.stylize(n,"string")}return y(t)?e.stylize(""+t,"number"):h(t)?e.stylize(""+t,"boolean"):m(t)?e.stylize("null","null"):void 0}(t,n);if(e)return e;var i,e=Object.keys(n),o=(i={},e.forEach(function(e,t){i[e]=!0}),i);if(t.showHidden&&(e=Object.getOwnPropertyNames(n)),w(n)&&(0<=e.indexOf("message")||0<=e.indexOf("description")))return d(n);if(0===e.length){if(k(n))return a=n.name?": "+n.name:"",t.stylize("[Function"+a+"]","special");if(b(n))return t.stylize(RegExp.prototype.toString.call(n),"regexp");if(_(n))return t.stylize(Date.prototype.toString.call(n),"date");if(w(n))return d(n)}var a="",s=!1,c=["{","}"];if(p(n)&&(s=!0,c=["[","]"]),k(n)&&(a=" [Function"+(n.name?": "+n.name:"")+"]"),b(n)&&(a=" "+RegExp.prototype.toString.call(n)),_(n)&&(a=" "+Date.prototype.toUTCString.call(n)),w(n)&&(a=" "+d(n)),0===e.length&&(!s||0==n.length))return c[0]+a+c[1];if(r<0)return b(n)?t.stylize(RegExp.prototype.toString.call(n),"regexp"):t.stylize("[Object]","special");t.seen.push(n),u=s?function(t,n,r,i,e){for(var o=[],a=0,s=n.length;a<s;++a)x(n,String(a))?o.push(f(t,n,r,i,String(a),!0)):o.push("");return e.forEach(function(e){e.match(/^\d+$/)||o.push(f(t,n,r,i,e,!0))}),o}(t,n,r,o,e):e.map(function(e){return f(t,n,r,o,e,s)}),t.seen.pop();var u;return 60<u.reduce(function(e,t){return 0<=t.indexOf("\n")&&0,e+t.replace(/\u001b\[\d\d?m/g,"").length+1},0)?c[0]+(""===a?"":a+"\n ")+" "+u.join(",\n  ")+" "+c[1]:c[0]+a+" "+u.join(", ")+" "+c[1]}function d(e){return"["+Error.prototype.toString.call(e)+"]"}function f(e,t,n,r,i,o){var a,s,t=Object.getOwnPropertyDescriptor(t,i)||{value:t[i]};if(t.get?s=t.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):t.set&&(s=e.stylize("[Setter]","special")),x(r,i)||(a="["+i+"]"),s||(e.seen.indexOf(t.value)<0?-1<(s=m(n)?l(e,t.value,null):l(e,t.value,n-1)).indexOf("\n")&&(s=o?s.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+s.split("\n").map(function(e){return"   "+e}).join("\n")):s=e.stylize("[Circular]","special")),g(a)){if(o&&i.match(/^\d+$/))return s;a=(a=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.substr(1,a.length-2),e.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),e.stylize(a,"string"))}return a+": "+s}function p(e){return Array.isArray(e)}function h(e){return"boolean"==typeof e}function m(e){return null===e}function y(e){return"number"==typeof e}function v(e){return"string"==typeof e}function g(e){return void 0===e}function b(e){return u(e)&&"[object RegExp]"===t(e)}function u(e){return"object"==typeof e&&null!==e}function _(e){return u(e)&&"[object Date]"===t(e)}function w(e){return u(e)&&("[object Error]"===t(e)||e instanceof Error)}function k(e){return"function"==typeof e}function t(e){return Object.prototype.toString.call(e)}function n(e){return e<10?"0"+e.toString(10):e.toString(10)}T.debuglog=function(t){var n;return g(e)&&(e=S.env.NODE_DEBUG||""),t=t.toUpperCase(),r[t]||(new RegExp("\\b"+t+"\\b","i").test(e)?(n=S.pid,r[t]=function(){var e=T.format.apply(T,arguments);console.error("%s %d: %s",t,n,e)}):r[t]=function(){}),r[t]},(T.inspect=c).colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},c.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},T.isArray=p,T.isBoolean=h,T.isNull=m,T.isNullOrUndefined=function(e){return null==e},T.isNumber=y,T.isString=v,T.isSymbol=function(e){return"symbol"==typeof e},T.isUndefined=g,T.isRegExp=b,T.isObject=u,T.isDate=_,T.isError=w,T.isFunction=k,T.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},T.isBuffer=C("./support/isBuffer");var a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function x(e,t){return Object.prototype.hasOwnProperty.call(e,t)}T.log=function(){var e,t;console.log("%s - %s",(e=new Date,t=[n(e.getHours()),n(e.getMinutes()),n(e.getSeconds())].join(":"),[e.getDate(),a[e.getMonth()],t].join(" ")),T.format.apply(T,arguments))},T.inherits=C("inherits"),T._extend=function(e,t){if(t&&u(t))for(var n=Object.keys(t),r=n.length;r--;)e[n[r]]=t[n[r]];return e}}.call(this)}.call(this,C("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":64,_process:60,inherits:63}]},{},[3])(3);"function"==typeof define&&define.amd?define([],function(){return t}):((e=e.Twilio=e.Twilio||{}).Call=e.Call||t.Call,e.Device=e.Device||t.Device,e.PStream=e.PStream||t.PStream,e.PreflightTest=e.PreflightTest||t.PreflightTest,e.Logger=e.Logger||t.Logger)}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this);var EventEmitter=require("events");const ConversationsClient=new Twilio.Conversations.Client(token),Device=Twilio.Device;class EventConstants{static MESSAGE_ADDED="manh:messageadded";static TYPING_STARTED="manh:typingstarted";static TYPING_ENDED="manh:typingended";static CUSTOMER_TYPING_STARTED="manh:customertypingstarted";static CUSTOMER_TYPING_ENDED="manh:customertypingended";static AGENT_ADDED="manh:agentadded";static POPULATE_MESSAGE="manh:populatemessage"}class Constants{static FROM_CUSTOMER="fromCustomer";static REGISTERED="registered";static IDENTITY="identity";static AGENT_ADDED="agentAdded";static AGENT_NAME="agentName";static AGENT_ID="agentId";static NAME="name";static CHAT_BOT="chatbot";static INTENT="Intent";static GET_CSR_SESSION_DETAILS="./api/customerengagementfacade/conversations/conversation/csr/csrSession"}class Conversation extends EventEmitter{conversation;fromCSR=!1;messages=[];registeredCustomerId;agentId="";agentName="Agent";firstName;lastName;emailId;phone;constructor(){super()}_setConversation(e){this.conversation=e}_setMessageOrigin(e){this.fromCSR=e}_setMessages(e){this.messages=e}getMessages(){return this.messages}_addMessage(e){this.messages.push(e)}typing(){this.conversation.typing()}sendMessage(e,t){let n=t?t:{};n[Constants.FROM_CUSTOMER]=!this.fromCSR,n[Constants.AGENT_ID]=this.agentId,n[Constants.REGISTERED]=!!this.registeredCustomerId,this.conversation.sendMessage(e,n)}}class ManhClient{static _events=new EventEmitter;static _populateToMessage(e){ManhClient._events.emit(EventConstants.POPULATE_MESSAGE,e)}static initialize(e){ManhClient._fetchConversation(e,!1)}static initializeCSR(t){ConversationsClient.create(t.accessToken).then(e=>{e.on("connectionStateChanged",e=>{"connected"!==e&&"connecting"!==e&&"disconnecting"!==e&&"disconnected"!==e&&"denied"!==e||t.onConnected(e)}),e.on("conversationAdded",e=>{t.onConversationAdded(e)}),e.on("conversationUpdated",e=>{t.onConversationUpdated(e)}),e.on("tokenAboutToExpire",()=>{t.onTokenAboutToExpire()}),e.on("tokenExpired",()=>{t.onTokenExpired()}),t.onClientLoaded(e)}).catch(e=>{t.onClientLoaded(null,"Error while creating client")})}static _fetchConversationCSR(e,t){let n=new Conversation,r;n.registeredCustomerId=t.registeredCustomerId,n.firstName=t.firstName,n.lastName=t.lastName,n.emailId=t.emailId,n.phone=t.phone,n._setMessageOrigin(!0),e.getConversationBySid(t.conversationId).then(e=>{r=e,n._setConversation(e),ManhClient._fetchMessagesCSR(r,n,t),ManhClient._addListeners(r,n,!0)}).catch(e=>{t.onConversationLoaded(null,null,"Error while fetching conversation")})}static _fetchConversation(i,o){ConversationsClient.create(i.accessToken).then(t=>{let n=new Conversation,r;n.registeredCustomerId=i.registeredCustomerId,n.firstName=i.firstName,n.lastName=i.lastName,n.emailId=i.emailId,n.phone=i.phone,o&&n._setMessageOrigin(!0),t.on("connectionStateChanged",e=>{!i.onConnected||"connected"!==e&&"connecting"!==e&&"disconnecting"!==e&&"disconnected"!==e&&"denied"!==e||i.onConnected(e),"connected"===e?t.getConversationBySid(i.conversationId).then(e=>{r=e,n._setConversation(e),ManhClient._fetchMessages(r,n,i),ManhClient._addListeners(r,n,o)}).catch(e=>{i.onConversationLoaded(null,"Error while fetching conversation")}):ManhClient._removeListeners(r,n)})}).catch(e=>{i.onConversationLoaded(null,"Error while creating client")})}static _fetchMessages(e,r,t){e.getMessages().then(e=>{let n=[];e.items.forEach(e=>{let t={};t.body=e.body,t.dateUpdated=e.dateUpdated,t.attributes=e.attributes,e.media&&e.media.getContentTemporaryUrl().then(e=>{t.media={imageUrl:e}}),ManhClient._setSenderDetails(t,e,r),n.push(t)}),r._setMessages(n),t.onConversationLoaded(r)}).catch(e=>{t.onConversationLoaded(null,"Error while fetching messages")})}static _fetchMessagesCSR(t,r,i){t.getMessages().then(e=>{let n=[];e.items.forEach(e=>{let t={};t.body=e.body,t.dateUpdated=e.dateUpdated,t.attributes=e.attributes,e.media&&e.media.getContentTemporaryUrl().then(e=>{t.media={imageUrl:e}}),ManhClient._setSenderDetails(t,e,r),n.push(t)}),r._setMessages(n),i.onConversationLoaded(t,r)}).catch(e=>{i.onConversationLoaded(null,null,"Error while fetching messages")})}static _addListeners(e,n,r){e.on("messageAdded",e=>{let t={};t.body=e.body,t.dateUpdated=e.dateUpdated,t.attributes=e.attributes,e.media&&e.media.getContentTemporaryUrl().then(e=>{t.media={imageUrl:e}}),ManhClient._setSenderDetails(t,e,n),n._addMessage(t),n.emit(EventConstants.MESSAGE_ADDED,t)}),e.on("participantJoined",e=>{var t;e.attributes[Constants.NAME]&&((t={agentAdded:!0}).body="Connected to agent "+e.attributes[Constants.NAME],n.agentId=e[Constants.IDENTITY],n.agentName=e.attributes[Constants.NAME],n._addMessage(t),n.emit(EventConstants.AGENT_ADDED))}),e.on("typingStarted",e=>{var t={};t.author=e.identity,r?n.emit(EventConstants.CUSTOMER_TYPING_STARTED,t):n.emit(EventConstants.TYPING_STARTED,t)}),e.on("typingEnded",e=>{var t={};t.author=e.identity,r?n.emit(EventConstants.CUSTOMER_TYPING_ENDED,t):n.emit(EventConstants.TYPING_ENDED,t)})}static _setSenderDetails(e,t,n){t.attributes&&(!0===t.attributes[Constants.FROM_CUSTOMER]?(e.senderType="customer",e.senderId=n.registeredCustomerId||null,n.firstName||n.lastName?e.senderDisplayName=n.firstName+" "+n.lastName:e.senderDisplayName="You"):t.author===Constants.CHAT_BOT?(e.senderType="bot",e.senderId=t.author,e.senderDisplayName="Robin (Chatbot)"):(e.senderType="agent",e.senderId=t.author,e.senderDisplayName=t.attributes[Constants.AGENT_NAME],n.agentId=t.author,n.agentName=t.attributes[Constants.AGENT_NAME]))}static _removeListeners(e,t){e&&(e.removeAllListeners(["messageAdded"]),e.removeAllListeners(["typingStarted"]),e.removeAllListeners(["typingEnded"]),e.removeAllListeners(["participantJoined"])),t&&t.removeAllListeners()}static async initializeDevice(n){console.log("VOICE TOKEN",n.Token),ManhClient.device=new Device(n.Token),ManhClient.device.register(),ManhClient.device.on("registered",()=>{n.onRegistration("The device is ready to receive and make outgoing calls.")}),ManhClient.device.on("incoming",e=>{console.log("Manhclient Incmoming call ",e),ManhClient.call=e,ManhClient.call&&(ManhClient.call.on("disconnect",e=>{n.onCallDisconnected(e)}),ManhClient.call.on("reject",e=>{n.onCallDisconnected(e)}),ManhClient.call.on("cancel",e=>{n.onCallDisconnected(e)}));var t={};t.calldetails=e,t.event="in-incoming",t.from=e.parameters?.From,t.caseId=ManhClient.call.customParameters?.get("CaseId"),n.onIncomingCall(t)}),ManhClient.device.on("error",e=>{n.onErrorDetails(e)})}static async makeOutGoingCall(e){var e={To:e.To};ManhClient.device?(e=await ManhClient.device.connect({params:e}),ManhClient.call=e):console.log("Unable to make call from voice service")}static acceptCallAction(){ManhClient.call.accept()}static rejectCallAction(e){"reject"==e.event&&(ManhClient.call.disconnect(),"INCOMING"==ManhClient.call._direction)&&ManhClient.call.reject()}static muteCallAction(){var e=ManhClient.call.isMuted();console.log("Mute Status ",e);let t=!0;t=1!=e,ManhClient.call.mute(t)}static isCallMuted(){return ManhClient.call.isMuted()}}export{ManhClient};